<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Reasoning Trainer v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            min-height: 100vh;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.5s ease;
        }
        
        /* Diagnosis cards for categorization */
        .dx-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 16px;
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }
        
        .dx-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .dx-card.selected-likely {
            border-color: #22c55e;
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
        }
        
        .dx-card.selected-must-not-miss {
            border-color: #ef4444;
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        
        /* Category drop zones */
        .category-zone {
            min-height: 120px;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }
        
        .category-zone.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .category-zone.likely {
            border-color: #86efac;
            background: #f0fdf4;
        }
        
        .category-zone.must-not-miss {
            border-color: #fca5a5;
            background: #fef2f2;
        }
        
        /* Question/Exam buttons */
        .selection-btn {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .selection-btn:hover:not(.selected):not(:disabled) {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .selection-btn.selected {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        .selection-btn:disabled {
            opacity: 0.7;
            cursor: default;
        }
        
        /* Feedback badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-essential { background: #dcfce7; color: #166534; }
        .badge-helpful { background: #dbeafe; color: #1e40af; }
        .badge-neutral { background: #f3f4f6; color: #4b5563; }
        .badge-low-yield { background: #fef3c7; color: #92400e; }
        
        /* Score display */
        .score-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        /* Narrative box */
        .narrative-box {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
            border: 2px solid #facc15;
            border-radius: 12px;
            padding: 20px;
            font-style: italic;
            line-height: 1.6;
        }
        
        /* Workup categories */
        .workup-category {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .workup-category-header {
            background: #f1f5f9;
            padding: 12px 16px;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        
        /* Thinking prompt */
        .thinking-prompt {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 2px solid #c084fc;
            border-radius: 12px;
            padding: 16px;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .category-zones-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto"></div>
    
    <script>
    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    
    const state = {
        screen: 'menu', // menu, case-select, differential, history, physical, revised-differential, workup, results, summary
        mode: null, // 'practice' or 'quiz'
        caseType: null,
        variantKey: null,
        
        // Differential stage
        selectedLikely: [],
        selectedMustNotMiss: [],
        differentialSubmitted: false,
        
        // History stage
        oldcartsViewed: false,
        selectedHistory: [],
        historySubmitted: false,
        
        // Physical exam stage
        selectedPhysical: [],
        physicalSubmitted: false,
        
        // Revised differential
        revisedLikely: [],
        revisedMustNotMiss: [],
        revisedSubmitted: false,
        differentialNotes: '',
        
        // Workup stage
        selectedWorkup: [],
        workupSubmitted: false,
        
        // Scoring
        scores: {
            differential: 0,
            history: 0,
            physical: 0,
            revisedDifferential: 0,
            workup: 0
        },
        bonuses: {
            mustNotMiss: false,
            selfCorrection: false,
            efficiency: false
        }
    };
    
    // ============================================================
    // SCORING CONFIGURATION
    // ============================================================
    
    const SCORING = {
        weights: {
            differential: 15,
            history: 20,
            physical: 15,
            revisedDifferential: 25,
            workup: 25
        },
        bonuses: {
            mustNotMiss: 5,
            selfCorrection: 5,
            efficiency: 5
        }
    };
    
    // ============================================================
    // CASE DATA
    // ============================================================
    
    const cases = [
        // ==================== EPIGASTRIC PAIN ====================
        {
            id: "epigastric",
            title: "Epigastric Pain",
            category: "GI",
            icon: "ðŸ”¥",
            
            variants: {
                "male-58-nsaid": {
                    name: "R.H.",
                    age: 58,
                    gender: "male",
                    chiefComplaint: "Burning stomach pain for 3 days",
                    vitalSigns: {
                        BP: "145/88",
                        HR: 78,
                        RR: 16,
                        Temp: "98.6Â°F",
                        SpO2: "98%"
                    },
                    
                    // All possible diagnoses (no absurd ones, but includes unlikely)
                    allDiagnoses: [
                        // Correct categorizations for this case
                        { name: "Peptic Ulcer Disease", correctCategory: "likely", rationale: "Daily NSAID use is a major risk factor. Burning epigastric pain with dark stools suggests possible bleeding ulcer." },
                        { name: "Gastritis", correctCategory: "likely", rationale: "NSAIDs, alcohol, and coffee are all gastric irritants. Burning epigastric pain fits well." },
                        { name: "GERD", correctCategory: "likely", rationale: "Burning epigastric pain worse after eating is classic for GERD. High caffeine intake is a risk factor." },
                        
                        { name: "Acute Coronary Syndrome", correctCategory: "must-not-miss", rationale: "58-year-old male with HTN and smoking history. Epigastric pain CAN be anginal equivalent. Must rule out!" },
                        { name: "Aortic Dissection", correctCategory: "must-not-miss", rationale: "HTN and smoking history are risk factors. Can present with epigastric pain. Look for tearing quality." },
                        { name: "Perforated Ulcer", correctCategory: "must-not-miss", rationale: "With daily NSAID use, perforation is a serious risk. Would present with acute peritonitis." },
                        
                        // Less likely but reasonable
                        { name: "Acute Pancreatitis", correctCategory: "less-likely", rationale: "Alcohol use is a risk factor, but gradual onset and burning quality without radiation to back is less typical." },
                        { name: "Biliary Colic", correctCategory: "less-likely", rationale: "Pain worse after eating could fit, but burning quality and lack of RUQ focus is atypical." },
                        { name: "Cholecystitis", correctCategory: "less-likely", rationale: "Would expect RUQ pain with Murphy's sign. Epigastric location is possible but less classic." },
                        { name: "Esophageal Spasm", correctCategory: "less-likely", rationale: "Can cause chest/epigastric pain but usually associated with dysphagia." },
                        { name: "Gastroparesis", correctCategory: "less-likely", rationale: "Usually in diabetics. Presents with nausea/vomiting and early satiety more than pain." },
                        { name: "Functional Dyspepsia", correctCategory: "less-likely", rationale: "Diagnosis of exclusion. Dark stools suggest organic pathology that needs investigation." }
                    ],
                    
                    // OLDCARTS narrative (given upfront)
                    oldcartsNarrative: `"The pain started about 3 days ago. It's right here in my upper stomach area, kind of burning. I'd say it's about a 6 out of 10. It gets worse after I eat, especially spicy foods, and when I lie down at night. Tums help a little but it keeps coming back. I've also noticed my stools have been darker than usual - almost black. I take ibuprofen every day for my back pain - have for years. I drink a couple beers most nights and probably too much coffee. I smoke about half a pack a day. My doctor told me I have high blood pressure but I ran out of my medication a few weeks ago."`,
                    
                    // Additional history questions (beyond OLDCARTS)
                    historyQuestions: [
                        // Essential - directly impacts differential
                        { id: "melena_details", text: "Can you describe the dark stools more? Are they tarry or sticky?", 
                          answer: "Yeah, they're really dark, almost like tar, and kind of sticky. Started maybe 2 days ago.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis"], 
                          reasoning: "Confirms melena - indicates upper GI bleeding, strongly supports PUD/gastritis with NSAID use" },
                        
                        { id: "chest_pain", text: "Any chest pain, pressure, or discomfort?",
                          answer: "No, it's really just in my stomach area. No chest pressure.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome"],
                          reasoning: "Helps rule out ACS as cause of epigastric pain" },
                        
                        { id: "exertional_symptoms", text: "Does the pain come on with exertion or walking?",
                          answer: "No, it's not related to activity at all. Mostly after eating.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome"],
                          reasoning: "Lack of exertional component argues against cardiac etiology" },
                        
                        { id: "radiation", text: "Does the pain go anywhere else - to your back, jaw, arm?",
                          answer: "No, it stays right here in my stomach.",
                          tier: "essential", linkedDx: ["Aortic Dissection", "Acute Pancreatitis", "Acute Coronary Syndrome"],
                          reasoning: "No radiation to back argues against dissection and pancreatitis; no arm/jaw radiation against ACS" },
                        
                        { id: "nsaid_details", text: "How much ibuprofen do you take and how often?",
                          answer: "Usually 600mg, three or four times a day. Been doing that for probably 5 years for my back.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis", "Perforated Ulcer"],
                          reasoning: "High-dose chronic NSAID use dramatically increases risk of peptic ulcer disease and complications" },
                        
                        { id: "sudden_onset", text: "Did the pain come on suddenly or gradually?",
                          answer: "It kind of built up over a few days. Wasn't sudden.",
                          tier: "essential", linkedDx: ["Perforated Ulcer", "Aortic Dissection"],
                          reasoning: "Gradual onset argues against perforation (usually sudden, severe) and dissection" },
                        
                        { id: "prior_ulcer", text: "Have you ever had an ulcer or GI bleeding before?",
                          answer: "Not that I know of. Never had a scope or anything.",
                          tier: "helpful", linkedDx: ["Peptic Ulcer Disease"],
                          reasoning: "Prior history would increase suspicion, but absence doesn't rule out first episode" },
                        
                        { id: "vomiting_blood", text: "Have you vomited any blood or material that looks like coffee grounds?",
                          answer: "No vomiting at all, actually.",
                          tier: "helpful", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "No hematemesis, but melena still indicates upper GI bleed" },
                        
                        { id: "lightheaded", text: "Have you felt lightheaded, dizzy, or like you might pass out?",
                          answer: "Maybe a little when I stand up fast, but nothing too bad.",
                          tier: "helpful", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "Orthostatic symptoms suggest significant blood loss - important for determining urgency" },
                        
                        { id: "weight_loss", text: "Have you had any unintentional weight loss?",
                          answer: "No, weight's been stable.",
                          tier: "helpful", linkedDx: ["Gastric Cancer"],
                          reasoning: "Weight loss would raise concern for malignancy" },
                        
                        { id: "dysphagia", text: "Any trouble swallowing?",
                          answer: "No, swallowing is fine.",
                          tier: "helpful", linkedDx: ["Esophageal Spasm", "Gastric Cancer"],
                          reasoning: "Dysphagia would suggest esophageal pathology or mass effect" },
                        
                        { id: "family_history", text: "Any family history of stomach problems, ulcers, or stomach cancer?",
                          answer: "My dad had an ulcer years ago but I don't think anyone had cancer.",
                          tier: "neutral", linkedDx: ["Peptic Ulcer Disease"],
                          reasoning: "Family history is less directly relevant than modifiable risk factors in this case" },
                        
                        { id: "stress", text: "Have you been under a lot of stress lately?",
                          answer: "Work's been stressful but nothing crazy.",
                          tier: "neutral", linkedDx: ["Functional Dyspepsia"],
                          reasoning: "Stress can contribute but dark stools point to organic pathology" },
                        
                        { id: "recent_travel", text: "Any recent travel?",
                          answer: "No, haven't been anywhere.",
                          tier: "low-yield", linkedDx: [],
                          reasoning: "Not relevant to this presentation" },
                        
                        { id: "sick_contacts", text: "Anyone around you been sick?",
                          answer: "No.",
                          tier: "low-yield", linkedDx: [],
                          reasoning: "Not relevant to this non-infectious presentation" }
                    ],
                    
                    // Physical exam options (comprehensive)
                    physicalExam: [
                        // Vital signs review
                        { id: "vitals_review", text: "Review vital signs in detail", category: "Vitals",
                          finding: "BP 145/88 (no orthostatic drop checked yet), HR 78 regular, RR 16, Temp 98.6Â°F, SpO2 98% RA",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Vital signs are fundamental to any assessment" },
                        
                        { id: "orthostatics", text: "Check orthostatic vital signs", category: "Vitals",
                          finding: "Lying: BP 145/88, HR 78. Standing: BP 128/76, HR 96. Patient feels slightly dizzy on standing.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "Orthostatic changes suggest significant volume loss from GI bleeding - important for management urgency" },
                        
                        // General
                        { id: "general", text: "General appearance assessment", category: "General",
                          finding: "Alert, oriented, appears mildly uncomfortable. Slightly pale. No acute distress.",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "General appearance provides important context for acuity" },
                        
                        // Cardiovascular
                        { id: "cardiac_auscultation", text: "Auscultate heart sounds", category: "Cardiovascular",
                          finding: "Regular rate and rhythm, no murmurs, rubs, or gallops.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome"],
                          reasoning: "Cardiac exam important given age and risk factors" },
                        
                        { id: "peripheral_pulses", text: "Check peripheral pulses", category: "Cardiovascular",
                          finding: "2+ radial, DP, and PT pulses bilaterally. No pulse deficits.",
                          tier: "helpful", linkedDx: ["Aortic Dissection"],
                          reasoning: "Pulse deficits could suggest dissection" },
                        
                        { id: "bp_both_arms", text: "Check blood pressure in both arms", category: "Cardiovascular",
                          finding: "Right arm: 145/88, Left arm: 142/86. No significant difference.",
                          tier: "helpful", linkedDx: ["Aortic Dissection"],
                          reasoning: "BP differential >20 mmHg can indicate dissection" },
                        
                        { id: "jvd", text: "Assess jugular venous distension", category: "Cardiovascular",
                          finding: "No JVD, estimated CVP normal.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Less relevant to primary GI presentation" },
                        
                        // Abdominal
                        { id: "abd_inspection", text: "Inspect abdomen", category: "Abdominal",
                          finding: "Soft, non-distended, no visible masses or pulsations. No surgical scars.",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Abdominal inspection is part of complete exam" },
                        
                        { id: "abd_auscultation", text: "Auscultate bowel sounds", category: "Abdominal",
                          finding: "Normoactive bowel sounds in all four quadrants.",
                          tier: "helpful", linkedDx: ["Perforated Ulcer"],
                          reasoning: "Absent bowel sounds could suggest perforation/peritonitis" },
                        
                        { id: "abd_palpation_light", text: "Light palpation of abdomen", category: "Abdominal",
                          finding: "Mild tenderness in epigastric region. No guarding or rigidity. No masses.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis", "Perforated Ulcer"],
                          reasoning: "Epigastric tenderness supports upper GI pathology; absence of guarding argues against perforation" },
                        
                        { id: "abd_palpation_deep", text: "Deep palpation of abdomen", category: "Abdominal",
                          finding: "Epigastric tenderness to deep palpation. No rebound. No hepatomegaly or splenomegaly.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "Confirms localized tenderness without peritoneal signs" },
                        
                        { id: "murphy_sign", text: "Murphy's sign", category: "Abdominal",
                          finding: "Negative - no increased pain or inspiratory arrest with RUQ palpation.",
                          tier: "helpful", linkedDx: ["Cholecystitis"],
                          reasoning: "Helps rule out cholecystitis" },
                        
                        { id: "aorta_palpation", text: "Palpate for aortic pulsation", category: "Abdominal",
                          finding: "No pulsatile mass. Cannot appreciate widened aorta.",
                          tier: "helpful", linkedDx: ["Aortic Dissection"],
                          reasoning: "Palpable pulsatile mass would suggest AAA/dissection" },
                        
                        { id: "rebound_guarding", text: "Check for rebound tenderness and guarding", category: "Abdominal",
                          finding: "No rebound tenderness. No involuntary guarding. No rigidity.",
                          tier: "essential", linkedDx: ["Perforated Ulcer"],
                          reasoning: "Absence of peritoneal signs argues strongly against perforation" },
                        
                        // Rectal
                        { id: "rectal_exam", text: "Digital rectal exam with guaiac", category: "Rectal",
                          finding: "No masses. Stool is black and tarry. Guaiac POSITIVE.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "CRITICAL FINDING - confirms GI bleeding (melena), establishes diagnosis of upper GI bleed" },
                        
                        // Other
                        { id: "skin_exam", text: "Examine skin for pallor, petechiae", category: "Skin",
                          finding: "Mildly pale. Conjunctivae slightly pale. No petechiae, no jaundice.",
                          tier: "helpful", linkedDx: ["Peptic Ulcer Disease"],
                          reasoning: "Pallor suggests anemia from blood loss" },
                        
                        { id: "lung_exam", text: "Auscultate lungs", category: "Pulmonary",
                          finding: "Clear to auscultation bilaterally. No wheezes, rales, or rhonchi.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Baseline assessment, less directly relevant" },
                        
                        { id: "neuro_exam", text: "Brief neurological exam", category: "Neurological",
                          finding: "Alert, oriented x3. No focal deficits. Cranial nerves intact.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Baseline assessment" },
                        
                        { id: "extremities", text: "Examine extremities", category: "Extremities",
                          finding: "No edema, no cyanosis, no clubbing.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Baseline assessment" }
                    ],
                    
                    // Workup options
                    workupOptions: {
                        labs: [
                            { id: "cbc", name: "CBC", 
                              result: "WBC 9.2, Hgb 9.8 (LOW), Hct 29.4%, Plt 245",
                              tier: "essential", reasoning: "Hemoglobin confirms significant blood loss - patient is anemic" },
                            { id: "bmp", name: "BMP (Basic Metabolic Panel)",
                              result: "Na 140, K 4.1, Cl 102, CO2 24, BUN 42 (HIGH), Cr 1.1, Glucose 118",
                              tier: "essential", reasoning: "Elevated BUN with normal Cr (BUN:Cr >20:1) suggests upper GI bleed" },
                            { id: "lipase", name: "Lipase",
                              result: "45 U/L (normal)",
                              tier: "helpful", reasoning: "Rules out pancreatitis" },
                            { id: "lfts", name: "Liver Function Tests",
                              result: "AST 28, ALT 32, Alk Phos 78, T.Bili 0.8 - all normal",
                              tier: "helpful", reasoning: "Normal LFTs reduce concern for hepatobiliary pathology" },
                            { id: "troponin", name: "Troponin",
                              result: "< 0.01 ng/mL (normal)",
                              tier: "essential", reasoning: "Rules out myocardial infarction - important given age and risk factors" },
                            { id: "ekg", name: "ECG/EKG",
                              result: "Normal sinus rhythm, rate 78. No ST changes, no Q waves. Normal intervals.",
                              tier: "essential", reasoning: "Rules out acute ischemic changes" },
                            { id: "type_screen", name: "Type and Screen",
                              result: "Type O positive. Antibody screen negative.",
                              tier: "essential", reasoning: "Essential preparation in case transfusion is needed" },
                            { id: "coags", name: "PT/INR, PTT",
                              result: "PT 12.1, INR 1.0, PTT 28 - all normal",
                              tier: "helpful", reasoning: "Normal coagulation - not on anticoagulants, no coagulopathy" },
                            { id: "lactate", name: "Lactate",
                              result: "1.8 mmol/L (normal)",
                              tier: "helpful", reasoning: "Normal lactate suggests adequate tissue perfusion despite bleeding" }
                        ],
                        imaging: [
                            { id: "cxr", name: "Chest X-ray",
                              result: "No acute cardiopulmonary process. No free air under diaphragm.",
                              tier: "helpful", reasoning: "Rules out perforation (no free air) and provides cardiac silhouette" },
                            { id: "upright_abd", name: "Upright Abdominal X-ray",
                              result: "No free air. Non-specific bowel gas pattern.",
                              tier: "helpful", reasoning: "Can detect free air from perforation" },
                            { id: "ct_abd", name: "CT Abdomen/Pelvis with contrast",
                              result: "Not immediately indicated",
                              tier: "less-helpful", reasoning: "EGD is preferred for diagnosis and potential treatment of upper GI bleed" },
                            { id: "ruq_us", name: "RUQ Ultrasound",
                              result: "Gallbladder normal, no stones, no wall thickening. CBD not dilated.",
                              tier: "neutral", reasoning: "Low suspicion for biliary pathology, but reasonable if considering" }
                        ],
                        procedures: [
                            { id: "ngt", name: "Nasogastric tube placement and lavage",
                              result: "Aspirate is dark ('coffee ground') material. Does not clear with lavage.",
                              tier: "helpful", reasoning: "Confirms upper GI source, helps risk-stratify. Coffee grounds = older blood in stomach." },
                            { id: "iv_access", name: "Establish large-bore IV access (2 large-bore IVs)",
                              result: "Two 18-gauge IVs placed successfully.",
                              tier: "essential", reasoning: "Essential for resuscitation in GI bleeding" },
                            { id: "foley", name: "Foley catheter",
                              result: "Placed. Initial output 200 mL clear yellow urine.",
                              tier: "helpful", reasoning: "Monitors urine output during resuscitation" }
                        ],
                        treatments: [
                            { id: "ivf", name: "IV fluid resuscitation (crystalloid)",
                              result: "1L NS bolus initiated.",
                              tier: "essential", reasoning: "Volume resuscitation is critical in GI bleeding with orthostatic changes" },
                            { id: "ppi_iv", name: "IV Proton Pump Inhibitor (e.g., pantoprazole)",
                              result: "Pantoprazole 80mg IV bolus given, drip initiated.",
                              tier: "essential", reasoning: "High-dose IV PPI reduces rebleeding risk in peptic ulcer disease" },
                            { id: "hold_nsaids", name: "Discontinue NSAIDs",
                              result: "Patient counseled. Ibuprofen stopped.",
                              tier: "essential", reasoning: "Removing the offending agent is critical" },
                            { id: "transfuse", name: "Transfuse PRBCs",
                              result: "Transfusion threshold not yet met (Hgb 9.8), but Type & Screen ready.",
                              tier: "helpful", reasoning: "Not immediately needed with Hgb 9.8, but prepared" },
                            { id: "antiemetic", name: "Antiemetic (ondansetron)",
                              result: "Given for comfort.",
                              tier: "neutral", reasoning: "Symptomatic treatment, not addressing primary issue" },
                            { id: "pain_med", name: "Pain medication",
                              result: "Consider carefully - avoid NSAIDs. Small dose IV acetaminophen given.",
                              tier: "neutral", reasoning: "Symptomatic, but avoid NSAIDs" }
                        ],
                        consults: [
                            { id: "gi_consult", name: "GI Consult for EGD",
                              result: "GI consulted. Plan for EGD within 24 hours given hemodynamic stability.",
                              tier: "essential", reasoning: "EGD is diagnostic AND therapeutic for upper GI bleed" },
                            { id: "surgery_consult", name: "Surgery Consult",
                              result: "Not immediately indicated.",
                              tier: "less-helpful", reasoning: "Surgery is rarely needed for PUD; EGD can treat most bleeding ulcers" },
                            { id: "cards_consult", name: "Cardiology Consult",
                              result: "Not indicated - troponin and ECG normal.",
                              tier: "less-helpful", reasoning: "No evidence of cardiac pathology" }
                        ],
                        disposition: [
                            { id: "admit_icu", name: "Admit to ICU",
                              result: "Consider based on stability.",
                              tier: "neutral", reasoning: "Patient is hemodynamically stable with only mild orthostatics - floor admission reasonable" },
                            { id: "admit_floor", name: "Admit to Medicine floor with telemetry",
                              result: "Appropriate level of care.",
                              tier: "essential", reasoning: "Appropriate for stable GI bleed requiring monitoring and EGD" },
                            { id: "admit_obs", name: "Observation unit",
                              result: "Not appropriate.",
                              tier: "less-helpful", reasoning: "Active GI bleeding with anemia requires full admission" },
                            { id: "discharge", name: "Discharge home",
                              result: "Not appropriate.",
                              tier: "inappropriate", reasoning: "Cannot discharge active GI bleed with anemia" }
                        ]
                    },
                    
                    // Actual diagnosis and key teaching
                    actualDiagnosis: {
                        name: "NSAID-induced Peptic Ulcer Disease with Upper GI Bleeding",
                        keyFindings: [
                            "Chronic high-dose NSAID use (major risk factor)",
                            "Melena (black, tarry stools) confirmed on exam",
                            "Guaiac positive stool",
                            "Anemia (Hgb 9.8)",
                            "Elevated BUN:Cr ratio (classic for upper GI bleed)",
                            "Orthostatic vital signs",
                            "Normal cardiac workup rules out ACS"
                        ],
                        teachingPoints: [
                            "NSAIDs inhibit prostaglandins that protect gastric mucosa - chronic use significantly increases ulcer and bleeding risk",
                            "Melena indicates upper GI source (blood oxidized during transit); >100mL blood needed to produce melena",
                            "BUN:Cr ratio >20:1 suggests upper GI bleed (blood protein is digested and absorbed)",
                            "Always check orthostatic vitals in suspected GI bleed - more sensitive than resting vitals for significant blood loss",
                            "In a 58-year-old male with HTN and smoking, MUST rule out cardiac causes of epigastric pain despite GI symptoms",
                            "EGD is both diagnostic and therapeutic - can identify and treat bleeding ulcers"
                        ]
                    }
                }
            }
        },
        
        // ==================== GI BLEED (BRBPR) ====================
        {
            id: "gi-bleed",
            title: "GI Bleed",
            category: "GI",
            icon: "ðŸ©¸",
            
            variants: {
                "adult-46-hemorrhoids": {
                    name: "A. Price",
                    age: 46,
                    gender: "neutral",
                    chiefComplaint: "Blood on toilet paper",
                    vitalSigns: {
                        BP: "118/75",
                        HR: 72,
                        RR: 16,
                        Temp: "97.5Â°F",
                        SpO2: "99%"
                    },
                    
                    allDiagnoses: [
                        { name: "Hemorrhoids", correctCategory: "likely", rationale: "Bright red blood on toilet paper after straining with constipation is classic. Very common cause of BRBPR." },
                        { name: "Anal Fissure", correctCategory: "likely", rationale: "Constipation with straining can cause mucosal tears. Usually painful with defecation." },
                        { name: "Diverticular Bleeding", correctCategory: "likely", rationale: "Age 46 with constipation. Diverticulosis can cause painless BRBPR." },
                        
                        { name: "Colorectal Cancer", correctCategory: "must-not-miss", rationale: "CRITICAL: Any rectal bleeding needs cancer consideration. Family history is key risk factor." },
                        { name: "Inflammatory Bowel Disease", correctCategory: "must-not-miss", rationale: "UC and Crohn's can present with rectal bleeding. Look for diarrhea, abdominal pain." },
                        { name: "Ischemic Colitis", correctCategory: "must-not-miss", rationale: "Can present with bloody diarrhea, especially in patients with vascular risk factors." },
                        
                        { name: "Rectal Polyp", correctCategory: "less-likely", rationale: "Can cause intermittent bleeding. Would need colonoscopy to evaluate." },
                        { name: "Angiodysplasia", correctCategory: "less-likely", rationale: "More common in elderly. Can cause painless bleeding." },
                        { name: "Infectious Colitis", correctCategory: "less-likely", rationale: "Usually has diarrhea, fever, sick contacts." },
                        { name: "Solitary Rectal Ulcer", correctCategory: "less-likely", rationale: "Associated with straining and rectal prolapse." },
                        { name: "Proctitis", correctCategory: "less-likely", rationale: "Could be infectious, radiation, or IBD-related." }
                    ],
                    
                    oldcartsNarrative: `"I noticed blood on the toilet paper yesterday after I had a bowel movement. It was bright red, and there was some blood coating the outside of the stool too - the water in the toilet was light pink. It doesn't hurt when I go, but I've been straining a lot because I've been constipated for about 3 months now. I used to go every day, but now it's maybe every 3-4 days. My job changed about 4 months ago - I'm a flight attendant now so I'm traveling a lot and eating airport food, not drinking enough water. I haven't noticed this before. Oh, and my father had colon cancer when he was 50."`,
                    
                    historyQuestions: [
                        { id: "family_cancer_details", text: "Tell me more about your father's colon cancer - how old was he? Is he still alive?",
                          answer: "He was 50 when they found it. He had surgery and chemo. He's still alive, thank God, but it was a close call.",
                          tier: "essential", linkedDx: ["Colorectal Cancer"],
                          reasoning: "First-degree relative with CRC before age 60 significantly increases risk. Patient should have started screening at 40 (10 years before father's diagnosis)." },
                        
                        { id: "colonoscopy_history", text: "Have you ever had a colonoscopy?",
                          answer: "No, never. I know I probably should have with my dad's history but I kept putting it off.",
                          tier: "essential", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Critical - patient with family history has never been screened. This is a major gap." },
                        
                        { id: "blood_mixed", text: "Is the blood mixed into the stool or just on the outside/paper?",
                          answer: "Just on the outside and on the paper. The stool itself looks brown.",
                          tier: "essential", linkedDx: ["Hemorrhoids", "Anal Fissure", "Colorectal Cancer"],
                          reasoning: "Blood on surface suggests distal source (anorectal). Blood mixed throughout raises concern for more proximal pathology." },
                        
                        { id: "pain_with_bm", text: "Any pain when you have a bowel movement?",
                          answer: "No pain really, just uncomfortable straining.",
                          tier: "helpful", linkedDx: ["Anal Fissure"],
                          reasoning: "Fissures typically cause significant pain with defecation. Painless bleeding more consistent with hemorrhoids." },
                        
                        { id: "weight_loss", text: "Have you had any unintentional weight loss?",
                          answer: "No, weight has been stable.",
                          tier: "essential", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Weight loss would be a red flag for malignancy" },
                        
                        { id: "appetite_changes", text: "Any changes in appetite?",
                          answer: "No, eating normally.",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Decreased appetite could suggest malignancy" },
                        
                        { id: "abdominal_pain", text: "Any abdominal pain or cramping?",
                          answer: "No, no belly pain.",
                          tier: "helpful", linkedDx: ["Inflammatory Bowel Disease", "Ischemic Colitis"],
                          reasoning: "IBD and ischemic colitis typically have abdominal pain" },
                        
                        { id: "diarrhea", text: "Any diarrhea or loose stools?",
                          answer: "No, opposite problem - I'm constipated.",
                          tier: "helpful", linkedDx: ["Inflammatory Bowel Disease", "Infectious Colitis"],
                          reasoning: "IBD usually presents with diarrhea. Constipation pattern here." },
                        
                        { id: "fatigue", text: "Have you been feeling tired or weak?",
                          answer: "Maybe a little more tired with the travel, but nothing major.",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Fatigue from anemia could indicate chronic blood loss" },
                        
                        { id: "other_family", text: "Any other family members with colon problems or cancer?",
                          answer: "Not that I know of, just my dad.",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Additional family history would further increase risk" },
                        
                        { id: "dietary_fiber", text: "How's your fiber intake? Fruits, vegetables, whole grains?",
                          answer: "Honestly pretty bad. Lots of packaged snacks and fast food with travel.",
                          tier: "neutral", linkedDx: ["Hemorrhoids"],
                          reasoning: "Low fiber contributes to constipation and hemorrhoids" },
                        
                        { id: "hydration", text: "How much water do you drink?",
                          answer: "Probably not enough. Maybe 2-3 cups a day.",
                          tier: "neutral", linkedDx: ["Hemorrhoids"],
                          reasoning: "Dehydration contributes to constipation" }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_review", text: "Review vital signs", category: "Vitals",
                          finding: "BP 118/75, HR 72, RR 16, Temp 97.5Â°F, SpO2 99% - all stable",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Stable vitals indicate no significant acute blood loss" },
                        
                        { id: "general", text: "General appearance", category: "General",
                          finding: "Well-appearing, no acute distress, no pallor",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "No signs of significant blood loss or systemic illness" },
                        
                        { id: "abd_palpation", text: "Abdominal palpation", category: "Abdominal",
                          finding: "Soft, non-tender, non-distended. No masses. No hepatomegaly.",
                          tier: "essential", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Looking for masses, organomegaly" },
                        
                        { id: "rectal_external", text: "External perianal inspection", category: "Rectal",
                          finding: "No external hemorrhoids visible. No fissures. No skin tags. No masses.",
                          tier: "essential", linkedDx: ["Hemorrhoids", "Anal Fissure"],
                          reasoning: "Looking for external hemorrhoids, fissures" },
                        
                        { id: "digital_rectal", text: "Digital rectal examination", category: "Rectal",
                          finding: "Internal hemorrhoids palpated. No masses within reach of finger. Stool in vault is brown with streaks of bright red blood. Guaiac positive.",
                          tier: "essential", linkedDx: ["Hemorrhoids", "Colorectal Cancer"],
                          reasoning: "CRITICAL - confirms internal hemorrhoids but DRE has limited reach. Cancer cannot be ruled out without colonoscopy." },
                        
                        { id: "anoscopy", text: "Anoscopy (if available)", category: "Rectal",
                          finding: "Grade II internal hemorrhoids at 3 and 7 o'clock positions with evidence of recent bleeding.",
                          tier: "helpful", linkedDx: ["Hemorrhoids"],
                          reasoning: "Directly visualizes hemorrhoids" },
                        
                        { id: "skin_pallor", text: "Assess for pallor", category: "Skin",
                          finding: "No pallor of skin or conjunctivae",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Pallor would suggest anemia from chronic blood loss" },
                        
                        { id: "lymph_nodes", text: "Lymph node examination", category: "Lymph",
                          finding: "No cervical, supraclavicular, axillary, or inguinal lymphadenopathy",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Lymphadenopathy could suggest metastatic disease" },
                        
                        { id: "abd_auscultation", text: "Auscultate bowel sounds", category: "Abdominal",
                          finding: "Normal bowel sounds",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Baseline assessment" },
                        
                        { id: "liver_stigmata", text: "Check for stigmata of liver disease", category: "General",
                          finding: "No spider angiomata, no palmar erythema, no jaundice, no ascites",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Rule out varices from portal hypertension" }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "cbc", name: "CBC",
                              result: "WBC 7.5, Hgb 14.2 (normal), Hct 42%, Plt 220",
                              tier: "helpful", reasoning: "Normal hemoglobin - no significant chronic blood loss" },
                            { id: "bmp", name: "BMP",
                              result: "All values normal",
                              tier: "neutral", reasoning: "Baseline, but not specifically indicated" },
                            { id: "iron_studies", name: "Iron studies",
                              result: "Ferritin 85, Iron 90, TIBC 320 - all normal",
                              tier: "neutral", reasoning: "Can detect iron deficiency from chronic blood loss, but Hgb normal" }
                        ],
                        imaging: [
                            { id: "colonoscopy", name: "Colonoscopy",
                              result: "URGENT - to be scheduled",
                              tier: "essential", reasoning: "CRITICAL - Must be done to rule out colorectal cancer given family history and symptoms. Cannot assume hemorrhoids without full evaluation." },
                            { id: "ct_colonography", name: "CT Colonography",
                              result: "Alternative if colonoscopy not tolerated",
                              tier: "neutral", reasoning: "Less preferred - cannot biopsy if lesion found" },
                            { id: "flex_sig", name: "Flexible sigmoidoscopy",
                              result: "Would only evaluate distal colon",
                              tier: "less-helpful", reasoning: "Incomplete evaluation - right-sided cancers would be missed" }
                        ],
                        procedures: [
                            { id: "anoscopy_proc", name: "Anoscopy in clinic",
                              result: "Confirms internal hemorrhoids",
                              tier: "helpful", reasoning: "Can visualize hemorrhoids but doesn't evaluate for proximal pathology" }
                        ],
                        treatments: [
                            { id: "fiber_supplement", name: "Fiber supplementation",
                              result: "Psyllium recommended",
                              tier: "helpful", reasoning: "Addresses constipation contributing to hemorrhoids" },
                            { id: "stool_softener", name: "Stool softener (docusate)",
                              result: "Given for symptom relief",
                              tier: "helpful", reasoning: "Reduces straining" },
                            { id: "topical_tx", name: "Topical hemorrhoid treatment",
                              result: "OTC preparation H or similar",
                              tier: "helpful", reasoning: "Symptomatic relief while awaiting colonoscopy" },
                            { id: "hydration_counseling", name: "Hydration and dietary counseling",
                              result: "Counseled on increasing water and fiber",
                              tier: "helpful", reasoning: "Addresses underlying cause" }
                        ],
                        consults: [
                            { id: "gi_colonoscopy", name: "GI referral for colonoscopy",
                              result: "URGENT referral placed given family history",
                              tier: "essential", reasoning: "Colonoscopy is mandatory given family history of CRC" },
                            { id: "colorectal_surgery", name: "Colorectal surgery referral",
                              result: "Not indicated until colonoscopy complete",
                              tier: "less-helpful", reasoning: "Premature without tissue diagnosis" }
                        ],
                        disposition: [
                            { id: "outpatient", name: "Outpatient follow-up with urgent colonoscopy",
                              result: "Appropriate disposition",
                              tier: "essential", reasoning: "Stable patient with urgent outpatient colonoscopy need" },
                            { id: "admit", name: "Admit for inpatient colonoscopy",
                              result: "Not necessary - patient is stable",
                              tier: "less-helpful", reasoning: "No hemodynamic instability to warrant admission" }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Internal Hemorrhoids (Colonoscopy REQUIRED to Rule Out Colorectal Cancer)",
                        keyFindings: [
                            "Bright red blood on toilet paper and coating stool - suggests distal source",
                            "Internal hemorrhoids palpated on DRE",
                            "3-month history of constipation with straining",
                            "CRITICAL: Father had colon cancer at age 50",
                            "Patient never had colonoscopy despite family history",
                            "Normal hemoglobin, stable vitals - no acute blood loss"
                        ],
                        teachingPoints: [
                            "NEVER assume 'just hemorrhoids' without considering colorectal cancer, especially with family history",
                            "First-degree relative with CRC before age 60 = start screening 10 years before their diagnosis age, or age 40, whichever is earlier",
                            "This patient should have had first colonoscopy at age 40 (10 years before father's diagnosis at 50)",
                            "Hemorrhoids can coexist with colorectal cancer - finding hemorrhoids does NOT rule out cancer",
                            "BRBPR (bright red blood per rectum) usually indicates distal source but doesn't guarantee benign etiology",
                            "Every patient with rectal bleeding and family history of CRC needs colonoscopy regardless of suspected hemorrhoids"
                        ]
                    }
                }
            }
        }
    ];
    
    // ============================================================
    // RENDER FUNCTIONS
    // ============================================================
    
    function render() {
        const app = document.getElementById('app');
        
        switch(state.screen) {
            case 'menu':
                app.innerHTML = renderMenu();
                break;
            case 'case-select':
                app.innerHTML = renderCaseSelect();
                break;
            case 'differential':
                app.innerHTML = renderDifferentialStage();
                break;
            case 'history':
                app.innerHTML = renderHistoryStage();
                break;
            case 'physical':
                app.innerHTML = renderPhysicalStage();
                break;
            case 'revised-differential':
                app.innerHTML = renderRevisedDifferentialStage();
                break;
            case 'workup':
                app.innerHTML = renderWorkupStage();
                break;
            case 'summary':
                app.innerHTML = renderSummary();
                break;
            default:
                app.innerHTML = renderMenu();
        }
    }
    
    function renderMenu() {
        return `
            <div class="text-center py-8 fade-in">
                <h1 class="text-4xl font-bold text-white mb-2">ðŸ©º Clinical Reasoning Trainer</h1>
                <p class="text-blue-200 mb-8">Master hypothesis-driven clinical thinking</p>
                
                <div class="card p-8 max-w-lg mx-auto">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Select Mode</h2>
                    
                    <div class="space-y-4">
                        <button onclick="selectMode('practice')" 
                                class="w-full p-6 rounded-xl border-2 border-blue-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-left">
                            <div class="flex items-center gap-4">
                                <span class="text-4xl">ðŸ“š</span>
                                <div>
                                    <div class="font-bold text-lg text-gray-800">Practice Mode</div>
                                    <div class="text-gray-600 text-sm">Learn with detailed feedback at each step. No pressure, maximum learning.</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="selectMode('quiz')"
                                class="w-full p-6 rounded-xl border-2 border-purple-200 hover:border-purple-500 hover:bg-purple-50 transition-all text-left">
                            <div class="flex items-center gap-4">
                                <span class="text-4xl">ðŸŽ¯</span>
                                <div>
                                    <div class="font-bold text-lg text-gray-800">Quiz Mode</div>
                                    <div class="text-gray-600 text-sm">Test yourself with scoring. Feedback after each section plus final score.</div>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">How It Works</h3>
                        <ol class="text-sm text-gray-600 space-y-1">
                            <li>1ï¸âƒ£ Create initial differential diagnosis (categorize as "Most Likely" vs "Must Not Miss")</li>
                            <li>2ï¸âƒ£ Review OLDCARTS, then select targeted history questions</li>
                            <li>3ï¸âƒ£ Choose focused physical exam maneuvers</li>
                            <li>4ï¸âƒ£ Revise your differential based on findings</li>
                            <li>5ï¸âƒ£ Select workup and next steps</li>
                            <li>6ï¸âƒ£ Review final diagnosis and teaching points</li>
                        </ol>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderCaseSelect() {
        return `
            <div class="fade-in">
                <button onclick="goBack()" class="text-blue-200 hover:text-white mb-4 flex items-center gap-2">
                    â† Back to Menu
                </button>
                
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">
                        ${state.mode === 'quiz' ? 'ðŸŽ¯ Quiz Mode' : 'ðŸ“š Practice Mode'}
                    </h2>
                    <p class="text-gray-600 text-center mb-6">Select a case to begin</p>
                    
                    <div class="grid gap-4 md:grid-cols-2">
                        ${cases.map(c => `
                            <button onclick="selectCase('${c.id}')"
                                    class="p-4 rounded-xl border-2 ${state.caseType === c.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'} transition-all text-left">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">${c.icon}</span>
                                    <div>
                                        <div class="font-bold text-gray-800">${c.title}</div>
                                        <div class="text-sm text-gray-500">${Object.keys(c.variants).length} variant${Object.keys(c.variants).length > 1 ? 's' : ''}</div>
                                    </div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    ${state.caseType ? renderVariantSelection() : ''}
                </div>
            </div>
        `;
    }
    
    function renderVariantSelection() {
        const caseData = cases.find(c => c.id === state.caseType);
        if (!caseData) return '';
        
        return `
            <div class="mt-6 pt-6 border-t">
                <h3 class="font-bold text-gray-800 mb-4">Select Patient</h3>
                <div class="space-y-3">
                    ${Object.entries(caseData.variants).map(([key, variant]) => `
                        <button onclick="selectVariant('${key}')"
                                class="w-full p-4 rounded-lg border-2 ${state.variantKey === key ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'} transition-all text-left">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold text-gray-800">${variant.name}, ${variant.age}-year-old ${variant.gender === 'male' ? 'Male' : variant.gender === 'female' ? 'Female' : 'Adult'}</div>
                                    <div class="text-sm text-gray-600 italic">"${variant.chiefComplaint}"</div>
                                </div>
                                ${state.variantKey === key ? '<span class="text-blue-500 text-xl">âœ“</span>' : ''}
                            </div>
                        </button>
                    `).join('')}
                </div>
                
                <button onclick="startCase()"
                        class="w-full mt-6 py-3 rounded-lg font-bold text-white ${state.variantKey ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                        ${state.variantKey ? '' : 'disabled'}>
                    Begin Case â†’
                </button>
            </div>
        `;
    }
    
    function renderDifferentialStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        const vs = variant.vitalSigns;
        
        const totalSelected = state.selectedLikely.length + state.selectedMustNotMiss.length;
        const availableDx = variant.allDiagnoses.filter(d => 
            !state.selectedLikely.includes(d.name) && !state.selectedMustNotMiss.includes(d.name)
        );
        
        return `
            <div class="fade-in">
                <button onclick="goBack()" class="text-blue-200 hover:text-white mb-4 flex items-center gap-2">
                    â† Back to Case Selection
                </button>
                
                <div class="card p-6 mb-4">
                    <!-- Case Header -->
                    <div class="flex items-center gap-4 mb-4">
                        <span class="text-4xl">${caseData.icon}</span>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">${variant.name}, ${variant.age}-year-old</h2>
                            <p class="text-gray-600">Chief Complaint: "${variant.chiefComplaint}"</p>
                        </div>
                    </div>
                    
                    <!-- Vital Signs -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-gray-700 mb-2">Vital Signs</h3>
                        <div class="grid grid-cols-5 gap-2 text-sm">
                            <div class="text-center"><span class="text-gray-500">BP</span><br><strong>${vs.BP}</strong></div>
                            <div class="text-center"><span class="text-gray-500">HR</span><br><strong>${vs.HR}</strong></div>
                            <div class="text-center"><span class="text-gray-500">RR</span><br><strong>${vs.RR}</strong></div>
                            <div class="text-center"><span class="text-gray-500">Temp</span><br><strong>${vs.Temp}</strong></div>
                            <div class="text-center"><span class="text-gray-500">SpO2</span><br><strong>${vs.SpO2}</strong></div>
                        </div>
                    </div>
                    
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 1 of 5</span>
                            <span>Initial Differential</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 20%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Build Your Differential Diagnosis</h3>
                    <p class="text-gray-600 text-sm mb-4">
                        Based on the chief complaint, vital signs, and patient demographics, categorize the diagnoses below. 
                        Click a diagnosis to assign it as "Most Likely" or "Must Not Miss."
                    </p>
                    
                    ${!state.differentialSubmitted ? `
                        <!-- Selection Counter -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                            <div class="text-center">
                                <span class="text-2xl font-bold text-blue-600">${totalSelected}</span>
                                <span class="text-gray-600"> diagnoses selected</span>
                            </div>
                            <p class="text-xs text-center text-gray-500 mt-1">Aim for 3-4 "Most Likely" and 2-3 "Must Not Miss"</p>
                        </div>
                        
                        <!-- Category Drop Zones -->
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <!-- Most Likely Zone -->
                            <div>
                                <h4 class="font-semibold text-green-700 mb-2 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                    Most Likely (${state.selectedLikely.length})
                                </h4>
                                <div class="category-zone likely min-h-[100px]">
                                    ${state.selectedLikely.length === 0 ? 
                                        '<p class="text-gray-400 text-sm text-center py-4">Click diagnoses below to add</p>' :
                                        state.selectedLikely.map(name => `
                                            <div class="dx-card selected-likely mb-2 flex justify-between items-center">
                                                <span>${name}</span>
                                                <button onclick="removeDx('${name}', 'likely')" class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                            
                            <!-- Must Not Miss Zone -->
                            <div>
                                <h4 class="font-semibold text-red-700 mb-2 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                    Must Not Miss (${state.selectedMustNotMiss.length})
                                </h4>
                                <div class="category-zone must-not-miss min-h-[100px]">
                                    ${state.selectedMustNotMiss.length === 0 ?
                                        '<p class="text-gray-400 text-sm text-center py-4">Click diagnoses below to add</p>' :
                                        state.selectedMustNotMiss.map(name => `
                                            <div class="dx-card selected-must-not-miss mb-2 flex justify-between items-center">
                                                <span>${name}</span>
                                                <button onclick="removeDx('${name}', 'must-not-miss')" class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Diagnoses -->
                        <h4 class="font-semibold text-gray-700 mb-2">Available Diagnoses (click to categorize)</h4>
                        <div class="grid gap-2 mb-6">
                            ${availableDx.map(dx => `
                                <div class="dx-card flex justify-between items-center">
                                    <span>${dx.name}</span>
                                    <div class="flex gap-2">
                                        <button onclick="addDx('${dx.name}', 'likely')" 
                                                class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                                            + Likely
                                        </button>
                                        <button onclick="addDx('${dx.name}', 'must-not-miss')"
                                                class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                            + Must Not Miss
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="submitDifferential()"
                                class="w-full py-3 rounded-lg font-bold text-white ${totalSelected >= 4 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${totalSelected >= 4 ? '' : 'disabled'}>
                            ${totalSelected < 4 ? `Select at least ${4 - totalSelected} more` : 'Submit Differential â†’'}
                        </button>
                    ` : renderDifferentialFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderDifferentialFeedback(variant) {
        // Calculate score
        let correctLikely = 0;
        let correctMustNotMiss = 0;
        let missedMustNotMiss = [];
        
        variant.allDiagnoses.forEach(dx => {
            if (dx.correctCategory === 'likely' && state.selectedLikely.includes(dx.name)) {
                correctLikely++;
            }
            if (dx.correctCategory === 'must-not-miss') {
                if (state.selectedMustNotMiss.includes(dx.name)) {
                    correctMustNotMiss++;
                } else if (!state.selectedLikely.includes(dx.name)) {
                    missedMustNotMiss.push(dx.name);
                }
            }
        });
        
        const totalMustNotMiss = variant.allDiagnoses.filter(d => d.correctCategory === 'must-not-miss').length;
        const allMustNotMissCaught = missedMustNotMiss.length === 0;
        
        return `
            <div class="slide-in">
                <!-- Score Display (Quiz Mode) -->
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${Math.round((correctLikely + correctMustNotMiss * 2) / (state.selectedLikely.length + state.selectedMustNotMiss.length * 2) * 100)}%</div>
                        <p class="text-gray-600 text-sm">Initial Differential Score</p>
                    </div>
                ` : ''}
                
                ${allMustNotMissCaught ? `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 text-green-700">
                            <span class="text-2xl">âœ…</span>
                            <span class="font-semibold">Excellent! You identified all "must not miss" diagnoses.</span>
                        </div>
                    </div>
                ` : `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 text-red-700 mb-2">
                            <span class="text-2xl">âš ï¸</span>
                            <span class="font-semibold">Missed some critical diagnoses!</span>
                        </div>
                        <p class="text-sm text-red-600">You missed: ${missedMustNotMiss.join(', ')}</p>
                    </div>
                `}
                
                <!-- Feedback for each selection -->
                <div class="space-y-4 mb-6">
                    <h4 class="font-semibold text-gray-700">Your Selections:</h4>
                    
                    <!-- Most Likely selections -->
                    ${state.selectedLikely.map(name => {
                        const dx = variant.allDiagnoses.find(d => d.name === name);
                        const isCorrect = dx?.correctCategory === 'likely';
                        const wasMustNotMiss = dx?.correctCategory === 'must-not-miss';
                        return `
                            <div class="p-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : wasMustNotMiss ? 'bg-yellow-50 border border-yellow-200' : 'bg-gray-50 border border-gray-200'}">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>${isCorrect ? 'âœ…' : wasMustNotMiss ? 'âš ï¸' : 'âž–'}</span>
                                    <span class="font-semibold">${name}</span>
                                    <span class="text-sm text-green-600">(You said: Most Likely)</span>
                                </div>
                                <p class="text-sm text-gray-600 ml-6">${dx?.rationale || ''}</p>
                                ${wasMustNotMiss ? '<p class="text-sm text-yellow-700 ml-6 mt-1"><strong>Note:</strong> This is actually a "Must Not Miss" diagnosis!</p>' : ''}
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- Must Not Miss selections -->
                    ${state.selectedMustNotMiss.map(name => {
                        const dx = variant.allDiagnoses.find(d => d.name === name);
                        const isCorrect = dx?.correctCategory === 'must-not-miss';
                        return `
                            <div class="p-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'}">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>${isCorrect ? 'âœ…' : 'âž–'}</span>
                                    <span class="font-semibold">${name}</span>
                                    <span class="text-sm text-red-600">(You said: Must Not Miss)</span>
                                </div>
                                <p class="text-sm text-gray-600 ml-6">${dx?.rationale || ''}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Thinking Prompt -->
                <div class="thinking-prompt mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ§ </span>
                        <h4 class="font-semibold text-purple-800">Before You Continue...</h4>
                    </div>
                    <p class="text-purple-700 text-sm">
                        Think about what history questions would help you distinguish between your top diagnoses. 
                        What specific information would make you more or less confident in each possibility?
                    </p>
                </div>
                
                <button onclick="advanceToHistory()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                    Continue to History Taking â†’
                </button>
            </div>
        `;
    }
    
    function renderHistoryStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        
        return `
            <div class="fade-in">
                <div class="card p-6 mb-4">
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 2 of 5</span>
                            <span>History Taking</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 40%"></div>
                        </div>
                    </div>
                    
                    <!-- OLDCARTS Narrative -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-800 mb-2">ðŸ“‹ Initial History (OLDCARTS)</h3>
                        <p class="text-sm text-gray-500 mb-3">After gathering the standard history using OLDCARTS or another approach, here's what you've learned:</p>
                        <div class="narrative-box">
                            ${variant.oldcartsNarrative}
                        </div>
                    </div>
                    
                    ${!state.historySubmitted ? `
                        <!-- Question Selection -->
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">ðŸŽ¯ Select Additional History Questions</h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Choose the questions that will most help you refine your differential. 
                                Focus on hypothesis-driven questions that rule in or rule out specific diagnoses.
                            </p>
                            
                            <!-- Selection Counter -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                <div class="text-center">
                                    <span class="text-2xl font-bold text-blue-600">${state.selectedHistory.length}</span>
                                    <span class="text-gray-600"> questions selected</span>
                                </div>
                                <p class="text-xs text-center text-gray-500 mt-1">A focused history typically includes 6-8 targeted questions beyond OLDCARTS</p>
                            </div>
                            
                            <!-- Questions -->
                            <div class="space-y-2 mb-6">
                                ${variant.historyQuestions.map(q => `
                                    <button onclick="toggleHistory('${q.id}')"
                                            class="selection-btn ${state.selectedHistory.includes(q.id) ? 'selected' : ''}">
                                        <div class="flex items-center justify-between">
                                            <span>${q.text}</span>
                                            ${state.selectedHistory.includes(q.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <button onclick="submitHistory()"
                                    class="w-full py-3 rounded-lg font-bold text-white ${state.selectedHistory.length >= 3 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                    ${state.selectedHistory.length >= 3 ? '' : 'disabled'}>
                                ${state.selectedHistory.length < 3 ? `Select at least ${3 - state.selectedHistory.length} more` : 'Submit History Questions â†’'}
                            </button>
                        </div>
                    ` : renderHistoryFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderHistoryFeedback(variant) {
        const selectedQuestions = variant.historyQuestions.filter(q => state.selectedHistory.includes(q.id));
        const essentialSelected = selectedQuestions.filter(q => q.tier === 'essential').length;
        const essentialTotal = variant.historyQuestions.filter(q => q.tier === 'essential').length;
        
        return `
            <div class="slide-in">
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${Math.round(essentialSelected / essentialTotal * 100)}%</div>
                        <p class="text-gray-600 text-sm">Essential Questions Asked</p>
                    </div>
                ` : ''}
                
                <h3 class="font-semibold text-gray-800 mb-4">Patient Responses & Feedback</h3>
                
                <div class="space-y-3 mb-6">
                    ${selectedQuestions.map(q => `
                        <div class="p-4 rounded-lg border ${q.tier === 'essential' ? 'border-green-300 bg-green-50' : q.tier === 'helpful' ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-gray-50'}">
                            <div class="flex items-start justify-between mb-2">
                                <span class="font-medium text-gray-800">${q.text}</span>
                                <span class="badge ${q.tier === 'essential' ? 'badge-essential' : q.tier === 'helpful' ? 'badge-helpful' : q.tier === 'neutral' ? 'badge-neutral' : 'badge-low-yield'}">
                                    ${q.tier === 'essential' ? 'â­ Essential' : q.tier === 'helpful' ? 'ðŸ‘ Helpful' : q.tier === 'neutral' ? 'âž– Neutral' : 'ðŸ“‰ Low-yield'}
                                </span>
                            </div>
                            <div class="bg-white rounded p-3 mb-2 italic text-gray-700">
                                "${q.answer}"
                            </div>
                            <div class="text-sm">
                                ${q.linkedDx.length > 0 ? `<span class="text-purple-600"><strong>Linked to:</strong> ${q.linkedDx.join(', ')}</span><br>` : ''}
                                <span class="text-gray-600">${q.reasoning}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Missed Essential Questions -->
                ${(() => {
                    const missedEssential = variant.historyQuestions.filter(q => q.tier === 'essential' && !state.selectedHistory.includes(q.id));
                    if (missedEssential.length === 0) return '';
                    return `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-yellow-800 mb-2">âš ï¸ Essential Questions You Didn't Ask:</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${missedEssential.map(q => `<li>â€¢ ${q.text} â€” <em>${q.reasoning}</em></li>`).join('')}
                            </ul>
                        </div>
                    `;
                })()}
                
                <div class="thinking-prompt mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ§ </span>
                        <h4 class="font-semibold text-purple-800">Reflect on Your Findings</h4>
                    </div>
                    <p class="text-purple-700 text-sm">
                        Based on what you've learned, which diagnoses are now MORE likely? Which are LESS likely? 
                        What physical exam findings would help you further narrow your differential?
                    </p>
                </div>
                
                <button onclick="advanceToPhysical()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                    Continue to Physical Exam â†’
                </button>
            </div>
        `;
    }
    
    function renderPhysicalStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        
        // Group exams by category
        const categories = [...new Set(variant.physicalExam.map(e => e.category))];
        
        return `
            <div class="fade-in">
                <div class="card p-6 mb-4">
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 3 of 5</span>
                            <span>Physical Examination</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 60%"></div>
                        </div>
                    </div>
                    
                    ${!state.physicalSubmitted ? `
                        <h3 class="font-semibold text-gray-800 mb-2">ðŸ©º Select Physical Exam Maneuvers</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            Choose the exam components that will help refine your differential. 
                            More thorough is generally better, but focus on the most relevant maneuvers for efficiency.
                        </p>
                        
                        <!-- Selection Counter -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                            <div class="text-center">
                                <span class="text-2xl font-bold text-blue-600">${state.selectedPhysical.length}</span>
                                <span class="text-gray-600"> maneuvers selected</span>
                            </div>
                            <p class="text-xs text-center text-gray-500 mt-1">A focused exam for this presentation typically includes 8-10 key maneuvers</p>
                        </div>
                        
                        <!-- Exam by Category -->
                        ${categories.map(cat => `
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-700 mb-2">${cat}</h4>
                                <div class="space-y-2">
                                    ${variant.physicalExam.filter(e => e.category === cat).map(exam => `
                                        <button onclick="togglePhysical('${exam.id}')"
                                                class="selection-btn ${state.selectedPhysical.includes(exam.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${exam.text}</span>
                                                ${state.selectedPhysical.includes(exam.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        
                        <button onclick="submitPhysical()"
                                class="w-full py-3 rounded-lg font-bold text-white ${state.selectedPhysical.length >= 5 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${state.selectedPhysical.length >= 5 ? '' : 'disabled'}>
                            ${state.selectedPhysical.length < 5 ? `Select at least ${5 - state.selectedPhysical.length} more` : 'Submit Physical Exam â†’'}
                        </button>
                    ` : renderPhysicalFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderPhysicalFeedback(variant) {
        const selectedExams = variant.physicalExam.filter(e => state.selectedPhysical.includes(e.id));
        const essentialSelected = selectedExams.filter(e => e.tier === 'essential').length;
        const essentialTotal = variant.physicalExam.filter(e => e.tier === 'essential').length;
        
        return `
            <div class="slide-in">
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${Math.round(essentialSelected / essentialTotal * 100)}%</div>
                        <p class="text-gray-600 text-sm">Essential Exams Performed</p>
                    </div>
                ` : ''}
                
                <h3 class="font-semibold text-gray-800 mb-4">Physical Exam Findings</h3>
                
                <div class="space-y-3 mb-6">
                    ${selectedExams.map(exam => `
                        <div class="p-4 rounded-lg border ${exam.tier === 'essential' ? 'border-green-300 bg-green-50' : exam.tier === 'helpful' ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-gray-50'}">
                            <div class="flex items-start justify-between mb-2">
                                <span class="font-medium text-gray-800">${exam.text}</span>
                                <span class="badge ${exam.tier === 'essential' ? 'badge-essential' : exam.tier === 'helpful' ? 'badge-helpful' : 'badge-neutral'}">
                                    ${exam.tier === 'essential' ? 'â­ Essential' : exam.tier === 'helpful' ? 'ðŸ‘ Helpful' : 'âž– Neutral'}
                                </span>
                            </div>
                            <div class="bg-white rounded p-3 mb-2 font-medium text-gray-800">
                                ${exam.finding}
                            </div>
                            <div class="text-sm text-gray-600">
                                ${exam.reasoning}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="thinking-prompt mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ§ </span>
                        <h4 class="font-semibold text-purple-800">Time to Revise Your Differential</h4>
                    </div>
                    <p class="text-purple-700 text-sm">
                        Based on your history and physical findings, how has your differential changed? 
                        Which diagnoses have moved up? Which have been ruled out or become less likely?
                    </p>
                </div>
                
                <button onclick="advanceToRevisedDifferential()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                    Revise Your Differential â†’
                </button>
            </div>
        `;
    }
    
    function renderRevisedDifferentialStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        
        // Initialize revised lists from original if empty
        if (state.revisedLikely.length === 0 && state.revisedMustNotMiss.length === 0 && !state.revisedSubmitted) {
            state.revisedLikely = [...state.selectedLikely];
            state.revisedMustNotMiss = [...state.selectedMustNotMiss];
        }
        
        const totalSelected = state.revisedLikely.length + state.revisedMustNotMiss.length;
        const availableDx = variant.allDiagnoses.filter(d => 
            !state.revisedLikely.includes(d.name) && !state.revisedMustNotMiss.includes(d.name)
        );
        
        return `
            <div class="fade-in">
                <div class="card p-6">
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 4 of 5</span>
                            <span>Revised Differential</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 80%"></div>
                        </div>
                    </div>
                    
                    ${!state.revisedSubmitted ? `
                        <h3 class="font-semibold text-gray-800 mb-2">ðŸ“ Revise Your Differential Diagnosis</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            Based on your history and physical findings, update your differential. 
                            Add or remove diagnoses as appropriate. What has changed and why?
                        </p>
                        
                        <!-- Thinking Notes -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700">Optional: Note why your differential changed</label>
                            <textarea 
                                class="w-full p-3 border rounded-lg mt-1" 
                                rows="2" 
                                placeholder="e.g., 'Moved PUD up because of melena and NSAID use. Ruled out ACS given normal ECG...'"
                                onchange="state.differentialNotes = this.value"
                            >${state.differentialNotes}</textarea>
                        </div>
                        
                        <!-- Category Zones (same as before) -->
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <h4 class="font-semibold text-green-700 mb-2 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                    Most Likely (${state.revisedLikely.length})
                                </h4>
                                <div class="category-zone likely min-h-[100px]">
                                    ${state.revisedLikely.length === 0 ? 
                                        '<p class="text-gray-400 text-sm text-center py-4">Click diagnoses below to add</p>' :
                                        state.revisedLikely.map(name => `
                                            <div class="dx-card selected-likely mb-2 flex justify-between items-center">
                                                <span>${name}</span>
                                                <button onclick="removeRevisedDx('${name}', 'likely')" class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-red-700 mb-2 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                    Must Not Miss (${state.revisedMustNotMiss.length})
                                </h4>
                                <div class="category-zone must-not-miss min-h-[100px]">
                                    ${state.revisedMustNotMiss.length === 0 ?
                                        '<p class="text-gray-400 text-sm text-center py-4">Click diagnoses below to add</p>' :
                                        state.revisedMustNotMiss.map(name => `
                                            <div class="dx-card selected-must-not-miss mb-2 flex justify-between items-center">
                                                <span>${name}</span>
                                                <button onclick="removeRevisedDx('${name}', 'must-not-miss')" class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <h4 class="font-semibold text-gray-700 mb-2">Available Diagnoses</h4>
                        <div class="grid gap-2 mb-6">
                            ${availableDx.map(dx => `
                                <div class="dx-card flex justify-between items-center">
                                    <span>${dx.name}</span>
                                    <div class="flex gap-2">
                                        <button onclick="addRevisedDx('${dx.name}', 'likely')" 
                                                class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                                            + Likely
                                        </button>
                                        <button onclick="addRevisedDx('${dx.name}', 'must-not-miss')"
                                                class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                            + Must Not Miss
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="submitRevisedDifferential()"
                                class="w-full py-3 rounded-lg font-bold text-white ${totalSelected >= 1 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${totalSelected >= 1 ? '' : 'disabled'}>
                            Submit Revised Differential â†’
                        </button>
                    ` : renderRevisedDifferentialFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderRevisedDifferentialFeedback(variant) {
        // Check if actual diagnosis is in their final differential
        const actualDx = variant.actualDiagnosis.name.split(' (')[0]; // Get first part of name
        const hasActualDx = state.revisedLikely.some(dx => actualDx.includes(dx) || dx.includes('Peptic Ulcer') || dx.includes('Hemorrhoid'));
        
        return `
            <div class="slide-in">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-green-800 mb-2">âœ… Differential Revised</h4>
                    <p class="text-green-700 text-sm">
                        Your final differential before workup:
                    </p>
                    <div class="mt-2">
                        <strong class="text-green-700">Most Likely:</strong> ${state.revisedLikely.join(', ') || 'None'}
                    </div>
                    <div>
                        <strong class="text-red-700">Must Not Miss:</strong> ${state.revisedMustNotMiss.join(', ') || 'None'}
                    </div>
                </div>
                
                ${state.differentialNotes ? `
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-purple-800 mb-1">Your Reasoning:</h4>
                        <p class="text-purple-700 text-sm">${state.differentialNotes}</p>
                    </div>
                ` : ''}
                
                <div class="thinking-prompt mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ§ </span>
                        <h4 class="font-semibold text-purple-800">Now Plan Your Workup</h4>
                    </div>
                    <p class="text-purple-700 text-sm">
                        What tests, imaging, or interventions would help confirm your leading diagnosis? 
                        What would help rule out your "must not miss" conditions? 
                        Prioritize: if you could only do 3 things right now, what would they be?
                    </p>
                </div>
                
                <button onclick="advanceToWorkup()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                    Continue to Workup & Next Steps â†’
                </button>
            </div>
        `;
    }
    
    function renderWorkupStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        const workup = variant.workupOptions;
        
        return `
            <div class="fade-in">
                <div class="card p-6">
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 5 of 5</span>
                            <span>Workup & Next Steps</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    ${!state.workupSubmitted ? `
                        <h3 class="font-semibold text-gray-800 mb-2">ðŸ”¬ Select Your Workup & Next Steps</h3>
                        <p class="text-sm text-gray-600 mb-2">
                            Choose the tests, imaging, treatments, and other steps you would order.
                        </p>
                        <p class="text-sm text-amber-600 font-medium mb-4">
                            ðŸ’¡ Prioritize: If you could only do 3 things immediately, what would they be?
                        </p>
                        
                        <!-- Selection Counter -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                            <div class="text-center">
                                <span class="text-2xl font-bold text-blue-600">${state.selectedWorkup.length}</span>
                                <span class="text-gray-600"> items selected</span>
                            </div>
                        </div>
                        
                        <!-- Workup Categories -->
                        <div class="space-y-4 mb-6">
                            <!-- Labs -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ§ª Labs</div>
                                <div class="p-3 space-y-2">
                                    ${workup.labs.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Imaging -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ“· Imaging</div>
                                <div class="p-3 space-y-2">
                                    ${workup.imaging.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Procedures -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ”§ Procedures</div>
                                <div class="p-3 space-y-2">
                                    ${workup.procedures.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Treatments -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ’Š Treatments</div>
                                <div class="p-3 space-y-2">
                                    ${workup.treatments.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Consults -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ‘¥ Consults</div>
                                <div class="p-3 space-y-2">
                                    ${workup.consults.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Disposition -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ¥ Disposition</div>
                                <div class="p-3 space-y-2">
                                    ${workup.disposition.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="submitWorkup()"
                                class="w-full py-3 rounded-lg font-bold text-white ${state.selectedWorkup.length >= 3 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${state.selectedWorkup.length >= 3 ? '' : 'disabled'}>
                            ${state.selectedWorkup.length < 3 ? `Select at least ${3 - state.selectedWorkup.length} more` : 'Submit Workup & See Results â†’'}
                        </button>
                    ` : renderWorkupFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderWorkupFeedback(variant) {
        const workup = variant.workupOptions;
        const allItems = [...workup.labs, ...workup.imaging, ...workup.procedures, ...workup.treatments, ...workup.consults, ...workup.disposition];
        const selectedItems = allItems.filter(item => state.selectedWorkup.includes(item.id));
        
        const essentialSelected = selectedItems.filter(item => item.tier === 'essential').length;
        const essentialTotal = allItems.filter(item => item.tier === 'essential').length;
        
        return `
            <div class="slide-in">
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${Math.round(essentialSelected / essentialTotal * 100)}%</div>
                        <p class="text-gray-600 text-sm">Essential Workup Items Selected</p>
                    </div>
                ` : ''}
                
                <h3 class="font-semibold text-gray-800 mb-4">ðŸ“‹ Results & Feedback</h3>
                
                <div class="space-y-3 mb-6">
                    ${selectedItems.map(item => `
                        <div class="p-4 rounded-lg border ${item.tier === 'essential' ? 'border-green-300 bg-green-50' : item.tier === 'helpful' ? 'border-blue-300 bg-blue-50' : item.tier === 'less-helpful' || item.tier === 'inappropriate' ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200 bg-gray-50'}">
                            <div class="flex items-start justify-between mb-2">
                                <span class="font-medium text-gray-800">${item.name}</span>
                                <span class="badge ${item.tier === 'essential' ? 'badge-essential' : item.tier === 'helpful' ? 'badge-helpful' : item.tier === 'less-helpful' || item.tier === 'inappropriate' ? 'badge-low-yield' : 'badge-neutral'}">
                                    ${item.tier === 'essential' ? 'â­ Essential' : item.tier === 'helpful' ? 'ðŸ‘ Helpful' : item.tier === 'less-helpful' ? 'ðŸ“‰ Less Helpful' : item.tier === 'inappropriate' ? 'âŒ Inappropriate' : 'âž– Neutral'}
                                </span>
                            </div>
                            <div class="bg-white rounded p-3 mb-2 font-medium text-gray-800">
                                ${item.result}
                            </div>
                            <div class="text-sm text-gray-600">
                                ${item.reasoning}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <button onclick="showSummary()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700">
                    See Final Diagnosis & Summary â†’
                </button>
            </div>
        `;
    }
    
    function renderSummary() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        const dx = variant.actualDiagnosis;
        
        return `
            <div class="fade-in">
                <div class="card p-6">
                    <div class="text-center mb-6">
                        <span class="text-6xl">ðŸŽ‰</span>
                        <h2 class="text-2xl font-bold text-gray-800 mt-4">Case Complete!</h2>
                    </div>
                    
                    <!-- Final Diagnosis -->
                    <div class="bg-green-50 border-2 border-green-300 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-bold text-green-800 mb-2">Final Diagnosis</h3>
                        <p class="text-xl font-semibold text-green-900">${dx.name}</p>
                    </div>
                    
                    <!-- Key Findings -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-3">ðŸ”‘ Key Findings</h3>
                        <ul class="space-y-2">
                            ${dx.keyFindings.map(f => `
                                <li class="flex items-start gap-2">
                                    <span class="text-green-500 mt-1">âœ“</span>
                                    <span>${f}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <!-- Teaching Points -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
                        <h3 class="font-bold text-blue-800 mb-3">ðŸ“š Teaching Points</h3>
                        <ul class="space-y-3">
                            ${dx.teachingPoints.map(t => `
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-500 mt-1">ðŸ’¡</span>
                                    <span class="text-blue-900">${t}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    ${state.mode === 'quiz' ? renderFinalScore() : ''}
                    
                    <div class="flex gap-4">
                        <button onclick="resetAndGoToMenu()"
                                class="flex-1 py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                            â† Back to Menu
                        </button>
                        <button onclick="restartCase()"
                                class="flex-1 py-3 rounded-lg font-bold text-blue-600 border-2 border-blue-600 hover:bg-blue-50">
                            Try Another Case
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderFinalScore() {
        // Calculate weighted score
        // This is a simplified version - would need more sophisticated calculation
        return `
            <div class="bg-purple-50 border-2 border-purple-300 rounded-xl p-6 mb-6 text-center">
                <h3 class="font-bold text-purple-800 mb-2">ðŸŽ¯ Your Score</h3>
                <div class="text-5xl font-bold text-purple-600 mb-2">85%</div>
                <p class="text-purple-700 text-sm">Great clinical reasoning!</p>
            </div>
        `;
    }
    
    // ============================================================
    // ACTION FUNCTIONS
    // ============================================================
    
    function selectMode(mode) {
        state.mode = mode;
        state.screen = 'case-select';
        render();
    }
    
    function selectCase(caseId) {
        state.caseType = caseId;
        state.variantKey = null;
        render();
    }
    
    function selectVariant(variantKey) {
        state.variantKey = variantKey;
        render();
    }
    
    function startCase() {
        if (!state.variantKey) return;
        state.screen = 'differential';
        render();
    }
    
    function goBack() {
        if (state.screen === 'case-select') {
            state.screen = 'menu';
            state.mode = null;
            state.caseType = null;
        } else if (state.screen === 'differential') {
            state.screen = 'case-select';
        }
        render();
    }
    
    // Differential functions
    function addDx(name, category) {
        if (category === 'likely') {
            state.selectedLikely.push(name);
        } else {
            state.selectedMustNotMiss.push(name);
        }
        render();
    }
    
    function removeDx(name, category) {
        if (category === 'likely') {
            state.selectedLikely = state.selectedLikely.filter(n => n !== name);
        } else {
            state.selectedMustNotMiss = state.selectedMustNotMiss.filter(n => n !== name);
        }
        render();
    }
    
    function submitDifferential() {
        state.differentialSubmitted = true;
        render();
    }
    
    function advanceToHistory() {
        state.screen = 'history';
        render();
    }
    
    // History functions
    function toggleHistory(id) {
        if (state.selectedHistory.includes(id)) {
            state.selectedHistory = state.selectedHistory.filter(h => h !== id);
        } else {
            state.selectedHistory.push(id);
        }
        render();
    }
    
    function submitHistory() {
        state.historySubmitted = true;
        render();
    }
    
    function advanceToPhysical() {
        state.screen = 'physical';
        render();
    }
    
    // Physical exam functions
    function togglePhysical(id) {
        if (state.selectedPhysical.includes(id)) {
            state.selectedPhysical = state.selectedPhysical.filter(p => p !== id);
        } else {
            state.selectedPhysical.push(id);
        }
        render();
    }
    
    function submitPhysical() {
        state.physicalSubmitted = true;
        render();
    }
    
    function advanceToRevisedDifferential() {
        state.screen = 'revised-differential';
        render();
    }
    
    // Revised differential functions
    function addRevisedDx(name, category) {
        if (category === 'likely') {
            state.revisedLikely.push(name);
        } else {
            state.revisedMustNotMiss.push(name);
        }
        render();
    }
    
    function removeRevisedDx(name, category) {
        if (category === 'likely') {
            state.revisedLikely = state.revisedLikely.filter(n => n !== name);
        } else {
            state.revisedMustNotMiss = state.revisedMustNotMiss.filter(n => n !== name);
        }
        render();
    }
    
    function submitRevisedDifferential() {
        state.revisedSubmitted = true;
        render();
    }
    
    function advanceToWorkup() {
        state.screen = 'workup';
        render();
    }
    
    // Workup functions
    function toggleWorkup(id) {
        if (state.selectedWorkup.includes(id)) {
            state.selectedWorkup = state.selectedWorkup.filter(w => w !== id);
        } else {
            state.selectedWorkup.push(id);
        }
        render();
    }
    
    function submitWorkup() {
        state.workupSubmitted = true;
        render();
    }
    
    function showSummary() {
        state.screen = 'summary';
        render();
    }
    
    function resetAndGoToMenu() {
        // Reset all state
        Object.assign(state, {
            screen: 'menu',
            mode: null,
            caseType: null,
            variantKey: null,
            selectedLikely: [],
            selectedMustNotMiss: [],
            differentialSubmitted: false,
            selectedHistory: [],
            historySubmitted: false,
            selectedPhysical: [],
            physicalSubmitted: false,
            revisedLikely: [],
            revisedMustNotMiss: [],
            revisedSubmitted: false,
            differentialNotes: '',
            selectedWorkup: [],
            workupSubmitted: false
        });
        render();
    }
    
    function restartCase() {
        state.screen = 'case-select';
        state.variantKey = null;
        state.selectedLikely = [];
        state.selectedMustNotMiss = [];
        state.differentialSubmitted = false;
        state.selectedHistory = [];
        state.historySubmitted = false;
        state.selectedPhysical = [];
        state.physicalSubmitted = false;
        state.revisedLikely = [];
        state.revisedMustNotMiss = [];
        state.revisedSubmitted = false;
        state.differentialNotes = '';
        state.selectedWorkup = [];
        state.workupSubmitted = false;
        render();
    }
    
    // Initialize
    render();
    </script>
</body>
</html>
