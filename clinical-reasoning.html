<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Reasoning Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            min-height: 100vh;
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes scorePop { 
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); } 50% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.8); } }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        .pulse { animation: pulse 0.3s ease-out; }
        .score-pop { animation: scorePop 0.8s ease-out forwards; }
        .shake { animation: shake 0.4s ease-out; }
        .glow { animation: glow 2s ease-in-out infinite; }
        
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .toggle-switch.active { background: #3b82f6; }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch.active::after { transform: translateX(24px); }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        
        /* Gender/Age Selection */
        .variant-card {
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .variant-card:hover { border-color: #3b82f6; transform: translateY(-2px); }
        .variant-card.selected { border-color: #3b82f6; background: #eff6ff; }
        
        /* Question buttons */
        .question-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        .question-btn:hover:not(:disabled) { border-color: #3b82f6; background: #f8fafc; }
        .question-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .question-btn.selected { border-color: #3b82f6; background: #eff6ff; }
        .question-btn.excellent { border-color: #22c55e; background: #f0fdf4; }
        .question-btn.good { border-color: #3b82f6; background: #eff6ff; }
        .question-btn.fair { border-color: #f59e0b; background: #fffbeb; }
        .question-btn.low-priority { border-color: #ef4444; background: #fef2f2; }
        
        /* Refinement buttons */
        .refine-btn {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .refine-btn.more { background: #dcfce7; color: #166534; }
        .refine-btn.more:hover, .refine-btn.more.selected { background: #22c55e; color: white; }
        .refine-btn.less { background: #fef3c7; color: #92400e; }
        .refine-btn.less:hover, .refine-btn.less.selected { background: #f59e0b; color: white; }
        .refine-btn.unchanged { background: #e5e7eb; color: #374151; }
        .refine-btn.unchanged:hover, .refine-btn.unchanged.selected { background: #6b7280; color: white; }
        .refine-btn.ruled-out { background: #fee2e2; color: #991b1b; }
        .refine-btn.ruled-out:hover, .refine-btn.ruled-out.selected { background: #ef4444; color: white; }
        
        /* Findings card */
        .finding-item {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }
        
        /* Timer warning */
        .timer-warning { animation: pulse 0.5s ease-in-out infinite; color: #ef4444; }
        
        /* Progress bar */
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }
        
        /* Feedback badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-excellent { background: #dcfce7; color: #166534; }
        .badge-good { background: #dbeafe; color: #1e40af; }
        .badge-fair { background: #fef3c7; color: #92400e; }
        .badge-low { background: #fee2e2; color: #991b1b; }
        .badge-correct { background: #dcfce7; color: #166534; }
        .badge-incorrect { background: #fee2e2; color: #991b1b; }
        .badge-partial { background: #fef3c7; color: #92400e; }
        
        /* Must not miss indicator */
        .must-not-miss {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 2px solid #ef4444;
        }
        
        /* Score popup */
        .score-popup {
            position: fixed;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            z-index: 1000;
        }
        .score-popup.positive { color: #22c55e; }
        .score-popup.negative { color: #ef4444; }
        
        /* HUD */
        .game-hud {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #1e3a5f, #2d5a87);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* Star rating */
        .star { font-size: 48px; opacity: 0.3; transition: all 0.3s ease; }
        .star.earned { opacity: 1; transform: scale(1.1); }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ==================== GAME CONFIGURATION ====================
        const LEVELS = [
            { level: 1, title: "Medical Student", xpRequired: 0, icon: "ðŸ“š" },
            { level: 2, title: "Clinical Clerk", xpRequired: 500, icon: "ðŸ©º" },
            { level: 3, title: "Sub-Intern", xpRequired: 1200, icon: "ðŸ“‹" },
            { level: 4, title: "Intern", xpRequired: 2500, icon: "ðŸ’‰" },
            { level: 5, title: "Resident", xpRequired: 4500, icon: "ðŸ”¬" },
            { level: 6, title: "Senior Resident", xpRequired: 7500, icon: "ðŸ“Š" },
            { level: 7, title: "Chief Resident", xpRequired: 12000, icon: "â­" },
            { level: 8, title: "Attending", xpRequired: 18000, icon: "ðŸ‘¨â€âš•ï¸" },
            { level: 9, title: "Master Diagnostician", xpRequired: 30000, icon: "ðŸ†" },
            { level: 10, title: "Legendary Clinician", xpRequired: 50000, icon: "ðŸ‘‘" }
        ];

        const STAGE_TIME_LIMIT = 300; // 5 minutes per stage
        const POINTS = {
            excellent: 150,
            good: 100,
            fair: 50,
            "low-priority": -50,
            streakBonus: 25,
            maxStreakMultiplier: 5,
            mustNotMissBonus: 200,
            mustNotMissPenalty: -150,
            speedBonusMultiplier: 1.5,
            refinementCorrect: 100,
            refinementPartial: 50,
            refinementIncorrect: -50,
            incorrectRuledOut: -100
        };

        // ==================== CASE DATA ====================
        const CASES = [
            {
                id: "epigastric-pain",
                title: "Epigastric Pain",
                category: "GI",
                icon: "ðŸ”¥",
                
                variants: {
                    "male-58": {
                        name: "R.H.",
                        age: 58,
                        gender: "male",
                        genderDisplay: "Male",
                        pronouns: { subject: "he", object: "him", possessive: "his", Subject: "He", Object: "Him", Possessive: "His" },
                        chiefComplaint: "Burning stomach pain for 3 days",
                        vitalSigns: "BP 145/88, HR 78, RR 16, Temp 98.6Â°F, SpO2 98%",
                        
                        initialDifferential: [
                            { name: "GERD", mustNotMiss: false },
                            { name: "Peptic Ulcer Disease (PUD)", mustNotMiss: false },
                            { name: "Acute Myocardial Infarction", mustNotMiss: true },
                            { name: "Acute Pancreatitis", mustNotMiss: false },
                            { name: "Gastritis", mustNotMiss: false },
                            { name: "Abdominal Aortic Aneurysm (AAA)", mustNotMiss: true },
                            { name: "Biliary Colic/Cholecystitis", mustNotMiss: false },
                            { name: "Esophageal Spasm", mustNotMiss: false }
                        ],
                        
                        historyFindings: {
                            "onset": { answer: "Started about 3 days ago, came on gradually over a few hours", displayed: false },
                            "character": { answer: "It's a burning feeling, right here (points to epigastrium)", displayed: false },
                            "severity": { answer: "I'd say about 6 out of 10, sometimes worse after eating", displayed: false },
                            "radiation": { answer: "No, it pretty much stays in one spot", displayed: false },
                            "timing": { answer: "It's there most of the time, but definitely worse after meals", displayed: false },
                            "aggravating": { answer: "Eating makes it worse, especially spicy food or coffee", displayed: false },
                            "alleviating": { answer: "Antacids help a little, but it comes back", displayed: false },
                            "associated_nausea": { answer: "Yeah, I've felt a bit queasy, but no vomiting", displayed: false },
                            "associated_vomiting": { answer: "No vomiting", displayed: false },
                            "hematemesis": { answer: "No, nothing like that", displayed: false },
                            "melena": { answer: "Actually, my stool has looked a bit darker lately", displayed: false },
                            "weight_loss": { answer: "Maybe a few pounds, I haven't been eating as much", displayed: false },
                            "dysphagia": { answer: "No trouble swallowing", displayed: false },
                            "chest_pain": { answer: "No chest pain, just the stomach", displayed: false },
                            "sob": { answer: "No shortness of breath", displayed: false },
                            "diaphoresis": { answer: "No unusual sweating", displayed: false },
                            "palpitations": { answer: "No", displayed: false },
                            "nsaid_use": { answer: "Yeah, I take ibuprofen almost daily for my back - probably 4-6 tablets a day for the past few months", displayed: false },
                            "alcohol": { answer: "I have a few beers most nights, maybe 3-4", displayed: false },
                            "smoking": { answer: "Used to smoke, quit about 5 years ago. Smoked a pack a day for 30 years", displayed: false },
                            "caffeine": { answer: "Lots of coffee, maybe 4-5 cups a day", displayed: false },
                            "recent_travel": { answer: "No recent travel", displayed: false },
                            "sick_contacts": { answer: "No one else sick at home", displayed: false },
                            "prior_episodes": { answer: "I've had some heartburn before, but nothing this bad", displayed: false },
                            "pmh_cardiac": { answer: "I have high blood pressure, take lisinopril for it", displayed: false },
                            "pmh_gi": { answer: "No history of ulcers or GI problems", displayed: false },
                            "pmh_diabetes": { answer: "No diabetes", displayed: false },
                            "family_cardiac": { answer: "My dad had a heart attack at 65", displayed: false },
                            "family_gi": { answer: "My mother had stomach problems, not sure exactly what", displayed: false },
                            "family_cancer": { answer: "No cancer that I know of", displayed: false },
                            "stress": { answer: "Work has been pretty stressful lately", displayed: false }
                        },
                        
                        postHistoryRefinement: {
                            "GERD": { correct: "more", rationale: "Burning quality, worse after eating, relieved partially by antacids, and high caffeine intake all support GERD." },
                            "Peptic Ulcer Disease (PUD)": { correct: "more", rationale: "Daily NSAID use for months is a major risk factor. Dark stools suggest possible GI bleeding. Alcohol use adds risk." },
                            "Acute Myocardial Infarction": { correct: "less", rationale: "Gradual onset over 3 days, burning quality, food-related symptoms, and no chest pain/SOB/diaphoresis make MI less likely - but don't rule it out given his age and risk factors." },
                            "Acute Pancreatitis": { correct: "less", rationale: "No radiation to back, no severe constant pain, no vomiting. Alcohol use is a risk factor, but presentation doesn't fit classic pancreatitis." },
                            "Gastritis": { correct: "more", rationale: "NSAIDs, alcohol, and coffee are all gastric irritants. Burning epigastric pain with nausea fits well." },
                            "Abdominal Aortic Aneurysm (AAA)": { correct: "less", rationale: "Gradual onset, burning quality, and food-related pattern are atypical for AAA. However, age 58 with HTN and smoking history means we can't ignore it." },
                            "Biliary Colic/Cholecystitis": { correct: "unchanged", rationale: "Pain worse after eating could fit, but burning quality and lack of RUQ focus make this less typical. Keep on differential." },
                            "Esophageal Spasm": { correct: "less", rationale: "No dysphagia, no chest pain radiation. The constant nature doesn't fit typical spasm pattern." }
                        },
                        
                        physicalFindings: {
                            "general_appearance": { finding: "Alert, mildly uncomfortable, no acute distress", displayed: false },
                            "vital_signs": { finding: "BP 145/88, HR 78, RR 16, Temp 98.6Â°F, SpO2 98% on RA", displayed: false },
                            "cardiac_auscultation": { finding: "Regular rate and rhythm, no murmurs, rubs, or gallops", displayed: false },
                            "lung_auscultation": { finding: "Clear to auscultation bilaterally", displayed: false },
                            "abdominal_inspection": { finding: "Soft, non-distended, no visible masses or pulsations", displayed: false },
                            "abdominal_auscultation": { finding: "Normal bowel sounds in all quadrants", displayed: false },
                            "epigastric_palpation": { finding: "Moderate tenderness to palpation in epigastrium, no guarding or rebound", displayed: false },
                            "ruq_palpation": { finding: "Mild tenderness, no Murphy's sign", displayed: false },
                            "luq_palpation": { finding: "Non-tender", displayed: false },
                            "llq_palpation": { finding: "Non-tender", displayed: false },
                            "rlq_palpation": { finding: "Non-tender", displayed: false },
                            "murphy_sign": { finding: "Negative", displayed: false },
                            "rebound_tenderness": { finding: "Absent", displayed: false },
                            "guarding": { finding: "Absent", displayed: false },
                            "aortic_palpation": { finding: "No pulsatile mass appreciated", displayed: false },
                            "cvat": { finding: "No costovertebral angle tenderness bilaterally", displayed: false },
                            "rectal_exam": { finding: "Stool is dark brown, guaiac positive", displayed: false },
                            "peripheral_pulses": { finding: "2+ bilateral, symmetric", displayed: false },
                            "lower_extremity_edema": { finding: "No edema", displayed: false },
                            "skin_exam": { finding: "No jaundice, no pallor", displayed: false }
                        },
                        
                        postPhysicalRefinement: {
                            "GERD": { correct: "unchanged", rationale: "Physical exam is often normal in GERD. Epigastric tenderness is non-specific." },
                            "Peptic Ulcer Disease (PUD)": { correct: "more", rationale: "Guaiac positive stool confirms GI bleeding! Combined with NSAID use and epigastric tenderness, PUD/gastritis with bleeding is now top of differential." },
                            "Acute Myocardial Infarction": { correct: "less", rationale: "Normal cardiac exam, stable vitals, no signs of heart failure. Still need EKG/troponin to definitively exclude." },
                            "Acute Pancreatitis": { correct: "less", rationale: "No severe tenderness, no guarding. Exam doesn't support pancreatitis." },
                            "Gastritis": { correct: "more", rationale: "Guaiac positive stool plus epigastric tenderness with NSAID/alcohol history strongly supports erosive gastritis." },
                            "Abdominal Aortic Aneurysm (AAA)": { correct: "less", rationale: "No pulsatile mass on exam. AAA much less likely but would confirm with imaging in this age group." },
                            "Biliary Colic/Cholecystitis": { correct: "less", rationale: "Negative Murphy's sign, minimal RUQ tenderness. Biliary pathology unlikely." },
                            "Esophageal Spasm": { correct: "less", rationale: "GI bleeding doesn't fit esophageal spasm. Much less likely now." }
                        },
                        
                        actualDiagnosis: {
                            name: "NSAID-induced Gastritis with GI Bleeding",
                            keyFindings: [
                                "Daily NSAID use for months (major risk factor)",
                                "Burning epigastric pain worse with eating",
                                "Dark stools reported + guaiac positive (confirms GI bleed)",
                                "Alcohol and caffeine as additional irritants",
                                "Epigastric tenderness on exam"
                            ],
                            teachingPoints: [
                                "NSAIDs inhibit prostaglandin synthesis, reducing gastric mucosal protection",
                                "Always ask about OTC medication use - patients often don't consider these 'medications'",
                                "Dark stools (melena) indicate upper GI bleeding - always do a rectal exam",
                                "GI bleeding can be subtle - guaiac testing is essential",
                                "Combination of NSAIDs + alcohol dramatically increases bleeding risk"
                            ],
                            workup: [
                                "CBC (check for anemia from blood loss)",
                                "BMP (renal function, electrolytes)",
                                "EKG (rule out cardiac cause given age/risk factors)",
                                "Troponin (if any concern for ACS)",
                                "Upper endoscopy (EGD) - gold standard for diagnosis and treatment"
                            ]
                        }
                    },
                    
                    "female-58": {
                        name: "R.H.",
                        age: 58,
                        gender: "female",
                        genderDisplay: "Female (Post-menopausal)",
                        pronouns: { subject: "she", object: "her", possessive: "her", Subject: "She", Object: "Her", Possessive: "Her" },
                        chiefComplaint: "Burning stomach pain for 3 days",
                        vitalSigns: "BP 142/86, HR 82, RR 16, Temp 98.4Â°F, SpO2 98%",
                        
                        initialDifferential: [
                            { name: "GERD", mustNotMiss: false },
                            { name: "Peptic Ulcer Disease (PUD)", mustNotMiss: false },
                            { name: "Acute Myocardial Infarction", mustNotMiss: true },
                            { name: "Acute Pancreatitis", mustNotMiss: false },
                            { name: "Gastritis", mustNotMiss: false },
                            { name: "Abdominal Aortic Aneurysm (AAA)", mustNotMiss: true },
                            { name: "Biliary Colic/Cholecystitis", mustNotMiss: false },
                            { name: "Esophageal Spasm", mustNotMiss: false }
                        ],
                        
                        historyFindings: {
                            "onset": { answer: "Started about 3 days ago, came on gradually over a few hours", displayed: false },
                            "character": { answer: "It's a burning feeling, right here (points to epigastrium)", displayed: false },
                            "severity": { answer: "I'd say about 6 out of 10, sometimes worse after eating", displayed: false },
                            "radiation": { answer: "No, it pretty much stays in one spot", displayed: false },
                            "timing": { answer: "It's there most of the time, but definitely worse after meals", displayed: false },
                            "aggravating": { answer: "Eating makes it worse, especially spicy food or coffee", displayed: false },
                            "alleviating": { answer: "Antacids help a little, but it comes back", displayed: false },
                            "associated_nausea": { answer: "Yeah, I've felt a bit queasy, but no vomiting", displayed: false },
                            "associated_vomiting": { answer: "No vomiting", displayed: false },
                            "hematemesis": { answer: "No, nothing like that", displayed: false },
                            "melena": { answer: "Actually, my stool has looked a bit darker lately", displayed: false },
                            "weight_loss": { answer: "Maybe a few pounds, I haven't been eating as much", displayed: false },
                            "dysphagia": { answer: "No trouble swallowing", displayed: false },
                            "chest_pain": { answer: "No chest pain, just the stomach", displayed: false },
                            "sob": { answer: "No shortness of breath", displayed: false },
                            "diaphoresis": { answer: "No unusual sweating", displayed: false },
                            "palpitations": { answer: "No", displayed: false },
                            "nsaid_use": { answer: "Yeah, I take ibuprofen almost daily for my arthritis - probably 4-6 tablets a day for the past few months", displayed: false },
                            "alcohol": { answer: "Just wine with dinner, maybe a glass or two", displayed: false },
                            "smoking": { answer: "Never smoked", displayed: false },
                            "caffeine": { answer: "Lots of coffee, maybe 4-5 cups a day", displayed: false },
                            "recent_travel": { answer: "No recent travel", displayed: false },
                            "sick_contacts": { answer: "No one else sick at home", displayed: false },
                            "prior_episodes": { answer: "I've had some heartburn before, but nothing this bad", displayed: false },
                            "pmh_cardiac": { answer: "I have high blood pressure and high cholesterol", displayed: false },
                            "pmh_gi": { answer: "No history of ulcers or GI problems", displayed: false },
                            "pmh_diabetes": { answer: "No diabetes", displayed: false },
                            "menstrual": { answer: "I went through menopause about 6 years ago", displayed: false },
                            "family_cardiac": { answer: "My mother had a heart attack at 70", displayed: false },
                            "family_gi": { answer: "No GI problems in my family", displayed: false },
                            "family_cancer": { answer: "No cancer that I know of", displayed: false },
                            "stress": { answer: "Work has been pretty stressful lately", displayed: false }
                        },
                        
                        postHistoryRefinement: {
                            "GERD": { correct: "more", rationale: "Burning quality, worse after eating, relieved partially by antacids, and high caffeine intake all support GERD." },
                            "Peptic Ulcer Disease (PUD)": { correct: "more", rationale: "Daily NSAID use for months is a major risk factor. Dark stools suggest possible GI bleeding." },
                            "Acute Myocardial Infarction": { correct: "unchanged", rationale: "Women often have atypical MI presentations - epigastric pain, nausea, and fatigue can BE the presentation. HTN and hyperlipidemia are risk factors. Post-menopausal women lose cardioprotective effect of estrogen. Keep high on differential!" },
                            "Acute Pancreatitis": { correct: "less", rationale: "No radiation to back, no severe constant pain, no vomiting. Low alcohol use. Doesn't fit classic pancreatitis." },
                            "Gastritis": { correct: "more", rationale: "NSAIDs and coffee are gastric irritants. Burning epigastric pain with nausea fits well." },
                            "Abdominal Aortic Aneurysm (AAA)": { correct: "less", rationale: "Much less common in women, and no smoking history. Gradual onset with food-related pattern atypical." },
                            "Biliary Colic/Cholecystitis": { correct: "unchanged", rationale: "Women have higher incidence of gallbladder disease. Pain worse after eating could fit. Keep on differential." },
                            "Esophageal Spasm": { correct: "less", rationale: "No dysphagia, no chest pain radiation. The constant nature doesn't fit typical spasm pattern." }
                        },
                        
                        physicalFindings: {
                            "general_appearance": { finding: "Alert, mildly uncomfortable, no acute distress", displayed: false },
                            "vital_signs": { finding: "BP 142/86, HR 82, RR 16, Temp 98.4Â°F, SpO2 98% on RA", displayed: false },
                            "cardiac_auscultation": { finding: "Regular rate and rhythm, no murmurs, rubs, or gallops", displayed: false },
                            "lung_auscultation": { finding: "Clear to auscultation bilaterally", displayed: false },
                            "abdominal_inspection": { finding: "Soft, non-distended, no visible masses", displayed: false },
                            "abdominal_auscultation": { finding: "Normal bowel sounds in all quadrants", displayed: false },
                            "epigastric_palpation": { finding: "Moderate tenderness to palpation in epigastrium, no guarding or rebound", displayed: false },
                            "ruq_palpation": { finding: "Mild tenderness, no Murphy's sign", displayed: false },
                            "luq_palpation": { finding: "Non-tender", displayed: false },
                            "llq_palpation": { finding: "Non-tender", displayed: false },
                            "rlq_palpation": { finding: "Non-tender", displayed: false },
                            "murphy_sign": { finding: "Negative", displayed: false },
                            "rebound_tenderness": { finding: "Absent", displayed: false },
                            "guarding": { finding: "Absent", displayed: false },
                            "cvat": { finding: "No costovertebral angle tenderness bilaterally", displayed: false },
                            "rectal_exam": { finding: "Stool is dark brown, guaiac positive", displayed: false },
                            "peripheral_pulses": { finding: "2+ bilateral, symmetric", displayed: false },
                            "lower_extremity_edema": { finding: "Trace bilateral ankle edema", displayed: false },
                            "skin_exam": { finding: "No jaundice, mild pallor", displayed: false }
                        },
                        
                        postPhysicalRefinement: {
                            "GERD": { correct: "unchanged", rationale: "Physical exam is often normal in GERD. Epigastric tenderness is non-specific." },
                            "Peptic Ulcer Disease (PUD)": { correct: "more", rationale: "Guaiac positive stool confirms GI bleeding! Combined with NSAID use, pallor, and epigastric tenderness, PUD/gastritis with bleeding is now top of differential." },
                            "Acute Myocardial Infarction": { correct: "unchanged", rationale: "Pallor and trace edema could suggest anemia from GI bleed OR could be subtle heart failure. EKG and troponin essential. Don't lower this diagnosis yet!" },
                            "Acute Pancreatitis": { correct: "less", rationale: "No severe tenderness, no guarding. Exam doesn't support pancreatitis." },
                            "Gastritis": { correct: "more", rationale: "Guaiac positive stool plus epigastric tenderness with NSAID history strongly supports erosive gastritis." },
                            "Abdominal Aortic Aneurysm (AAA)": { correct: "ruled-out", rationale: "Very rare in non-smoking women. No pulsatile mass. Can reasonably exclude." },
                            "Biliary Colic/Cholecystitis": { correct: "less", rationale: "Negative Murphy's sign, minimal RUQ tenderness. Biliary pathology unlikely." },
                            "Esophageal Spasm": { correct: "less", rationale: "GI bleeding doesn't fit esophageal spasm. Much less likely now." }
                        },
                        
                        actualDiagnosis: {
                            name: "NSAID-induced Gastritis with GI Bleeding",
                            keyFindings: [
                                "Daily NSAID use for months (major risk factor)",
                                "Burning epigastric pain worse with eating",
                                "Dark stools reported + guaiac positive (confirms GI bleed)",
                                "Pallor on exam suggesting anemia",
                                "Epigastric tenderness on exam"
                            ],
                            teachingPoints: [
                                "NSAIDs inhibit prostaglandin synthesis, reducing gastric mucosal protection",
                                "Women can have atypical MI presentations - always maintain appropriate suspicion with risk factors",
                                "Dark stools (melena) indicate upper GI bleeding - always do a rectal exam",
                                "Pallor may be the only physical sign of significant blood loss",
                                "Post-menopausal women lose cardiovascular protection - treat cardiac risk factors seriously"
                            ],
                            workup: [
                                "CBC (check for anemia from blood loss)",
                                "BMP (renal function, electrolytes)",
                                "EKG (important in women with atypical symptoms)",
                                "Troponin (rule out ACS - women have atypical presentations)",
                                "Upper endoscopy (EGD) - gold standard for diagnosis and treatment"
                            ]
                        }
                    },
                    
                    "female-28": {
                        name: "R.H.",
                        age: 28,
                        gender: "female",
                        genderDisplay: "Female (Reproductive Age)",
                        pronouns: { subject: "she", object: "her", possessive: "her", Subject: "She", Object: "Her", Possessive: "Her" },
                        chiefComplaint: "Burning stomach pain for 3 days",
                        vitalSigns: "BP 118/72, HR 88, RR 16, Temp 98.8Â°F, SpO2 99%",
                        
                        initialDifferential: [
                            { name: "GERD", mustNotMiss: false },
                            { name: "Peptic Ulcer Disease (PUD)", mustNotMiss: false },
                            { name: "Gastritis", mustNotMiss: false },
                            { name: "Ectopic Pregnancy", mustNotMiss: true },
                            { name: "Biliary Colic/Cholecystitis", mustNotMiss: false },
                            { name: "Acute Pancreatitis", mustNotMiss: false },
                            { name: "Ovarian Pathology (Cyst/Torsion)", mustNotMiss: true },
                            { name: "Acute Myocardial Infarction", mustNotMiss: true },
                            { name: "Esophageal Spasm", mustNotMiss: false }
                        ],
                        
                        historyFindings: {
                            "onset": { answer: "Started about 3 days ago, came on gradually", displayed: false },
                            "character": { answer: "It's a burning feeling, mostly right here (points to epigastrium)", displayed: false },
                            "severity": { answer: "Maybe 5 out of 10, worse after I eat", displayed: false },
                            "radiation": { answer: "No, stays in one spot", displayed: false },
                            "timing": { answer: "It's there on and off, worse after meals", displayed: false },
                            "aggravating": { answer: "Eating makes it worse, especially coffee and spicy food", displayed: false },
                            "alleviating": { answer: "Tums help a little bit", displayed: false },
                            "associated_nausea": { answer: "Yes, I've been feeling nauseous, especially in the mornings", displayed: false },
                            "associated_vomiting": { answer: "I threw up once yesterday morning", displayed: false },
                            "hematemesis": { answer: "No blood when I vomited", displayed: false },
                            "melena": { answer: "No, my stool looks normal", displayed: false },
                            "weight_loss": { answer: "No weight loss", displayed: false },
                            "dysphagia": { answer: "No trouble swallowing", displayed: false },
                            "chest_pain": { answer: "No chest pain", displayed: false },
                            "sob": { answer: "No shortness of breath", displayed: false },
                            "lmp": { answer: "Um, let me think... it's been about 6 weeks? Maybe 7? I'm usually pretty regular but I've been stressed", displayed: false },
                            "pregnancy_possible": { answer: "I mean, I guess it's possible. I'm not on birth control right now", displayed: false },
                            "vaginal_bleeding": { answer: "No bleeding or spotting", displayed: false },
                            "vaginal_discharge": { answer: "Nothing unusual", displayed: false },
                            "dysuria": { answer: "No pain with urination", displayed: false },
                            "sexual_history": { answer: "I'm sexually active with my boyfriend", displayed: false },
                            "contraception": { answer: "We use condoms but not always consistently", displayed: false },
                            "prior_pregnancies": { answer: "Never been pregnant before", displayed: false },
                            "nsaid_use": { answer: "Sometimes ibuprofen for cramps, but not recently", displayed: false },
                            "alcohol": { answer: "Socially on weekends, maybe a few drinks", displayed: false },
                            "smoking": { answer: "No, never smoked", displayed: false },
                            "caffeine": { answer: "A lot of coffee, probably 4-5 cups a day with finals coming up", displayed: false },
                            "stress": { answer: "Yes, I'm in grad school and finals are in two weeks", displayed: false },
                            "pmh_gi": { answer: "I've had heartburn before during stressful times", displayed: false },
                            "pmh_gyn": { answer: "No gynecologic problems, normal periods usually", displayed: false }
                        },
                        
                        postHistoryRefinement: {
                            "GERD": { correct: "more", rationale: "Burning quality, coffee intake, stress, worse with eating, helped by antacids - classic GERD symptoms." },
                            "Peptic Ulcer Disease (PUD)": { correct: "unchanged", rationale: "No regular NSAID use, young age. Less likely but high caffeine could contribute." },
                            "Gastritis": { correct: "more", rationale: "Stress and high caffeine intake during finals are risk factors. Burning pain fits." },
                            "Ectopic Pregnancy": { correct: "more", rationale: "CRITICAL: Last menstrual period 6-7 weeks ago in a sexually active woman with inconsistent contraception. Morning nausea and vomiting. MUST rule out ectopic pregnancy!" },
                            "Biliary Colic/Cholecystitis": { correct: "unchanged", rationale: "Young women can have gallbladder disease. Pain with eating could fit. Keep on differential." },
                            "Acute Pancreatitis": { correct: "less", rationale: "No significant alcohol use, no severe pain, no radiation to back. Less likely." },
                            "Ovarian Pathology (Cyst/Torsion)": { correct: "less", rationale: "Pain is epigastric, not pelvic. No acute severe onset. Less likely but need to consider given delayed LMP." },
                            "Acute Myocardial Infarction": { correct: "less", rationale: "Age 28 with no risk factors. Very unlikely but technically possible." },
                            "Esophageal Spasm": { correct: "less", rationale: "No dysphagia, no chest pain. Pattern doesn't fit." }
                        },
                        
                        physicalFindings: {
                            "general_appearance": { finding: "Alert, mildly uncomfortable, appears anxious", displayed: false },
                            "vital_signs": { finding: "BP 118/72, HR 88, RR 16, Temp 98.8Â°F, SpO2 99% on RA", displayed: false },
                            "cardiac_auscultation": { finding: "Regular rate and rhythm, no murmurs", displayed: false },
                            "lung_auscultation": { finding: "Clear to auscultation bilaterally", displayed: false },
                            "abdominal_inspection": { finding: "Flat, soft, no distension", displayed: false },
                            "abdominal_auscultation": { finding: "Normal bowel sounds", displayed: false },
                            "epigastric_palpation": { finding: "Mild tenderness in epigastrium, no guarding", displayed: false },
                            "ruq_palpation": { finding: "Non-tender, no Murphy's sign", displayed: false },
                            "luq_palpation": { finding: "Non-tender", displayed: false },
                            "suprapubic_palpation": { finding: "Non-tender, no masses", displayed: false },
                            "llq_palpation": { finding: "Non-tender", displayed: false },
                            "rlq_palpation": { finding: "Non-tender", displayed: false },
                            "murphy_sign": { finding: "Negative", displayed: false },
                            "rebound_tenderness": { finding: "Absent", displayed: false },
                            "guarding": { finding: "Absent", displayed: false },
                            "cvat": { finding: "No costovertebral angle tenderness", displayed: false },
                            "pelvic_exam": { finding: "Cervix closed, no cervical motion tenderness, no adnexal masses or tenderness, small amount of white discharge", displayed: false },
                            "urine_pregnancy": { finding: "POSITIVE", displayed: false },
                            "breast_exam": { finding: "Mild bilateral breast tenderness, no masses", displayed: false }
                        },
                        
                        postPhysicalRefinement: {
                            "GERD": { correct: "less", rationale: "While symptoms fit, the positive pregnancy test changes everything. Morning sickness and pregnancy-related reflux are now the more likely explanation." },
                            "Peptic Ulcer Disease (PUD)": { correct: "less", rationale: "Positive pregnancy test makes this less relevant as the primary diagnosis." },
                            "Gastritis": { correct: "less", rationale: "Symptoms now better explained by early pregnancy." },
                            "Ectopic Pregnancy": { correct: "more", rationale: "POSITIVE PREGNANCY TEST with 6-7 weeks LMP. No adnexal tenderness or CMT is reassuring but does NOT rule out ectopic. Need quantitative hCG and transvaginal ultrasound URGENTLY." },
                            "Biliary Colic/Cholecystitis": { correct: "ruled-out", rationale: "Negative Murphy's, non-tender RUQ, and positive pregnancy test redirects diagnosis." },
                            "Acute Pancreatitis": { correct: "ruled-out", rationale: "Benign abdominal exam, no severe pain. Not pancreatitis." },
                            "Ovarian Pathology (Cyst/Torsion)": { correct: "less", rationale: "No adnexal tenderness or masses. Ovarian pathology less likely." },
                            "Acute Myocardial Infarction": { correct: "ruled-out", rationale: "Age 28, positive pregnancy test, no risk factors. Can exclude MI." },
                            "Esophageal Spasm": { correct: "ruled-out", rationale: "Symptoms explained by pregnancy. Not esophageal spasm." }
                        },
                        
                        actualDiagnosis: {
                            name: "Early Intrauterine Pregnancy with Pregnancy-Related Nausea (must rule out Ectopic Pregnancy)",
                            keyFindings: [
                                "Positive urine pregnancy test",
                                "Last menstrual period 6-7 weeks ago",
                                "Morning nausea and vomiting (classic first trimester symptoms)",
                                "Sexually active with inconsistent contraception",
                                "No adnexal tenderness or cervical motion tenderness (reassuring but not definitive)"
                            ],
                            teachingPoints: [
                                "ALWAYS check pregnancy test in reproductive-age females with abdominal pain/nausea",
                                "Ectopic pregnancy can present before rupture with minimal symptoms - don't be falsely reassured",
                                "A negative pelvic exam does NOT rule out ectopic pregnancy",
                                "Quantitative Î²-hCG + transvaginal ultrasound is the workup for pregnancy of unknown location",
                                "Î²-hCG > 1500-2000 should show intrauterine pregnancy on TVUS; if not seen, suspect ectopic",
                                "Morning nausea, breast tenderness, and food aversions are common early pregnancy symptoms"
                            ],
                            workup: [
                                "Quantitative Î²-hCG level",
                                "Transvaginal ultrasound (confirm IUP vs ectopic)",
                                "Blood type and Rh status",
                                "If ectopic suspected: serial Î²-hCG levels q48h (should double in normal IUP)",
                                "CBC, BMP (baseline)"
                            ]
                        }
                    }
                },
                
                // History questions - available based on variant
                historyQuestions: [
                    // HPI - Onset/Character/Severity
                    { id: "onset", text: "When did this pain start?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "character", text: "Can you describe the pain? What does it feel like?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "severity", text: "On a scale of 1-10, how bad is the pain?", quality: "good", category: "HPI", forAll: true },
                    { id: "radiation", text: "Does the pain go anywhere else?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "timing", text: "Is the pain constant or does it come and go?", quality: "good", category: "HPI", forAll: true },
                    { id: "aggravating", text: "What makes the pain worse?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "alleviating", text: "What makes the pain better?", quality: "excellent", category: "HPI", forAll: true },
                    
                    // Associated symptoms - GI
                    { id: "associated_nausea", text: "Have you had any nausea?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "associated_vomiting", text: "Have you had any vomiting?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "hematemesis", text: "Have you vomited any blood?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "melena", text: "Have you noticed any dark or bloody stools?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "weight_loss", text: "Have you had any unintentional weight loss?", quality: "good", category: "Associated", forAll: true },
                    { id: "dysphagia", text: "Do you have trouble swallowing?", quality: "good", category: "Associated", forAll: true },
                    
                    // Associated symptoms - Cardiac
                    { id: "chest_pain", text: "Have you had any chest pain?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "sob", text: "Have you had any shortness of breath?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "diaphoresis", text: "Have you had any unusual sweating?", quality: "good", category: "Associated", forAll: true },
                    { id: "palpitations", text: "Have you felt your heart racing or skipping beats?", quality: "fair", category: "Associated", forAll: true },
                    
                    // GYN History - Female only
                    { id: "lmp", text: "When was your last menstrual period?", quality: "excellent", category: "GYN", forFemaleReproductive: true },
                    { id: "pregnancy_possible", text: "Is there any chance you could be pregnant?", quality: "excellent", category: "GYN", forFemaleReproductive: true },
                    { id: "vaginal_bleeding", text: "Have you had any vaginal bleeding or spotting?", quality: "excellent", category: "GYN", forFemaleReproductive: true },
                    { id: "vaginal_discharge", text: "Have you noticed any unusual vaginal discharge?", quality: "good", category: "GYN", forFemaleReproductive: true },
                    { id: "dysuria", text: "Do you have any pain or burning with urination?", quality: "good", category: "GYN", forFemaleReproductive: true },
                    { id: "sexual_history", text: "Are you sexually active?", quality: "excellent", category: "GYN", forFemaleReproductive: true },
                    { id: "contraception", text: "What form of contraception do you use?", quality: "excellent", category: "GYN", forFemaleReproductive: true },
                    { id: "prior_pregnancies", text: "Have you ever been pregnant before?", quality: "good", category: "GYN", forFemaleReproductive: true },
                    { id: "menstrual", text: "Tell me about your menstrual history", quality: "fair", category: "GYN", forFemalePostmenopausal: true },
                    
                    // Social History
                    { id: "nsaid_use", text: "Do you take any anti-inflammatory medications like ibuprofen or aspirin?", quality: "excellent", category: "Social", forAll: true },
                    { id: "alcohol", text: "How much alcohol do you drink?", quality: "excellent", category: "Social", forAll: true },
                    { id: "smoking", text: "Do you smoke or have you ever smoked?", quality: "good", category: "Social", forAll: true },
                    { id: "caffeine", text: "How much caffeine do you consume daily?", quality: "good", category: "Social", forAll: true },
                    { id: "recent_travel", text: "Have you traveled recently?", quality: "low-priority", category: "Social", forAll: true },
                    { id: "sick_contacts", text: "Has anyone around you been sick?", quality: "low-priority", category: "Social", forAll: true },
                    { id: "stress", text: "Have you been under any unusual stress?", quality: "fair", category: "Social", forAll: true },
                    
                    // Past Medical History
                    { id: "prior_episodes", text: "Have you had anything like this before?", quality: "good", category: "PMH", forAll: true },
                    { id: "pmh_cardiac", text: "Do you have any heart problems or high blood pressure?", quality: "excellent", category: "PMH", forAll: true },
                    { id: "pmh_gi", text: "Do you have any history of stomach problems or ulcers?", quality: "excellent", category: "PMH", forAll: true },
                    { id: "pmh_diabetes", text: "Do you have diabetes?", quality: "good", category: "PMH", forAll: true },
                    { id: "pmh_gyn", text: "Do you have any gynecologic conditions?", quality: "good", category: "PMH", forFemale: true },
                    
                    // Family History
                    { id: "family_cardiac", text: "Does anyone in your family have heart disease?", quality: "good", category: "FH", forAll: true },
                    { id: "family_gi", text: "Does anyone in your family have stomach or GI problems?", quality: "fair", category: "FH", forAll: true },
                    { id: "family_cancer", text: "Is there any cancer in your family?", quality: "fair", category: "FH", forAll: true }
                ],
                
                // Physical exam maneuvers
                physicalExamManeuvers: [
                    { id: "general_appearance", text: "Assess general appearance", quality: "excellent", category: "General", forAll: true },
                    { id: "vital_signs", text: "Review vital signs", quality: "excellent", category: "General", forAll: true },
                    { id: "cardiac_auscultation", text: "Auscultate heart", quality: "excellent", category: "Cardiac", forAll: true },
                    { id: "lung_auscultation", text: "Auscultate lungs", quality: "good", category: "Pulmonary", forAll: true },
                    { id: "abdominal_inspection", text: "Inspect abdomen", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "abdominal_auscultation", text: "Auscultate bowel sounds", quality: "good", category: "Abdominal", forAll: true },
                    { id: "epigastric_palpation", text: "Palpate epigastrium", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "ruq_palpation", text: "Palpate right upper quadrant", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "luq_palpation", text: "Palpate left upper quadrant", quality: "good", category: "Abdominal", forAll: true },
                    { id: "suprapubic_palpation", text: "Palpate suprapubic region", quality: "good", category: "Abdominal", forFemale: true },
                    { id: "llq_palpation", text: "Palpate left lower quadrant", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "rlq_palpation", text: "Palpate right lower quadrant", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "murphy_sign", text: "Check Murphy's sign", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "rebound_tenderness", text: "Check for rebound tenderness", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "guarding", text: "Assess for guarding", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "aortic_palpation", text: "Palpate for aortic pulsation", quality: "excellent", category: "Abdominal", forMale: true },
                    { id: "aortic_palpation", text: "Palpate for aortic pulsation", quality: "fair", category: "Abdominal", forFemale: true },
                    { id: "cvat", text: "Check costovertebral angle tenderness", quality: "good", category: "Back", forAll: true },
                    { id: "rectal_exam", text: "Perform rectal examination", quality: "excellent", category: "Rectal", forAll: true },
                    { id: "pelvic_exam", text: "Perform pelvic examination", quality: "excellent", category: "GYN", forFemaleReproductive: true },
                    { id: "urine_pregnancy", text: "Check urine pregnancy test", quality: "excellent", category: "GYN", forFemaleReproductive: true },
                    { id: "breast_exam", text: "Perform breast examination", quality: "fair", category: "GYN", forFemaleReproductive: true },
                    { id: "peripheral_pulses", text: "Check peripheral pulses", quality: "good", category: "Vascular", forAll: true },
                    { id: "lower_extremity_edema", text: "Check for lower extremity edema", quality: "good", category: "Vascular", forAll: true },
                    { id: "skin_exam", text: "Examine skin (jaundice, pallor)", quality: "good", category: "General", forAll: true }
                ]
            },
            
            // ==================== RLQ PAIN CASE ====================
            {
                id: "rlq-pain",
                title: "RLQ Pain",
                category: "GI/GYN",
                icon: "ðŸ”»",
                
                variants: {
                    "female-28": {
                        name: "J.M.",
                        age: 28,
                        gender: "female",
                        genderDisplay: "Female (Reproductive Age)",
                        pronouns: { subject: "she", object: "her", possessive: "her", Subject: "She", Object: "Her", Possessive: "Her" },
                        chiefComplaint: "Pain in my lower right belly since yesterday",
                        vitalSigns: "BP 112/70, HR 102, RR 18, Temp 101.2Â°F, SpO2 98%",
                        
                        initialDifferential: [
                            { name: "Appendicitis", mustNotMiss: false },
                            { name: "Ectopic Pregnancy", mustNotMiss: true },
                            { name: "Ovarian Torsion", mustNotMiss: true },
                            { name: "Ovarian Cyst Rupture", mustNotMiss: false },
                            { name: "Gastroenteritis", mustNotMiss: false },
                            { name: "Crohn's Disease", mustNotMiss: false },
                            { name: "Perforated Viscus", mustNotMiss: true },
                            { name: "Pelvic Inflammatory Disease", mustNotMiss: false }
                        ],
                        
                        historyFindings: {
                            "onset": { answer: "It started yesterday afternoon, maybe around 2 PM", displayed: false },
                            "location": { answer: "It started near my belly button, but now it's definitely down here on the right side", displayed: false },
                            "character": { answer: "At first it was dull and achy, but now it's sharp and constant", displayed: false },
                            "severity": { answer: "It's an 8 out of 10 right now. It was maybe a 4 or 5 yesterday", displayed: false },
                            "radiation": { answer: "No, it stays in that one spot on my lower right", displayed: false },
                            "timing": { answer: "It's constant now, doesn't really come and go anymore", displayed: false },
                            "aggravating": { answer: "Moving makes it worse. Coughing hurts. Even walking here was painful", displayed: false },
                            "alleviating": { answer: "Lying very still helps a little. Nothing really makes it go away", displayed: false },
                            "associated_nausea": { answer: "Yes, I've felt nauseous since last night", displayed: false },
                            "associated_vomiting": { answer: "I threw up once this morning. It wasn't bloody or anything", displayed: false },
                            "anorexia": { answer: "I haven't wanted to eat anything since yesterday. The thought of food makes me feel sick", displayed: false },
                            "fever_chills": { answer: "I felt feverish last night and had some chills. I didn't take my temperature though", displayed: false },
                            "bowel_habits": { answer: "I haven't had a bowel movement today. Yesterday I was a little constipated", displayed: false },
                            "diarrhea": { answer: "No diarrhea", displayed: false },
                            "urinary_symptoms": { answer: "No burning or frequency when I pee", displayed: false },
                            "lmp": { answer: "About 3 weeks ago. It was normal, on time", displayed: false },
                            "pregnancy_possible": { answer: "I don't think so. I'm sexually active but we use condoms every time", displayed: false },
                            "vaginal_bleeding": { answer: "No bleeding or spotting", displayed: false },
                            "vaginal_discharge": { answer: "Nothing unusual", displayed: false },
                            "sexual_history": { answer: "I'm sexually active with one partner - my boyfriend of about a year", displayed: false },
                            "contraception": { answer: "We use condoms consistently. I'm not on birth control pills or anything", displayed: false },
                            "sti_history": { answer: "I've never had an STI. I was tested about 6 months ago", displayed: false },
                            "prior_episodes": { answer: "I've never had pain like this before", displayed: false },
                            "prior_surgeries": { answer: "I've never had any surgeries", displayed: false },
                            "pmh_gi": { answer: "No history of stomach or bowel problems", displayed: false },
                            "sick_contacts": { answer: "No one around me has been sick", displayed: false },
                            "recent_travel": { answer: "No recent travel", displayed: false }
                        },
                        
                        postHistoryRefinement: {
                            "Appendicitis": { correct: "more", rationale: "Classic presentation: pain migrating from periumbilical to RLQ, anorexia, nausea/vomiting, fever, and pain worsening with movement. This is textbook appendicitis." },
                            "Ectopic Pregnancy": { correct: "less", rationale: "LMP was 3 weeks ago and normal, consistent condom use, no vaginal bleeding. While we must still rule it out with a pregnancy test, history makes this less likely." },
                            "Ovarian Torsion": { correct: "less", rationale: "Torsion typically presents with sudden, severe onset and often intermittent pain. This gradual migration pattern is more typical of appendicitis." },
                            "Ovarian Cyst Rupture": { correct: "less", rationale: "Cyst rupture usually causes sudden, sharp pain often mid-cycle. The migratory pattern and fever don't fit." },
                            "Gastroenteritis": { correct: "less", rationale: "No diarrhea, no sick contacts, localized RLQ pain rather than diffuse cramping. This doesn't fit gastroenteritis." },
                            "Crohn's Disease": { correct: "unchanged", rationale: "First episode, no chronic diarrhea or prior symptoms. Unlikely but RLQ pain can be initial presentation." },
                            "Perforated Viscus": { correct: "less", rationale: "Patient is uncomfortable but not in severe distress. No signs of peritonitis or shock yet. Keep on differential but less likely." },
                            "Pelvic Inflammatory Disease": { correct: "less", rationale: "Consistent condom use, no STI history, no vaginal discharge. PID less likely but pelvic exam will help differentiate." }
                        },
                        
                        physicalFindings: {
                            "general_appearance": { finding: "Mildly distressed, lying still, guards abdomen when moving", displayed: false },
                            "vital_signs": { finding: "BP 112/70, HR 102, RR 18, Temp 101.2Â°F, SpO2 98% on RA", displayed: false },
                            "abdominal_inspection": { finding: "Flat, no scars, no visible distension", displayed: false },
                            "abdominal_auscultation": { finding: "Hypoactive bowel sounds in all quadrants", displayed: false },
                            "rlq_palpation": { finding: "Significant tenderness at McBurney's point with voluntary guarding", displayed: false },
                            "llq_palpation": { finding: "Non-tender", displayed: false },
                            "ruq_palpation": { finding: "Non-tender", displayed: false },
                            "luq_palpation": { finding: "Non-tender", displayed: false },
                            "epigastric_palpation": { finding: "Mild tenderness, less than RLQ", displayed: false },
                            "suprapubic_palpation": { finding: "Non-tender", displayed: false },
                            "rebound_tenderness": { finding: "Positive rebound tenderness in RLQ", displayed: false },
                            "guarding": { finding: "Voluntary guarding in RLQ, no rigidity", displayed: false },
                            "rovsing_sign": { finding: "Positive - palpation of LLQ causes pain in RLQ", displayed: false },
                            "psoas_sign": { finding: "Positive - pain with right hip extension", displayed: false },
                            "obturator_sign": { finding: "Negative", displayed: false },
                            "murphy_sign": { finding: "Negative", displayed: false },
                            "cvat": { finding: "No costovertebral angle tenderness", displayed: false },
                            "pelvic_exam": { finding: "No cervical motion tenderness, no adnexal masses or tenderness, closed cervix, no discharge", displayed: false },
                            "urine_pregnancy": { finding: "NEGATIVE", displayed: false },
                            "rectal_exam": { finding: "Right-sided tenderness on rectal exam, stool guaiac negative", displayed: false }
                        },
                        
                        postPhysicalRefinement: {
                            "Appendicitis": { correct: "more", rationale: "McBurney's point tenderness, positive Rovsing's and psoas signs, rebound tenderness, and fever - this is classic acute appendicitis. Surgical consultation needed." },
                            "Ectopic Pregnancy": { correct: "ruled-out", rationale: "Negative pregnancy test definitively rules out ectopic pregnancy." },
                            "Ovarian Torsion": { correct: "less", rationale: "No adnexal tenderness or masses on pelvic exam. Negative pregnancy test. Very unlikely." },
                            "Ovarian Cyst Rupture": { correct: "less", rationale: "No adnexal findings, tenderness localized to McBurney's point rather than adnexa." },
                            "Gastroenteritis": { correct: "ruled-out", rationale: "Localized peritoneal signs (rebound, guarding) rule out simple gastroenteritis." },
                            "Crohn's Disease": { correct: "less", rationale: "Acute presentation with peritoneal signs more consistent with appendicitis. Crohn's rarely presents this acutely initially." },
                            "Perforated Viscus": { correct: "less", rationale: "No rigidity, vital signs stable, no signs of diffuse peritonitis. Localized findings suggest appendicitis not perforation." },
                            "Pelvic Inflammatory Disease": { correct: "ruled-out", rationale: "No cervical motion tenderness, no adnexal tenderness, no discharge. PID ruled out." }
                        },
                        
                        actualDiagnosis: {
                            name: "Acute Appendicitis",
                            keyFindings: [
                                "Pain migration from periumbilical to RLQ (classic presentation)",
                                "Anorexia, nausea, vomiting (in correct sequence)",
                                "Low-grade fever with tachycardia",
                                "McBurney's point tenderness with positive Rovsing's and psoas signs",
                                "Rebound tenderness indicating peritoneal irritation",
                                "Negative pregnancy test ruling out ectopic"
                            ],
                            teachingPoints: [
                                "Classic appendicitis triad: RLQ pain, anorexia, fever - but sequence matters (pain first, then anorexia, then vomiting)",
                                "Pain migration from periumbilical to RLQ occurs as inflammation extends from visceral to parietal peritoneum",
                                "McBurney's point is 1/3 the distance from ASIS to umbilicus",
                                "Rovsing's sign: LLQ palpation causes RLQ pain due to peritoneal stretch",
                                "Psoas sign positive = retrocecal appendix irritating the iliopsoas muscle",
                                "Always get pregnancy test in reproductive-age women with abdominal pain - ectopic is a must-not-miss",
                                "Appendicitis is a clinical diagnosis - imaging confirms but shouldn't delay surgical consultation"
                            ],
                            workup: [
                                "CBC with differential (expect leukocytosis with left shift)",
                                "CMP (baseline before surgery)",
                                "Urinalysis (rule out UTI, may show mild pyuria from appendiceal inflammation)",
                                "CT abdomen/pelvis with contrast (if diagnosis uncertain)",
                                "Surgical consultation for appendectomy"
                            ]
                        }
                    },
                    
                    "male-28": {
                        name: "J.M.",
                        age: 28,
                        gender: "male",
                        genderDisplay: "Male",
                        pronouns: { subject: "he", object: "him", possessive: "his", Subject: "He", Object: "Him", Possessive: "His" },
                        chiefComplaint: "Pain in my lower right belly since yesterday",
                        vitalSigns: "BP 118/74, HR 98, RR 18, Temp 101.4Â°F, SpO2 99%",
                        
                        initialDifferential: [
                            { name: "Appendicitis", mustNotMiss: false },
                            { name: "Gastroenteritis", mustNotMiss: false },
                            { name: "Crohn's Disease", mustNotMiss: false },
                            { name: "Mesenteric Adenitis", mustNotMiss: false },
                            { name: "Perforated Viscus", mustNotMiss: true },
                            { name: "Testicular Torsion (referred)", mustNotMiss: true },
                            { name: "Kidney Stone", mustNotMiss: false }
                        ],
                        
                        historyFindings: {
                            "onset": { answer: "Started yesterday afternoon around 2 PM", displayed: false },
                            "location": { answer: "It started around my belly button but moved down to the right side", displayed: false },
                            "character": { answer: "Started as a dull ache, now it's sharp and constant", displayed: false },
                            "severity": { answer: "8 out of 10 now. Was about 4 or 5 yesterday", displayed: false },
                            "radiation": { answer: "No, stays in that one spot", displayed: false },
                            "timing": { answer: "It's constant now", displayed: false },
                            "aggravating": { answer: "Moving makes it worse. Coughing really hurts", displayed: false },
                            "alleviating": { answer: "Lying still helps a little", displayed: false },
                            "associated_nausea": { answer: "Yes, I've been nauseous since last night", displayed: false },
                            "associated_vomiting": { answer: "Threw up once this morning", displayed: false },
                            "anorexia": { answer: "Haven't wanted to eat anything", displayed: false },
                            "fever_chills": { answer: "Felt feverish with some chills last night", displayed: false },
                            "bowel_habits": { answer: "Haven't had a bowel movement today, was constipated yesterday", displayed: false },
                            "diarrhea": { answer: "No diarrhea", displayed: false },
                            "urinary_symptoms": { answer: "No burning or blood in my urine", displayed: false },
                            "testicular_pain": { answer: "No pain in my testicles", displayed: false },
                            "prior_episodes": { answer: "Never had anything like this before", displayed: false },
                            "prior_surgeries": { answer: "Never had any surgeries", displayed: false },
                            "pmh_gi": { answer: "No history of GI problems", displayed: false },
                            "sick_contacts": { answer: "No one around me has been sick", displayed: false },
                            "recent_travel": { answer: "No recent travel", displayed: false }
                        },
                        
                        postHistoryRefinement: {
                            "Appendicitis": { correct: "more", rationale: "Classic presentation: periumbilical to RLQ migration, anorexia, nausea/vomiting, fever. Textbook appendicitis." },
                            "Gastroenteritis": { correct: "less", rationale: "No diarrhea, no sick contacts, localized RLQ pain. Doesn't fit gastroenteritis." },
                            "Crohn's Disease": { correct: "unchanged", rationale: "First episode, no chronic symptoms. Unlikely but possible." },
                            "Mesenteric Adenitis": { correct: "less", rationale: "No preceding viral illness, no sick contacts. Less likely." },
                            "Perforated Viscus": { correct: "less", rationale: "Not in severe distress, gradual onset. Less likely but keep on differential." },
                            "Testicular Torsion (referred)": { correct: "less", rationale: "No testicular pain. Very unlikely to be referred pain from torsion." },
                            "Kidney Stone": { correct: "less", rationale: "No flank pain, no urinary symptoms, no colicky pattern. Doesn't fit." }
                        },
                        
                        physicalFindings: {
                            "general_appearance": { finding: "Mildly distressed, lying still, guards abdomen", displayed: false },
                            "vital_signs": { finding: "BP 118/74, HR 98, RR 18, Temp 101.4Â°F, SpO2 99% on RA", displayed: false },
                            "abdominal_inspection": { finding: "Flat, no scars", displayed: false },
                            "abdominal_auscultation": { finding: "Hypoactive bowel sounds", displayed: false },
                            "rlq_palpation": { finding: "Significant tenderness at McBurney's point with guarding", displayed: false },
                            "llq_palpation": { finding: "Non-tender", displayed: false },
                            "ruq_palpation": { finding: "Non-tender", displayed: false },
                            "luq_palpation": { finding: "Non-tender", displayed: false },
                            "rebound_tenderness": { finding: "Positive rebound tenderness in RLQ", displayed: false },
                            "guarding": { finding: "Voluntary guarding in RLQ", displayed: false },
                            "rovsing_sign": { finding: "Positive - LLQ palpation causes RLQ pain", displayed: false },
                            "psoas_sign": { finding: "Positive - pain with right hip extension", displayed: false },
                            "obturator_sign": { finding: "Negative", displayed: false },
                            "cvat": { finding: "No CVA tenderness", displayed: false },
                            "testicular_exam": { finding: "Normal lie, no tenderness, no swelling bilaterally", displayed: false },
                            "rectal_exam": { finding: "Right-sided tenderness, guaiac negative", displayed: false }
                        },
                        
                        postPhysicalRefinement: {
                            "Appendicitis": { correct: "more", rationale: "McBurney's point tenderness, positive Rovsing's and psoas signs, rebound tenderness, fever - classic acute appendicitis." },
                            "Gastroenteritis": { correct: "ruled-out", rationale: "Localized peritoneal signs rule out simple gastroenteritis." },
                            "Crohn's Disease": { correct: "less", rationale: "Acute presentation with peritoneal signs more consistent with appendicitis." },
                            "Mesenteric Adenitis": { correct: "less", rationale: "Peritoneal signs and fever pattern more consistent with appendicitis." },
                            "Perforated Viscus": { correct: "less", rationale: "No rigidity, stable vitals, localized findings suggest appendicitis." },
                            "Testicular Torsion (referred)": { correct: "ruled-out", rationale: "Normal testicular exam rules this out." },
                            "Kidney Stone": { correct: "ruled-out", rationale: "No CVA tenderness, no urinary symptoms, localized peritoneal signs." }
                        },
                        
                        actualDiagnosis: {
                            name: "Acute Appendicitis",
                            keyFindings: [
                                "Pain migration from periumbilical to RLQ",
                                "Anorexia, nausea, vomiting sequence",
                                "Low-grade fever with tachycardia",
                                "McBurney's point tenderness",
                                "Positive Rovsing's and psoas signs",
                                "Rebound tenderness indicating peritoneal irritation"
                            ],
                            teachingPoints: [
                                "In males, the differential is narrower without GYN pathology but still must consider testicular torsion with referred pain",
                                "Pain migration is the most specific historical feature for appendicitis",
                                "The classic sequence: pain â†’ anorexia â†’ nausea â†’ vomiting (if vomiting precedes pain, think gastroenteritis)",
                                "Psoas sign positive suggests retrocecal appendix",
                                "Appendicitis is the most common surgical emergency"
                            ],
                            workup: [
                                "CBC with differential",
                                "CMP",
                                "Urinalysis",
                                "CT abdomen/pelvis with contrast if diagnosis uncertain",
                                "Surgical consultation for appendectomy"
                            ]
                        }
                    }
                },
                
                historyQuestions: [
                    { id: "onset", text: "When did this pain start?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "location", text: "Where exactly is the pain? Has it moved?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "character", text: "Can you describe the pain?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "severity", text: "On a scale of 1-10, how bad is the pain?", quality: "good", category: "HPI", forAll: true },
                    { id: "radiation", text: "Does the pain go anywhere else?", quality: "good", category: "HPI", forAll: true },
                    { id: "timing", text: "Is the pain constant or does it come and go?", quality: "good", category: "HPI", forAll: true },
                    { id: "aggravating", text: "What makes the pain worse?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "alleviating", text: "What makes the pain better?", quality: "good", category: "HPI", forAll: true },
                    { id: "associated_nausea", text: "Have you had any nausea?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "associated_vomiting", text: "Have you had any vomiting?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "anorexia", text: "How is your appetite? Have you wanted to eat?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "fever_chills", text: "Have you had any fever or chills?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "bowel_habits", text: "How are your bowel movements?", quality: "good", category: "Associated", forAll: true },
                    { id: "diarrhea", text: "Have you had any diarrhea?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "urinary_symptoms", text: "Any burning or blood when you urinate?", quality: "good", category: "Associated", forAll: true },
                    { id: "lmp", text: "When was your last menstrual period?", quality: "excellent", category: "GYN", forFemale: true },
                    { id: "pregnancy_possible", text: "Is there any chance you could be pregnant?", quality: "excellent", category: "GYN", forFemale: true },
                    { id: "vaginal_bleeding", text: "Have you had any vaginal bleeding or spotting?", quality: "excellent", category: "GYN", forFemale: true },
                    { id: "vaginal_discharge", text: "Any unusual vaginal discharge?", quality: "good", category: "GYN", forFemale: true },
                    { id: "sexual_history", text: "Are you sexually active?", quality: "excellent", category: "GYN", forFemale: true },
                    { id: "contraception", text: "What form of contraception do you use?", quality: "excellent", category: "GYN", forFemale: true },
                    { id: "sti_history", text: "Have you ever had a sexually transmitted infection?", quality: "good", category: "GYN", forFemale: true },
                    { id: "testicular_pain", text: "Do you have any pain in your testicles?", quality: "excellent", category: "GU", forMale: true },
                    { id: "prior_episodes", text: "Have you ever had pain like this before?", quality: "good", category: "PMH", forAll: true },
                    { id: "prior_surgeries", text: "Have you had any abdominal surgeries?", quality: "good", category: "PMH", forAll: true },
                    { id: "pmh_gi", text: "Any history of GI problems or IBD?", quality: "good", category: "PMH", forAll: true },
                    { id: "sick_contacts", text: "Has anyone around you been sick?", quality: "good", category: "Social", forAll: true },
                    { id: "recent_travel", text: "Have you traveled recently?", quality: "low-priority", category: "Social", forAll: true }
                ],
                
                physicalExamManeuvers: [
                    { id: "general_appearance", text: "Assess general appearance", quality: "excellent", category: "General", forAll: true },
                    { id: "vital_signs", text: "Review vital signs", quality: "excellent", category: "General", forAll: true },
                    { id: "abdominal_inspection", text: "Inspect abdomen", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "abdominal_auscultation", text: "Auscultate bowel sounds", quality: "good", category: "Abdominal", forAll: true },
                    { id: "rlq_palpation", text: "Palpate right lower quadrant (McBurney's point)", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "llq_palpation", text: "Palpate left lower quadrant", quality: "good", category: "Abdominal", forAll: true },
                    { id: "ruq_palpation", text: "Palpate right upper quadrant", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "luq_palpation", text: "Palpate left upper quadrant", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "epigastric_palpation", text: "Palpate epigastrium", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "suprapubic_palpation", text: "Palpate suprapubic region", quality: "good", category: "Abdominal", forFemale: true },
                    { id: "rebound_tenderness", text: "Check for rebound tenderness", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "guarding", text: "Assess for guarding/rigidity", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "rovsing_sign", text: "Check Rovsing's sign", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "psoas_sign", text: "Check psoas sign", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "obturator_sign", text: "Check obturator sign", quality: "good", category: "Abdominal", forAll: true },
                    { id: "murphy_sign", text: "Check Murphy's sign", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "cvat", text: "Check costovertebral angle tenderness", quality: "good", category: "Back", forAll: true },
                    { id: "pelvic_exam", text: "Perform pelvic examination", quality: "excellent", category: "GYN", forFemale: true },
                    { id: "urine_pregnancy", text: "Check urine pregnancy test", quality: "excellent", category: "GYN", forFemale: true },
                    { id: "testicular_exam", text: "Examine testicles", quality: "excellent", category: "GU", forMale: true },
                    { id: "rectal_exam", text: "Perform rectal examination", quality: "good", category: "Rectal", forAll: true }
                ]
            },
            
            // ==================== RUQ PAIN CASE ====================
            {
                id: "ruq-pain",
                title: "RUQ Pain",
                category: "GI/Hepatobiliary",
                icon: "ðŸŸ¡",
                
                variants: {
                    "female-38": {
                        name: "M.T.",
                        age: 38,
                        gender: "female",
                        genderDisplay: "Female",
                        pronouns: { subject: "she", object: "her", possessive: "her", Subject: "She", Object: "Her", Possessive: "Her" },
                        chiefComplaint: "Sharp pain in my upper right belly since last night",
                        vitalSigns: "BP 110/68, HR 104, RR 18, Temp 100.8Â°F, SpO2 99%",
                        
                        initialDifferential: [
                            { name: "Acute Cholecystitis", mustNotMiss: false },
                            { name: "Biliary Colic", mustNotMiss: false },
                            { name: "Ascending Cholangitis", mustNotMiss: true },
                            { name: "Hepatitis", mustNotMiss: false },
                            { name: "Liver Abscess", mustNotMiss: true },
                            { name: "Abdominal Aortic Aneurysm (AAA)", mustNotMiss: true },
                            { name: "Hepatic Congestion (CHF)", mustNotMiss: false },
                            { name: "Peptic Ulcer Disease", mustNotMiss: false }
                        ],
                        
                        historyFindings: {
                            "onset": { answer: "It started last night, about 2 hours after dinner", displayed: false },
                            "meal_relation": { answer: "I had fried chicken and fries for dinner. The pain started a couple hours after", displayed: false },
                            "character": { answer: "It started as crampy but now it's sharp and constant", displayed: false },
                            "severity": { answer: "It's about a 7 out of 10 now. Earlier it was up to a 9", displayed: false },
                            "radiation": { answer: "Yes, it goes to my right shoulder blade in the back", displayed: false },
                            "timing": { answer: "It's been constant for about 12 hours now", displayed: false },
                            "aggravating": { answer: "Deep breaths make it worse. Pressing on it hurts. I can't get comfortable", displayed: false },
                            "alleviating": { answer: "Lying still and not eating seems to help a little", displayed: false },
                            "associated_nausea": { answer: "Yes, I've been pretty nauseous", displayed: false },
                            "associated_vomiting": { answer: "I threw up once this morning", displayed: false },
                            "fever_chills": { answer: "I felt feverish last night and had some chills", displayed: false },
                            "jaundice": { answer: "I don't think so. My eyes look normal to me", displayed: false },
                            "dark_urine": { answer: "I haven't really noticed", displayed: false },
                            "pale_stools": { answer: "No, my stool looks normal", displayed: false },
                            "prior_episodes": { answer: "I've had two or three similar episodes in the past year after big meals, but they went away on their own", displayed: false },
                            "chest_pain": { answer: "No chest pain", displayed: false },
                            "sob": { answer: "No shortness of breath", displayed: false },
                            "leg_swelling": { answer: "No swelling in my legs", displayed: false },
                            "pmh": { answer: "No chronic medical conditions. I've never had surgery", displayed: false },
                            "medications": { answer: "Just birth control pills", displayed: false },
                            "family_history": { answer: "My mom had her gallbladder out when she was about 45. I'm worried it might be the same thing", displayed: false },
                            "alcohol": { answer: "Just socially, maybe 1-2 drinks a week", displayed: false },
                            "recent_travel": { answer: "No recent travel", displayed: false },
                            "diet": { answer: "I eat a lot of fried and processed foods. I know I should eat better", displayed: false }
                        },
                        
                        postHistoryRefinement: {
                            "Acute Cholecystitis": { correct: "more", rationale: "Classic presentation: RUQ pain after fatty meal, radiating to right scapula, with fever, nausea/vomiting. Prior similar episodes suggest cholelithiasis. Family history and oral contraceptives are risk factors." },
                            "Biliary Colic": { correct: "less", rationale: "Biliary colic typically resolves within 6 hours. This has been constant for 12+ hours with fever - suggests progression to cholecystitis." },
                            "Ascending Cholangitis": { correct: "unchanged", rationale: "No jaundice reported, but must keep on differential. Charcot's triad (fever, jaundice, RUQ pain) may not be complete early. This is a surgical emergency if present." },
                            "Hepatitis": { correct: "less", rationale: "Acute presentation with fatty meal trigger, radiation to scapula, prior similar episodes - not typical for hepatitis." },
                            "Liver Abscess": { correct: "less", rationale: "No risk factors (no travel, no immunocompromise, no recent infection). Clinical picture fits cholecystitis better." },
                            "Abdominal Aortic Aneurysm (AAA)": { correct: "less", rationale: "Young female, no cardiovascular risk factors, pain clearly related to meals. AAA very unlikely." },
                            "Hepatic Congestion (CHF)": { correct: "less", rationale: "No SOB, no leg swelling, no cardiac history. Doesn't fit CHF pattern." },
                            "Peptic Ulcer Disease": { correct: "less", rationale: "Location and radiation pattern more consistent with biliary pathology. No NSAID use or prior ulcer history." }
                        },
                        
                        physicalFindings: {
                            "general_appearance": { finding: "Mild distress, prefers lying still", displayed: false },
                            "vital_signs": { finding: "BP 110/68, HR 104, RR 18, Temp 100.8Â°F, SpO2 99% on RA. BMI 30.9", displayed: false },
                            "skin_eyes": { finding: "No scleral icterus, no jaundice", displayed: false },
                            "cardiac_auscultation": { finding: "Regular rate and rhythm, no murmurs, no S3/S4", displayed: false },
                            "lung_auscultation": { finding: "Clear to auscultation bilaterally", displayed: false },
                            "jvp": { finding: "JVP not elevated", displayed: false },
                            "abdominal_inspection": { finding: "Soft, non-distended, no scars", displayed: false },
                            "abdominal_auscultation": { finding: "Normoactive bowel sounds", displayed: false },
                            "ruq_palpation": { finding: "Significant tenderness in RUQ with voluntary guarding", displayed: false },
                            "murphy_sign": { finding: "POSITIVE - inspiratory arrest with RUQ palpation", displayed: false },
                            "liver_palpation": { finding: "Liver edge not enlarged, non-tender apart from gallbladder area", displayed: false },
                            "liver_percussion": { finding: "Normal liver span, approximately 10 cm in midclavicular line", displayed: false },
                            "epigastric_palpation": { finding: "Mild tenderness", displayed: false },
                            "luq_palpation": { finding: "Non-tender", displayed: false },
                            "llq_palpation": { finding: "Non-tender", displayed: false },
                            "rlq_palpation": { finding: "Non-tender", displayed: false },
                            "rebound_tenderness": { finding: "No rebound tenderness", displayed: false },
                            "aortic_palpation": { finding: "No pulsatile mass", displayed: false },
                            "lower_extremity_edema": { finding: "No peripheral edema", displayed: false }
                        },
                        
                        postPhysicalRefinement: {
                            "Acute Cholecystitis": { correct: "more", rationale: "POSITIVE Murphy's sign is highly specific for acute cholecystitis. Combined with fever, RUQ tenderness, and classic history - this is the diagnosis." },
                            "Biliary Colic": { correct: "less", rationale: "Murphy's sign positive with fever indicates inflammation beyond simple colic. This is cholecystitis." },
                            "Ascending Cholangitis": { correct: "less", rationale: "No jaundice on exam. Murphy's sign more consistent with cholecystitis. Still need labs to fully assess." },
                            "Hepatitis": { correct: "ruled-out", rationale: "No jaundice, no hepatomegaly, normal liver span. Localized RUQ/gallbladder tenderness. Not hepatitis." },
                            "Liver Abscess": { correct: "ruled-out", rationale: "No hepatomegaly, no diffuse liver tenderness. Findings localized to gallbladder." },
                            "Abdominal Aortic Aneurysm (AAA)": { correct: "ruled-out", rationale: "No pulsatile mass, young female, clinical picture clearly biliary." },
                            "Hepatic Congestion (CHF)": { correct: "ruled-out", rationale: "No JVD, no peripheral edema, no hepatomegaly. No signs of CHF." },
                            "Peptic Ulcer Disease": { correct: "less", rationale: "Murphy's sign localizes to gallbladder. PUD would have epigastric tenderness without Murphy's sign." }
                        },
                        
                        actualDiagnosis: {
                            name: "Acute Calculous Cholecystitis",
                            keyFindings: [
                                "RUQ pain radiating to right scapula after fatty meal (classic)",
                                "Pain lasting >6 hours with fever (distinguishes from biliary colic)",
                                "Prior similar self-limited episodes (suggests cholelithiasis)",
                                "Positive Murphy's sign (most specific physical exam finding)",
                                "Risk factors: female, fertile age, obesity (BMI 30.9), oral contraceptives, family history",
                                "No jaundice (argues against cholangitis)"
                            ],
                            teachingPoints: [
                                "Murphy's sign: inspiratory arrest during RUQ palpation - highly specific for cholecystitis",
                                "Classic cholecystitis = RUQ pain + fever + Murphy's sign; biliary colic = pain only, resolves <6 hours",
                                "4 F's mnemonic for gallstone risk: Female, Forty, Fertile, Fat (though all ages/genders can be affected)",
                                "Oral contraceptives increase cholesterol saturation in bile, promoting stone formation",
                                "Scapular radiation occurs due to phrenic nerve irritation (C3-5 dermatomal referred pain)",
                                "Charcot's triad (fever, jaundice, RUQ pain) = ascending cholangitis - surgical emergency",
                                "Reynolds' pentad adds confusion and hypotension - indicates septic cholangitis"
                            ],
                            workup: [
                                "RUQ ultrasound (gallstones, gallbladder wall thickening >3mm, pericholecystic fluid)",
                                "CBC (leukocytosis)",
                                "CMP with LFTs (elevated if stone in CBD)",
                                "Lipase (rule out pancreatitis)",
                                "If diagnosis uncertain: HIDA scan (gold standard for acute cholecystitis)",
                                "Surgical consultation for cholecystectomy"
                            ]
                        }
                    },
                    
                    "male-50": {
                        name: "M.T.",
                        age: 50,
                        gender: "male",
                        genderDisplay: "Male",
                        pronouns: { subject: "he", object: "him", possessive: "his", Subject: "He", Object: "Him", Possessive: "His" },
                        chiefComplaint: "Sharp pain in my upper right belly since last night",
                        vitalSigns: "BP 138/82, HR 96, RR 18, Temp 100.4Â°F, SpO2 98%",
                        
                        initialDifferential: [
                            { name: "Acute Cholecystitis", mustNotMiss: false },
                            { name: "Biliary Colic", mustNotMiss: false },
                            { name: "Ascending Cholangitis", mustNotMiss: true },
                            { name: "Hepatitis", mustNotMiss: false },
                            { name: "Liver Abscess", mustNotMiss: true },
                            { name: "Abdominal Aortic Aneurysm (AAA)", mustNotMiss: true },
                            { name: "Hepatic Congestion (CHF)", mustNotMiss: false },
                            { name: "Acute Myocardial Infarction", mustNotMiss: true }
                        ],
                        
                        historyFindings: {
                            "onset": { answer: "Started last night after a big steak dinner", displayed: false },
                            "meal_relation": { answer: "Had a ribeye with all the fixings. Pain started maybe 2 hours later", displayed: false },
                            "character": { answer: "Started as pressure, now it's sharp and constant", displayed: false },
                            "severity": { answer: "About 7 out of 10", displayed: false },
                            "radiation": { answer: "Goes to my back, between my shoulder blades on the right", displayed: false },
                            "timing": { answer: "Been constant for about 10 hours", displayed: false },
                            "aggravating": { answer: "Deep breaths, moving around", displayed: false },
                            "alleviating": { answer: "Nothing really helps", displayed: false },
                            "associated_nausea": { answer: "Yeah, pretty nauseous", displayed: false },
                            "associated_vomiting": { answer: "Threw up once", displayed: false },
                            "fever_chills": { answer: "Felt warm, had some chills", displayed: false },
                            "jaundice": { answer: "My wife said my eyes looked a little yellow this morning", displayed: false },
                            "dark_urine": { answer: "Come to think of it, my urine was darker than usual", displayed: false },
                            "pale_stools": { answer: "Didn't notice", displayed: false },
                            "chest_pain": { answer: "No chest pain", displayed: false },
                            "sob": { answer: "No trouble breathing", displayed: false },
                            "diaphoresis": { answer: "No unusual sweating", displayed: false },
                            "prior_episodes": { answer: "Had something similar once last year but it went away", displayed: false },
                            "pmh_cardiac": { answer: "I have high blood pressure and high cholesterol. Take lisinopril and a statin", displayed: false },
                            "pmh_diabetes": { answer: "No diabetes", displayed: false },
                            "alcohol": { answer: "Few beers on weekends, nothing heavy", displayed: false },
                            "smoking": { answer: "Quit 10 years ago, smoked for about 20 years before that", displayed: false }
                        },
                        
                        postHistoryRefinement: {
                            "Acute Cholecystitis": { correct: "more", rationale: "RUQ pain after fatty meal, radiation to back, prior similar episode, fever - classic cholecystitis." },
                            "Biliary Colic": { correct: "less", rationale: "Duration >6 hours with fever indicates progression beyond simple colic." },
                            "Ascending Cholangitis": { correct: "more", rationale: "CONCERNING: Wife noticed jaundice, dark urine reported. Charcot's triad may be developing (fever + jaundice + RUQ pain). This is a surgical emergency!" },
                            "Hepatitis": { correct: "less", rationale: "Acute onset after fatty meal with focal RUQ pain not typical for hepatitis." },
                            "Liver Abscess": { correct: "unchanged", rationale: "Fever present, keep on differential but biliary pathology more likely." },
                            "Abdominal Aortic Aneurysm (AAA)": { correct: "unchanged", rationale: "Age 50, HTN, smoking history are risk factors. Pain after meal argues against, but 50yo male with cardiovascular risk factors - cannot dismiss." },
                            "Hepatic Congestion (CHF)": { correct: "less", rationale: "No SOB, no edema history. Acute presentation doesn't fit CHF." },
                            "Acute Myocardial Infarction": { correct: "less", rationale: "No chest pain, no SOB, no diaphoresis. Pain clearly related to meal. Less likely but cardiac risk factors present." }
                        },
                        
                        physicalFindings: {
                            "general_appearance": { finding: "Moderate distress, diaphoretic", displayed: false },
                            "vital_signs": { finding: "BP 138/82, HR 96, RR 18, Temp 100.4Â°F, SpO2 98% on RA", displayed: false },
                            "skin_eyes": { finding: "Mild scleral icterus present", displayed: false },
                            "cardiac_auscultation": { finding: "Regular rate, no murmurs", displayed: false },
                            "lung_auscultation": { finding: "Clear bilaterally", displayed: false },
                            "jvp": { finding: "Not elevated", displayed: false },
                            "abdominal_inspection": { finding: "Soft, non-distended", displayed: false },
                            "abdominal_auscultation": { finding: "Decreased bowel sounds", displayed: false },
                            "ruq_palpation": { finding: "Marked tenderness with involuntary guarding", displayed: false },
                            "murphy_sign": { finding: "Positive with significant pain", displayed: false },
                            "liver_palpation": { finding: "Liver edge tender, slightly enlarged", displayed: false },
                            "liver_percussion": { finding: "Liver span 13 cm (mildly enlarged)", displayed: false },
                            "aortic_palpation": { finding: "No pulsatile mass appreciated", displayed: false },
                            "lower_extremity_edema": { finding: "No edema", displayed: false }
                        },
                        
                        postPhysicalRefinement: {
                            "Acute Cholecystitis": { correct: "more", rationale: "Positive Murphy's sign confirms gallbladder inflammation." },
                            "Biliary Colic": { correct: "ruled-out", rationale: "Fever, jaundice, and Murphy's sign indicate inflammation beyond colic." },
                            "Ascending Cholangitis": { correct: "more", rationale: "CHARCOT'S TRIAD PRESENT: Fever + Jaundice (scleral icterus) + RUQ pain. This patient needs urgent biliary decompression! May have cholecystitis AND cholangitis." },
                            "Hepatitis": { correct: "less", rationale: "Jaundice present but Murphy's sign and focal tenderness point to biliary obstruction, not diffuse hepatitis." },
                            "Liver Abscess": { correct: "less", rationale: "Tender liver edge but clinical picture fits cholangitis better." },
                            "Abdominal Aortic Aneurysm (AAA)": { correct: "ruled-out", rationale: "No pulsatile mass, clinical picture clearly biliary with jaundice." },
                            "Hepatic Congestion (CHF)": { correct: "ruled-out", rationale: "No JVD, no edema, no cardiac findings." },
                            "Acute Myocardial Infarction": { correct: "ruled-out", rationale: "Scleral icterus, Murphy's sign - this is biliary pathology, not cardiac." }
                        },
                        
                        actualDiagnosis: {
                            name: "Acute Cholecystitis with Possible Ascending Cholangitis",
                            keyFindings: [
                                "Charcot's triad present: Fever + Jaundice + RUQ pain",
                                "Positive Murphy's sign",
                                "Dark urine and scleral icterus suggest biliary obstruction",
                                "Mildly enlarged, tender liver",
                                "Prior similar episode suggests cholelithiasis"
                            ],
                            teachingPoints: [
                                "Charcot's triad = ascending cholangitis until proven otherwise - surgical emergency!",
                                "Reynolds' pentad (Charcot's + confusion + hypotension) = septic shock from cholangitis",
                                "In cholangitis, infection ascends from obstructed bile duct - bacteria enter bloodstream",
                                "Cholecystitis can progress to cholangitis if stone migrates to common bile duct",
                                "Jaundice + biliary pain = stone likely in CBD, not just gallbladder",
                                "This patient needs URGENT ERCP for biliary decompression",
                                "Males with biliary disease often present later/more severely than females"
                            ],
                            workup: [
                                "STAT labs: CBC, CMP with LFTs, lipase, lactate, blood cultures x2",
                                "RUQ ultrasound (look for CBD dilation, stones, wall thickening)",
                                "If CBD dilated: MRCP or ERCP",
                                "ERCP for stone extraction and biliary decompression (therapeutic)",
                                "IV antibiotics covering gram-negatives and anaerobes",
                                "Surgical consultation",
                                "Consider ICU if hemodynamically unstable"
                            ]
                        }
                    }
                },
                
                historyQuestions: [
                    { id: "onset", text: "When did this pain start?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "meal_relation", text: "What did you eat before the pain started?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "character", text: "Can you describe the pain?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "severity", text: "On a scale of 1-10, how bad is the pain?", quality: "good", category: "HPI", forAll: true },
                    { id: "radiation", text: "Does the pain go anywhere else?", quality: "excellent", category: "HPI", forAll: true },
                    { id: "timing", text: "How long has the pain lasted?", quality: "good", category: "HPI", forAll: true },
                    { id: "aggravating", text: "What makes the pain worse?", quality: "good", category: "HPI", forAll: true },
                    { id: "alleviating", text: "What makes the pain better?", quality: "good", category: "HPI", forAll: true },
                    { id: "associated_nausea", text: "Have you had any nausea?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "associated_vomiting", text: "Have you had any vomiting?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "fever_chills", text: "Have you had any fever or chills?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "jaundice", text: "Have you or anyone noticed yellowing of your skin or eyes?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "dark_urine", text: "Have you noticed dark urine?", quality: "excellent", category: "Associated", forAll: true },
                    { id: "pale_stools", text: "Have you noticed pale or clay-colored stools?", quality: "good", category: "Associated", forAll: true },
                    { id: "chest_pain", text: "Have you had any chest pain?", quality: "excellent", category: "Cardiac", forAll: true },
                    { id: "sob", text: "Have you had any shortness of breath?", quality: "excellent", category: "Cardiac", forAll: true },
                    { id: "diaphoresis", text: "Have you had any unusual sweating?", quality: "good", category: "Cardiac", forAll: true },
                    { id: "leg_swelling", text: "Have you had any leg swelling?", quality: "good", category: "Cardiac", forAll: true },
                    { id: "prior_episodes", text: "Have you had pain like this before?", quality: "excellent", category: "PMH", forAll: true },
                    { id: "pmh", text: "Do you have any medical conditions?", quality: "good", category: "PMH", forAll: true },
                    { id: "pmh_cardiac", text: "Do you have any heart problems or high blood pressure?", quality: "good", category: "PMH", forAll: true },
                    { id: "pmh_diabetes", text: "Do you have diabetes?", quality: "fair", category: "PMH", forAll: true },
                    { id: "medications", text: "What medications do you take?", quality: "good", category: "PMH", forAll: true },
                    { id: "family_history", text: "Does anyone in your family have gallbladder problems?", quality: "good", category: "FH", forAll: true },
                    { id: "alcohol", text: "How much alcohol do you drink?", quality: "good", category: "Social", forAll: true },
                    { id: "smoking", text: "Do you smoke?", quality: "fair", category: "Social", forAll: true },
                    { id: "recent_travel", text: "Have you traveled recently?", quality: "low-priority", category: "Social", forAll: true },
                    { id: "diet", text: "Tell me about your typical diet", quality: "good", category: "Social", forAll: true }
                ],
                
                physicalExamManeuvers: [
                    { id: "general_appearance", text: "Assess general appearance", quality: "excellent", category: "General", forAll: true },
                    { id: "vital_signs", text: "Review vital signs", quality: "excellent", category: "General", forAll: true },
                    { id: "skin_eyes", text: "Examine skin and eyes for jaundice", quality: "excellent", category: "General", forAll: true },
                    { id: "cardiac_auscultation", text: "Auscultate heart", quality: "good", category: "Cardiac", forAll: true },
                    { id: "lung_auscultation", text: "Auscultate lungs", quality: "good", category: "Pulmonary", forAll: true },
                    { id: "jvp", text: "Assess jugular venous pressure", quality: "good", category: "Cardiac", forAll: true },
                    { id: "abdominal_inspection", text: "Inspect abdomen", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "abdominal_auscultation", text: "Auscultate bowel sounds", quality: "good", category: "Abdominal", forAll: true },
                    { id: "ruq_palpation", text: "Palpate right upper quadrant", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "murphy_sign", text: "Check Murphy's sign", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "liver_palpation", text: "Palpate liver edge", quality: "excellent", category: "Abdominal", forAll: true },
                    { id: "liver_percussion", text: "Percuss liver span", quality: "good", category: "Abdominal", forAll: true },
                    { id: "epigastric_palpation", text: "Palpate epigastrium", quality: "good", category: "Abdominal", forAll: true },
                    { id: "luq_palpation", text: "Palpate left upper quadrant", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "llq_palpation", text: "Palpate left lower quadrant", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "rlq_palpation", text: "Palpate right lower quadrant", quality: "fair", category: "Abdominal", forAll: true },
                    { id: "rebound_tenderness", text: "Check for rebound tenderness", quality: "good", category: "Abdominal", forAll: true },
                    { id: "aortic_palpation", text: "Palpate for aortic pulsation", quality: "excellent", category: "Abdominal", forMale: true },
                    { id: "aortic_palpation", text: "Palpate for aortic pulsation", quality: "fair", category: "Abdominal", forFemale: true },
                    { id: "lower_extremity_edema", text: "Check for lower extremity edema", quality: "good", category: "Vascular", forAll: true }
                ]
            }
        ];

        // ==================== GAME STATE ====================
        let state = {
            screen: 'menu', // menu, variantSelect, case, results, profile, achievements
            mode: 'practice', // practice, game
            enhancedMode: true, // Show patient findings and differential refinement
            currentCase: null,
            currentVariant: null,
            variantKey: null,
            stage: 'differential', // differential, history, historyFindings, refinement1, physical, physicalFindings, refinement2, diagnosis
            
            // Selections
            selectedDifferential: [],
            selectedHistory: [],
            selectedPhysical: [],
            refinement1: {}, // { diagnosisName: 'more'|'less'|'unchanged'|'ruled-out' }
            refinement2: {},
            
            // Scoring
            score: 0,
            streak: 0,
            maxStreak: 0,
            stageStartTime: null,
            stageTimeRemaining: STAGE_TIME_LIMIT,
            timerInterval: null,
            
            // Player stats (persisted)
            stats: {
                totalXp: 0,
                totalPoints: 0,
                casesCompleted: 0,
                badges: [],
                caseScores: {}
            }
        };

        // ==================== UTILITY FUNCTIONS ====================
        function getStageInfo(stageName) {
            const fullStages = ['differential', 'history', 'historyFindings', 'refinement1', 'physical', 'physicalFindings', 'refinement2', 'diagnosis'];
            const basicStages = ['differential', 'history', 'physical', 'diagnosis'];
            
            const stages = state.enhancedMode ? fullStages : basicStages;
            const index = stages.indexOf(stageName);
            const total = stages.length;
            const num = index + 1;
            const progress = ((num) / total) * 100;
            
            return { num, total, progress };
        }
        
        function loadStats() {
            const saved = localStorage.getItem('clinicalReasoningStats');
            if (saved) {
                state.stats = JSON.parse(saved);
            }
        }

        function saveStats() {
            localStorage.setItem('clinicalReasoningStats', JSON.stringify(state.stats));
        }

        function getLevelInfo(xp) {
            let currentLevel = LEVELS[0];
            let nextLevel = LEVELS[1];
            
            for (let i = LEVELS.length - 1; i >= 0; i--) {
                if (xp >= LEVELS[i].xpRequired) {
                    currentLevel = LEVELS[i];
                    nextLevel = LEVELS[i + 1] || null;
                    break;
                }
            }
            
            const progress = nextLevel 
                ? ((xp - currentLevel.xpRequired) / (nextLevel.xpRequired - currentLevel.xpRequired)) * 100
                : 100;
            
            return { current: currentLevel, next: nextLevel, progress };
        }

        function getAvailableQuestions(questions, variantKey) {
            return questions.filter(q => {
                if (q.forAll) return true;
                if (q.forMale && variantKey.includes('male') && !variantKey.includes('female')) return true;
                if (q.forFemale && variantKey.includes('female')) return true;
                if (q.forFemaleReproductive && variantKey.includes('female') && (variantKey.includes('28') || variantKey.includes('38'))) return true;
                if (q.forFemalePostmenopausal && variantKey.includes('female') && variantKey.includes('58')) return true;
                return false;
            });
        }

        function showScorePopup(points, x, y) {
            if (state.mode !== 'game') return;
            
            const popup = document.createElement('div');
            popup.className = `score-popup score-pop ${points >= 0 ? 'positive' : 'negative'}`;
            popup.textContent = points >= 0 ? `+${points}` : points;
            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 800);
        }

        function startTimer() {
            if (state.mode !== 'game') return;
            
            state.stageStartTime = Date.now();
            state.stageTimeRemaining = STAGE_TIME_LIMIT;
            
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            state.timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - state.stageStartTime) / 1000);
                state.stageTimeRemaining = Math.max(0, STAGE_TIME_LIMIT - elapsed);
                
                // Update timer display
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    const mins = Math.floor(state.stageTimeRemaining / 60);
                    const secs = state.stageTimeRemaining % 60;
                    timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    timerEl.className = state.stageTimeRemaining < 60 ? 'timer-warning font-bold' : 'font-bold';
                }
                
                if (state.stageTimeRemaining <= 0) {
                    clearInterval(state.timerInterval);
                    advanceStage();
                }
            }, 1000);
        }

        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }

        // ==================== RENDER FUNCTIONS ====================
        function render() {
            const app = document.getElementById('app');
            
            switch(state.screen) {
                case 'menu':
                    app.innerHTML = renderMenu();
                    break;
                case 'variantSelect':
                    app.innerHTML = renderVariantSelect();
                    break;
                case 'case':
                    app.innerHTML = renderCase();
                    break;
                case 'results':
                    app.innerHTML = renderResults();
                    break;
                case 'profile':
                    app.innerHTML = renderProfile();
                    break;
                default:
                    app.innerHTML = renderMenu();
            }
        }

        function renderMenu() {
            const level = getLevelInfo(state.stats.totalXp);
            
            return `
                <div class="min-h-screen p-6">
                    <div class="max-w-4xl mx-auto">
                        <!-- Header -->
                        <div class="text-center mb-8 pt-8">
                            <h1 class="text-4xl font-bold text-white mb-2">ðŸ©º Clinical Reasoning Tool</h1>
                            <p class="text-blue-200">Master differential diagnosis through interactive cases</p>
                        </div>
                        
                        <!-- Settings Card -->
                        <div class="card p-6 mb-6">
                            <h3 class="font-bold text-gray-800 mb-4">âš™ï¸ Settings</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- Game Mode Toggle -->
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div class="font-semibold text-gray-800 flex items-center gap-2">
                                            ðŸŽ® Game Mode
                                        </div>
                                        <p class="text-sm text-gray-500">Timer, scoring, XP & badges</p>
                                    </div>
                                    <div class="toggle-switch ${state.mode === 'game' ? 'active' : ''}" onclick="toggleGameMode()"></div>
                                </div>
                                
                                <!-- Enhanced Features Toggle -->
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div class="font-semibold text-gray-800 flex items-center gap-2">
                                            ðŸ”¬ Enhanced Features
                                        </div>
                                        <p class="text-sm text-gray-500">Patient responses & Dx refinement</p>
                                    </div>
                                    <div class="toggle-switch ${state.enhancedMode ? 'active' : ''}" onclick="toggleEnhancedMode()"></div>
                                </div>
                            </div>
                            
                            <!-- Current Settings Summary -->
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
                                <span class="font-semibold text-blue-800">Current setup:</span>
                                <span class="text-blue-700">
                                    ${state.mode === 'game' ? 'â±ï¸ Timed with scoring' : 'ðŸ“š Self-paced practice'}
                                    ${state.enhancedMode ? ' â€¢ ðŸ”¬ See patient findings & refine differential' : ' â€¢ Standard workflow'}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Case Selection -->
                        <div class="card p-6 mb-6">
                            <h3 class="font-bold text-gray-800 mb-4">ðŸ“‹ Select a Case</h3>
                            <div class="grid md:grid-cols-3 gap-4">
                                ${CASES.map(c => `
                                    <div class="p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-all" onclick="selectCase('${c.id}')">
                                        <div class="flex items-center gap-3 mb-2">
                                            <div class="text-3xl">${c.icon}</div>
                                            <div>
                                                <h4 class="font-bold text-gray-800">${c.title}</h4>
                                                <p class="text-xs text-gray-500">${c.category}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 text-xs">
                                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded">${Object.keys(c.variants).length} variants</span>
                                            ${state.stats.caseScores[c.id] ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded">âœ“ Completed</span>' : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Stats Card -->
                        <div class="card p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-gray-800">ðŸ“Š Your Progress</h3>
                                <button onclick="showProfile()" class="text-blue-600 text-sm font-semibold hover:underline">View Profile â†’</button>
                            </div>
                            <div class="grid grid-cols-4 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-gray-800">${level.current.icon}</div>
                                    <div class="text-xs text-gray-500">${level.current.title}</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800">${state.stats.casesCompleted}</div>
                                    <div class="text-xs text-gray-500">Cases Done</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800">${state.stats.totalPoints.toLocaleString()}</div>
                                    <div class="text-xs text-gray-500">Total Points</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800">${state.stats.badges.length}</div>
                                    <div class="text-xs text-gray-500">Badges</div>
                                </div>
                            </div>
                            ${level.next ? `
                                <div class="mt-4">
                                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                                        <span>${state.stats.totalXp} XP</span>
                                        <span>${level.next.xpRequired} XP to ${level.next.title}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${level.progress}%"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Back Link -->
                        <div class="text-center">
                            <a href="index.html" class="text-blue-200 hover:text-white">â† Back to All Tools</a>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVariantSelect() {
            const caseData = CASES.find(c => c.id === state.currentCase);
            
            return `
                <div class="min-h-screen p-6">
                    <div class="max-w-3xl mx-auto">
                        <button onclick="goToMenu()" class="text-blue-200 hover:text-white mb-6 inline-block">â† Back to Menu</button>
                        
                        <div class="card p-8">
                            <div class="text-center mb-6">
                                <div class="text-5xl mb-3">${caseData.icon}</div>
                                <h1 class="text-2xl font-bold text-gray-800">${caseData.title}</h1>
                                <p class="text-gray-600">Select patient demographics</p>
                            </div>
                            
                            <div class="mb-6">
                                <p class="text-sm text-gray-500 mb-4 text-center">
                                    Patient demographics affect the differential diagnosis, available history questions, and physical exam maneuvers.
                                </p>
                            </div>
                            
                            <div class="grid gap-4 mb-6">
                                ${Object.entries(caseData.variants).map(([key, variant]) => `
                                    <div class="variant-card card p-4 ${state.variantKey === key ? 'selected' : ''}" onclick="selectVariant('${key}')">
                                        <div class="flex items-center gap-4">
                                            <div class="text-3xl">${variant.gender === 'male' ? 'ðŸ‘¨' : 'ðŸ‘©'}</div>
                                            <div class="flex-1">
                                                <div class="font-bold text-gray-800">${variant.name}, ${variant.age}-year-old ${variant.genderDisplay}</div>
                                                <div class="text-sm text-gray-600">"${variant.chiefComplaint}"</div>
                                            </div>
                                            ${state.variantKey === key ? '<div class="text-green-500 text-xl">âœ“</div>' : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button 
                                onclick="startCase()" 
                                class="w-full py-3 rounded-lg font-bold text-white ${state.variantKey ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${!state.variantKey ? 'disabled' : ''}
                            >
                                ${state.mode === 'game' ? 'ðŸŽ® Start Game' : 'ðŸ“š Start Practice'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCase() {
            const caseData = CASES.find(c => c.id === state.currentCase);
            const variant = caseData.variants[state.variantKey];
            
            let content = '';
            
            switch(state.stage) {
                case 'differential':
                    content = renderDifferentialStage(caseData, variant);
                    break;
                case 'history':
                    content = renderHistoryStage(caseData, variant);
                    break;
                case 'historyFindings':
                    content = renderHistoryFindingsStage(caseData, variant);
                    break;
                case 'refinement1':
                    content = renderRefinementStage(caseData, variant, 1);
                    break;
                case 'physical':
                    content = renderPhysicalStage(caseData, variant);
                    break;
                case 'physicalFindings':
                    content = renderPhysicalFindingsStage(caseData, variant);
                    break;
                case 'refinement2':
                    content = renderRefinementStage(caseData, variant, 2);
                    break;
                case 'diagnosis':
                    content = renderDiagnosisStage(caseData, variant);
                    break;
            }
            
            return `
                ${state.mode === 'game' ? renderHUD(caseData, variant) : renderPracticeHeader(caseData, variant)}
                <div class="max-w-4xl mx-auto p-6">
                    ${content}
                </div>
            `;
        }

        function renderHUD(caseData, variant) {
            const mins = Math.floor(state.stageTimeRemaining / 60);
            const secs = state.stageTimeRemaining % 60;
            
            return `
                <div class="game-hud">
                    <button onclick="quitCase()" class="text-white hover:text-red-300">âœ• Quit</button>
                    <div class="text-white font-semibold">${caseData.title} - ${variant.genderDisplay}</div>
                    <div class="flex items-center gap-4">
                        ${state.streak > 0 ? `<div class="text-orange-400">ðŸ”¥ ${state.streak}x</div>` : ''}
                        <div class="text-yellow-400 font-bold">${state.score} pts</div>
                        <div class="text-white">â±ï¸ <span id="timer" class="${state.stageTimeRemaining < 60 ? 'timer-warning' : ''} font-bold">${mins}:${secs.toString().padStart(2, '0')}</span></div>
                    </div>
                </div>
            `;
        }

        function renderPracticeHeader(caseData, variant) {
            return `
                <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-4">
                    <div class="max-w-4xl mx-auto flex justify-between items-center">
                        <button onclick="quitCase()" class="text-white hover:text-blue-200">â† Exit Case</button>
                        <div class="text-white font-semibold">${caseData.title} - ${variant.genderDisplay}</div>
                        <div class="text-blue-200">Practice Mode</div>
                    </div>
                </div>
            `;
        }

        function renderDifferentialStage(caseData, variant) {
            const stageInfo = getStageInfo('differential');
            
            return `
                <div class="card p-6 mb-6 fade-in">
                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-500 mb-2">
                            <span>Stage ${stageInfo.num} of ${stageInfo.total}</span>
                            <span>Initial Differential</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stageInfo.progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- Patient Info -->
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="flex items-start gap-4">
                            <div class="text-4xl">${variant.gender === 'male' ? 'ðŸ‘¨' : 'ðŸ‘©'}</div>
                            <div>
                                <h2 class="font-bold text-gray-800">${variant.name}, ${variant.age}yo ${variant.gender === 'male' ? 'M' : 'F'}</h2>
                                <p class="text-gray-700"><strong>Chief Complaint:</strong> "${variant.chiefComplaint}"</p>
                                <p class="text-gray-600 text-sm"><strong>Vitals:</strong> ${variant.vitalSigns}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-2">Generate Your Initial Differential Diagnosis</h3>
                        <p class="text-gray-600 text-sm">Based only on the chief complaint, age, and gender, select the diagnoses you want to consider. Include "must-not-miss" diagnoses!</p>
                    </div>
                    
                    <!-- Differential Options -->
                    <div class="grid gap-3 mb-6">
                        ${variant.initialDifferential.map(dx => `
                            <button 
                                class="question-btn ${state.selectedDifferential.includes(dx.name) ? 'selected' : ''}"
                                onclick="toggleDifferential('${dx.name}')"
                            >
                                <div class="flex items-center justify-between">
                                    <span>${dx.name}</span>
                                    ${state.selectedDifferential.includes(dx.name) ? '<span class="text-blue-600">âœ“</span>' : ''}
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <button 
                        onclick="advanceStage()"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold"
                    >
                        Continue to History Taking â†’
                    </button>
                </div>
            `;
        }

        function renderHistoryStage(caseData, variant) {
            const availableQuestions = getAvailableQuestions(caseData.historyQuestions, state.variantKey);
            const categories = [...new Set(availableQuestions.map(q => q.category))];
            const stageInfo = getStageInfo('history');
            
            return `
                <div class="card p-6 mb-6 fade-in">
                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-500 mb-2">
                            <span>Stage ${stageInfo.num} of ${stageInfo.total}</span>
                            <span>History Taking</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stageInfo.progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-2">Select History Questions</h3>
                        <p class="text-gray-600 text-sm">Choose the questions you would ask this patient. Focus on hypothesis-driven questions that will help narrow your differential.</p>
                    </div>
                    
                    <!-- Questions by Category -->
                    ${categories.map(cat => `
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">${cat}</h4>
                            <div class="grid gap-2">
                                ${availableQuestions.filter(q => q.category === cat).map(q => `
                                    <button 
                                        class="question-btn ${state.selectedHistory.includes(q.id) ? (state.mode === 'game' ? q.quality : 'selected') : ''}"
                                        onclick="selectHistory('${q.id}', event)"
                                        ${state.selectedHistory.includes(q.id) ? 'disabled' : ''}
                                    >
                                        <div class="flex items-center justify-between">
                                            <span>${q.text}</span>
                                            ${state.selectedHistory.includes(q.id) ? `<span class="badge badge-${q.quality === 'low-priority' ? 'low' : q.quality}">${q.quality}</span>` : ''}
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    
                    <div class="flex gap-4">
                        <button 
                            onclick="goToPreviousStage()"
                            class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-bold"
                        >
                            â† Back
                        </button>
                        <button 
                            onclick="advanceStage()"
                            class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold"
                        >
                            ${state.enhancedMode ? 'See Patient Responses â†’' : 'Continue to Physical Exam â†’'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHistoryFindingsStage(caseData, variant) {
            const availableQuestions = getAvailableQuestions(caseData.historyQuestions, state.variantKey);
            const selectedQuestions = availableQuestions.filter(q => state.selectedHistory.includes(q.id));
            const stageInfo = getStageInfo('historyFindings');
            
            return `
                <div class="card p-6 mb-6 fade-in">
                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-500 mb-2">
                            <span>Stage ${stageInfo.num} of ${stageInfo.total}</span>
                            <span>History Findings</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stageInfo.progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-2">ðŸ“‹ Patient's Responses</h3>
                        <p class="text-gray-600 text-sm">Here's what ${variant.name} told you. Review these findings carefully - you'll use them to refine your differential.</p>
                    </div>
                    
                    <!-- Findings -->
                    <div class="mb-6">
                        ${selectedQuestions.length > 0 ? selectedQuestions.map(q => `
                            <div class="finding-item slide-in">
                                <div class="font-semibold text-gray-700 text-sm">${q.text}</div>
                                <div class="text-gray-800 mt-1">"${variant.historyFindings[q.id]?.answer || 'No response available'}"</div>
                            </div>
                        `).join('') : `
                            <div class="text-center py-8 text-gray-500">
                                <p>You didn't ask any history questions.</p>
                                <p class="text-sm">In practice, you should always take a thorough history!</p>
                            </div>
                        `}
                    </div>
                    
                    <!-- Key findings summary -->
                    ${selectedQuestions.length > 0 ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-yellow-800 mb-2">ðŸ’¡ Consider these key findings:</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${getKeyHistoryFindings(variant, selectedQuestions).map(f => `<li>â€¢ ${f}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <button 
                        onclick="advanceStage()"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold"
                    >
                        Refine Your Differential â†’
                    </button>
                </div>
            `;
        }

        function renderRefinementStage(caseData, variant, refinementNumber) {
            const refinementData = refinementNumber === 1 ? variant.postHistoryRefinement : variant.postPhysicalRefinement;
            const currentRefinement = refinementNumber === 1 ? state.refinement1 : state.refinement2;
            const stageName = refinementNumber === 1 ? 'refinement1' : 'refinement2';
            const stageInfo = getStageInfo(stageName);
            const title = refinementNumber === 1 ? 'Refine Based on History' : 'Refine Based on Physical Exam';
            
            return `
                <div class="card p-6 mb-6 fade-in">
                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-500 mb-2">
                            <span>Stage ${stageInfo.num} of ${stageInfo.total}</span>
                            <span>${title}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stageInfo.progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-2">ðŸ”„ ${title}</h3>
                        <p class="text-gray-600 text-sm">Based on the ${refinementNumber === 1 ? 'history' : 'physical exam'} findings, how does each diagnosis change in likelihood?</p>
                        <p class="text-gray-500 text-xs mt-2">âš ï¸ <strong>Note:</strong> "Ruled Out" should be used rarely - history and physical exam usually shift probabilities, not definitively exclude diagnoses.</p>
                    </div>
                    
                    <!-- Diagnoses to refine -->
                    <div class="space-y-4 mb-6">
                        ${state.selectedDifferential.map(dx => `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="font-semibold text-gray-800 mb-3">${dx}</div>
                                <div class="flex flex-wrap gap-2">
                                    <button class="refine-btn more ${currentRefinement[dx] === 'more' ? 'selected' : ''}" onclick="setRefinement(${refinementNumber}, '${dx}', 'more')">
                                        â¬†ï¸ More Likely
                                    </button>
                                    <button class="refine-btn unchanged ${currentRefinement[dx] === 'unchanged' ? 'selected' : ''}" onclick="setRefinement(${refinementNumber}, '${dx}', 'unchanged')">
                                        âž¡ï¸ Unchanged
                                    </button>
                                    <button class="refine-btn less ${currentRefinement[dx] === 'less' ? 'selected' : ''}" onclick="setRefinement(${refinementNumber}, '${dx}', 'less')">
                                        â¬‡ï¸ Less Likely
                                    </button>
                                    <button class="refine-btn ruled-out ${currentRefinement[dx] === 'ruled-out' ? 'selected' : ''}" onclick="setRefinement(${refinementNumber}, '${dx}', 'ruled-out')">
                                        âŒ Ruled Out
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="flex gap-4">
                        <button 
                            onclick="goToPreviousStage()"
                            class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-bold"
                        >
                            â† Back
                        </button>
                        <button 
                            onclick="submitRefinement(${refinementNumber})"
                            class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold"
                        >
                            ${refinementNumber === 1 ? 'Continue to Physical Exam â†’' : 'See Final Diagnosis â†’'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPhysicalStage(caseData, variant) {
            const availableManeuvers = getAvailableQuestions(caseData.physicalExamManeuvers, state.variantKey);
            const categories = [...new Set(availableManeuvers.map(m => m.category))];
            const stageInfo = getStageInfo('physical');
            
            return `
                <div class="card p-6 mb-6 fade-in">
                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-500 mb-2">
                            <span>Stage ${stageInfo.num} of ${stageInfo.total}</span>
                            <span>Physical Examination</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stageInfo.progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-2">Select Physical Exam Maneuvers</h3>
                        <p class="text-gray-600 text-sm">Choose the physical exam components you would perform. Be targeted based on your differential.</p>
                    </div>
                    
                    <!-- Maneuvers by Category -->
                    ${categories.map(cat => `
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">${cat}</h4>
                            <div class="grid gap-2">
                                ${availableManeuvers.filter(m => m.category === cat).map(m => `
                                    <button 
                                        class="question-btn ${state.selectedPhysical.includes(m.id) ? (state.mode === 'game' ? m.quality : 'selected') : ''}"
                                        onclick="selectPhysical('${m.id}', event)"
                                        ${state.selectedPhysical.includes(m.id) ? 'disabled' : ''}
                                    >
                                        <div class="flex items-center justify-between">
                                            <span>${m.text}</span>
                                            ${state.selectedPhysical.includes(m.id) ? `<span class="badge badge-${m.quality === 'low-priority' ? 'low' : m.quality}">${m.quality}</span>` : ''}
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    
                    <div class="flex gap-4">
                        <button 
                            onclick="goToPreviousStage()"
                            class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-bold"
                        >
                            â† Back
                        </button>
                        <button 
                            onclick="advanceStage()"
                            class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold"
                        >
                            ${state.enhancedMode ? 'See Exam Findings â†’' : 'See Final Diagnosis â†’'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPhysicalFindingsStage(caseData, variant) {
            const availableManeuvers = getAvailableQuestions(caseData.physicalExamManeuvers, state.variantKey);
            const selectedManeuvers = availableManeuvers.filter(m => state.selectedPhysical.includes(m.id));
            const stageInfo = getStageInfo('physicalFindings');
            
            return `
                <div class="card p-6 mb-6 fade-in">
                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-500 mb-2">
                            <span>Stage ${stageInfo.num} of ${stageInfo.total}</span>
                            <span>Physical Exam Findings</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stageInfo.progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- Instructions -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-2">ðŸ©º Physical Examination Findings</h3>
                        <p class="text-gray-600 text-sm">Here are the findings from your physical exam of ${variant.name}.</p>
                    </div>
                    
                    <!-- Findings -->
                    <div class="mb-6">
                        ${selectedManeuvers.length > 0 ? selectedManeuvers.map(m => `
                            <div class="finding-item slide-in ${isSignificantFinding(variant.physicalFindings[m.id]?.finding) ? 'border-l-orange-500' : ''}">
                                <div class="font-semibold text-gray-700 text-sm">${m.text}</div>
                                <div class="text-gray-800 mt-1">${variant.physicalFindings[m.id]?.finding || 'Not performed'}</div>
                            </div>
                        `).join('') : `
                            <div class="text-center py-8 text-gray-500">
                                <p>You didn't perform any physical exam maneuvers.</p>
                                <p class="text-sm">The physical exam provides crucial diagnostic information!</p>
                            </div>
                        `}
                    </div>
                    
                    <!-- Key findings highlight -->
                    ${selectedManeuvers.length > 0 ? `
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-orange-800 mb-2">ðŸ” Significant Findings:</h4>
                            <ul class="text-sm text-orange-700 space-y-1">
                                ${getKeyPhysicalFindings(variant, selectedManeuvers).map(f => `<li>â€¢ ${f}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <button 
                        onclick="advanceStage()"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold"
                    >
                        Final Differential Refinement â†’
                    </button>
                </div>
            `;
        }

        function renderDiagnosisStage(caseData, variant) {
            // Check which must-not-miss diagnoses were included/missed
            const mustNotMissDx = variant.initialDifferential.filter(dx => dx.mustNotMiss);
            const includedMustNotMiss = mustNotMissDx.filter(dx => state.selectedDifferential.includes(dx.name));
            const missedMustNotMiss = mustNotMissDx.filter(dx => !state.selectedDifferential.includes(dx.name));
            const stageInfo = getStageInfo('diagnosis');
            
            return `
                <div class="card p-6 mb-6 fade-in">
                    <!-- Progress -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-500 mb-2">
                            <span>Stage ${stageInfo.num} of ${stageInfo.total}</span>
                            <span>Final Diagnosis</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <!-- Diagnosis Reveal -->
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">ðŸŽ¯</div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Final Diagnosis</h2>
                        <div class="bg-green-100 text-green-800 text-xl font-bold py-4 px-6 rounded-lg inline-block">
                            ${variant.actualDiagnosis.name}
                        </div>
                    </div>
                    
                    <!-- Must Not Miss Feedback -->
                    ${mustNotMissDx.length > 0 ? `
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">âš ï¸ Must-Not-Miss Diagnoses:</h3>
                            <div class="space-y-2">
                                ${mustNotMissDx.map(dx => `
                                    <div class="flex items-center gap-3 p-3 rounded-lg ${state.selectedDifferential.includes(dx.name) ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                                        <span class="${state.selectedDifferential.includes(dx.name) ? 'text-green-600' : 'text-red-600'} text-xl">
                                            ${state.selectedDifferential.includes(dx.name) ? 'âœ“' : 'âœ—'}
                                        </span>
                                        <span class="font-medium ${state.selectedDifferential.includes(dx.name) ? 'text-green-800' : 'text-red-800'}">
                                            ${dx.name}
                                        </span>
                                        <span class="text-sm ${state.selectedDifferential.includes(dx.name) ? 'text-green-600' : 'text-red-600'}">>
                                            ${state.selectedDifferential.includes(dx.name) ? 'â€” Good! You included this.' : 'â€” You missed this critical diagnosis!'}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                            ${missedMustNotMiss.length > 0 ? `
                                <p class="text-red-700 text-sm mt-3">
                                    <strong>Remember:</strong> Must-not-miss diagnoses should always be on your initial differential, even if unlikely. Missing these can have serious consequences for patients.
                                </p>
                            ` : `
                                <p class="text-green-700 text-sm mt-3">
                                    <strong>Excellent!</strong> You correctly included all must-not-miss diagnoses in your differential.
                                </p>
                            `}
                        </div>
                    ` : ''}
                    
                    <!-- Key Findings -->
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <h3 class="font-bold text-blue-800 mb-3">ðŸ”‘ Key Findings That Led to This Diagnosis:</h3>
                        <ul class="space-y-2">
                            ${variant.actualDiagnosis.keyFindings.map(f => `
                                <li class="flex items-start gap-2 text-blue-700">
                                    <span class="text-green-500 mt-1">âœ“</span>
                                    <span>${f}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <!-- Teaching Points -->
                    <div class="bg-purple-50 rounded-lg p-4 mb-6">
                        <h3 class="font-bold text-purple-800 mb-3">ðŸ“š Teaching Points:</h3>
                        <ul class="space-y-2">
                            ${variant.actualDiagnosis.teachingPoints.map(t => `
                                <li class="flex items-start gap-2 text-purple-700">
                                    <span class="text-purple-500 mt-1">â€¢</span>
                                    <span>${t}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <!-- Recommended Workup -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-bold text-gray-800 mb-3">ðŸ§ª Recommended Workup:</h3>
                        <ul class="space-y-1">
                            ${variant.actualDiagnosis.workup.map(w => `
                                <li class="text-gray-700">â€¢ ${w}</li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <button 
                        onclick="completeCase()"
                        class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold"
                    >
                        ${state.mode === 'game' ? 'See Your Results â†’' : 'Complete Case â†’'}
                    </button>
                </div>
            `;
        }

        function renderResults() {
            const caseData = CASES.find(c => c.id === state.currentCase);
            const variant = caseData.variants[state.variantKey];
            const level = getLevelInfo(state.stats.totalXp);
            
            const stars = state.score >= 1700 ? 3 : state.score >= 1200 ? 2 : state.score >= 700 ? 1 : 0;
            
            return `
                <div class="min-h-screen p-6">
                    <div class="max-w-2xl mx-auto">
                        <div class="card p-8 text-center">
                            <!-- Stars -->
                            <div class="mb-6">
                                <div class="text-6xl mb-2">
                                    ${'â­'.repeat(stars)}${'â˜†'.repeat(3-stars)}
                                </div>
                                <h1 class="text-2xl font-bold text-gray-800">Case Complete!</h1>
                                <p class="text-gray-600">${caseData.title} - ${variant.genderDisplay}</p>
                            </div>
                            
                            ${state.mode === 'game' ? `
                                <!-- Score -->
                                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-6 mb-6">
                                    <div class="text-5xl font-bold mb-2">${state.score}</div>
                                    <div class="text-blue-100">Total Points</div>
                                </div>
                                
                                <!-- Stats Grid -->
                                <div class="grid grid-cols-3 gap-4 mb-6">
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="text-xl font-bold text-gray-800">${Math.round(state.score * 0.1)}</div>
                                        <div class="text-xs text-gray-500">XP Earned</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="text-xl font-bold text-gray-800">ðŸ”¥ ${state.maxStreak}</div>
                                        <div class="text-xs text-gray-500">Best Streak</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="text-xl font-bold text-gray-800">${level.current.icon}</div>
                                        <div class="text-xs text-gray-500">${level.current.title}</div>
                                    </div>
                                </div>
                                
                                <!-- Level Progress -->
                                <div class="mb-6">
                                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                                        <span>${level.current.title}</span>
                                        <span>${level.next ? level.next.title : 'Max Level'}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${level.progress}%"></div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">${state.stats.totalXp} / ${level.next?.xpRequired || 'MAX'} XP</div>
                                </div>
                            ` : `
                                <div class="bg-green-50 rounded-lg p-4 mb-6">
                                    <p class="text-green-800">Great practice session! Review the teaching points above to reinforce your learning.</p>
                                </div>
                            `}
                            
                            <!-- Actions -->
                            <div class="flex gap-4">
                                <button onclick="goToMenu()" class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-bold">
                                    Main Menu
                                </button>
                                <button onclick="replayCase()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold">
                                    Play Again
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProfile() {
            const level = getLevelInfo(state.stats.totalXp);
            
            return `
                <div class="min-h-screen p-6">
                    <div class="max-w-2xl mx-auto">
                        <button onclick="goToMenu()" class="text-blue-200 hover:text-white mb-6 inline-block">â† Back to Menu</button>
                        
                        <div class="card p-8">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-2">${level.current.icon}</div>
                                <h1 class="text-2xl font-bold text-gray-800">${level.current.title}</h1>
                                <p class="text-gray-600">Level ${level.current.level}</p>
                            </div>
                            
                            <!-- XP Progress -->
                            <div class="mb-8">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>${state.stats.totalXp} XP</span>
                                    <span>${level.next ? `${level.next.xpRequired} XP` : 'MAX'}</span>
                                </div>
                                <div class="progress-bar h-4">
                                    <div class="progress-fill" style="width: ${level.progress}%"></div>
                                </div>
                                ${level.next ? `<p class="text-xs text-gray-500 mt-2 text-center">${level.next.xpRequired - state.stats.totalXp} XP to ${level.next.title}</p>` : ''}
                            </div>
                            
                            <!-- Stats -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <div class="text-3xl font-bold text-gray-800">${state.stats.casesCompleted}</div>
                                    <div class="text-sm text-gray-500">Cases Completed</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 text-center">
                                    <div class="text-3xl font-bold text-gray-800">${state.stats.totalPoints.toLocaleString()}</div>
                                    <div class="text-sm text-gray-500">Total Points</div>
                                </div>
                            </div>
                            
                            <!-- Badges -->
                            <h3 class="font-bold text-gray-800 mb-3">Badges Earned (${state.stats.badges.length})</h3>
                            <div class="flex flex-wrap gap-2">
                                ${state.stats.badges.length > 0 ? state.stats.badges.map(b => `
                                    <span class="badge badge-excellent">${b}</span>
                                `).join('') : '<p class="text-gray-500">No badges yet. Complete cases to earn badges!</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== HELPER FUNCTIONS ====================
        function getKeyHistoryFindings(variant, selectedQuestions) {
            const keyFindings = [];
            
            selectedQuestions.forEach(q => {
                const answer = variant.historyFindings[q.id]?.answer || '';
                const answerLower = answer.toLowerCase();
                
                // Epigastric pain findings
                if (q.id === 'nsaid_use' && answerLower.includes('daily')) {
                    keyFindings.push('Daily NSAID use - major risk factor for gastric pathology');
                }
                if (q.id === 'melena' && answerLower.includes('dark')) {
                    keyFindings.push('Dark stools reported - possible upper GI bleeding');
                }
                if (q.id === 'lmp' && answer.includes('6') && answer.includes('week')) {
                    keyFindings.push('Delayed menstrual period (6-7 weeks) - pregnancy must be considered');
                }
                if (q.id === 'pregnancy_possible' && answerLower.includes('possible')) {
                    keyFindings.push('Pregnancy is possible - requires testing');
                }
                if (q.id === 'alcohol' && (answer.includes('3-4') || answer.includes('few beers'))) {
                    keyFindings.push('Moderate-heavy alcohol use - additional GI irritant');
                }
                if (q.id === 'character' && answerLower.includes('burning')) {
                    keyFindings.push('Burning quality - suggests acid-related pathology');
                }
                if (q.id === 'aggravating' && answerLower.includes('eat')) {
                    keyFindings.push('Symptoms worse with eating - typical of gastric/esophageal pathology');
                }
                
                // RLQ pain findings
                if (q.id === 'location' && answerLower.includes('belly button') && answerLower.includes('right')) {
                    keyFindings.push('Pain migration from periumbilical to RLQ - classic for appendicitis');
                }
                if (q.id === 'anorexia' && answerLower.includes('haven\'t wanted to eat')) {
                    keyFindings.push('Anorexia present - supports appendicitis (pain â†’ anorexia â†’ vomiting sequence)');
                }
                if (q.id === 'fever_chills' && (answerLower.includes('fever') || answerLower.includes('chills'))) {
                    keyFindings.push('Fever/chills present - suggests inflammatory/infectious process');
                }
                if (q.id === 'aggravating' && answerLower.includes('mov') || answerLower.includes('cough')) {
                    keyFindings.push('Pain worse with movement/coughing - peritoneal irritation');
                }
                
                // RUQ pain findings
                if (q.id === 'meal_relation' && (answerLower.includes('fried') || answerLower.includes('fatty'))) {
                    keyFindings.push('Pain after fatty meal - classic trigger for biliary colic/cholecystitis');
                }
                if (q.id === 'radiation' && answerLower.includes('shoulder') || answerLower.includes('scapula')) {
                    keyFindings.push('Radiation to right scapula - phrenic nerve irritation (biliary pathology)');
                }
                if (q.id === 'jaundice' && answerLower.includes('yellow')) {
                    keyFindings.push('JAUNDICE PRESENT - concerning for cholangitis or CBD obstruction!');
                }
                if (q.id === 'dark_urine' && answerLower.includes('dark')) {
                    keyFindings.push('Dark urine reported - suggests biliary obstruction');
                }
                if (q.id === 'prior_episodes' && answerLower.includes('similar')) {
                    keyFindings.push('Prior similar episodes - suggests underlying cholelithiasis');
                }
            });
            
            return keyFindings.length > 0 ? keyFindings : ['Review the patient responses carefully for diagnostic clues'];
        }

        function getKeyPhysicalFindings(variant, selectedManeuvers) {
            const keyFindings = [];
            
            selectedManeuvers.forEach(m => {
                const finding = variant.physicalFindings[m.id]?.finding || '';
                const findingLower = finding.toLowerCase();
                
                // Common findings
                if (m.id === 'rectal_exam' && findingLower.includes('guaiac positive')) {
                    keyFindings.push('Guaiac positive stool - confirms GI bleeding!');
                }
                if (m.id === 'urine_pregnancy' && findingLower.includes('positive')) {
                    keyFindings.push('POSITIVE pregnancy test - critical finding!');
                }
                if (m.id === 'urine_pregnancy' && findingLower.includes('negative')) {
                    keyFindings.push('Negative pregnancy test - ectopic pregnancy ruled out');
                }
                if (m.id === 'skin_exam' && findingLower.includes('pallor')) {
                    keyFindings.push('Pallor present - possible anemia from blood loss');
                }
                
                // Epigastric findings
                if (m.id === 'epigastric_palpation' && findingLower.includes('tender')) {
                    keyFindings.push('Epigastric tenderness - localizes pathology');
                }
                if (m.id === 'murphy_sign' && findingLower.includes('negative')) {
                    keyFindings.push('Negative Murphy\'s sign - cholecystitis less likely');
                }
                if (m.id === 'pelvic_exam' && findingLower.includes('no') && findingLower.includes('tenderness')) {
                    keyFindings.push('No adnexal/cervical motion tenderness - reassuring');
                }
                
                // RLQ findings
                if (m.id === 'rlq_palpation' && findingLower.includes('mcburney')) {
                    keyFindings.push('McBurney\'s point tenderness - classic for appendicitis');
                }
                if (m.id === 'rovsing_sign' && findingLower.includes('positive')) {
                    keyFindings.push('Positive Rovsing\'s sign - peritoneal irritation in RLQ');
                }
                if (m.id === 'psoas_sign' && findingLower.includes('positive')) {
                    keyFindings.push('Positive psoas sign - suggests retrocecal appendix');
                }
                if (m.id === 'rebound_tenderness' && findingLower.includes('positive')) {
                    keyFindings.push('Rebound tenderness present - peritoneal inflammation');
                }
                if (m.id === 'pelvic_exam' && findingLower.includes('no cervical motion tenderness')) {
                    keyFindings.push('No CMT - PID less likely');
                }
                
                // RUQ findings
                if (m.id === 'murphy_sign' && findingLower.includes('positive')) {
                    keyFindings.push('POSITIVE Murphy\'s sign - highly specific for cholecystitis');
                }
                if (m.id === 'skin_eyes' && findingLower.includes('icterus')) {
                    keyFindings.push('SCLERAL ICTERUS - Charcot\'s triad component, consider cholangitis!');
                }
                if (m.id === 'liver_palpation' && findingLower.includes('enlarged')) {
                    keyFindings.push('Hepatomegaly - may indicate hepatic congestion or hepatitis');
                }
                if (m.id === 'jvp' && findingLower.includes('elevated')) {
                    keyFindings.push('Elevated JVP - suggests right heart failure/hepatic congestion');
                }
            });
            
            return keyFindings.length > 0 ? keyFindings : ['No major abnormalities detected on exam'];
        }

        function isSignificantFinding(finding) {
            if (!finding) return false;
            const significant = ['positive', 'tender', 'abnormal', 'mass', 'guaiac', 'pallor', 'edema'];
            return significant.some(s => finding.toLowerCase().includes(s));
        }

        // ==================== EVENT HANDLERS ====================
        function selectMode(mode) {
            state.mode = mode;
            render();
        }

        function toggleGameMode() {
            state.mode = state.mode === 'game' ? 'practice' : 'game';
            render();
        }

        function toggleEnhancedMode() {
            state.enhancedMode = !state.enhancedMode;
            render();
        }

        function selectCase(caseId) {
            state.currentCase = caseId;
            state.screen = 'variantSelect';
            state.variantKey = null;
            render();
        }

        function selectVariant(key) {
            state.variantKey = key;
            render();
        }

        function startCase() {
            if (!state.variantKey) return;
            
            const caseData = CASES.find(c => c.id === state.currentCase);
            state.currentVariant = caseData.variants[state.variantKey];
            state.screen = 'case';
            state.stage = 'differential';
            state.selectedDifferential = [];
            state.selectedHistory = [];
            state.selectedPhysical = [];
            state.refinement1 = {};
            state.refinement2 = {};
            state.score = 0;
            state.streak = 0;
            state.maxStreak = 0;
            
            if (state.mode === 'game') {
                startTimer();
            }
            
            render();
        }

        function toggleDifferential(name) {
            if (state.selectedDifferential.includes(name)) {
                state.selectedDifferential = state.selectedDifferential.filter(d => d !== name);
            } else {
                state.selectedDifferential.push(name);
            }
            render();
        }

        function selectHistory(id, event) {
            if (state.selectedHistory.includes(id)) return;
            
            state.selectedHistory.push(id);
            
            if (state.mode === 'game') {
                const caseData = CASES.find(c => c.id === state.currentCase);
                const question = caseData.historyQuestions.find(q => q.id === id);
                const points = POINTS[question.quality] || 0;
                
                if (question.quality === 'low-priority') {
                    state.streak = 0;
                } else {
                    state.streak++;
                    state.maxStreak = Math.max(state.maxStreak, state.streak);
                }
                
                const streakBonus = question.quality !== 'low-priority' ? Math.min(state.streak, POINTS.maxStreakMultiplier) * POINTS.streakBonus : 0;
                const totalPoints = points + streakBonus;
                state.score += totalPoints;
                
                showScorePopup(totalPoints, event.clientX, event.clientY);
            }
            
            render();
        }

        function selectPhysical(id, event) {
            if (state.selectedPhysical.includes(id)) return;
            
            state.selectedPhysical.push(id);
            
            if (state.mode === 'game') {
                const caseData = CASES.find(c => c.id === state.currentCase);
                const maneuver = getAvailableQuestions(caseData.physicalExamManeuvers, state.variantKey).find(m => m.id === id);
                const points = POINTS[maneuver.quality] || 0;
                
                if (maneuver.quality === 'low-priority') {
                    state.streak = 0;
                } else {
                    state.streak++;
                    state.maxStreak = Math.max(state.maxStreak, state.streak);
                }
                
                const streakBonus = maneuver.quality !== 'low-priority' ? Math.min(state.streak, POINTS.maxStreakMultiplier) * POINTS.streakBonus : 0;
                const totalPoints = points + streakBonus;
                state.score += totalPoints;
                
                showScorePopup(totalPoints, event.clientX, event.clientY);
            }
            
            render();
        }

        function setRefinement(refinementNumber, diagnosis, value) {
            if (refinementNumber === 1) {
                state.refinement1[diagnosis] = value;
            } else {
                state.refinement2[diagnosis] = value;
            }
            render();
        }

        function submitRefinement(refinementNumber) {
            const caseData = CASES.find(c => c.id === state.currentCase);
            const variant = caseData.variants[state.variantKey];
            const refinementData = refinementNumber === 1 ? variant.postHistoryRefinement : variant.postPhysicalRefinement;
            const studentRefinement = refinementNumber === 1 ? state.refinement1 : state.refinement2;
            
            if (state.mode === 'game') {
                // Score the refinement
                state.selectedDifferential.forEach(dx => {
                    const correct = refinementData[dx]?.correct;
                    const student = studentRefinement[dx];
                    
                    if (student && correct) {
                        if (student === correct) {
                            state.score += POINTS.refinementCorrect;
                        } else if (student === 'ruled-out' && correct !== 'ruled-out') {
                            // Penalty for incorrect ruled-out
                            state.score += POINTS.incorrectRuledOut;
                        } else if ((student === 'more' && correct === 'less') || (student === 'less' && correct === 'more')) {
                            // Wrong direction
                            state.score += POINTS.refinementIncorrect;
                        } else {
                            // Partial credit for close answers
                            state.score += POINTS.refinementPartial;
                        }
                    }
                });
            }
            
            // Show feedback briefly then advance
            advanceStage();
        }

        function advanceStage() {
            // Full stages with enhanced features
            const fullStages = ['differential', 'history', 'historyFindings', 'refinement1', 'physical', 'physicalFindings', 'refinement2', 'diagnosis'];
            // Basic stages without enhanced features
            const basicStages = ['differential', 'history', 'physical', 'diagnosis'];
            
            const stages = state.enhancedMode ? fullStages : basicStages;
            const currentIndex = stages.indexOf(state.stage);
            
            if (currentIndex < stages.length - 1) {
                state.stage = stages[currentIndex + 1];
                if (state.mode === 'game' && ['history', 'physical'].includes(state.stage)) {
                    startTimer();
                }
            }
            
            render();
        }

        function goToPreviousStage() {
            const fullStages = ['differential', 'history', 'historyFindings', 'refinement1', 'physical', 'physicalFindings', 'refinement2', 'diagnosis'];
            const basicStages = ['differential', 'history', 'physical', 'diagnosis'];
            
            const stages = state.enhancedMode ? fullStages : basicStages;
            const currentIndex = stages.indexOf(state.stage);
            
            if (currentIndex > 0) {
                state.stage = stages[currentIndex - 1];
            }
            
            render();
        }

        function completeCase() {
            stopTimer();
            
            // Update stats
            if (state.mode === 'game') {
                const xpEarned = Math.round(state.score * 0.1);
                state.stats.totalXp += xpEarned;
                state.stats.totalPoints += state.score;
            }
            state.stats.casesCompleted++;
            saveStats();
            
            state.screen = 'results';
            render();
        }

        function quitCase() {
            stopTimer();
            state.screen = 'menu';
            render();
        }

        function goToMenu() {
            stopTimer();
            state.screen = 'menu';
            render();
        }

        function showProfile() {
            state.screen = 'profile';
            render();
        }

        function replayCase() {
            state.screen = 'variantSelect';
            state.variantKey = null;
            render();
        }

        // ==================== INITIALIZATION ====================
        loadStats();
        render();
    </script>
</body>
</html>
