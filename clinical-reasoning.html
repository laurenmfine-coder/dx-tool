<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Reasoning Trainer v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            min-height: 100vh;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.5s ease;
        }
        
        /* Diagnosis cards for categorization */
        .dx-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 16px;
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }
        
        .dx-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .dx-card.selected-likely {
            border-color: #22c55e;
            background: #f0fdf4;
            border-left: 4px solid #22c55e;
        }
        
        .dx-card.selected-must-not-miss {
            border-color: #ef4444;
            background: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        
        /* Category drop zones */
        .category-zone {
            min-height: 120px;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }
        
        .category-zone.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .category-zone.likely {
            border-color: #86efac;
            background: #f0fdf4;
        }
        
        .category-zone.must-not-miss {
            border-color: #fca5a5;
            background: #fef2f2;
        }
        
        /* Question/Exam buttons */
        .selection-btn {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .selection-btn:hover:not(.selected):not(:disabled) {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .selection-btn.selected {
            border-color: #3b82f6;
            background: #dbeafe;
        }
        
        .selection-btn:disabled {
            opacity: 0.7;
            cursor: default;
        }
        
        /* Feedback badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-essential { background: #dcfce7; color: #166534; }
        .badge-helpful { background: #dbeafe; color: #1e40af; }
        .badge-neutral { background: #f3f4f6; color: #4b5563; }
        .badge-low-yield { background: #fef3c7; color: #92400e; }
        
        /* Score display */
        .score-ring {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        /* Narrative box */
        .narrative-box {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
            border: 2px solid #facc15;
            border-radius: 12px;
            padding: 20px;
            font-style: italic;
            line-height: 1.6;
        }
        
        /* Workup categories */
        .workup-category {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .workup-category-header {
            background: #f1f5f9;
            padding: 12px 16px;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }
        
        /* Thinking prompt */
        .thinking-prompt {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border: 2px solid #c084fc;
            border-radius: 12px;
            padding: 16px;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .category-zones-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto"></div>
    
    <script>
    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    
    const state = {
        screen: 'menu', // menu, case-select, differential, history, physical, revised-differential, workup, results, summary
        mode: null, // 'practice' or 'quiz'
        caseType: null,
        variantKey: null,
        
        // Differential stage
        selectedLikely: [],
        selectedMustNotMiss: [],
        differentialSubmitted: false,
        
        // History stage
        oldcartsViewed: false,
        selectedHistory: [],
        historySubmitted: false,
        
        // Physical exam stage
        selectedPhysical: [],
        physicalSubmitted: false,
        
        // Revised differential
        revisedLikely: [],
        revisedMustNotMiss: [],
        revisedSubmitted: false,
        differentialNotes: '',
        
        // Workup stage
        selectedWorkup: [],
        workupSubmitted: false,
        
        // Scoring
        scores: {
            differential: 0,
            history: 0,
            physical: 0,
            revisedDifferential: 0,
            workup: 0
        },
        bonuses: {
            mustNotMiss: false,
            selfCorrection: false,
            efficiency: false
        }
    };
    
    // ============================================================
    // SCORING CONFIGURATION
    // ============================================================
    
    const SCORING = {
        weights: {
            differential: 15,
            history: 20,
            physical: 15,
            revisedDifferential: 25,
            workup: 25
        },
        bonuses: {
            mustNotMiss: 5,
            selfCorrection: 5,
            efficiency: 5
        }
    };
    
    // ============================================================
    // CASE DATA
    // ============================================================
    
    const cases = [
        // ==================== EPIGASTRIC PAIN ====================
        {
            id: "epigastric",
            title: "Epigastric Pain",
            category: "GI",
            icon: "ðŸ”¥",
            
            variants: {
                "male-58-nsaid": {
                    name: "R.H.",
                    age: 58,
                    gender: "male",
                    chiefComplaint: "Burning stomach pain for 3 days",
                    vitalSigns: {
                        BP: "145/88",
                        HR: 78,
                        RR: 16,
                        Temp: "98.6Â°F",
                        SpO2: "98%"
                    },
                    
                    // All possible diagnoses (no absurd ones, but includes unlikely)
                    allDiagnoses: [
                        // Correct categorizations for this case
                        { name: "Peptic Ulcer Disease", correctCategory: "likely", rationale: "Daily NSAID use is a major risk factor. Burning epigastric pain with dark stools suggests possible bleeding ulcer." },
                        { name: "Gastritis", correctCategory: "likely", rationale: "NSAIDs, alcohol, and coffee are all gastric irritants. Burning epigastric pain fits well." },
                        { name: "GERD", correctCategory: "likely", rationale: "Burning epigastric pain worse after eating is classic for GERD. High caffeine intake is a risk factor." },
                        
                        { name: "Acute Coronary Syndrome", correctCategory: "must-not-miss", rationale: "58-year-old male with HTN and smoking history. Epigastric pain CAN be anginal equivalent. Must rule out!" },
                        { name: "Aortic Dissection", correctCategory: "must-not-miss", rationale: "HTN and smoking history are risk factors. Can present with epigastric pain. Look for tearing quality." },
                        { name: "Perforated Ulcer", correctCategory: "must-not-miss", rationale: "With daily NSAID use, perforation is a serious risk. Would present with acute peritonitis." },
                        
                        // Less likely but reasonable
                        { name: "Acute Pancreatitis", correctCategory: "less-likely", rationale: "Alcohol use is a risk factor, but gradual onset and burning quality without radiation to back is less typical." },
                        { name: "Biliary Colic", correctCategory: "less-likely", rationale: "Pain worse after eating could fit, but burning quality and lack of RUQ focus is atypical." },
                        { name: "Cholecystitis", correctCategory: "less-likely", rationale: "Would expect RUQ pain with Murphy's sign. Epigastric location is possible but less classic." },
                        { name: "Esophageal Spasm", correctCategory: "less-likely", rationale: "Can cause chest/epigastric pain but usually associated with dysphagia." },
                        { name: "Gastroparesis", correctCategory: "less-likely", rationale: "Usually in diabetics. Presents with nausea/vomiting and early satiety more than pain." },
                        { name: "Functional Dyspepsia", correctCategory: "less-likely", rationale: "Diagnosis of exclusion. Dark stools suggest organic pathology that needs investigation." }
                    ],
                    
                    // OLDCARTS narrative (given upfront)
                    oldcartsNarrative: `"The pain started about 3 days ago. It's right here in my upper stomach area, kind of burning. I'd say it's about a 6 out of 10. It gets worse after I eat, especially spicy foods, and when I lie down at night. Tums help a little but it keeps coming back. I've also noticed my stools have been darker than usual - almost black. I take ibuprofen every day for my back pain - have for years. I drink a couple beers most nights and probably too much coffee. I smoke about half a pack a day. My doctor told me I have high blood pressure but I ran out of my medication a few weeks ago."`,
                    
                    // Additional history questions (beyond OLDCARTS)
                    historyQuestions: [
                        // Essential - directly impacts differential
                        { id: "melena_details", text: "Can you describe the dark stools more? Are they tarry or sticky?", 
                          answer: "Yeah, they're really dark, almost like tar, and kind of sticky. Started maybe 2 days ago.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis"], 
                          reasoning: "Confirms melena - indicates upper GI bleeding, strongly supports PUD/gastritis with NSAID use" },
                        
                        { id: "chest_pain", text: "Any chest pain, pressure, or discomfort?",
                          answer: "No, it's really just in my stomach area. No chest pressure.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome"],
                          reasoning: "Helps rule out ACS as cause of epigastric pain" },
                        
                        { id: "exertional_symptoms", text: "Does the pain come on with exertion or walking?",
                          answer: "No, it's not related to activity at all. Mostly after eating.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome"],
                          reasoning: "Lack of exertional component argues against cardiac etiology" },
                        
                        { id: "radiation", text: "Does the pain go anywhere else - to your back, jaw, arm?",
                          answer: "No, it stays right here in my stomach.",
                          tier: "essential", linkedDx: ["Aortic Dissection", "Acute Pancreatitis", "Acute Coronary Syndrome"],
                          reasoning: "No radiation to back argues against dissection and pancreatitis; no arm/jaw radiation against ACS" },
                        
                        { id: "nsaid_details", text: "How much ibuprofen do you take and how often?",
                          answer: "Usually 600mg, three or four times a day. Been doing that for probably 5 years for my back.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis", "Perforated Ulcer"],
                          reasoning: "High-dose chronic NSAID use dramatically increases risk of peptic ulcer disease and complications" },
                        
                        { id: "sudden_onset", text: "Did the pain come on suddenly or gradually?",
                          answer: "It kind of built up over a few days. Wasn't sudden.",
                          tier: "essential", linkedDx: ["Perforated Ulcer", "Aortic Dissection"],
                          reasoning: "Gradual onset argues against perforation (usually sudden, severe) and dissection" },
                        
                        { id: "prior_ulcer", text: "Have you ever had an ulcer or GI bleeding before?",
                          answer: "Not that I know of. Never had a scope or anything.",
                          tier: "helpful", linkedDx: ["Peptic Ulcer Disease"],
                          reasoning: "Prior history would increase suspicion, but absence doesn't rule out first episode" },
                        
                        { id: "vomiting_blood", text: "Have you vomited any blood or material that looks like coffee grounds?",
                          answer: "No vomiting at all, actually.",
                          tier: "helpful", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "No hematemesis, but melena still indicates upper GI bleed" },
                        
                        { id: "lightheaded", text: "Have you felt lightheaded, dizzy, or like you might pass out?",
                          answer: "Maybe a little when I stand up fast, but nothing too bad.",
                          tier: "helpful", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "Orthostatic symptoms suggest significant blood loss - important for determining urgency" },
                        
                        { id: "weight_loss", text: "Have you had any unintentional weight loss?",
                          answer: "No, weight's been stable.",
                          tier: "helpful", linkedDx: ["Gastric Cancer"],
                          reasoning: "Weight loss would raise concern for malignancy" },
                        
                        { id: "dysphagia", text: "Any trouble swallowing?",
                          answer: "No, swallowing is fine.",
                          tier: "helpful", linkedDx: ["Esophageal Spasm", "Gastric Cancer"],
                          reasoning: "Dysphagia would suggest esophageal pathology or mass effect" },
                        
                        { id: "family_history", text: "Any family history of stomach problems, ulcers, or stomach cancer?",
                          answer: "My dad had an ulcer years ago but I don't think anyone had cancer.",
                          tier: "neutral", linkedDx: ["Peptic Ulcer Disease"],
                          reasoning: "Family history is less directly relevant than modifiable risk factors in this case" },
                        
                        { id: "stress", text: "Have you been under a lot of stress lately?",
                          answer: "Work's been stressful but nothing crazy.",
                          tier: "neutral", linkedDx: ["Functional Dyspepsia"],
                          reasoning: "Stress can contribute but dark stools point to organic pathology" },
                        
                        { id: "recent_travel", text: "Any recent travel?",
                          answer: "No, haven't been anywhere.",
                          tier: "low-yield", linkedDx: [],
                          reasoning: "Not relevant to this presentation" },
                        
                        { id: "sick_contacts", text: "Anyone around you been sick?",
                          answer: "No.",
                          tier: "low-yield", linkedDx: [],
                          reasoning: "Not relevant to this non-infectious presentation" }
                    ],
                    
                    // Physical exam options (comprehensive)
                    physicalExam: [
                        // Vital signs review
                        { id: "vitals_review", text: "Review vital signs in detail", category: "Vitals",
                          finding: "BP 145/88 (no orthostatic drop checked yet), HR 78 regular, RR 16, Temp 98.6Â°F, SpO2 98% RA",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Vital signs are fundamental to any assessment" },
                        
                        { id: "orthostatics", text: "Check orthostatic vital signs", category: "Vitals",
                          finding: "Lying: BP 145/88, HR 78. Standing: BP 128/76, HR 96. Patient feels slightly dizzy on standing.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "Orthostatic changes suggest significant volume loss from GI bleeding - important for management urgency" },
                        
                        // General
                        { id: "general", text: "General appearance assessment", category: "General",
                          finding: "Alert, oriented, appears mildly uncomfortable. Slightly pale. No acute distress.",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "General appearance provides important context for acuity" },
                        
                        // Cardiovascular
                        { id: "cardiac_auscultation", text: "Auscultate heart sounds", category: "Cardiovascular",
                          finding: "Regular rate and rhythm, no murmurs, rubs, or gallops.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome"],
                          reasoning: "Cardiac exam important given age and risk factors" },
                        
                        { id: "peripheral_pulses", text: "Check peripheral pulses", category: "Cardiovascular",
                          finding: "2+ radial, DP, and PT pulses bilaterally. No pulse deficits.",
                          tier: "helpful", linkedDx: ["Aortic Dissection"],
                          reasoning: "Pulse deficits could suggest dissection" },
                        
                        { id: "bp_both_arms", text: "Check blood pressure in both arms", category: "Cardiovascular",
                          finding: "Right arm: 145/88, Left arm: 142/86. No significant difference.",
                          tier: "helpful", linkedDx: ["Aortic Dissection"],
                          reasoning: "BP differential >20 mmHg can indicate dissection" },
                        
                        { id: "jvd", text: "Assess jugular venous distension", category: "Cardiovascular",
                          finding: "No JVD, estimated CVP normal.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Less relevant to primary GI presentation" },
                        
                        // Abdominal
                        { id: "abd_inspection", text: "Inspect abdomen", category: "Abdominal",
                          finding: "Soft, non-distended, no visible masses or pulsations. No surgical scars.",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Abdominal inspection is part of complete exam" },
                        
                        { id: "abd_auscultation", text: "Auscultate bowel sounds", category: "Abdominal",
                          finding: "Normoactive bowel sounds in all four quadrants.",
                          tier: "helpful", linkedDx: ["Perforated Ulcer"],
                          reasoning: "Absent bowel sounds could suggest perforation/peritonitis" },
                        
                        { id: "abd_palpation_light", text: "Light palpation of abdomen", category: "Abdominal",
                          finding: "Mild tenderness in epigastric region. No guarding or rigidity. No masses.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis", "Perforated Ulcer"],
                          reasoning: "Epigastric tenderness supports upper GI pathology; absence of guarding argues against perforation" },
                        
                        { id: "abd_palpation_deep", text: "Deep palpation of abdomen", category: "Abdominal",
                          finding: "Epigastric tenderness to deep palpation. No rebound. No hepatomegaly or splenomegaly.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "Confirms localized tenderness without peritoneal signs" },
                        
                        { id: "murphy_sign", text: "Murphy's sign", category: "Abdominal",
                          finding: "Negative - no increased pain or inspiratory arrest with RUQ palpation.",
                          tier: "helpful", linkedDx: ["Cholecystitis"],
                          reasoning: "Helps rule out cholecystitis" },
                        
                        { id: "aorta_palpation", text: "Palpate for aortic pulsation", category: "Abdominal",
                          finding: "No pulsatile mass. Cannot appreciate widened aorta.",
                          tier: "helpful", linkedDx: ["Aortic Dissection"],
                          reasoning: "Palpable pulsatile mass would suggest AAA/dissection" },
                        
                        { id: "rebound_guarding", text: "Check for rebound tenderness and guarding", category: "Abdominal",
                          finding: "No rebound tenderness. No involuntary guarding. No rigidity.",
                          tier: "essential", linkedDx: ["Perforated Ulcer"],
                          reasoning: "Absence of peritoneal signs argues strongly against perforation" },
                        
                        // Rectal
                        { id: "rectal_exam", text: "Digital rectal exam with guaiac", category: "Rectal",
                          finding: "No masses. Stool is black and tarry. Guaiac POSITIVE.",
                          tier: "essential", linkedDx: ["Peptic Ulcer Disease", "Gastritis"],
                          reasoning: "CRITICAL FINDING - confirms GI bleeding (melena), establishes diagnosis of upper GI bleed" },
                        
                        // Other
                        { id: "skin_exam", text: "Examine skin for pallor, petechiae", category: "Skin",
                          finding: "Mildly pale. Conjunctivae slightly pale. No petechiae, no jaundice.",
                          tier: "helpful", linkedDx: ["Peptic Ulcer Disease"],
                          reasoning: "Pallor suggests anemia from blood loss" },
                        
                        { id: "lung_exam", text: "Auscultate lungs", category: "Pulmonary",
                          finding: "Clear to auscultation bilaterally. No wheezes, rales, or rhonchi.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Baseline assessment, less directly relevant" },
                        
                        { id: "neuro_exam", text: "Brief neurological exam", category: "Neurological",
                          finding: "Alert, oriented x3. No focal deficits. Cranial nerves intact.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Baseline assessment" },
                        
                        { id: "extremities", text: "Examine extremities", category: "Extremities",
                          finding: "No edema, no cyanosis, no clubbing.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Baseline assessment" }
                    ],
                    
                    // Workup options
                    workupOptions: {
                        labs: [
                            { id: "cbc", name: "CBC", 
                              result: "WBC 9.2, Hgb 9.8 (LOW), Hct 29.4%, Plt 245",
                              tier: "essential", reasoning: "Hemoglobin confirms significant blood loss - patient is anemic" },
                            { id: "bmp", name: "BMP (Basic Metabolic Panel)",
                              result: "Na 140, K 4.1, Cl 102, CO2 24, BUN 42 (HIGH), Cr 1.1, Glucose 118",
                              tier: "essential", reasoning: "Elevated BUN with normal Cr (BUN:Cr >20:1) suggests upper GI bleed" },
                            { id: "lipase", name: "Lipase",
                              result: "45 U/L (normal)",
                              tier: "helpful", reasoning: "Rules out pancreatitis" },
                            { id: "lfts", name: "Liver Function Tests",
                              result: "AST 28, ALT 32, Alk Phos 78, T.Bili 0.8 - all normal",
                              tier: "helpful", reasoning: "Normal LFTs reduce concern for hepatobiliary pathology" },
                            { id: "troponin", name: "Troponin",
                              result: "< 0.01 ng/mL (normal)",
                              tier: "essential", reasoning: "Rules out myocardial infarction - important given age and risk factors" },
                            { id: "ekg", name: "ECG/EKG",
                              result: "Normal sinus rhythm, rate 78. No ST changes, no Q waves. Normal intervals.",
                              tier: "essential", reasoning: "Rules out acute ischemic changes" },
                            { id: "type_screen", name: "Type and Screen",
                              result: "Type O positive. Antibody screen negative.",
                              tier: "essential", reasoning: "Essential preparation in case transfusion is needed" },
                            { id: "coags", name: "PT/INR, PTT",
                              result: "PT 12.1, INR 1.0, PTT 28 - all normal",
                              tier: "helpful", reasoning: "Normal coagulation - not on anticoagulants, no coagulopathy" },
                            { id: "lactate", name: "Lactate",
                              result: "1.8 mmol/L (normal)",
                              tier: "helpful", reasoning: "Normal lactate suggests adequate tissue perfusion despite bleeding" }
                        ],
                        imaging: [
                            { id: "cxr", name: "Chest X-ray",
                              result: "No acute cardiopulmonary process. No free air under diaphragm.",
                              tier: "helpful", reasoning: "Rules out perforation (no free air) and provides cardiac silhouette" },
                            { id: "upright_abd", name: "Upright Abdominal X-ray",
                              result: "No free air. Non-specific bowel gas pattern.",
                              tier: "helpful", reasoning: "Can detect free air from perforation" },
                            { id: "ct_abd", name: "CT Abdomen/Pelvis with contrast",
                              result: "Not immediately indicated",
                              tier: "less-helpful", reasoning: "EGD is preferred for diagnosis and potential treatment of upper GI bleed" },
                            { id: "ruq_us", name: "RUQ Ultrasound",
                              result: "Gallbladder normal, no stones, no wall thickening. CBD not dilated.",
                              tier: "neutral", reasoning: "Low suspicion for biliary pathology, but reasonable if considering" }
                        ],
                        procedures: [
                            { id: "ngt", name: "Nasogastric tube placement and lavage",
                              result: "Aspirate is dark ('coffee ground') material. Does not clear with lavage.",
                              tier: "helpful", reasoning: "Confirms upper GI source, helps risk-stratify. Coffee grounds = older blood in stomach." },
                            { id: "iv_access", name: "Establish large-bore IV access (2 large-bore IVs)",
                              result: "Two 18-gauge IVs placed successfully.",
                              tier: "essential", reasoning: "Essential for resuscitation in GI bleeding" },
                            { id: "foley", name: "Foley catheter",
                              result: "Placed. Initial output 200 mL clear yellow urine.",
                              tier: "helpful", reasoning: "Monitors urine output during resuscitation" }
                        ],
                        treatments: [
                            { id: "ivf", name: "IV fluid resuscitation (crystalloid)",
                              result: "1L NS bolus initiated.",
                              tier: "essential", reasoning: "Volume resuscitation is critical in GI bleeding with orthostatic changes" },
                            { id: "ppi_iv", name: "IV Proton Pump Inhibitor (e.g., pantoprazole)",
                              result: "Pantoprazole 80mg IV bolus given, drip initiated.",
                              tier: "essential", reasoning: "High-dose IV PPI reduces rebleeding risk in peptic ulcer disease" },
                            { id: "hold_nsaids", name: "Discontinue NSAIDs",
                              result: "Patient counseled. Ibuprofen stopped.",
                              tier: "essential", reasoning: "Removing the offending agent is critical" },
                            { id: "transfuse", name: "Transfuse PRBCs",
                              result: "Transfusion threshold not yet met (Hgb 9.8), but Type & Screen ready.",
                              tier: "helpful", reasoning: "Not immediately needed with Hgb 9.8, but prepared" },
                            { id: "antiemetic", name: "Antiemetic (ondansetron)",
                              result: "Given for comfort.",
                              tier: "neutral", reasoning: "Symptomatic treatment, not addressing primary issue" },
                            { id: "pain_med", name: "Pain medication",
                              result: "Consider carefully - avoid NSAIDs. Small dose IV acetaminophen given.",
                              tier: "neutral", reasoning: "Symptomatic, but avoid NSAIDs" }
                        ],
                        consults: [
                            { id: "gi_consult", name: "GI Consult for EGD",
                              result: "GI consulted. Plan for EGD within 24 hours given hemodynamic stability.",
                              tier: "essential", reasoning: "EGD is diagnostic AND therapeutic for upper GI bleed" },
                            { id: "surgery_consult", name: "Surgery Consult",
                              result: "Not immediately indicated.",
                              tier: "less-helpful", reasoning: "Surgery is rarely needed for PUD; EGD can treat most bleeding ulcers" },
                            { id: "cards_consult", name: "Cardiology Consult",
                              result: "Not indicated - troponin and ECG normal.",
                              tier: "less-helpful", reasoning: "No evidence of cardiac pathology" }
                        ],
                        disposition: [
                            { id: "admit_icu", name: "Admit to ICU",
                              result: "Consider based on stability.",
                              tier: "neutral", reasoning: "Patient is hemodynamically stable with only mild orthostatics - floor admission reasonable" },
                            { id: "admit_floor", name: "Admit to Medicine floor with telemetry",
                              result: "Appropriate level of care.",
                              tier: "essential", reasoning: "Appropriate for stable GI bleed requiring monitoring and EGD" },
                            { id: "admit_obs", name: "Observation unit",
                              result: "Not appropriate.",
                              tier: "less-helpful", reasoning: "Active GI bleeding with anemia requires full admission" },
                            { id: "discharge", name: "Discharge home",
                              result: "Not appropriate.",
                              tier: "inappropriate", reasoning: "Cannot discharge active GI bleed with anemia" }
                        ]
                    },
                    
                    // Actual diagnosis and key teaching
                    actualDiagnosis: {
                        name: "NSAID-induced Peptic Ulcer Disease with Upper GI Bleeding",
                        keyFindings: [
                            "Chronic high-dose NSAID use (major risk factor)",
                            "Melena (black, tarry stools) confirmed on exam",
                            "Guaiac positive stool",
                            "Anemia (Hgb 9.8)",
                            "Elevated BUN:Cr ratio (classic for upper GI bleed)",
                            "Orthostatic vital signs",
                            "Normal cardiac workup rules out ACS"
                        ],
                        teachingPoints: [
                            "NSAIDs inhibit prostaglandins that protect gastric mucosa - chronic use significantly increases ulcer and bleeding risk",
                            "Melena indicates upper GI source (blood oxidized during transit); >100mL blood needed to produce melena",
                            "BUN:Cr ratio >20:1 suggests upper GI bleed (blood protein is digested and absorbed)",
                            "Always check orthostatic vitals in suspected GI bleed - more sensitive than resting vitals for significant blood loss",
                            "In a 58-year-old male with HTN and smoking, MUST rule out cardiac causes of epigastric pain despite GI symptoms",
                            "EGD is both diagnostic and therapeutic - can identify and treat bleeding ulcers"
                        ]
                    }
                }
            }
        },
        
        // ==================== GI BLEED (BRBPR) ====================
        {
            id: "gi-bleed",
            title: "GI Bleed",
            category: "GI",
            icon: "ðŸ©¸",
            
            variants: {
                "adult-46-hemorrhoids": {
                    name: "A. Price",
                    age: 46,
                    gender: "neutral",
                    chiefComplaint: "Blood on toilet paper",
                    vitalSigns: {
                        BP: "118/75",
                        HR: 72,
                        RR: 16,
                        Temp: "97.5Â°F",
                        SpO2: "99%"
                    },
                    
                    allDiagnoses: [
                        { name: "Hemorrhoids", correctCategory: "likely", rationale: "Bright red blood on toilet paper after straining with constipation is classic. Very common cause of BRBPR." },
                        { name: "Anal Fissure", correctCategory: "likely", rationale: "Constipation with straining can cause mucosal tears. Usually painful with defecation." },
                        { name: "Diverticular Bleeding", correctCategory: "likely", rationale: "Age 46 with constipation. Diverticulosis can cause painless BRBPR." },
                        
                        { name: "Colorectal Cancer", correctCategory: "must-not-miss", rationale: "CRITICAL: Any rectal bleeding needs cancer consideration. Family history is key risk factor." },
                        { name: "Inflammatory Bowel Disease", correctCategory: "must-not-miss", rationale: "UC and Crohn's can present with rectal bleeding. Look for diarrhea, abdominal pain." },
                        { name: "Ischemic Colitis", correctCategory: "must-not-miss", rationale: "Can present with bloody diarrhea, especially in patients with vascular risk factors." },
                        
                        { name: "Rectal Polyp", correctCategory: "less-likely", rationale: "Can cause intermittent bleeding. Would need colonoscopy to evaluate." },
                        { name: "Angiodysplasia", correctCategory: "less-likely", rationale: "More common in elderly. Can cause painless bleeding." },
                        { name: "Infectious Colitis", correctCategory: "less-likely", rationale: "Usually has diarrhea, fever, sick contacts." },
                        { name: "Solitary Rectal Ulcer", correctCategory: "less-likely", rationale: "Associated with straining and rectal prolapse." },
                        { name: "Proctitis", correctCategory: "less-likely", rationale: "Could be infectious, radiation, or IBD-related." }
                    ],
                    
                    oldcartsNarrative: `"I noticed blood on the toilet paper yesterday after I had a bowel movement. It was bright red, and there was some blood coating the outside of the stool too - the water in the toilet was light pink. It doesn't hurt when I go, but I've been straining a lot because I've been constipated for about 3 months now. I used to go every day, but now it's maybe every 3-4 days. My job changed about 4 months ago - I'm a flight attendant now so I'm traveling a lot and eating airport food, not drinking enough water. I haven't noticed this before. Oh, and my father had colon cancer when he was 50."`,
                    
                    historyQuestions: [
                        { id: "family_cancer_details", text: "Tell me more about your father's colon cancer - how old was he? Is he still alive?",
                          answer: "He was 50 when they found it. He had surgery and chemo. He's still alive, thank God, but it was a close call.",
                          tier: "essential", linkedDx: ["Colorectal Cancer"],
                          reasoning: "First-degree relative with CRC before age 60 significantly increases risk. Patient should have started screening at 40 (10 years before father's diagnosis)." },
                        
                        { id: "colonoscopy_history", text: "Have you ever had a colonoscopy?",
                          answer: "No, never. I know I probably should have with my dad's history but I kept putting it off.",
                          tier: "essential", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Critical - patient with family history has never been screened. This is a major gap." },
                        
                        { id: "blood_mixed", text: "Is the blood mixed into the stool or just on the outside/paper?",
                          answer: "Just on the outside and on the paper. The stool itself looks brown.",
                          tier: "essential", linkedDx: ["Hemorrhoids", "Anal Fissure", "Colorectal Cancer"],
                          reasoning: "Blood on surface suggests distal source (anorectal). Blood mixed throughout raises concern for more proximal pathology." },
                        
                        { id: "pain_with_bm", text: "Any pain when you have a bowel movement?",
                          answer: "No pain really, just uncomfortable straining.",
                          tier: "helpful", linkedDx: ["Anal Fissure"],
                          reasoning: "Fissures typically cause significant pain with defecation. Painless bleeding more consistent with hemorrhoids." },
                        
                        { id: "weight_loss", text: "Have you had any unintentional weight loss?",
                          answer: "No, weight has been stable.",
                          tier: "essential", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Weight loss would be a red flag for malignancy" },
                        
                        { id: "appetite_changes", text: "Any changes in appetite?",
                          answer: "No, eating normally.",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Decreased appetite could suggest malignancy" },
                        
                        { id: "abdominal_pain", text: "Any abdominal pain or cramping?",
                          answer: "No, no belly pain.",
                          tier: "helpful", linkedDx: ["Inflammatory Bowel Disease", "Ischemic Colitis"],
                          reasoning: "IBD and ischemic colitis typically have abdominal pain" },
                        
                        { id: "diarrhea", text: "Any diarrhea or loose stools?",
                          answer: "No, opposite problem - I'm constipated.",
                          tier: "helpful", linkedDx: ["Inflammatory Bowel Disease", "Infectious Colitis"],
                          reasoning: "IBD usually presents with diarrhea. Constipation pattern here." },
                        
                        { id: "fatigue", text: "Have you been feeling tired or weak?",
                          answer: "Maybe a little more tired with the travel, but nothing major.",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Fatigue from anemia could indicate chronic blood loss" },
                        
                        { id: "other_family", text: "Any other family members with colon problems or cancer?",
                          answer: "Not that I know of, just my dad.",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Additional family history would further increase risk" },
                        
                        { id: "dietary_fiber", text: "How's your fiber intake? Fruits, vegetables, whole grains?",
                          answer: "Honestly pretty bad. Lots of packaged snacks and fast food with travel.",
                          tier: "neutral", linkedDx: ["Hemorrhoids"],
                          reasoning: "Low fiber contributes to constipation and hemorrhoids" },
                        
                        { id: "hydration", text: "How much water do you drink?",
                          answer: "Probably not enough. Maybe 2-3 cups a day.",
                          tier: "neutral", linkedDx: ["Hemorrhoids"],
                          reasoning: "Dehydration contributes to constipation" }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_review", text: "Review vital signs", category: "Vitals",
                          finding: "BP 118/75, HR 72, RR 16, Temp 97.5Â°F, SpO2 99% - all stable",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Stable vitals indicate no significant acute blood loss" },
                        
                        { id: "general", text: "General appearance", category: "General",
                          finding: "Well-appearing, no acute distress, no pallor",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "No signs of significant blood loss or systemic illness" },
                        
                        { id: "abd_palpation", text: "Abdominal palpation", category: "Abdominal",
                          finding: "Soft, non-tender, non-distended. No masses. No hepatomegaly.",
                          tier: "essential", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Looking for masses, organomegaly" },
                        
                        { id: "rectal_external", text: "External perianal inspection", category: "Rectal",
                          finding: "No external hemorrhoids visible. No fissures. No skin tags. No masses.",
                          tier: "essential", linkedDx: ["Hemorrhoids", "Anal Fissure"],
                          reasoning: "Looking for external hemorrhoids, fissures" },
                        
                        { id: "digital_rectal", text: "Digital rectal examination", category: "Rectal",
                          finding: "Internal hemorrhoids palpated. No masses within reach of finger. Stool in vault is brown with streaks of bright red blood. Guaiac positive.",
                          tier: "essential", linkedDx: ["Hemorrhoids", "Colorectal Cancer"],
                          reasoning: "CRITICAL - confirms internal hemorrhoids but DRE has limited reach. Cancer cannot be ruled out without colonoscopy." },
                        
                        { id: "anoscopy", text: "Anoscopy (if available)", category: "Rectal",
                          finding: "Grade II internal hemorrhoids at 3 and 7 o'clock positions with evidence of recent bleeding.",
                          tier: "helpful", linkedDx: ["Hemorrhoids"],
                          reasoning: "Directly visualizes hemorrhoids" },
                        
                        { id: "skin_pallor", text: "Assess for pallor", category: "Skin",
                          finding: "No pallor of skin or conjunctivae",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Pallor would suggest anemia from chronic blood loss" },
                        
                        { id: "lymph_nodes", text: "Lymph node examination", category: "Lymph",
                          finding: "No cervical, supraclavicular, axillary, or inguinal lymphadenopathy",
                          tier: "helpful", linkedDx: ["Colorectal Cancer"],
                          reasoning: "Lymphadenopathy could suggest metastatic disease" },
                        
                        { id: "abd_auscultation", text: "Auscultate bowel sounds", category: "Abdominal",
                          finding: "Normal bowel sounds",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Baseline assessment" },
                        
                        { id: "liver_stigmata", text: "Check for stigmata of liver disease", category: "General",
                          finding: "No spider angiomata, no palmar erythema, no jaundice, no ascites",
                          tier: "neutral", linkedDx: [],
                          reasoning: "Rule out varices from portal hypertension" }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "cbc", name: "CBC",
                              result: "WBC 7.5, Hgb 14.2 (normal), Hct 42%, Plt 220",
                              tier: "helpful", reasoning: "Normal hemoglobin - no significant chronic blood loss" },
                            { id: "bmp", name: "BMP",
                              result: "All values normal",
                              tier: "neutral", reasoning: "Baseline, but not specifically indicated" },
                            { id: "iron_studies", name: "Iron studies",
                              result: "Ferritin 85, Iron 90, TIBC 320 - all normal",
                              tier: "neutral", reasoning: "Can detect iron deficiency from chronic blood loss, but Hgb normal" }
                        ],
                        imaging: [
                            { id: "colonoscopy", name: "Colonoscopy",
                              result: "URGENT - to be scheduled",
                              tier: "essential", reasoning: "CRITICAL - Must be done to rule out colorectal cancer given family history and symptoms. Cannot assume hemorrhoids without full evaluation." },
                            { id: "ct_colonography", name: "CT Colonography",
                              result: "Alternative if colonoscopy not tolerated",
                              tier: "neutral", reasoning: "Less preferred - cannot biopsy if lesion found" },
                            { id: "flex_sig", name: "Flexible sigmoidoscopy",
                              result: "Would only evaluate distal colon",
                              tier: "less-helpful", reasoning: "Incomplete evaluation - right-sided cancers would be missed" }
                        ],
                        procedures: [
                            { id: "anoscopy_proc", name: "Anoscopy in clinic",
                              result: "Confirms internal hemorrhoids",
                              tier: "helpful", reasoning: "Can visualize hemorrhoids but doesn't evaluate for proximal pathology" }
                        ],
                        treatments: [
                            { id: "fiber_supplement", name: "Fiber supplementation",
                              result: "Psyllium recommended",
                              tier: "helpful", reasoning: "Addresses constipation contributing to hemorrhoids" },
                            { id: "stool_softener", name: "Stool softener (docusate)",
                              result: "Given for symptom relief",
                              tier: "helpful", reasoning: "Reduces straining" },
                            { id: "topical_tx", name: "Topical hemorrhoid treatment",
                              result: "OTC preparation H or similar",
                              tier: "helpful", reasoning: "Symptomatic relief while awaiting colonoscopy" },
                            { id: "hydration_counseling", name: "Hydration and dietary counseling",
                              result: "Counseled on increasing water and fiber",
                              tier: "helpful", reasoning: "Addresses underlying cause" }
                        ],
                        consults: [
                            { id: "gi_colonoscopy", name: "GI referral for colonoscopy",
                              result: "URGENT referral placed given family history",
                              tier: "essential", reasoning: "Colonoscopy is mandatory given family history of CRC" },
                            { id: "colorectal_surgery", name: "Colorectal surgery referral",
                              result: "Not indicated until colonoscopy complete",
                              tier: "less-helpful", reasoning: "Premature without tissue diagnosis" }
                        ],
                        disposition: [
                            { id: "outpatient", name: "Outpatient follow-up with urgent colonoscopy",
                              result: "Appropriate disposition",
                              tier: "essential", reasoning: "Stable patient with urgent outpatient colonoscopy need" },
                            { id: "admit", name: "Admit for inpatient colonoscopy",
                              result: "Not necessary - patient is stable",
                              tier: "less-helpful", reasoning: "No hemodynamic instability to warrant admission" }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Internal Hemorrhoids (Colonoscopy REQUIRED to Rule Out Colorectal Cancer)",
                        keyFindings: [
                            "Bright red blood on toilet paper and coating stool - suggests distal source",
                            "Internal hemorrhoids palpated on DRE",
                            "3-month history of constipation with straining",
                            "CRITICAL: Father had colon cancer at age 50",
                            "Patient never had colonoscopy despite family history",
                            "Normal hemoglobin, stable vitals - no acute blood loss"
                        ],
                        teachingPoints: [
                            "NEVER assume 'just hemorrhoids' without considering colorectal cancer, especially with family history",
                            "First-degree relative with CRC before age 60 = start screening 10 years before their diagnosis age, or age 40, whichever is earlier",
                            "This patient should have had first colonoscopy at age 40 (10 years before father's diagnosis at 50)",
                            "Hemorrhoids can coexist with colorectal cancer - finding hemorrhoids does NOT rule out cancer",
                            "BRBPR (bright red blood per rectum) usually indicates distal source but doesn't guarantee benign etiology",
                            "Every patient with rectal bleeding and family history of CRC needs colonoscopy regardless of suspected hemorrhoids"
                        ]
                    }
                }
            }
        },
        
        // ==================== CHEST PAIN ====================
        {
            id: "chest-pain",
            title: "Chest Pain",
            category: "Cardiovascular",
            icon: "ðŸ’”",
            
            variants: {
                "diabetic-58": {
                    name: "J. Quincy",
                    age: 58,
                    gender: "neutral",
                    chiefComplaint: "Chest discomfort for two weeks",
                    vitalSigns: {
                        BP: "136/86",
                        HR: 94,
                        RR: 18,
                        Temp: "98.4Â°F",
                        SpO2: "97%"
                    },
                    
                    allDiagnoses: [
                        { name: "Acute Coronary Syndrome / Unstable Angina", correctCategory: "likely", rationale: "Diabetic patient with exertional chest pressure, radiation to shoulder/jaw, increasing frequency. Classic for ACS despite atypical 'burning' quality." },
                        { name: "Stable Angina", correctCategory: "likely", rationale: "Exertional chest discomfort relieved by rest fits stable angina, but worsening pattern suggests progression to unstable." },
                        { name: "GERD", correctCategory: "likely", rationale: "Burning quality, relation to meals, partial antacid relief. However, must rule out cardiac cause first in this risk profile." },
                        
                        { name: "Acute Myocardial Infarction", correctCategory: "must-not-miss", rationale: "CRITICAL: 58yo diabetic with HTN, worsening exertional symptoms. Diabetics often present atypically - must have low threshold for ACS workup." },
                        { name: "Aortic Dissection", correctCategory: "must-not-miss", rationale: "HTN is a risk factor. Look for tearing pain to back, BP asymmetry, pulse deficits. Less likely given gradual onset but must consider." },
                        { name: "Pulmonary Embolism", correctCategory: "must-not-miss", rationale: "Recent long flight is a risk factor. Look for pleuritic pain, dyspnea, tachycardia, hypoxia." },
                        
                        { name: "Musculoskeletal Chest Pain", correctCategory: "less-likely", rationale: "Not reproducible with palpation, no trauma history. Less likely but could coexist." },
                        { name: "Esophageal Spasm", correctCategory: "less-likely", rationale: "Can mimic cardiac pain but usually associated with dysphagia." },
                        { name: "Pericarditis", correctCategory: "less-likely", rationale: "Would expect sharp, pleuritic pain improved leaning forward. No recent viral illness." },
                        { name: "Panic/Anxiety Disorder", correctCategory: "less-likely", rationale: "Diagnosis of exclusion. Never assume anxiety without ruling out organic causes, especially in high-risk patients." },
                        { name: "Pneumothorax", correctCategory: "less-likely", rationale: "Would expect sudden onset, pleuritic pain, dyspnea. No trauma or risk factors." }
                    ],
                    
                    oldcartsNarrative: `"It's not exactly pain, more like a pressure or tightness that comes and goes. Started about two weeks ago. It's right in the center of my chest, kind of burning or squeezing. At first I thought it was just indigestion because it sometimes happened after big meals. But lately it's happening when I walk up stairs or carry groceries - even without eating. It lasts about 5-10 minutes and goes away when I rest. Sometimes it spreads to my left shoulder and jaw. I get a little short of breath and tired when it happens. I've had some acid reflux before but this feels different - stronger. My dad had a heart attack in his 60s. I have diabetes - been on metformin for 10 years - and high blood pressure. I take lisinopril but sometimes forget. Work has been stressful lately."`,
                    
                    historyQuestions: [
                        { id: "exertion_pattern", text: "Does the discomfort come on with physical activity or exertion?",
                          answer: "Yes, lately it happens even with light activity like walking across the parking lot. It used to only happen after big meals.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome / Unstable Angina", "Stable Angina"],
                          reasoning: "Exertional chest discomfort in a diabetic with risk factors is highly concerning for ischemia. Worsening exertional threshold suggests unstable angina." },
                        
                        { id: "rest_relief", text: "Does rest relieve the discomfort?",
                          answer: "Yes, it usually goes away within a few minutes if I stop and sit down.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome / Unstable Angina", "Stable Angina"],
                          reasoning: "Relief with rest is classic for angina. Suggests demand ischemia." },
                        
                        { id: "radiation", text: "Does the pain go anywhere else - to your arm, jaw, neck, or back?",
                          answer: "Sometimes it spreads to my left shoulder and up toward my jaw. Not to my back.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome / Unstable Angina", "Aortic Dissection"],
                          reasoning: "Radiation to left arm/jaw is classic for cardiac ischemia. Absence of back radiation argues against dissection." },
                        
                        { id: "worsening_pattern", text: "Has the frequency or intensity changed over time?",
                          answer: "Definitely getting worse. Started maybe once or twice a week, now it's almost every day, and with less and less activity.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome / Unstable Angina"],
                          reasoning: "CRITICAL: Crescendo pattern (increasing frequency with decreasing exertion threshold) defines unstable angina. This is a high-risk feature." },
                        
                        { id: "diaphoresis", text: "Do you get sweaty or clammy when this happens?",
                          answer: "No, I don't really get sweaty with it.",
                          tier: "helpful", linkedDx: ["Acute Myocardial Infarction"],
                          reasoning: "Diaphoresis often accompanies MI. Absence doesn't rule it out, especially in diabetics who may have atypical presentations." },
                        
                        { id: "diabetes_control", text: "How well controlled is your diabetes?",
                          answer: "My last A1c was around 8. I try to watch what I eat but it's hard with my schedule.",
                          tier: "helpful", linkedDx: ["Acute Coronary Syndrome / Unstable Angina"],
                          reasoning: "Suboptimal diabetes control (A1c 8) increases cardiovascular risk. Diabetics may have silent ischemia or atypical presentations." },
                        
                        { id: "nitro_response", text: "Have you ever taken nitroglycerin for chest pain?",
                          answer: "No, I've never been prescribed that. I don't even know what that is really.",
                          tier: "helpful", linkedDx: ["Stable Angina"],
                          reasoning: "No prior angina diagnosis or treatment. This appears to be new-onset symptoms." },
                        
                        { id: "recent_travel", text: "Any recent long trips or periods of immobility?",
                          answer: "Actually, I flew home from visiting my daughter about 3 weeks ago - about a 5-hour flight.",
                          tier: "essential", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "Recent long flight is a VTE risk factor. Must consider PE in differential, though presentation is more consistent with ACS." },
                        
                        { id: "leg_symptoms", text: "Any leg pain, swelling, or warmth?",
                          answer: "No, my legs feel fine.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "No DVT symptoms, but PE can occur without obvious DVT. Doesn't rule out PE but lowers suspicion slightly." },
                        
                        { id: "pleuritic", text: "Is the pain sharp or worse with deep breaths?",
                          answer: "No, it's not sharp and breathing doesn't really affect it.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism", "Pericarditis", "Pneumothorax"],
                          reasoning: "Non-pleuritic pain argues against PE, pericarditis, and pneumothorax." },
                        
                        { id: "reproducible", text: "Can you reproduce the pain by pressing on your chest?",
                          answer: "No, pressing on it doesn't make it worse.",
                          tier: "helpful", linkedDx: ["Musculoskeletal Chest Pain"],
                          reasoning: "Non-reproducible pain argues against musculoskeletal cause." },
                        
                        { id: "family_history", text: "Any family history of heart disease?",
                          answer: "My dad had a heart attack when he was in his sixties.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome / Unstable Angina"],
                          reasoning: "Positive family history of premature CAD significantly increases risk." },
                        
                        { id: "smoking", text: "Do you smoke or have you ever smoked?",
                          answer: "I quit about 5 years ago, but I smoked for probably 20 years before that.",
                          tier: "helpful", linkedDx: ["Acute Coronary Syndrome / Unstable Angina"],
                          reasoning: "20 pack-year history is a significant cardiovascular risk factor." },
                        
                        { id: "medications", text: "What medications are you currently taking?",
                          answer: "Metformin for diabetes, lisinopril for blood pressure - though I sometimes forget to take it. And ibuprofen sometimes for aches.",
                          tier: "helpful", linkedDx: ["Acute Coronary Syndrome / Unstable Angina"],
                          reasoning: "Not on aspirin or statin. Suboptimal BP control (sometimes forgets lisinopril) adds to risk." }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_review", text: "Review vital signs in detail", category: "Vitals",
                          finding: "BP 136/86, HR 94 regular, RR 18, Temp 98.4Â°F, SpO2 97% RA. BP in right arm: 136/86, left arm: 134/84 - no significant difference.",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Mildly elevated BP and HR. No BP asymmetry argues against dissection." },
                        
                        { id: "general", text: "General appearance assessment", category: "General",
                          finding: "Alert, mildly anxious, no acute distress. Not diaphoretic. Slightly overweight.",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "No signs of cardiogenic shock or severe distress. Overweight adds to CV risk profile." },
                        
                        { id: "cardiac_auscultation", text: "Auscultate heart sounds at all areas", category: "Cardiovascular",
                          finding: "Regular rate and rhythm. Normal S1, S2. No S3 or S4 gallop. No murmurs. No pericardial friction rub.",
                          tier: "essential", linkedDx: ["Acute Coronary Syndrome / Unstable Angina", "Aortic Dissection"],
                          reasoning: "No new murmur (would raise concern for papillary muscle dysfunction or dissection). No friction rub (argues against pericarditis)." },
                        
                        { id: "pmi", text: "Palpate PMI and precordium", category: "Cardiovascular",
                          finding: "PMI at 5th intercostal space, midclavicular line. No heaves or thrills. No displaced PMI.",
                          tier: "helpful", linkedDx: ["Acute Coronary Syndrome / Unstable Angina"],
                          reasoning: "Non-displaced PMI suggests no chronic cardiomegaly." },
                        
                        { id: "carotid_exam", text: "Examine carotid pulses", category: "Cardiovascular",
                          finding: "Carotid pulses 2+ bilaterally, symmetric. No bruits. Normal upstroke.",
                          tier: "helpful", linkedDx: ["Aortic Dissection"],
                          reasoning: "Symmetric pulses argue against dissection. No bruits." },
                        
                        { id: "peripheral_pulses", text: "Check all peripheral pulses", category: "Cardiovascular",
                          finding: "Radial, brachial, femoral, popliteal, DP, PT pulses all 2+ and symmetric bilaterally. No radial-femoral delay.",
                          tier: "essential", linkedDx: ["Aortic Dissection"],
                          reasoning: "Symmetric pulses throughout strongly argue against aortic dissection." },
                        
                        { id: "jvp", text: "Assess jugular venous pressure", category: "Cardiovascular",
                          finding: "JVP not elevated (approximately 7 cm H2O). No hepatojugular reflux.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "Normal JVP argues against right heart strain from large PE." },
                        
                        { id: "lung_exam", text: "Auscultate lungs", category: "Pulmonary",
                          finding: "Clear to auscultation bilaterally. No wheezes, crackles, or rhonchi. Good air movement throughout.",
                          tier: "essential", linkedDx: ["Pulmonary Embolism", "Pneumothorax"],
                          reasoning: "Clear lungs are common in PE (can't rule it out). Symmetric breath sounds argue against pneumothorax." },
                        
                        { id: "chest_wall", text: "Palpate chest wall for tenderness", category: "Musculoskeletal",
                          finding: "No tenderness to palpation over sternum, costochondral junctions, or chest wall. No reproducible pain.",
                          tier: "helpful", linkedDx: ["Musculoskeletal Chest Pain"],
                          reasoning: "Non-reproducible pain argues against musculoskeletal cause." },
                        
                        { id: "leg_exam", text: "Examine lower extremities", category: "Extremities",
                          finding: "No calf tenderness, no asymmetric swelling, no palpable cords. Negative Homan's sign bilaterally. Trace bilateral ankle edema.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "No signs of DVT, though PE can occur without DVT. Trace edema non-specific." },
                        
                        { id: "abdominal_aorta", text: "Auscultate abdominal aorta for bruits", category: "Abdominal",
                          finding: "No abdominal bruits. No pulsatile mass.",
                          tier: "helpful", linkedDx: ["Aortic Dissection"],
                          reasoning: "No abdominal aortic abnormality." },
                        
                        { id: "skin_exam", text: "Examine skin for pallor, cyanosis", category: "Skin",
                          finding: "No pallor, no cyanosis. No diaphoresis.",
                          tier: "neutral", linkedDx: ["Acute Myocardial Infarction"],
                          reasoning: "No signs of cardiogenic shock." }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "troponin", name: "Troponin (serial)",
                              result: "Initial troponin: 0.08 ng/mL (mildly elevated, normal <0.04). Repeat at 3 hours: 0.15 ng/mL (rising).",
                              tier: "essential", reasoning: "CRITICAL FINDING: Rising troponin confirms myocardial injury. This patient has NSTEMI/unstable angina with positive biomarkers." },
                            { id: "ekg", name: "ECG/EKG",
                              result: "Sinus rhythm at 94 bpm. ST depression 1mm in leads V4-V6 and II, III, aVF. No ST elevation. T-wave inversions in lateral leads.",
                              tier: "essential", reasoning: "CRITICAL FINDING: ST depression and T-wave inversions indicate myocardial ischemia. Consistent with NSTEMI." },
                            { id: "cbc", name: "CBC",
                              result: "WBC 8.2, Hgb 13.5, Hct 40%, Plt 220. Normal.",
                              tier: "helpful", reasoning: "No anemia that could exacerbate ischemia. Normal WBC." },
                            { id: "bmp", name: "BMP",
                              result: "Na 139, K 4.2, Cl 102, CO2 24, BUN 18, Cr 1.1, Glucose 165.",
                              tier: "helpful", reasoning: "Mild hyperglycemia consistent with diabetes. Normal renal function." },
                            { id: "bnp", name: "BNP or NT-proBNP",
                              result: "BNP 280 pg/mL (mildly elevated, normal <100).",
                              tier: "helpful", reasoning: "Mildly elevated BNP suggests some cardiac strain. Can be elevated in ACS." },
                            { id: "lipid_panel", name: "Lipid Panel",
                              result: "Total cholesterol 245, LDL 165, HDL 38, Triglycerides 210.",
                              tier: "neutral", reasoning: "Dyslipidemia present - adds to CV risk but doesn't change acute management." },
                            { id: "d_dimer", name: "D-dimer",
                              result: "450 ng/mL (mildly elevated)",
                              tier: "neutral", reasoning: "Mildly elevated but can be elevated in many conditions including ACS. Low-moderate suspicion for PE given presentation." }
                        ],
                        imaging: [
                            { id: "cxr", name: "Chest X-ray",
                              result: "Heart size upper limits of normal. Lungs clear. No pulmonary edema. No pneumothorax.",
                              tier: "essential", reasoning: "Rules out pneumothorax, pulmonary edema. Baseline for comparison." },
                            { id: "echo", name: "Echocardiogram",
                              result: "To be performed - would assess wall motion abnormalities and EF.",
                              tier: "helpful", reasoning: "Can identify regional wall motion abnormalities suggesting ischemia. Important for risk stratification." },
                            { id: "ct_angio", name: "CT Angiography of Chest",
                              result: "Not immediately indicated given clinical picture pointing to ACS.",
                              tier: "less-helpful", reasoning: "PE is lower on differential given classic ACS presentation. Would delay definitive ACS treatment." }
                        ],
                        procedures: [
                            { id: "iv_access", name: "Establish IV access",
                              result: "Two large-bore IVs placed.",
                              tier: "essential", reasoning: "Essential for medication administration and potential emergency interventions." }
                        ],
                        treatments: [
                            { id: "aspirin", name: "Aspirin 325mg (chewed)",
                              result: "Given immediately.",
                              tier: "essential", reasoning: "CRITICAL: Aspirin reduces mortality in ACS. Should be given immediately unless contraindicated." },
                            { id: "nitro", name: "Nitroglycerin (sublingual or IV)",
                              result: "SL NTG x3 given. Chest discomfort improved.",
                              tier: "essential", reasoning: "First-line for anginal symptoms. Response supports ischemic etiology." },
                            { id: "heparin", name: "Anticoagulation (heparin or enoxaparin)",
                              result: "Heparin drip initiated.",
                              tier: "essential", reasoning: "Anticoagulation is standard for ACS to prevent clot propagation." },
                            { id: "beta_blocker", name: "Beta-blocker (metoprolol)",
                              result: "Metoprolol 25mg PO given.",
                              tier: "essential", reasoning: "Reduces myocardial oxygen demand. Standard ACS therapy unless contraindicated." },
                            { id: "statin", name: "High-intensity statin (atorvastatin 80mg)",
                              result: "Atorvastatin 80mg given.",
                              tier: "essential", reasoning: "High-intensity statin therapy is indicated for all ACS patients." },
                            { id: "oxygen", name: "Supplemental oxygen",
                              result: "SpO2 97% on RA - oxygen not required.",
                              tier: "neutral", reasoning: "Only indicated if SpO2 <90%. Not needed here." },
                            { id: "morphine", name: "Morphine for pain",
                              result: "Consider if pain persists despite nitrates.",
                              tier: "neutral", reasoning: "Third-line for persistent ischemic pain. Use cautiously." }
                        ],
                        consults: [
                            { id: "cardiology", name: "Cardiology consult",
                              result: "STAT cardiology consult placed. Plan for cardiac catheterization.",
                              tier: "essential", reasoning: "NSTEMI requires cardiology involvement for risk stratification and consideration of early invasive strategy." },
                            { id: "cath_lab", name: "Activate cardiac catheterization lab",
                              result: "Interventional cardiology aware. Plan for cath within 24-48 hours (early invasive strategy).",
                              tier: "essential", reasoning: "NSTEMI with high-risk features (rising troponin, ECG changes) benefits from early invasive approach." }
                        ],
                        disposition: [
                            { id: "admit_ccu", name: "Admit to CCU/Cardiac ICU",
                              result: "Admitted for continuous monitoring and cath planning.",
                              tier: "essential", reasoning: "NSTEMI requires telemetry monitoring. CCU appropriate for high-risk features." },
                            { id: "admit_tele", name: "Admit to telemetry floor",
                              result: "Appropriate if CCU not available and patient stable.",
                              tier: "helpful", reasoning: "Minimum level of care for ACS - requires continuous monitoring." },
                            { id: "discharge", name: "Discharge home",
                              result: "INAPPROPRIATE - patient has active ACS.",
                              tier: "inappropriate", reasoning: "NEVER discharge an active ACS. Patient requires admission." }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "NSTEMI (Non-ST Elevation Myocardial Infarction) - Unstable Angina with Positive Biomarkers",
                        keyFindings: [
                            "Classic ACS symptoms: exertional chest pressure with radiation to arm/jaw",
                            "Crescendo pattern: increasing frequency with decreasing exertional threshold",
                            "Multiple cardiac risk factors: diabetes, hypertension, smoking history, family history, dyslipidemia",
                            "Rising troponin (0.08 â†’ 0.15) confirms myocardial injury",
                            "ECG with ST depression and T-wave inversions in lateral/inferior leads",
                            "Relief with rest and nitroglycerin supports ischemic etiology"
                        ],
                        teachingPoints: [
                            "DIABETIC PATIENTS PRESENT ATYPICALLY: 'Burning' or 'indigestion' quality should not falsely reassure you. Have a low threshold for ACS workup in diabetics.",
                            "CRESCENDO ANGINA IS HIGH-RISK: Increasing frequency + decreasing exertional threshold = unstable angina. This is an acute coronary syndrome.",
                            "DON'T BE FOOLED BY GERD-LIKE SYMPTOMS: Meal relation and partial antacid relief can occur in ACS. Risk factors should drive your concern.",
                            "SERIAL TROPONINS ARE ESSENTIAL: Initial troponin may be normal or mildly elevated. Rising pattern over 3-6 hours confirms acute myocardial injury.",
                            "ECG CHANGES IN NSTEMI: ST depression and T-wave inversions indicate ischemia. Unlike STEMI, no urgent need for immediate cath, but early invasive strategy (24-48h) recommended.",
                            "ASPIRIN SAVES LIVES: Give aspirin immediately in suspected ACS unless true allergy. Chewed for faster absorption.",
                            "WOMEN AND DIABETICS: Both groups commonly present with 'atypical' symptoms - dyspnea, fatigue, nausea rather than classic crushing chest pain."
                        ]
                    }
                }
            }
        },
        
        // ==================== SYNCOPE ====================
        {
            id: "syncope",
            title: "Syncope",
            category: "Cardiovascular",
            icon: "ðŸ’«",
            
            variants: {
                "adult-40-as": {
                    name: "M. Torres",
                    age: 40,
                    gender: "male",
                    chiefComplaint: "I passed out while climbing stairs",
                    vitalSigns: {
                        BP: "118/78",
                        HR: 72,
                        RR: 16,
                        Temp: "98.2Â°F",
                        SpO2: "99%"
                    },
                    
                    allDiagnoses: [
                        { name: "Aortic Stenosis", correctCategory: "likely", rationale: "Exertional syncope with known murmur since childhood. Classic presentation of symptomatic AS. Bicuspid aortic valve can cause critical AS even in young adults." },
                        { name: "Vasovagal Syncope", correctCategory: "likely", rationale: "Common cause of syncope, but typically has prodrome (lightheadedness, warmth, nausea) and occurs in specific situations (prolonged standing, emotional stress). Less likely given exertional pattern." },
                        
                        { name: "Cardiac Arrhythmia", correctCategory: "must-not-miss", rationale: "VT, AV block, or other arrhythmia can cause sudden syncope without prodrome. Must rule out, especially with structural heart disease." },
                        { name: "Acute Myocardial Infarction", correctCategory: "must-not-miss", rationale: "MI can present with syncope. Less likely at age 40 without risk factors, but must consider." },
                        { name: "Pulmonary Embolism", correctCategory: "must-not-miss", rationale: "Large PE can cause syncope from acute right heart failure. No DVT symptoms here but must consider." },
                        { name: "Hypertrophic Cardiomyopathy (HOCM)", correctCategory: "must-not-miss", rationale: "Another cause of exertional syncope with murmur. HOCM murmur behaves differently than AS (increases with Valsalva/standing)." },
                        
                        { name: "Orthostatic Hypotension", correctCategory: "less-likely", rationale: "Can cause syncope but typically with positional changes, not exertion. Should check orthostatics." },
                        { name: "Seizure", correctCategory: "less-likely", rationale: "Can mimic syncope. Look for post-ictal confusion, tongue biting, incontinence. Patient had rapid recovery." },
                        { name: "Carotid Sinus Hypersensitivity", correctCategory: "less-likely", rationale: "Usually in older patients. Triggered by neck pressure/turning." }
                    ],
                    
                    oldcartsNarrative: `"I was climbing the stairs at work - just a couple of flights like I do every day - and suddenly I felt really lightheaded and my vision started going gray. Next thing I knew I was on the landing and my coworker was helping me up. I was only out for a few seconds, maybe 10-15 seconds, and then I felt pretty normal right away. No confusion after. This is the first time I've actually passed out, but I've been getting more winded than usual going up stairs the last few months, and sometimes I feel like my heart is pounding. I've always known I had a heart murmur since I was a kid - they said it was nothing to worry about. I don't have any chest pain. No leg swelling. I did feel a little chest tightness when I was climbing before I passed out."`,
                    
                    historyQuestions: [
                        { id: "exertional", text: "Does the lightheadedness or near-syncope happen with exertion specifically?",
                          answer: "Yes, mostly when I'm doing something physical - stairs, walking fast, sometimes when I'm exercising. Never just sitting around.",
                          tier: "essential", linkedDx: ["Aortic Stenosis", "Hypertrophic Cardiomyopathy (HOCM)"],
                          reasoning: "CRITICAL: Exertional syncope is always pathologic until proven otherwise. In setting of known murmur, strongly suggests valvular or structural heart disease." },
                        
                        { id: "prodrome", text: "Did you have any warning before you passed out - lightheadedness, nausea, warmth, tunnel vision?",
                          answer: "Just a brief moment of feeling lightheaded and my vision going gray, then nothing. Maybe 5-10 seconds of warning.",
                          tier: "essential", linkedDx: ["Cardiac Arrhythmia", "Aortic Stenosis"],
                          reasoning: "Minimal prodrome suggests cardiac cause. Vasovagal typically has longer prodrome with nausea/warmth. Arrhythmia can have no prodrome at all." },
                        
                        { id: "recovery", text: "How did you feel immediately after waking up?",
                          answer: "Pretty normal honestly. A little shaken up but not confused or anything. I could stand up right away.",
                          tier: "essential", linkedDx: ["Cardiac Arrhythmia", "Aortic Stenosis"],
                          reasoning: "Rapid recovery without post-ictal confusion argues against seizure. Consistent with cardiac cause where once perfusion restored, patient recovers quickly." },
                        
                        { id: "murmur_history", text: "Tell me more about this heart murmur you've had since childhood.",
                          answer: "They found it when I was maybe 10. The doctors listened a few times over the years and said it was probably a bicuspid valve or something, but nothing to worry about. I've never had any problems with it until recently.",
                          tier: "essential", linkedDx: ["Aortic Stenosis"],
                          reasoning: "CRITICAL: Bicuspid aortic valve is the most common cause of aortic stenosis in patients under 65. Previously 'innocent' murmur now causing symptoms = progressive stenosis." },
                        
                        { id: "dyspnea_pattern", text: "You mentioned being more winded lately - can you describe that?",
                          answer: "I used to run up stairs no problem. Now even two flights and I'm breathing hard. It's been getting worse over the past 6 months or so.",
                          tier: "essential", linkedDx: ["Aortic Stenosis"],
                          reasoning: "Progressive dyspnea on exertion is part of the classic AS triad (angina, syncope, dyspnea). Indicates symptomatic AS - this changes prognosis and management." },
                        
                        { id: "chest_pain", text: "Any chest pain or chest tightness?",
                          answer: "Sometimes when I'm exerting myself I get this tight feeling in my chest. It goes away when I stop. No pain at rest.",
                          tier: "essential", linkedDx: ["Aortic Stenosis", "Acute Myocardial Infarction"],
                          reasoning: "Exertional chest tightness completing the AS triad: Angina + Syncope + Dyspnea. This is symptomatic severe AS until proven otherwise." },
                        
                        { id: "palpitations", text: "Any palpitations or feeling like your heart is racing or skipping?",
                          answer: "Sometimes I feel like my heart is pounding, especially after activity. No skipping or fluttering.",
                          tier: "helpful", linkedDx: ["Cardiac Arrhythmia"],
                          reasoning: "Pounding sensation may be hyperdynamic LV trying to overcome obstruction. No clear arrhythmia symptoms, but would still want ECG." },
                        
                        { id: "family_sudden_death", text: "Any family history of sudden death or heart problems at a young age?",
                          answer: "No, not that I know of. My parents are healthy.",
                          tier: "helpful", linkedDx: ["Hypertrophic Cardiomyopathy (HOCM)", "Cardiac Arrhythmia"],
                          reasoning: "Family history of sudden death would raise concern for inherited cardiomyopathy or channelopathy." },
                        
                        { id: "recent_illness", text: "Any recent illness, fever, or infections?",
                          answer: "No, I've been healthy otherwise.",
                          tier: "neutral", linkedDx: [],
                          reasoning: "No recent illness that could suggest endocarditis or myocarditis." },
                        
                        { id: "medications", text: "Are you taking any medications?",
                          answer: "Just a multivitamin. Nothing prescription.",
                          tier: "helpful", linkedDx: [],
                          reasoning: "No medications that could cause orthostatic hypotension or arrhythmia." }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_ortho", text: "Check orthostatic vital signs", category: "Vitals",
                          finding: "Lying: BP 118/78, HR 70. Standing: BP 114/76, HR 76. No significant orthostatic changes.",
                          tier: "essential", linkedDx: ["Orthostatic Hypotension"],
                          reasoning: "Negative orthostatics make orthostatic hypotension less likely as cause." },
                        
                        { id: "general", text: "General appearance assessment", category: "General",
                          finding: "Well-appearing male, no acute distress, no pallor or diaphoresis.",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Currently stable. No signs of ongoing hemodynamic compromise." },
                        
                        { id: "cardiac_auscultation", text: "Auscultate heart in all positions", category: "Cardiovascular",
                          finding: "Grade 3/6 harsh crescendo-decrescendo systolic ejection murmur, loudest at right upper sternal border (aortic area), radiating to both carotids. Normal S1, soft/single S2. No S3. Possible S4 present.",
                          tier: "essential", linkedDx: ["Aortic Stenosis", "Hypertrophic Cardiomyopathy (HOCM)"],
                          reasoning: "CLASSIC AS MURMUR: Crescendo-decrescendo at RUSB radiating to carotids. Soft S2 indicates immobile valve. S4 suggests LV stiffness from hypertrophy." },
                        
                        { id: "carotid_pulses", text: "Palpate carotid pulses carefully", category: "Cardiovascular",
                          finding: "Carotid pulses are diminished bilaterally with delayed upstroke (pulsus parvus et tardus). Carotid thrill palpable.",
                          tier: "essential", linkedDx: ["Aortic Stenosis"],
                          reasoning: "PULSUS PARVUS ET TARDUS is pathognomonic for severe AS. The pulse is weak (parvus) and slow-rising (tardus) due to obstruction." },
                        
                        { id: "pmi", text: "Palpate PMI and precordium", category: "Cardiovascular",
                          finding: "Sustained, forceful apical impulse. Not displaced. Systolic thrill at base.",
                          tier: "essential", linkedDx: ["Aortic Stenosis"],
                          reasoning: "Sustained apical impulse indicates LV hypertrophy from chronic pressure overload. Thrill confirms significant turbulence." },
                        
                        { id: "dynamic_maneuvers", text: "Perform Valsalva and squat-to-stand maneuvers", category: "Cardiovascular",
                          finding: "Murmur DECREASES with Valsalva and standing (decreased preload). Murmur INCREASES with squatting (increased preload). Opposite of HOCM pattern.",
                          tier: "essential", linkedDx: ["Aortic Stenosis", "Hypertrophic Cardiomyopathy (HOCM)"],
                          reasoning: "CRITICAL FOR DIFFERENTIATION: AS murmur decreases with decreased preload (less blood crossing valve). HOCM murmur would increase. This confirms AS." },
                        
                        { id: "peripheral_pulses", text: "Check all peripheral pulses", category: "Cardiovascular",
                          finding: "Peripheral pulses present but diminished throughout. No radial-femoral delay.",
                          tier: "helpful", linkedDx: ["Aortic Stenosis"],
                          reasoning: "Diminished peripheral pulses consistent with reduced stroke volume from AS." },
                        
                        { id: "lung_exam", text: "Auscultate lungs", category: "Pulmonary",
                          finding: "Clear to auscultation bilaterally. No crackles or wheezes.",
                          tier: "helpful", linkedDx: ["Aortic Stenosis"],
                          reasoning: "No pulmonary edema currently, though may develop if AS progresses." },
                        
                        { id: "jvp", text: "Assess JVP", category: "Cardiovascular",
                          finding: "JVP normal, not elevated.",
                          tier: "helpful", linkedDx: [],
                          reasoning: "No right heart failure signs." },
                        
                        { id: "leg_exam", text: "Examine lower extremities", category: "Extremities",
                          finding: "No peripheral edema. No calf tenderness.",
                          tier: "neutral", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "No signs of DVT or right heart failure." },
                        
                        { id: "neuro_exam", text: "Brief neurological exam", category: "Neurological",
                          finding: "Alert, oriented x4. No focal deficits. Cranial nerves intact. Normal gait.",
                          tier: "helpful", linkedDx: [],
                          reasoning: "No post-ictal findings. No focal deficits that would suggest stroke/TIA." }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "ekg", name: "ECG/EKG",
                              result: "Sinus rhythm at 72 bpm. Left ventricular hypertrophy by voltage criteria (deep S in V1, tall R in V5-V6). Left atrial enlargement. No acute ischemic changes.",
                              tier: "essential", reasoning: "LVH on ECG is expected with chronic AS from pressure overload. Important to rule out arrhythmia as cause of syncope." },
                            { id: "troponin", name: "Troponin",
                              result: "Troponin <0.01 ng/mL (normal)",
                              tier: "helpful", reasoning: "Rules out MI as cause of syncope. Important given exertional chest tightness." },
                            { id: "cbc", name: "CBC",
                              result: "Normal - no anemia",
                              tier: "neutral", reasoning: "Rules out severe anemia as contributor to symptoms." },
                            { id: "bmp", name: "BMP",
                              result: "Normal electrolytes and renal function",
                              tier: "neutral", reasoning: "Baseline assessment. No electrolyte abnormalities that could cause arrhythmia." },
                            { id: "bnp", name: "BNP",
                              result: "BNP 450 pg/mL (elevated)",
                              tier: "helpful", reasoning: "Elevated BNP indicates cardiac strain and helps risk-stratify symptomatic AS." }
                        ],
                        imaging: [
                            { id: "echo", name: "Transthoracic Echocardiogram",
                              result: "CRITICAL: Bicuspid aortic valve with severe aortic stenosis. Aortic valve area 0.8 cmÂ² (normal >2.0). Mean gradient 48 mmHg. Peak velocity 4.5 m/s. Concentric LVH. EF 55%.",
                              tier: "essential", reasoning: "DIAGNOSTIC TEST OF CHOICE for AS. Confirms severe stenosis (AVA <1.0 cmÂ², mean gradient >40). This patient needs intervention." },
                            { id: "cxr", name: "Chest X-ray",
                              result: "Mild cardiomegaly. No pulmonary edema. Post-stenotic dilation of ascending aorta.",
                              tier: "helpful", reasoning: "Post-stenotic dilation is common with AS. No current heart failure." }
                        ],
                        procedures: [
                            { id: "holter", name: "Holter monitor (24-48 hour)",
                              result: "To be arranged as outpatient if needed",
                              tier: "helpful", reasoning: "Would evaluate for arrhythmia as contributor, though echo findings explain symptoms." }
                        ],
                        treatments: [
                            { id: "avoid_exertion", name: "Activity restriction - avoid strenuous exertion",
                              result: "Patient counseled to avoid strenuous activity until definitive treatment.",
                              tier: "essential", reasoning: "Exertional syncope with severe AS carries sudden death risk. Must restrict activity until valve replacement." },
                            { id: "avoid_vasodilators", name: "Avoid vasodilators and volume depletion",
                              result: "Counseled to maintain hydration, avoid hot tubs, avoid new BP medications without cardiology input.",
                              tier: "essential", reasoning: "Patients with severe AS are preload-dependent. Vasodilation can cause dangerous hypotension." }
                        ],
                        consults: [
                            { id: "cardiology", name: "Cardiology consult",
                              result: "URGENT cardiology consult placed. Plan for surgical or transcatheter aortic valve replacement evaluation.",
                              tier: "essential", reasoning: "Symptomatic severe AS requires intervention. Without treatment, survival is 50% at 2 years with syncope." },
                            { id: "ct_surgery", name: "Cardiac surgery consultation",
                              result: "To be arranged for valve replacement planning.",
                              tier: "essential", reasoning: "Definitive treatment is aortic valve replacement (surgical or TAVR). Must be evaluated promptly." }
                        ],
                        disposition: [
                            { id: "admit", name: "Admit to telemetry for monitoring and expedited workup",
                              result: "Admitted for echo and cardiology evaluation.",
                              tier: "essential", reasoning: "Exertional syncope with suspected severe AS warrants admission for expedited evaluation and monitoring." },
                            { id: "discharge", name: "Discharge home with outpatient follow-up",
                              result: "INAPPROPRIATE - high-risk patient",
                              tier: "inappropriate", reasoning: "Symptomatic severe AS with syncope has poor short-term prognosis without treatment. Should not be discharged without definitive plan." }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Severe Symptomatic Aortic Stenosis (Bicuspid Aortic Valve)",
                        keyFindings: [
                            "Exertional syncope - the most ominous symptom of AS",
                            "Classic AS triad present: Angina (exertional chest tightness) + Syncope + Dyspnea on exertion",
                            "Crescendo-decrescendo systolic murmur at RUSB radiating to carotids",
                            "Pulsus parvus et tardus (weak, delayed carotid upstroke)",
                            "Murmur decreases with Valsalva (confirms AS, not HOCM)",
                            "Known bicuspid valve since childhood - most common cause of AS in patients <65",
                            "Echo confirms severe AS: AVA 0.8 cmÂ², mean gradient 48 mmHg"
                        ],
                        teachingPoints: [
                            "EXERTIONAL SYNCOPE IS ALWAYS PATHOLOGIC: Never assume vasovagal in someone who passes out during exertion. This is cardiac until proven otherwise.",
                            "AORTIC STENOSIS TRIAD: Angina, Syncope, Dyspnea (CHF). Once symptoms appear, prognosis without treatment is 5 years (angina), 3 years (syncope), 2 years (CHF).",
                            "BICUSPID AORTIC VALVE: Present in 1-2% of population. Most common cause of AS in young adults. Can remain asymptomatic for decades then progress.",
                            "PULSUS PARVUS ET TARDUS: Pathognomonic for AS. The carotid pulse is weak (parvus) and slow-rising (tardus) because blood must slowly squeeze through the stenotic valve.",
                            "DYNAMIC MANEUVERS DIFFERENTIATE AS FROM HOCM: AS murmur decreases with decreased preload (Valsalva, standing). HOCM murmur increases. This is a crucial bedside test.",
                            "AVOID VASODILATORS IN SEVERE AS: These patients are preload-dependent. Nitrates, diuretics, and antihypertensives can cause dangerous hypotension.",
                            "SYMPTOMATIC AS REQUIRES INTERVENTION: Aortic valve replacement (surgical or TAVR) is the only definitive treatment. Medical therapy alone doesn't change outcomes."
                        ]
                    }
                }
            }
        },
        
        // ==================== RLQ PAIN / ECTOPIC PREGNANCY ====================
        {
            id: "rlq-ectopic",
            title: "RLQ Pain",
            category: "GYN Emergency",
            icon: "âš ï¸",
            
            variants: {
                "female-26-ectopic": {
                    name: "A. Rivera",
                    age: 26,
                    gender: "female",
                    chiefComplaint: "Pain in my right lower belly",
                    vitalSigns: {
                        BP: "102/68",
                        HR: 108,
                        RR: 18,
                        Temp: "98.8Â°F",
                        SpO2: "99%"
                    },
                    
                    allDiagnoses: [
                        { name: "Ectopic Pregnancy", correctCategory: "likely", rationale: "Reproductive-age female with RLQ pain, missed period, and risk factors (prior PID). Tachycardia and borderline low BP suggest possible rupture. MUST be at top of differential." },
                        { name: "Ovarian Cyst Rupture", correctCategory: "likely", rationale: "Common cause of acute pelvic pain in young women. Can cause significant pain but usually self-limited." },
                        
                        { name: "Ruptured Ectopic Pregnancy", correctCategory: "must-not-miss", rationale: "SURGICAL EMERGENCY. Tachycardia and near-syncope suggest hemodynamic compromise. Can be rapidly fatal without intervention." },
                        { name: "Ovarian Torsion", correctCategory: "must-not-miss", rationale: "Surgical emergency - ovary can become necrotic within hours. Sudden onset severe pain with nausea is classic." },
                        { name: "Appendicitis", correctCategory: "must-not-miss", rationale: "RLQ pain classic for appendicitis. Must differentiate from gynecologic causes." },
                        
                        { name: "Pelvic Inflammatory Disease (PID)", correctCategory: "less-likely", rationale: "History of prior PID increases ectopic risk. Current presentation less typical for acute PID (no discharge, no fever)." },
                        { name: "UTI/Pyelonephritis", correctCategory: "less-likely", rationale: "Would expect dysuria, frequency, and flank pain for pyelo." },
                        { name: "Gastroenteritis", correctCategory: "less-likely", rationale: "Usually bilateral cramping with diarrhea, not localized RLQ pain." },
                        { name: "Kidney Stone", correctCategory: "less-likely", rationale: "Would expect colicky flank pain radiating to groin, hematuria." }
                    ],
                    
                    oldcartsNarrative: `"The pain started yesterday and it's gotten a lot worse. It's in my right lower belly, pretty sharp. Probably an 8 out of 10 right now. It's constant - doesn't come and go. Nothing makes it better, and moving around makes it worse. I also felt really lightheaded earlier when I stood up - almost passed out. I've been a little nauseous but no vomiting. My last period... I guess it's been about 7 weeks? I'm usually pretty regular, every 28 days. I am sexually active with my boyfriend. We use condoms but not every time, and I'm not on the pill. I had a chlamydia infection a few years ago that turned into PID - I was in the hospital for that. I have an IUD... well, I had one but it fell out about 2 months ago and I haven't gotten a new one yet."`,
                    
                    historyQuestions: [
                        { id: "lmp", text: "When was your last menstrual period?",
                          answer: "About 7 weeks ago. I'm usually regular, every 28 days, so I'm definitely late.",
                          tier: "essential", linkedDx: ["Ectopic Pregnancy", "Ruptured Ectopic Pregnancy"],
                          reasoning: "CRITICAL: Missed period in reproductive-age woman with abdominal pain = pregnancy until proven otherwise. 7 weeks is classic timing for ectopic to present." },
                        
                        { id: "pregnancy_test", text: "Have you taken a pregnancy test?",
                          answer: "No, I didn't even think about that. I mean, we use condoms... most of the time.",
                          tier: "essential", linkedDx: ["Ectopic Pregnancy"],
                          reasoning: "Every reproductive-age woman with abdominal pain needs pregnancy test regardless of contraception history." },
                        
                        { id: "vaginal_bleeding", text: "Any vaginal bleeding or spotting?",
                          answer: "Actually yes, I had some light spotting a few days ago. Not like my normal period - just some brownish discharge.",
                          tier: "essential", linkedDx: ["Ectopic Pregnancy", "Ruptured Ectopic Pregnancy"],
                          reasoning: "Vaginal bleeding + missed period + pelvic pain = ectopic pregnancy triad. Spotting is classic for ectopic." },
                        
                        { id: "syncope", text: "Tell me more about feeling lightheaded - did you actually pass out?",
                          answer: "When I stood up to go to the bathroom I got really dizzy and my vision went gray. I had to grab the wall. I almost fell but caught myself.",
                          tier: "essential", linkedDx: ["Ruptured Ectopic Pregnancy"],
                          reasoning: "CRITICAL RED FLAG: Near-syncope suggests hemodynamic compromise, likely from intra-abdominal bleeding. This is ruptured ectopic until proven otherwise." },
                        
                        { id: "pid_history", text: "Tell me about the PID you had before.",
                          answer: "I was 22. I had chlamydia that I didn't know about, and it spread. I was really sick - high fever, bad pain. They admitted me for IV antibiotics for a few days.",
                          tier: "essential", linkedDx: ["Ectopic Pregnancy"],
                          reasoning: "History of PID is the #1 risk factor for ectopic pregnancy. PID causes tubal scarring that can trap the embryo." },
                        
                        { id: "iud_history", text: "You mentioned an IUD that fell out?",
                          answer: "Yeah, I had a copper IUD for about a year but it came out on its own about 2 months ago. I was going to get another one but never made the appointment.",
                          tier: "helpful", linkedDx: ["Ectopic Pregnancy"],
                          reasoning: "IUD use can increase relative risk of ectopic if pregnancy occurs. Expulsion 2 months ago means she's been without reliable contraception." },
                        
                        { id: "shoulder_pain", text: "Any pain in your shoulder or upper abdomen?",
                          answer: "Now that you mention it, my right shoulder has been achy since this morning. I thought I slept on it wrong.",
                          tier: "essential", linkedDx: ["Ruptured Ectopic Pregnancy"],
                          reasoning: "CRITICAL: Referred shoulder pain (Kehr's sign) indicates diaphragmatic irritation from blood in the abdomen. Strongly suggests hemoperitoneum." },
                        
                        { id: "pain_onset", text: "How did the pain start - sudden or gradual?",
                          answer: "It started as kind of a dull ache yesterday but then got suddenly much worse this morning. That's when I felt like I might pass out.",
                          tier: "essential", linkedDx: ["Ruptured Ectopic Pregnancy", "Ovarian Torsion"],
                          reasoning: "Sudden worsening suggests rupture. Timeline fits with ectopic: gradual symptoms as tubal pregnancy grows, then acute when rupture occurs." },
                        
                        { id: "nausea_vomiting", text: "Any nausea or vomiting?",
                          answer: "I've been queasy all day but haven't thrown up.",
                          tier: "helpful", linkedDx: ["Ectopic Pregnancy", "Appendicitis", "Ovarian Torsion"],
                          reasoning: "Nausea common in ectopic, appendicitis, and torsion. Non-specific but part of pattern." },
                        
                        { id: "urinary_symptoms", text: "Any pain with urination, frequency, or blood in urine?",
                          answer: "No, peeing is normal.",
                          tier: "helpful", linkedDx: ["UTI/Pyelonephritis", "Kidney Stone"],
                          reasoning: "Absence of urinary symptoms makes UTI and kidney stone less likely." },
                        
                        { id: "bowel_symptoms", text: "Any diarrhea, constipation, or blood in stool?",
                          answer: "No, bowels have been normal.",
                          tier: "helpful", linkedDx: ["Appendicitis", "Gastroenteritis"],
                          reasoning: "No GI symptoms makes gastroenteritis less likely." }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_review", text: "Review vital signs", category: "Vitals",
                          finding: "BP 102/68 (borderline low), HR 108 (tachycardic), RR 18, Temp 98.8Â°F, SpO2 99%. Repeat BP after 500mL NS: 106/70.",
                          tier: "essential", linkedDx: ["Ruptured Ectopic Pregnancy"],
                          reasoning: "CRITICAL: Tachycardia with borderline low BP indicates early hemorrhagic shock. This patient needs immediate resuscitation and surgery." },
                        
                        { id: "general", text: "General appearance", category: "General",
                          finding: "Appears uncomfortable and anxious, lying still. Pale skin. Mild diaphoresis.",
                          tier: "essential", linkedDx: ["Ruptured Ectopic Pregnancy"],
                          reasoning: "Pallor and diaphoresis are signs of blood loss and sympathetic activation." },
                        
                        { id: "abd_inspection", text: "Inspect abdomen", category: "Abdominal",
                          finding: "Flat, no distension. No visible masses. No surgical scars.",
                          tier: "essential", linkedDx: ["all"],
                          reasoning: "Abdominal distension can occur with significant hemoperitoneum but may be absent early." },
                        
                        { id: "abd_palpation", text: "Palpate abdomen", category: "Abdominal",
                          finding: "Significant RLQ and suprapubic tenderness. Mild voluntary guarding. No rebound initially but develops with deeper palpation. Left side less tender.",
                          tier: "essential", linkedDx: ["Ectopic Pregnancy", "Appendicitis"],
                          reasoning: "RLQ/pelvic tenderness with developing peritoneal signs indicates pelvic pathology with possible blood irritating peritoneum." },
                        
                        { id: "mcburney", text: "McBurney's point tenderness", category: "Abdominal",
                          finding: "Tenderness present but maximal tenderness is more medial and inferior, toward the pelvis.",
                          tier: "essential", linkedDx: ["Appendicitis"],
                          reasoning: "Location lower and more medial than typical appendicitis. Pelvic source more likely." },
                        
                        { id: "rovsing", text: "Rovsing's sign", category: "Abdominal",
                          finding: "Negative - palpation of LLQ does not increase RLQ pain.",
                          tier: "helpful", linkedDx: ["Appendicitis"],
                          reasoning: "Negative Rovsing's makes appendicitis less likely." },
                        
                        { id: "psoas_obturator", text: "Psoas and obturator signs", category: "Abdominal",
                          finding: "Psoas sign negative. Obturator sign mildly positive on right.",
                          tier: "helpful", linkedDx: ["Appendicitis"],
                          reasoning: "Mild obturator sign can be seen with pelvic pathology near the internal obturator muscle." },
                        
                        { id: "cva_tenderness", text: "Costovertebral angle tenderness", category: "Abdominal",
                          finding: "No CVA tenderness bilaterally.",
                          tier: "helpful", linkedDx: ["Kidney Stone", "UTI/Pyelonephritis"],
                          reasoning: "Absence argues against pyelonephritis." },
                        
                        { id: "pelvic_bimanual", text: "Bimanual pelvic examination", category: "Pelvic",
                          finding: "Right adnexal tenderness and fullness. Cervical motion tenderness present (positive chandelier sign). Left adnexa non-tender. No active vaginal bleeding on exam but dark blood in vault.",
                          tier: "essential", linkedDx: ["Ectopic Pregnancy", "PID", "Ovarian Torsion"],
                          reasoning: "CRITICAL: CMT + adnexal tenderness + old blood = ectopic pregnancy until proven otherwise. CMT occurs when cervix movement pulls on inflamed/bleeding fallopian tube." },
                        
                        { id: "skin_exam", text: "Examine skin for pallor", category: "Skin",
                          finding: "Pale conjunctivae. Pale nail beds. Cool extremities.",
                          tier: "helpful", linkedDx: ["Ruptured Ectopic Pregnancy"],
                          reasoning: "Pallor and cool extremities indicate blood loss and peripheral vasoconstriction." }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "urine_hcg", name: "Urine Pregnancy Test (point-of-care)",
                              result: "POSITIVE",
                              tier: "essential", reasoning: "CRITICAL: Confirms pregnancy. Combined with RLQ pain and bleeding = ectopic until proven otherwise." },
                            { id: "serum_hcg", name: "Quantitative serum Î²-hCG",
                              result: "Î²-hCG: 4,200 mIU/mL",
                              tier: "essential", reasoning: "Above discriminatory zone (typically 1500-2000) - should see intrauterine pregnancy on ultrasound if present. If no IUP seen, strongly suggests ectopic." },
                            { id: "cbc", name: "CBC",
                              result: "WBC 11.2, Hgb 9.8 (LOW - was 13.2 on old labs), Hct 29%, Plt 290",
                              tier: "essential", reasoning: "CRITICAL: Hemoglobin 9.8 indicates blood loss. Compared to prior Hgb of 13.2 = significant bleeding." },
                            { id: "type_screen", name: "Type and Screen / Crossmatch",
                              result: "Type O positive. 2 units crossmatched.",
                              tier: "essential", reasoning: "CRITICAL: Must have blood available. Ruptured ectopic can rapidly exsanguinate." },
                            { id: "bmp", name: "BMP",
                              result: "Normal except mild metabolic acidosis (CO2 20)",
                              tier: "helpful", reasoning: "Mild metabolic acidosis can indicate tissue hypoperfusion from blood loss." },
                            { id: "coags", name: "PT/INR, PTT",
                              result: "Normal coagulation",
                              tier: "helpful", reasoning: "Important for surgical planning." }
                        ],
                        imaging: [
                            { id: "tvus", name: "Transvaginal Ultrasound (TVUS)",
                              result: "No intrauterine pregnancy (empty uterus). Complex right adnexal mass 3.2cm with ring of fire sign. Moderate free fluid in pelvis (blood). Left ovary normal.",
                              tier: "essential", reasoning: "DIAGNOSTIC: No IUP + Î²-hCG above discriminatory zone + adnexal mass + free fluid = ECTOPIC PREGNANCY with rupture." },
                            { id: "ct", name: "CT Abdomen/Pelvis",
                              result: "Would delay definitive treatment - not indicated",
                              tier: "less-helpful", reasoning: "Ultrasound is faster and more specific for ectopic. CT would delay surgical treatment." }
                        ],
                        procedures: [
                            { id: "iv_access", name: "Two large-bore IVs",
                              result: "Two 16-gauge IVs placed. 1L NS bolus infusing.",
                              tier: "essential", reasoning: "Large-bore access critical for resuscitation." },
                            { id: "foley", name: "Foley catheter",
                              result: "Placed. Urine output 30mL first hour.",
                              tier: "helpful", reasoning: "Monitor urine output as marker of resuscitation." }
                        ],
                        treatments: [
                            { id: "ivf_resuscitation", name: "Aggressive IV fluid resuscitation",
                              result: "2L NS bolused. BP improved to 110/72, HR 98.",
                              tier: "essential", reasoning: "Volume resuscitation critical while preparing for surgery." },
                            { id: "blood_transfusion", name: "Transfuse PRBCs",
                              result: "2 units O-negative given emergently. Type-specific blood now available.",
                              tier: "essential", reasoning: "With Hgb 9.8 and ongoing bleeding, transfusion indicated. Don't wait for type-specific in unstable patient." },
                            { id: "rhogam", name: "RhoGAM (if Rh negative)",
                              result: "Patient is Rh positive - not needed.",
                              tier: "helpful", reasoning: "Must consider in all pregnancy losses. Would give if Rh negative." }
                        ],
                        consults: [
                            { id: "ob_gyn_stat", name: "STAT OB/GYN Surgery consult",
                              result: "OB/GYN called to bedside immediately. OR being prepared for emergent laparoscopy vs laparotomy.",
                              tier: "essential", reasoning: "CRITICAL: Ruptured ectopic requires immediate surgical intervention. Every minute counts." }
                        ],
                        disposition: [
                            { id: "or", name: "Emergent OR for surgical management",
                              result: "Patient taken emergently to OR for laparoscopy. Ruptured right ectopic found with 800mL hemoperitoneum. Right salpingectomy performed.",
                              tier: "essential", reasoning: "Definitive treatment. Laparoscopy if stable; laparotomy if unstable. Salpingectomy (tube removal) is standard for ruptured ectopic." },
                            { id: "admit", name: "Admit for observation",
                              result: "INAPPROPRIATE - patient needs immediate surgery",
                              tier: "inappropriate", reasoning: "Observation would allow continued bleeding. Ruptured ectopic is a surgical emergency." },
                            { id: "discharge", name: "Discharge",
                              result: "INAPPROPRIATE - life-threatening emergency",
                              tier: "inappropriate", reasoning: "Patient would die. This is a surgical emergency." }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Ruptured Ectopic Pregnancy - Surgical Emergency",
                        keyFindings: [
                            "Missed period (7 weeks) + RLQ pain + vaginal spotting = ectopic triad",
                            "Near-syncope and shoulder pain (Kehr's sign) indicate hemoperitoneum",
                            "Tachycardia (HR 108) with borderline low BP (102/68) = early hemorrhagic shock",
                            "History of PID - the #1 risk factor for ectopic pregnancy",
                            "Positive pregnancy test with Î²-hCG 4,200 (above discriminatory zone)",
                            "Empty uterus on ultrasound with adnexal mass and free fluid = DIAGNOSTIC",
                            "Hemoglobin 9.8 (dropped from baseline 13.2) confirms blood loss"
                        ],
                        teachingPoints: [
                            "PREGNANCY TEST IN ALL REPRODUCTIVE-AGE WOMEN WITH ABDOMINAL PAIN: This is non-negotiable. Ectopic pregnancy can present atypically and is life-threatening.",
                            "ECTOPIC TRIAD: Missed period + vaginal bleeding + pelvic pain. But many patients don't have all three - have a low threshold.",
                            "PID IS THE #1 RISK FACTOR: Prior PID causes tubal scarring that can trap the embryo. Other risks: prior ectopic, tubal surgery, IUD, infertility treatments.",
                            "KEHR'S SIGN: Referred shoulder pain from diaphragmatic irritation by blood. If present with pelvic pain and positive pregnancy test, assume ruptured ectopic.",
                            "DISCRIMINATORY ZONE: Î²-hCG level (usually 1500-2000) above which you should see an intrauterine pregnancy on TVUS. No IUP above this level = likely ectopic.",
                            "RUPTURED ECTOPIC = SURGICAL EMERGENCY: Don't wait for type-specific blood. Don't get CT. Get OB/GYN and go to OR. Patients can exsanguinate rapidly.",
                            "TIME IS BLOOD: Every minute of delay in a ruptured ectopic means more blood loss. Rapid recognition and resuscitation saves lives."
                        ]
                    }
                }
            }
        },
        
        // ==================== CHF / DYSPNEA ====================
        {
            id: "chf-dyspnea",
            title: "Dyspnea (CHF)",
            category: "Cardiovascular",
            icon: "ðŸ«",
            
            variants: {
                "female-58-chf": {
                    name: "S. Martin",
                    age: 58,
                    gender: "female",
                    chiefComplaint: "I get short of breath really easily lately",
                    vitalSigns: {
                        BP: "148/90",
                        HR: 94,
                        RR: 22,
                        Temp: "98.4Â°F",
                        SpO2: "94%"
                    },
                    
                    allDiagnoses: [
                        { name: "CHF Exacerbation (Systolic Heart Failure)", correctCategory: "likely", rationale: "Prior MI, orthopnea, PND, ankle edema, elevated BP, and ran out of diuretic. Classic presentation of decompensated heart failure." },
                        { name: "CHF (Diastolic/HFpEF)", correctCategory: "likely", rationale: "HTN, diabetes, and obesity are risk factors for HFpEF. Would need echo to differentiate from systolic failure." },
                        
                        { name: "Acute Myocardial Infarction", correctCategory: "must-not-miss", rationale: "History of prior MI. Exertional chest pressure present. Could be ACS precipitating CHF exacerbation." },
                        { name: "Pulmonary Embolism", correctCategory: "must-not-miss", rationale: "Recent 5-hour flight + HRT (estrogen) = PE risk factors. Must consider even with CHF history." },
                        { name: "Severe Valvular Disease", correctCategory: "must-not-miss", rationale: "Can cause or worsen heart failure. Would need echo to evaluate." },
                        
                        { name: "COPD Exacerbation", correctCategory: "less-likely", rationale: "25 pack-year smoking history is a risk factor. But orthopnea/PND point more to cardiac cause." },
                        { name: "Anemia", correctCategory: "less-likely", rationale: "Ibuprofen use could cause GI bleeding. Pallor noted. Would worsen CHF symptoms." },
                        { name: "Pneumonia", correctCategory: "less-likely", rationale: "No fever, cough, or sputum production." }
                    ],
                    
                    oldcartsNarrative: `"About three weeks ago I started getting more winded than usual. I used to walk my dog around the block no problem, but now I have to stop once or twice to catch my breath. Even walking from the parking lot makes me winded now. At night I need two pillows or I can't breathe, and twice this week I woke up gasping and had to sit up. My ankles have been swelling, especially by evening. I also get this tight feeling in my chest when I walk uphill - goes away when I stop. I'm feeling really tired and a little lightheaded. I ran out of my water pill last week and haven't refilled it. I had a heart attack about 6 years ago and they told me I had mild heart failure after. I take ibuprofen for my knee pain a few times a week. Oh, and I flew home from visiting my daughter 3 weeks ago - about a 5-hour flight. I also recently started hormone therapy for menopause."`,
                    
                    historyQuestions: [
                        { id: "orthopnea", text: "Do you need extra pillows to sleep? How many?",
                          answer: "Yes, I need two pillows now or I feel like I'm suffocating lying flat. I never needed that before a few weeks ago.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "New orthopnea is a classic symptom of CHF exacerbation. Indicates pulmonary congestion when supine." },
                        
                        { id: "pnd", text: "Do you ever wake up suddenly at night short of breath?",
                          answer: "Yes! Twice this week I woke up gasping, like I couldn't get air. I had to sit up on the edge of the bed for 15-20 minutes before it got better.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "PND (paroxysmal nocturnal dyspnea) is highly specific for CHF. Caused by fluid redistribution when supine." },
                        
                        { id: "edema", text: "Have you noticed any swelling in your legs or feet?",
                          answer: "My ankles are puffy, especially by evening. My shoes feel tighter. It's been getting worse over the past week.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "Peripheral edema indicates right heart failure/fluid overload. Worsening pattern suggests decompensation." },
                        
                        { id: "medication_adherence", text: "Are you taking all your medications regularly?",
                          answer: "I ran out of my water pill - furosemide - about a week ago and haven't had a chance to get it refilled. The pharmacy said they needed a new prescription.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "CRITICAL: Diuretic non-adherence is the #1 cause of CHF exacerbation. Missing furosemide leads to fluid accumulation." },
                        
                        { id: "chest_pressure", text: "Tell me more about the chest tightness.",
                          answer: "It's more like pressure than pain. Happens when I'm walking, especially uphill. Goes away after a few minutes of rest. No pain at rest.",
                          tier: "essential", linkedDx: ["Acute Myocardial Infarction", "CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "Exertional chest pressure in patient with prior MI could indicate ongoing ischemia. May be anginal equivalent or demand ischemia from CHF." },
                        
                        { id: "prior_mi", text: "Tell me about your heart attack.",
                          answer: "It was 6 years ago. I had stents put in. A few months later they told me my heart was a little weak - mild heart failure they said. I've been on medications since then.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "Prior MI with reduced EF is classic setup for ischemic cardiomyopathy and CHF." },
                        
                        { id: "recent_travel", text: "You mentioned a flight - tell me about that.",
                          answer: "I flew to visit my daughter about 3 weeks ago. It was about 5 hours each way. I did get up and walk around a little.",
                          tier: "essential", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "5-hour flight is VTE risk factor. Timing correlates with symptom onset. Must consider PE." },
                        
                        { id: "hrt", text: "You mentioned hormone therapy - what are you taking?",
                          answer: "I just started estrogen patches about 2 months ago for hot flashes and night sweats. My gynecologist prescribed them.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "Estrogen therapy increases VTE risk. Combined with recent travel, raises PE concern." },
                        
                        { id: "leg_symptoms", text: "Any pain or swelling in just one leg? Calf pain?",
                          answer: "No, the swelling is in both ankles equally. No calf pain.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "Bilateral symmetric edema is more consistent with CHF. Unilateral would raise DVT concern." },
                        
                        { id: "cough", text: "Any cough?",
                          answer: "No cough.",
                          tier: "helpful", linkedDx: ["Pneumonia", "COPD Exacerbation"],
                          reasoning: "No cough makes pneumonia and COPD exacerbation less likely." },
                        
                        { id: "nsaid_use", text: "How often do you take ibuprofen?",
                          answer: "Probably 3-4 times a week for my knee arthritis.",
                          tier: "helpful", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)", "Anemia"],
                          reasoning: "NSAIDs cause fluid retention and can worsen CHF. Also risk for GI bleeding." },
                        
                        { id: "smoking", text: "Do you or did you smoke?",
                          answer: "I quit 5 years ago but I smoked for about 25 years before that - about half a pack a day.",
                          tier: "helpful", linkedDx: ["COPD Exacerbation"],
                          reasoning: "25 pack-year history is significant. COPD should be considered but presentation more classic for CHF." }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_review", text: "Review vital signs", category: "Vitals",
                          finding: "BP 148/90, HR 94, RR 22, Temp 98.4Â°F, SpO2 94% on RA. Elevated BP, mild tachycardia, tachypnea, borderline hypoxia.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "Tachypnea and borderline hypoxia indicate respiratory compromise. Elevated BP may be contributing to decompensation." },
                        
                        { id: "general", text: "General appearance", category: "General",
                          finding: "Obese female, mild respiratory distress, speaks in full sentences but appears fatigued. Slightly pale.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "Can still speak in sentences - not severe respiratory failure. Pallor may indicate anemia." },
                        
                        { id: "jvp", text: "Assess jugular venous pressure", category: "Cardiovascular",
                          finding: "JVP elevated to 12 cm H2O (normal <8). Positive hepatojugular reflux.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "CRITICAL FINDING: Elevated JVP indicates right heart pressure/volume overload. Very specific for CHF." },
                        
                        { id: "cardiac_auscultation", text: "Auscultate heart", category: "Cardiovascular",
                          finding: "Regular rhythm, tachycardic. S1, S2 present. S3 gallop heard at apex. Soft systolic murmur at apex (MR). No rubs.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "S3 GALLOP is pathognomonic for systolic heart failure (ventricular dysfunction). MR murmur often accompanies dilated LV." },
                        
                        { id: "pmi", text: "Palpate PMI", category: "Cardiovascular",
                          finding: "PMI displaced laterally to anterior axillary line (normally midclavicular). Diffuse and sustained.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "Laterally displaced PMI indicates cardiomegaly from chronic LV dilation." },
                        
                        { id: "lung_exam", text: "Auscultate lungs", category: "Pulmonary",
                          finding: "Bibasilar crackles (rales) extending to mid-lung fields bilaterally. No wheezes.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "BIBASILAR CRACKLES indicate pulmonary edema. Classic finding in decompensated CHF." },
                        
                        { id: "leg_exam", text: "Examine lower extremities", category: "Extremities",
                          finding: "2+ pitting edema bilateral ankles extending to mid-shin. No calf tenderness or asymmetry. No Homan's sign.",
                          tier: "essential", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)", "Pulmonary Embolism"],
                          reasoning: "Bilateral symmetric edema consistent with CHF. No DVT signs, though doesn't rule out PE." },
                        
                        { id: "abdomen", text: "Examine abdomen", category: "Abdominal",
                          finding: "Soft, non-tender. Liver palpable 2cm below costal margin. Mild hepatomegaly. No ascites.",
                          tier: "helpful", linkedDx: ["CHF Exacerbation (Systolic Heart Failure)"],
                          reasoning: "Hepatomegaly from hepatic congestion supports right heart failure." },
                        
                        { id: "skin_pallor", text: "Assess for pallor", category: "Skin",
                          finding: "Conjunctival pallor present. Pale nail beds.",
                          tier: "helpful", linkedDx: ["Anemia"],
                          reasoning: "Pallor suggests anemia, which could be exacerbating CHF symptoms." }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "bnp", name: "BNP or NT-proBNP",
                              result: "BNP: 1,450 pg/mL (markedly elevated; normal <100)",
                              tier: "essential", reasoning: "DIAGNOSTIC for CHF. BNP >400 strongly suggests acute heart failure. Very useful for distinguishing cardiac vs pulmonary dyspnea." },
                            { id: "troponin", name: "Troponin",
                              result: "Troponin: 0.06 ng/mL (mildly elevated; normal <0.04)",
                              tier: "essential", reasoning: "Mild elevation common in CHF ('demand ischemia'). Not high enough for acute MI but indicates myocardial strain." },
                            { id: "cbc", name: "CBC",
                              result: "WBC 7.5, Hgb 10.2 (low; normal >12), Hct 31%, MCV 78 (low)",
                              tier: "essential", reasoning: "Microcytic anemia present. Likely iron deficiency from chronic NSAID use. Anemia worsens CHF symptoms." },
                            { id: "bmp", name: "BMP",
                              result: "Na 138, K 3.8, Cl 98, CO2 22, BUN 32, Cr 1.4 (slightly elevated), Glucose 145",
                              tier: "essential", reasoning: "Mild prerenal azotemia (elevated BUN/Cr) from poor cardiac output. Slightly low CO2 from tachypnea." },
                            { id: "ekg", name: "ECG",
                              result: "Sinus tachycardia at 94. Old Q waves in V1-V3 (prior anterior MI). LVH by voltage. No acute ST changes.",
                              tier: "essential", reasoning: "Confirms prior MI. No acute ischemia currently. LVH from chronic HTN/CHF." }
                        ],
                        imaging: [
                            { id: "cxr", name: "Chest X-ray",
                              result: "Cardiomegaly. Bilateral pulmonary vascular congestion. Small bilateral pleural effusions. Kerley B lines present. No consolidation.",
                              tier: "essential", reasoning: "Classic CHF findings: cardiomegaly, pulmonary edema, pleural effusions, Kerley B lines (interstitial edema)." },
                            { id: "echo", name: "Echocardiogram",
                              result: "EF 30% (reduced; normal >55%). Dilated LV. Moderate MR. No pericardial effusion. Diastolic dysfunction grade II.",
                              tier: "essential", reasoning: "Confirms systolic heart failure with reduced EF. Guides treatment and prognosis." }
                        ],
                        treatments: [
                            { id: "iv_diuretic", name: "IV Furosemide (Lasix)",
                              result: "Furosemide 40mg IV given. Urine output 800mL in first 2 hours.",
                              tier: "essential", reasoning: "FIRST-LINE treatment for acute decompensated CHF. IV diuresis to relieve pulmonary congestion." },
                            { id: "oxygen", name: "Supplemental oxygen",
                              result: "2L NC applied, SpO2 improved to 97%.",
                              tier: "essential", reasoning: "Indicated for hypoxia. Improves oxygenation while treating underlying cause." },
                            { id: "fluid_restriction", name: "Fluid restriction (1.5L/day)",
                              result: "Patient counseled on fluid restriction.",
                              tier: "helpful", reasoning: "Reduces fluid intake to help with volume status." },
                            { id: "low_sodium", name: "Low sodium diet (<2g/day)",
                              result: "Dietary counseling provided.",
                              tier: "helpful", reasoning: "Reduces fluid retention. Part of long-term CHF management." },
                            { id: "hold_nsaids", name: "Discontinue NSAIDs",
                              result: "Ibuprofen stopped. Counseled on alternative pain management.",
                              tier: "essential", reasoning: "NSAIDs cause fluid retention and worsen CHF. Must be stopped." }
                        ],
                        consults: [
                            { id: "cardiology", name: "Cardiology consult",
                              result: "Cardiology consulted for CHF optimization and possible cath.",
                              tier: "essential", reasoning: "Should optimize medical therapy. May need coronary evaluation given prior MI and exertional symptoms." }
                        ],
                        disposition: [
                            { id: "admit_tele", name: "Admit to telemetry for diuresis",
                              result: "Admitted for IV diuresis and monitoring.",
                              tier: "essential", reasoning: "Acute decompensated CHF requires admission for IV diuresis and monitoring." },
                            { id: "discharge", name: "Discharge with oral diuretics",
                              result: "Patient too symptomatic for outpatient management.",
                              tier: "less-helpful", reasoning: "Patient has hypoxia, significant pulmonary edema. Needs IV diuresis." }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Acute Decompensated Heart Failure (CHF Exacerbation) - Systolic HF from Ischemic Cardiomyopathy",
                        keyFindings: [
                            "Classic CHF symptoms: dyspnea on exertion, orthopnea (2 pillows), PND, bilateral edema",
                            "Precipitant identified: ran out of furosemide (diuretic non-adherence)",
                            "Additional contributor: chronic NSAID use causing fluid retention",
                            "Physical exam: JVP elevated, S3 gallop, bibasilar crackles, bilateral pitting edema",
                            "BNP markedly elevated (1,450) confirming cardiac cause of dyspnea",
                            "CXR: cardiomegaly, pulmonary edema, Kerley B lines, pleural effusions",
                            "Echo: EF 30%, dilated LV, moderate MR (ischemic cardiomyopathy from prior MI)"
                        ],
                        teachingPoints: [
                            "MEDICATION NON-ADHERENCE is the #1 cause of CHF exacerbation. Always ask about medications, especially diuretics.",
                            "S3 GALLOP is pathognomonic for systolic heart failure. It's the sound of blood sloshing into a dilated, non-compliant ventricle.",
                            "JVP ELEVATION is the most specific physical exam finding for CHF. Learn to measure it accurately.",
                            "BNP is extremely helpful: <100 essentially rules out CHF, >400 strongly suggests it. Useful when diagnosis is unclear.",
                            "NSAIDs WORSEN CHF: They cause sodium retention and reduce effectiveness of diuretics and ACE inhibitors. Avoid in all CHF patients.",
                            "DON'T FORGET PE: Recent travel + estrogen therapy are risk factors. CHF and PE can coexist. Keep it on your differential.",
                            "CHF IS A CLINICAL DIAGNOSIS: Orthopnea + PND + JVD + S3 + crackles + edema = CHF until proven otherwise."
                        ]
                    }
                }
            }
        },
        
        // ==================== ACUTE DYSPNEA (ASTHMA) ====================
        {
            id: "acute-dyspnea",
            title: "Acute Dyspnea",
            category: "Pulmonary",
            icon: "ðŸ˜®â€ðŸ’¨",
            
            variants: {
                "female-32-asthma": {
                    name: "J. Rivera",
                    age: 32,
                    gender: "female",
                    chiefComplaint: "I can't catch my breath",
                    vitalSigns: {
                        BP: "116/74",
                        HR: 108,
                        RR: 26,
                        Temp: "98.8Â°F",
                        SpO2: "93%"
                    },
                    
                    allDiagnoses: [
                        { name: "Asthma Exacerbation", correctCategory: "likely", rationale: "Known asthma, triggered by dog exposure (known allergen), wheezing, partial response to albuterol. Classic acute exacerbation." },
                        { name: "Anxiety/Panic Attack", correctCategory: "likely", rationale: "Young woman with acute dyspnea and anxiety. However, must rule out organic causes first - anxiety is diagnosis of exclusion." },
                        
                        { name: "Pulmonary Embolism", correctCategory: "must-not-miss", rationale: "CRITICAL: Recent 12-hour round trip car ride + oral contraceptive use = significant VTE risk factors. Must be ruled out despite asthma history." },
                        { name: "Pneumothorax", correctCategory: "must-not-miss", rationale: "Sudden onset dyspnea in young person. Check for asymmetric breath sounds and hyperresonance." },
                        
                        { name: "Pneumonia", correctCategory: "less-likely", rationale: "No fever, no cough, no sputum. Less likely but should check CXR." },
                        { name: "Anaphylaxis", correctCategory: "less-likely", rationale: "Animal allergy usually causes respiratory symptoms, not full anaphylaxis in this patient. No urticaria, no hypotension." }
                    ],
                    
                    oldcartsNarrative: `"It started about an hour ago while I was driving. I was transporting a rescue dog to a foster home - I volunteer for an animal shelter. I suddenly started wheezing and couldn't get a deep breath. My chest feels tight. I used my rescue inhaler twice and it helped a little but I'm still wheezy and short of breath. I have asthma - been diagnosed since I was 10. Usually it only acts up around cats and dogs. I drove 6 hours each way over the past 2 days - 6 hours down yesterday, helped at the shelter, then 6 hours back today with the dog in the car. I'm on birth control pills. No fever, no chest pain, no cough. I haven't had to be hospitalized for asthma before."`,
                    
                    historyQuestions: [
                        { id: "trigger", text: "What were you doing when this started?",
                          answer: "I was driving with a dog in the car. I volunteer for an animal rescue. Dogs and cats always make me wheeze if I'm around them too long.",
                          tier: "essential", linkedDx: ["Asthma Exacerbation"],
                          reasoning: "Clear trigger identified - allergen exposure (dog dander). Consistent with asthma exacerbation." },
                        
                        { id: "inhaler_response", text: "How did you respond to your rescue inhaler?",
                          answer: "I used it twice. It helped some - the wheezing got a little better - but I'm still short of breath and tight.",
                          tier: "essential", linkedDx: ["Asthma Exacerbation"],
                          reasoning: "Partial response to albuterol supports asthma. Incomplete response suggests moderate-severe exacerbation needing additional treatment." },
                        
                        { id: "asthma_severity", text: "How well controlled is your asthma usually? Any hospitalizations or intubations?",
                          answer: "It's usually pretty mild. I use my daily inhaler and only need the rescue one occasionally. Never been hospitalized or intubated for it.",
                          tier: "essential", linkedDx: ["Asthma Exacerbation"],
                          reasoning: "Mild persistent asthma baseline. No history of near-fatal asthma - lower risk for severe exacerbation." },
                        
                        { id: "recent_travel", text: "Tell me more about the driving you mentioned.",
                          answer: "I drove 6 hours yesterday to get to the shelter, then 6 hours back today. So about 12 hours of driving in 2 days, plus time at the shelter.",
                          tier: "essential", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "CRITICAL: 12 hours of prolonged immobility in 2 days is a significant VTE risk factor. Must consider PE." },
                        
                        { id: "contraceptives", text: "Are you taking any medications, including birth control?",
                          answer: "I'm on birth control pills - the combination kind. And my daily asthma inhaler - fluticasone. And albuterol as needed.",
                          tier: "essential", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "Oral contraceptives containing estrogen increase VTE risk 3-4x. Combined with travel = significant PE risk." },
                        
                        { id: "leg_symptoms", text: "Any leg pain, swelling, or redness?",
                          answer: "No, my legs feel fine. Just my breathing.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "No DVT symptoms, but PE can occur without obvious DVT. Absence is reassuring but doesn't rule out PE." },
                        
                        { id: "chest_pain", text: "Any chest pain?",
                          answer: "Not really pain, more like tightness. It's hard to take a deep breath.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism", "Asthma Exacerbation"],
                          reasoning: "Chest tightness common in both asthma and PE. Pleuritic sharp pain would raise PE suspicion more." },
                        
                        { id: "pleuritic", text: "Is the discomfort worse when you take a deep breath?",
                          answer: "Not really. It's more constant tightness.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism", "Pneumothorax"],
                          reasoning: "Non-pleuritic makes PE slightly less likely, but doesn't rule it out." },
                        
                        { id: "hemoptysis", text: "Any coughing up blood?",
                          answer: "No, no cough at all.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "No hemoptysis. Absence of cough also argues against pneumonia." },
                        
                        { id: "fever", text: "Any fever or feeling sick otherwise?",
                          answer: "No fever. I felt fine until the breathing started.",
                          tier: "helpful", linkedDx: ["Pneumonia"],
                          reasoning: "No systemic symptoms makes infection less likely." }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_review", text: "Review vital signs", category: "Vitals",
                          finding: "BP 116/74, HR 108, RR 26, Temp 98.8Â°F, SpO2 93% on RA. Tachycardia and tachypnea with mild hypoxia.",
                          tier: "essential", linkedDx: ["Asthma Exacerbation", "Pulmonary Embolism"],
                          reasoning: "Tachycardia and tachypnea consistent with respiratory distress. SpO2 93% indicates moderate severity." },
                        
                        { id: "general", text: "General appearance", category: "General",
                          finding: "Anxious-appearing young woman in mild respiratory distress. Speaking in short phrases but can complete sentences. Using accessory muscles (SCM).",
                          tier: "essential", linkedDx: ["Asthma Exacerbation"],
                          reasoning: "Can speak sentences = not severe. Accessory muscle use indicates moderate distress." },
                        
                        { id: "lung_exam", text: "Auscultate lungs", category: "Pulmonary",
                          finding: "Diffuse bilateral expiratory wheezing throughout all lung fields. Prolonged expiratory phase. Good air movement. No focal crackles or decreased breath sounds.",
                          tier: "essential", linkedDx: ["Asthma Exacerbation"],
                          reasoning: "DIFFUSE BILATERAL WHEEZING with prolonged expiration is classic for asthma. Symmetric breath sounds argue against pneumothorax." },
                        
                        { id: "percussion", text: "Percuss chest", category: "Pulmonary",
                          finding: "Resonant throughout bilaterally. No hyperresonance or dullness.",
                          tier: "helpful", linkedDx: ["Pneumothorax"],
                          reasoning: "No hyperresonance argues against pneumothorax." },
                        
                        { id: "cardiac_exam", text: "Auscultate heart", category: "Cardiovascular",
                          finding: "Tachycardic but regular rhythm. Normal S1/S2. No murmurs, rubs, or gallops. No loud P2.",
                          tier: "helpful", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "No loud P2 (which would suggest pulmonary hypertension from large PE). Normal cardiac exam otherwise." },
                        
                        { id: "leg_exam", text: "Examine lower extremities", category: "Extremities",
                          finding: "No calf tenderness, no asymmetric swelling, no warmth, no palpable cords. Negative Homan's sign.",
                          tier: "essential", linkedDx: ["Pulmonary Embolism"],
                          reasoning: "No DVT signs. Reduces but does not eliminate PE concern given risk factors." },
                        
                        { id: "pefr", text: "Peak expiratory flow rate (PEFR)", category: "Pulmonary",
                          finding: "PEFR: 280 L/min (predicted 450 for height/age = 62% predicted)",
                          tier: "essential", linkedDx: ["Asthma Exacerbation"],
                          reasoning: "PEFR 60-80% predicted = moderate exacerbation. <60% would be severe. Useful for monitoring response to treatment." },
                        
                        { id: "skin_exam", text: "Examine skin for rash", category: "Skin",
                          finding: "No urticaria, no angioedema, no rash.",
                          tier: "neutral", linkedDx: ["Anaphylaxis"],
                          reasoning: "No anaphylaxis findings." }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "abg", name: "ABG or VBG",
                              result: "pH 7.42, pCO2 38, pO2 68, HCO3 24",
                              tier: "helpful", reasoning: "Normal CO2 in setting of tachypnea - patient is compensating. Low pO2 confirms hypoxia. Would worry if CO2 rising (tiring out)." },
                            { id: "d_dimer", name: "D-dimer",
                              result: "D-dimer: 380 ng/mL (normal <500)",
                              tier: "essential", reasoning: "Negative D-dimer with Wells score â‰¤4 effectively rules out PE. Important given travel + OCP risk factors." },
                            { id: "cbc", name: "CBC",
                              result: "WBC 9.2, Hgb 13.5, normal eosinophils.",
                              tier: "neutral", reasoning: "Normal. No leukocytosis to suggest infection." }
                        ],
                        imaging: [
                            { id: "cxr", name: "Chest X-ray",
                              result: "Hyperinflation. No infiltrates, no pneumothorax, no effusion. Normal cardiac silhouette.",
                              tier: "essential", reasoning: "Rules out pneumothorax and pneumonia. Hyperinflation consistent with obstructive airway disease." },
                            { id: "cta", name: "CT Angiography chest",
                              result: "Not performed - low probability given negative D-dimer and classic asthma presentation.",
                              tier: "less-helpful", reasoning: "With negative D-dimer and low clinical probability, CTA not needed. Avoid unnecessary radiation/contrast." }
                        ],
                        treatments: [
                            { id: "albuterol_neb", name: "Albuterol nebulizer (continuous or q20min x3)",
                              result: "Albuterol 2.5mg nebulizer given x3 over 1 hour. Wheezing improved significantly.",
                              tier: "essential", reasoning: "First-line for asthma exacerbation. Continuous or stacked nebs for moderate-severe exacerbation." },
                            { id: "ipratropium", name: "Ipratropium nebulizer",
                              result: "Ipratropium added to first 3 nebulizers.",
                              tier: "essential", reasoning: "Add ipratropium to albuterol for moderate-severe exacerbation. Provides additional bronchodilation." },
                            { id: "steroids", name: "Systemic corticosteroids (prednisone or methylprednisolone)",
                              result: "Prednisone 60mg PO given.",
                              tier: "essential", reasoning: "CRITICAL: Systemic steroids reduce inflammation and prevent relapse. Give early - takes hours to work." },
                            { id: "oxygen", name: "Supplemental oxygen",
                              result: "2L NC applied, SpO2 improved to 97%.",
                              tier: "essential", reasoning: "Indicated for hypoxia. Target SpO2 >92%." },
                            { id: "magnesium", name: "IV Magnesium sulfate",
                              result: "Not given - reserved for severe exacerbation refractory to initial treatment.",
                              tier: "helpful", reasoning: "Bronchodilator for severe exacerbation. Not needed in moderate cases responding to standard treatment." }
                        ],
                        consults: [],
                        disposition: [
                            { id: "discharge", name: "Discharge with prednisone burst and albuterol",
                              result: "After 4 hours, PEFR improved to 85% predicted, SpO2 98% on RA, minimal wheeze. Discharged with 5-day prednisone burst.",
                              tier: "essential", reasoning: "Good response to treatment. Discharge with steroids, rescue inhaler, and close follow-up." },
                            { id: "admit", name: "Admit for ongoing treatment",
                              result: "Not needed if good response to treatment.",
                              tier: "less-helpful", reasoning: "Reserve admission for poor response, severe hypoxia, or history of ICU admissions for asthma." }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Acute Asthma Exacerbation (Moderate) - Triggered by Allergen Exposure",
                        keyFindings: [
                            "Known asthma with clear trigger: dog allergen exposure",
                            "Classic presentation: wheezing, chest tightness, dyspnea, partial response to home albuterol",
                            "Physical exam: diffuse bilateral expiratory wheezing, prolonged expiratory phase, accessory muscle use",
                            "PEFR 62% predicted = moderate exacerbation",
                            "SpO2 93% improved with treatment",
                            "PE ruled out: negative D-dimer despite risk factors (travel, OCPs)",
                            "CXR: hyperinflation, no pneumothorax or pneumonia"
                        ],
                        teachingPoints: [
                            "ALWAYS CONSIDER PE in acute dyspnea: This patient had significant VTE risk factors (12-hour car travel + OCPs). D-dimer helped rule out PE.",
                            "WHEEZING ISN'T ALWAYS ASTHMA: PE can cause wheezing ('cardiac asthma'). Don't assume asthma just because patient has history - reassess each time.",
                            "SILENT CHEST IS DANGEROUS: Severe asthma can present with DECREASED breath sounds (not wheezing) as air movement becomes minimal. Wheezing actually requires air movement.",
                            "STEROIDS ARE ESSENTIAL: Give systemic steroids early in any moderate-severe exacerbation. They reduce inflammation and prevent relapse.",
                            "PEFR MONITORING: Use PEFR to assess severity and response to treatment. <50% predicted = severe; >70% predicted and improving = may be safe to discharge.",
                            "D-DIMER RULES OUT PE in low-moderate risk: With Wells score â‰¤4 and negative D-dimer, PE is essentially ruled out. Saves radiation exposure from CTA.",
                            "ANXIETY IS DIAGNOSIS OF EXCLUSION: Never assume anxiety without ruling out organic causes, especially PE and asthma."
                        ]
                    }
                }
            }
        },
        
        // ==================== NEW ONSET HYPERTENSION ====================
        {
            id: "new-htn",
            title: "New Onset HTN",
            category: "Cardiovascular",
            icon: "ðŸ“ˆ",
            
            variants: {
                "male-42-essential": {
                    name: "R. Chen",
                    age: 42,
                    gender: "male",
                    chiefComplaint: "I was told my blood pressure was high at a health fair",
                    vitalSigns: {
                        BP: "156/98",
                        HR: 78,
                        RR: 14,
                        Temp: "98.4Â°F",
                        SpO2: "99%"
                    },
                    
                    allDiagnoses: [
                        { name: "Essential (Primary) Hypertension", correctCategory: "likely", rationale: "Most common cause of HTN (>90%). Age 42, family history, obesity, high-sodium diet, sedentary lifestyle all risk factors. Gradual onset without secondary symptoms." },
                        
                        { name: "Pheochromocytoma", correctCategory: "must-not-miss", rationale: "Rare but dangerous catecholamine-secreting tumor. Look for episodic headaches, sweating, palpitations - the 'spells.'" },
                        { name: "Renal Artery Stenosis", correctCategory: "must-not-miss", rationale: "Important secondary cause. Look for abdominal bruit, renal dysfunction, resistant HTN." },
                        { name: "Primary Aldosteronism", correctCategory: "must-not-miss", rationale: "More common than previously thought. Look for hypokalemia, resistant HTN." },
                        { name: "Coarctation of the Aorta", correctCategory: "must-not-miss", rationale: "Congenital narrowing of aorta. Look for BP difference between arms, weak femoral pulses, radial-femoral delay." },
                        
                        { name: "Hyperthyroidism", correctCategory: "less-likely", rationale: "Can cause systolic HTN. Would expect weight loss, tremor, heat intolerance." },
                        { name: "Obstructive Sleep Apnea", correctCategory: "less-likely", rationale: "Common contributor to HTN. Would expect snoring, daytime somnolence." },
                        { name: "Cushing's Syndrome", correctCategory: "less-likely", rationale: "Would expect weight gain, striae, moon facies." },
                        { name: "Medication-Induced HTN", correctCategory: "less-likely", rationale: "NSAIDs, decongestants, stimulants can raise BP. No such medications reported." }
                    ],
                    
                    oldcartsNarrative: `"I went to a health fair at work last week and they said my blood pressure was 158/96. They checked it twice and said it was high both times. I've never been told I had high blood pressure before, but I admit I haven't seen a doctor in years. I feel fine - no headaches, no chest pain, no shortness of breath. I've gained about 30 pounds since college. I probably eat too much salt - lots of processed foods and eating out. My dad has high blood pressure and my mom had a stroke in her 60s. I sit at a desk all day and don't really exercise. I don't smoke anymore - quit 5 years ago. I have maybe 2-3 beers on weekends. No medications except ibuprofen occasionally."`,
                    
                    historyQuestions: [
                        { id: "symptoms", text: "Have you noticed any symptoms - headaches, vision changes, chest pain, shortness of breath?",
                          answer: "No, I really feel fine. That's why I was surprised about the blood pressure.",
                          tier: "essential", linkedDx: ["Essential (Primary) Hypertension", "Pheochromocytoma"],
                          reasoning: "Asymptomatic HTN is typical of essential HTN. Pheochromocytoma would cause episodic symptoms." },
                        
                        { id: "spells", text: "Do you ever have episodes of sudden headache, sweating, or racing heart that come in 'spells'?",
                          answer: "No, nothing like that. Pretty steady day to day.",
                          tier: "essential", linkedDx: ["Pheochromocytoma"],
                          reasoning: "No paroxysmal symptoms argues against pheochromocytoma." },
                        
                        { id: "family_history", text: "Tell me about your family history of heart disease or high blood pressure.",
                          answer: "My dad takes blood pressure pills. My mom had a stroke when she was about 65. My older brother has high blood pressure too.",
                          tier: "essential", linkedDx: ["Essential (Primary) Hypertension"],
                          reasoning: "Strong family history of HTN and stroke supports essential hypertension." },
                        
                        { id: "diet", text: "Tell me about your diet and salt intake.",
                          answer: "Honestly not great. I eat out a lot - fast food, Chinese takeout. Lots of processed snacks. I probably eat way more salt than I should.",
                          tier: "essential", linkedDx: ["Essential (Primary) Hypertension"],
                          reasoning: "High sodium diet is major modifiable risk factor for essential HTN." },
                        
                        { id: "exercise", text: "How much physical activity do you get?",
                          answer: "Almost none. I sit at a computer all day and then sit on the couch at night. I know I should exercise but haven't made time.",
                          tier: "essential", linkedDx: ["Essential (Primary) Hypertension"],
                          reasoning: "Sedentary lifestyle is major modifiable risk factor." },
                        
                        { id: "weight", text: "How has your weight changed over the years?",
                          answer: "I've put on about 30 pounds since college. I'm probably about 215 now.",
                          tier: "helpful", linkedDx: ["Essential (Primary) Hypertension", "Obstructive Sleep Apnea"],
                          reasoning: "Obesity is major HTN risk factor. Also increases sleep apnea risk." },
                        
                        { id: "snoring", text: "Do you snore? Any trouble sleeping or daytime tiredness?",
                          answer: "My wife says I snore. I do feel tired during the day but I figured that's normal.",
                          tier: "helpful", linkedDx: ["Obstructive Sleep Apnea"],
                          reasoning: "Snoring and daytime somnolence suggest possible OSA, which can cause or worsen HTN." },
                        
                        { id: "medications", text: "What medications or supplements do you take, including over-the-counter?",
                          answer: "Just ibuprofen sometimes for back pain. Maybe a couple times a week.",
                          tier: "helpful", linkedDx: ["Medication-Induced HTN"],
                          reasoning: "NSAIDs can elevate BP modestly. Not likely primary cause here but worth noting." },
                        
                        { id: "smoking_alcohol", text: "Any tobacco or alcohol use?",
                          answer: "I quit smoking 5 years ago. I was about half a pack a day. I have a few beers on weekends, maybe 2-3.",
                          tier: "helpful", linkedDx: ["Essential (Primary) Hypertension"],
                          reasoning: "Former smoker increases cardiovascular risk. Alcohol use is moderate." },
                        
                        { id: "leg_weakness", text: "Any leg weakness, cramping with walking, or cold feet?",
                          answer: "No, legs feel fine.",
                          tier: "helpful", linkedDx: ["Coarctation of the Aorta"],
                          reasoning: "Claudication or cold lower extremities can occur with coarctation. Absence is reassuring." }
                    ],
                    
                    physicalExam: [
                        { id: "bp_both_arms", text: "Measure BP in both arms", category: "Vitals",
                          finding: "Right arm: 156/98. Left arm: 154/96. No significant inter-arm difference.",
                          tier: "essential", linkedDx: ["Coarctation of the Aorta"],
                          reasoning: "No BP asymmetry argues against coarctation. >20 mmHg difference would be concerning." },
                        
                        { id: "general", text: "General appearance", category: "General",
                          finding: "Overweight male (BMI 31), appears comfortable, no acute distress. No truncal obesity, no moon facies, no striae.",
                          tier: "essential", linkedDx: ["Essential (Primary) Hypertension", "Cushing's Syndrome"],
                          reasoning: "Obesity present. No cushingoid features." },
                        
                        { id: "fundoscopy", text: "Fundoscopic examination", category: "HEENT",
                          finding: "Mild arteriolar narrowing (grade I hypertensive retinopathy). No AV nicking, hemorrhages, exudates, or papilledema.",
                          tier: "essential", linkedDx: ["Essential (Primary) Hypertension"],
                          reasoning: "Mild chronic changes suggest HTN has been present for some time. No acute/severe changes." },
                        
                        { id: "thyroid", text: "Examine thyroid", category: "HEENT",
                          finding: "No thyromegaly, no nodules, no tenderness. No tremor.",
                          tier: "helpful", linkedDx: ["Hyperthyroidism"],
                          reasoning: "Normal thyroid exam argues against hyperthyroidism." },
                        
                        { id: "cardiac_exam", text: "Cardiac examination", category: "Cardiovascular",
                          finding: "Regular rhythm, normal S1/S2. S4 gallop present (suggests LVH). No murmurs.",
                          tier: "essential", linkedDx: ["Essential (Primary) Hypertension"],
                          reasoning: "S4 gallop suggests left ventricular stiffness from chronic HTN. Indicates some end-organ effect." },
                        
                        { id: "abdominal_auscultation", text: "Auscultate abdomen for bruits", category: "Abdominal",
                          finding: "No abdominal bruits. No renal artery bruits.",
                          tier: "essential", linkedDx: ["Renal Artery Stenosis"],
                          reasoning: "Absence of renal bruits makes RAS less likely, though doesn't completely rule it out." },
                        
                        { id: "peripheral_pulses", text: "Palpate all peripheral pulses", category: "Cardiovascular",
                          finding: "All pulses 2+ and symmetric. Femoral pulses strong bilaterally. No radial-femoral delay.",
                          tier: "essential", linkedDx: ["Coarctation of the Aorta"],
                          reasoning: "Normal femoral pulses and no radial-femoral delay effectively rules out coarctation." },
                        
                        { id: "edema", text: "Check for peripheral edema", category: "Extremities",
                          finding: "No peripheral edema.",
                          tier: "helpful", linkedDx: ["Essential (Primary) Hypertension"],
                          reasoning: "No signs of heart failure currently." },
                        
                        { id: "neuro_exam", text: "Brief neurological exam", category: "Neurological",
                          finding: "Alert, oriented. No focal deficits. Normal strength and sensation.",
                          tier: "helpful", linkedDx: [],
                          reasoning: "No evidence of prior stroke or hypertensive encephalopathy." }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "bmp", name: "Basic Metabolic Panel",
                              result: "Na 140, K 4.1 (normal), Cl 102, CO2 25, BUN 16, Cr 1.0 (normal), Glucose 105.",
                              tier: "essential", reasoning: "Normal potassium argues against primary aldosteronism. Normal creatinine rules out renal dysfunction." },
                            { id: "lipids", name: "Lipid Panel",
                              result: "Total cholesterol 245, LDL 155, HDL 42, Triglycerides 240.",
                              tier: "helpful", reasoning: "Dyslipidemia present - adds to cardiovascular risk. Needs treatment along with HTN." },
                            { id: "urinalysis", name: "Urinalysis",
                              result: "No proteinuria, no hematuria. Normal.",
                              tier: "essential", reasoning: "No proteinuria suggests no renal damage yet from HTN." },
                            { id: "a1c", name: "Hemoglobin A1c",
                              result: "HbA1c: 5.9% (prediabetes range)",
                              tier: "helpful", reasoning: "Prediabetes - adds to cardiovascular risk. Lifestyle modification even more important." },
                            { id: "tsh", name: "TSH",
                              result: "TSH: 2.4 (normal)",
                              tier: "helpful", reasoning: "Normal TSH rules out thyroid dysfunction as cause of HTN." },
                            { id: "ecg", name: "ECG",
                              result: "Sinus rhythm. LVH by voltage criteria. No ischemic changes.",
                              tier: "essential", reasoning: "LVH indicates chronic HTN with end-organ effect. Important for risk stratification." }
                        ],
                        imaging: [
                            { id: "echo", name: "Echocardiogram",
                              result: "Mild concentric LVH. Normal EF 60%. No valvular disease.",
                              tier: "helpful", reasoning: "Confirms LVH. Useful for risk stratification but not urgently needed." },
                            { id: "renal_doppler", name: "Renal artery Doppler ultrasound",
                              result: "Not indicated given low clinical suspicion for RAS.",
                              tier: "less-helpful", reasoning: "No indications for secondary HTN workup currently (no resistant HTN, no flash pulmonary edema, normal K+)." }
                        ],
                        treatments: [
                            { id: "lifestyle", name: "Lifestyle counseling (DASH diet, exercise, weight loss, sodium restriction)",
                              result: "Extensive counseling provided. DASH diet handout given. Exercise prescription: 150 min/week moderate activity.",
                              tier: "essential", reasoning: "First-line for stage 1 HTN. Can lower BP 10-15 mmHg. Essential even if medications started." },
                            { id: "ace_inhibitor", name: "Start ACE inhibitor (lisinopril 10mg daily)",
                              result: "Lisinopril 10mg daily prescribed.",
                              tier: "essential", reasoning: "First-line antihypertensive. Good choice given no contraindications. Will need follow-up to titrate." },
                            { id: "thiazide", name: "Start thiazide diuretic (HCTZ 12.5mg or chlorthalidone 12.5mg)",
                              result: "Alternative first-line agent, or can be added if BP not controlled on ACE inhibitor.",
                              tier: "helpful", reasoning: "Good first-line option, especially in Black patients. Can be used alone or in combination." }
                        ],
                        consults: [],
                        disposition: [
                            { id: "outpatient_fu", name: "Outpatient follow-up in 2-4 weeks to recheck BP",
                              result: "Follow-up scheduled in 3 weeks to recheck BP and assess medication effect.",
                              tier: "essential", reasoning: "Need to confirm BP remains elevated (at least 2 readings) and monitor response to treatment." },
                            { id: "home_bp", name: "Home BP monitoring",
                              result: "Instructed on proper technique. Asked to check and log BP twice daily.",
                              tier: "helpful", reasoning: "Helps rule out white coat HTN and monitors response to treatment." }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Essential (Primary) Hypertension, Stage 2, with Target Organ Damage (LVH)",
                        keyFindings: [
                            "New diagnosis of HTN: BP 156/98 (Stage 2: systolic â‰¥140 or diastolic â‰¥90)",
                            "Multiple modifiable risk factors: obesity (BMI 31), high-sodium diet, sedentary lifestyle",
                            "Strong family history of HTN and stroke",
                            "No symptoms of secondary causes (no spells, no claudication, no muscle weakness)",
                            "Physical exam: S4 gallop, mild hypertensive retinopathy",
                            "Normal K+ (argues against aldosteronism), no renal bruits (argues against RAS), equal arm BPs and strong femoral pulses (rules out coarctation)",
                            "Target organ damage already present: LVH on ECG and echo"
                        ],
                        teachingPoints: [
                            "ESSENTIAL HTN is the diagnosis in >90% of cases: But always screen for secondary causes, especially in young patients, severe/resistant HTN, or with suspicious symptoms.",
                            "SECONDARY HTN RED FLAGS: Age <30 or >55 at onset, severe/resistant HTN, hypokalemia, abdominal bruit, episodic symptoms (spells), cushingoid appearance.",
                            "BP IN BOTH ARMS: Should be done at initial diagnosis. >20 mmHg difference suggests coarctation or subclavian stenosis.",
                            "FUNDOSCOPIC EXAM: Can detect chronic hypertensive damage. Papilledema indicates hypertensive emergency.",
                            "S4 GALLOP = LVH: Indicates chronic pressure overload. The heart is already affected - treatment is urgent.",
                            "LIFESTYLE IS FIRST-LINE: DASH diet + exercise + weight loss + sodium restriction can lower BP 10-15 mmHg. Essential even if medications needed.",
                            "LVH IS TARGET ORGAN DAMAGE: Patient has Stage 2 HTN with evidence of end-organ effects. This elevates cardiovascular risk significantly."
                        ]
                    }
                }
            }
        },
        
        // ==================== COUGH AND CONGESTION (VIRAL URI) ====================
        {
            id: "cough-uri",
            title: "Cough & Congestion",
            category: "Respiratory/ENT",
            icon: "ðŸ¤§",
            
            variants: {
                "adult-36-uri": {
                    name: "T. Chen",
                    age: 36,
                    gender: "neutral",
                    chiefComplaint: "I've had this cough and congestion for about a week",
                    vitalSigns: {
                        BP: "116/74",
                        HR: 92,
                        RR: 18,
                        Temp: "99.3Â°F",
                        SpO2: "98%"
                    },
                    
                    allDiagnoses: [
                        { name: "Viral Upper Respiratory Infection (URI)", correctCategory: "likely", rationale: "Classic presentation: gradual onset, nasal congestion, postnasal drip, low-grade fever, clear/yellow sputum, 7-day duration with improvement. Sick contacts present." },
                        { name: "Acute Bronchitis", correctCategory: "likely", rationale: "Persistent cough with sputum, worse at night. Often post-viral. Distinction from URI is somewhat arbitrary - both are usually viral." },
                        { name: "Bacterial Sinusitis", correctCategory: "likely", rationale: "Facial pressure, headache worse bending forward, 7-day duration. However, no high fever, no purulent drainage, no 'double worsening' - criteria for bacterial not met." },
                        
                        { name: "Pneumonia", correctCategory: "must-not-miss", rationale: "Must rule out. Would expect higher fever, productive cough with purulent sputum, dyspnea, focal lung findings." },
                        { name: "Peritonsillar Abscess", correctCategory: "must-not-miss", rationale: "Dangerous complication of pharyngitis. Would expect severe sore throat, trismus, 'hot potato' voice, uvula deviation." },
                        { name: "Epiglottitis", correctCategory: "must-not-miss", rationale: "Medical emergency. Would expect rapid onset, high fever, drooling, stridor, respiratory distress." },
                        
                        { name: "Influenza", correctCategory: "less-likely", rationale: "Would expect more systemic symptoms: high fever, myalgias, sudden onset, severe fatigue." },
                        { name: "Allergic Rhinitis", correctCategory: "less-likely", rationale: "Patient has seasonal allergies but says 'this feels different.' Low-grade fever and sick contacts point to infection." },
                        { name: "COVID-19", correctCategory: "less-likely", rationale: "Should be considered in any respiratory illness. Would confirm with testing if concerned." }
                    ],
                    
                    oldcartsNarrative: `"It started about a week ago with a scratchy throat and stuffy nose. Then it got worse over a couple days - lots of congestion, postnasal drip, and this cough that won't quit. The cough brings up clear or slightly yellow stuff, especially in the mornings. I feel this pressure under my eyes and get headaches, especially when I bend forward. No real fever - maybe 99-100 at the highest. No chest pain, no shortness of breath. My ears feel kind of plugged but not painful. I've been taking DayQuil and NyQuil and some saline spray which helps a little. My kid had a cold last week so I probably caught it from them. I get seasonal allergies but this feels different. I'm worried it might be turning into something worse like pneumonia."`,
                    
                    historyQuestions: [
                        { id: "onset_progression", text: "How did this start and how has it progressed?",
                          answer: "Started about a week ago with a scratchy throat and stuffy nose. Got worse over the next 2-3 days, then kind of plateaued. The sore throat actually went away but the congestion and cough are hanging on.",
                          tier: "essential", linkedDx: ["Viral Upper Respiratory Infection (URI)"],
                          reasoning: "Classic URI pattern: gradual onset, peaks at day 3-4, then slow improvement. 'Double worsening' (improving then getting worse again) would suggest bacterial superinfection." },
                        
                        { id: "sputum_character", text: "What does the sputum look like when you cough?",
                          answer: "Mostly clear, sometimes a little yellow. Not green or bloody.",
                          tier: "essential", linkedDx: ["Viral Upper Respiratory Infection (URI)", "Pneumonia"],
                          reasoning: "Clear/yellow sputum is typical of viral URI. Green doesn't necessarily mean bacterial. Rusty or bloody sputum would raise concern for pneumonia." },
                        
                        { id: "fever", text: "What's the highest your temperature has gotten?",
                          answer: "Maybe 99 or 100 at the highest. Never got really high.",
                          tier: "essential", linkedDx: ["Viral Upper Respiratory Infection (URI)", "Bacterial Sinusitis", "Pneumonia"],
                          reasoning: "Low-grade fever typical of viral URI. High fever (>101-102Â°F) would raise concern for bacterial infection (sinusitis, pneumonia)." },
                        
                        { id: "sinus_symptoms", text: "Tell me more about the facial pressure and headaches.",
                          answer: "It feels full under my eyes and between them. The headache gets worse when I bend forward or look down. It's more pressure than pain.",
                          tier: "essential", linkedDx: ["Bacterial Sinusitis"],
                          reasoning: "Sinus pressure is common with viral URI due to mucosal inflammation. Bacterial sinusitis criteria: symptoms >10 days OR 'double worsening' OR severe symptoms (fever >102, purulent drainage) - not met here." },
                        
                        { id: "dyspnea", text: "Any shortness of breath or trouble breathing?",
                          answer: "No, not really. I only get a little winded if I have a bad coughing fit, but otherwise breathing is fine.",
                          tier: "essential", linkedDx: ["Pneumonia"],
                          reasoning: "No dyspnea argues against pneumonia. Important red flag to rule out." },
                        
                        { id: "chest_pain", text: "Any chest pain?",
                          answer: "My chest gets a little sore from coughing so much, but no sharp pain or anything when I breathe.",
                          tier: "essential", linkedDx: ["Pneumonia"],
                          reasoning: "Chest wall soreness from coughing is common. Pleuritic pain (sharp, worse with breathing) would raise pneumonia concern." },
                        
                        { id: "sore_throat", text: "How is your throat now?",
                          answer: "The sore throat was only at the beginning and went away after a few days. Throat feels fine now.",
                          tier: "helpful", linkedDx: ["Peritonsillar Abscess"],
                          reasoning: "Resolved sore throat makes peritonsillar abscess very unlikely. Would expect severe, worsening throat pain." },
                        
                        { id: "voice_swallowing", text: "Any changes to your voice or difficulty swallowing?",
                          answer: "Maybe a little hoarse from the postnasal drip, but no trouble swallowing. Nothing stuck in my throat.",
                          tier: "helpful", linkedDx: ["Peritonsillar Abscess", "Epiglottitis"],
                          reasoning: "No 'hot potato' voice, no dysphagia, no drooling rules out serious pharyngeal/epiglottic pathology." },
                        
                        { id: "sick_contacts", text: "Anyone around you been sick?",
                          answer: "Yeah, my kid had the same thing last week. A couple coworkers too. There's definitely something going around.",
                          tier: "essential", linkedDx: ["Viral Upper Respiratory Infection (URI)"],
                          reasoning: "Sick contacts strongly support viral etiology - URIs are highly contagious." },
                        
                        { id: "allergies", text: "Do you have seasonal allergies?",
                          answer: "Yeah, usually in the spring. But this feels different - I have the low fever and feel more run down than usual allergies.",
                          tier: "helpful", linkedDx: ["Allergic Rhinitis"],
                          reasoning: "Patient can distinguish this from their usual allergies. Fever and sick contacts point to infection over allergies." },
                        
                        { id: "smoking", text: "Do you smoke?",
                          answer: "No, never have.",
                          tier: "helpful", linkedDx: ["Acute Bronchitis"],
                          reasoning: "Non-smoker reduces concern for COPD exacerbation or complicated bronchitis." }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_review", text: "Review vital signs", category: "Vitals",
                          finding: "BP 116/74, HR 92, RR 18, Temp 99.3Â°F, SpO2 98% on RA. Low-grade fever, otherwise normal vitals.",
                          tier: "essential", linkedDx: ["Viral Upper Respiratory Infection (URI)"],
                          reasoning: "Low-grade fever typical of URI. Normal oxygen saturation argues against pneumonia." },
                        
                        { id: "general", text: "General appearance", category: "General",
                          finding: "Alert, comfortable, no acute distress. Occasional cough during exam. Mild nasal congestion voice. Tissues in hand.",
                          tier: "essential", linkedDx: ["Viral Upper Respiratory Infection (URI)"],
                          reasoning: "Not toxic-appearing. Comfortable appearance argues against serious bacterial infection." },
                        
                        { id: "ear_exam", text: "Otoscopic examination", category: "HEENT",
                          finding: "Tympanic membranes intact bilaterally with slightly dull landmarks. No bulging, no erythema, no effusion. Mild eustachian tube dysfunction.",
                          tier: "helpful", linkedDx: ["Viral Upper Respiratory Infection (URI)"],
                          reasoning: "Mild eustachian tube dysfunction explains ear fullness. No otitis media." },
                        
                        { id: "nasal_exam", text: "Examine nasal mucosa", category: "HEENT",
                          finding: "Nasal mucosa edematous and erythematous. Turbinates swollen. Clear to slightly cloudy mucoid discharge. No purulent drainage.",
                          tier: "essential", linkedDx: ["Viral Upper Respiratory Infection (URI)", "Bacterial Sinusitis"],
                          reasoning: "Mucosal inflammation with clear/mucoid discharge typical of viral URI. Purulent drainage would raise bacterial sinusitis concern." },
                        
                        { id: "sinus_palpation", text: "Palpate sinuses", category: "HEENT",
                          finding: "Mild tenderness to palpation over maxillary sinuses bilaterally. No frontal sinus tenderness. No periorbital swelling or erythema.",
                          tier: "essential", linkedDx: ["Bacterial Sinusitis"],
                          reasoning: "Mild sinus tenderness common in viral URI. Severe tenderness with fever/purulent discharge would suggest bacterial." },
                        
                        { id: "throat_exam", text: "Examine oropharynx", category: "HEENT",
                          finding: "Mild posterior pharyngeal erythema. Cobblestoning from postnasal drip. Tonsils normal size, no exudates. Uvula midline. No trismus.",
                          tier: "essential", linkedDx: ["Viral Upper Respiratory Infection (URI)", "Peritonsillar Abscess"],
                          reasoning: "Cobblestoning is classic for postnasal drip. No tonsillar asymmetry or uvula deviation rules out peritonsillar abscess." },
                        
                        { id: "neck_exam", text: "Examine neck and lymph nodes", category: "HEENT",
                          finding: "Small, mobile, non-tender anterior cervical lymph nodes bilaterally. No posterior cervical lymphadenopathy. Neck supple.",
                          tier: "helpful", linkedDx: ["Viral Upper Respiratory Infection (URI)"],
                          reasoning: "Mild reactive lymphadenopathy common with viral URI." },
                        
                        { id: "lung_exam", text: "Auscultate lungs", category: "Pulmonary",
                          finding: "Clear to auscultation bilaterally. Good air movement. No wheezes, crackles, or rhonchi. No focal findings.",
                          tier: "essential", linkedDx: ["Pneumonia", "Acute Bronchitis"],
                          reasoning: "CRITICAL: Clear lungs essentially rule out pneumonia. No focal findings to suggest consolidation." },
                        
                        { id: "lung_percussion", text: "Percuss chest", category: "Pulmonary",
                          finding: "Resonant throughout all lung fields. No dullness.",
                          tier: "helpful", linkedDx: ["Pneumonia"],
                          reasoning: "No dullness argues against consolidation or effusion." }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "none_needed", name: "No labs indicated",
                              result: "Clinical diagnosis - no labs necessary for uncomplicated viral URI.",
                              tier: "essential", reasoning: "Viral URI is a clinical diagnosis. Labs not indicated unless concerned for bacterial infection or complications." },
                            { id: "rapid_strep", name: "Rapid strep test",
                              result: "Not indicated - patient does not have significant pharyngitis currently.",
                              tier: "less-helpful", reasoning: "Centor criteria: fever, tonsillar exudates, tender anterior cervical nodes, absence of cough. Patient doesn't meet criteria." },
                            { id: "covid_test", name: "COVID-19 test",
                              result: "Could consider if local prevalence high or patient concerned. Rapid antigen negative.",
                              tier: "neutral", reasoning: "Reasonable to test if high community prevalence or for epidemiologic purposes." }
                        ],
                        imaging: [
                            { id: "cxr", name: "Chest X-ray",
                              result: "Not indicated with clear lung exam and no red flags.",
                              tier: "less-helpful", reasoning: "CXR not needed for URI with clear lungs, no hypoxia, no dyspnea, no high fever." },
                            { id: "sinus_ct", name: "Sinus CT",
                              result: "Not indicated - does not meet criteria for bacterial sinusitis.",
                              tier: "less-helpful", reasoning: "Imaging not recommended for acute sinusitis. Clinical criteria not met for bacterial infection." }
                        ],
                        treatments: [
                            { id: "supportive_care", name: "Supportive care counseling (rest, fluids, humidifier)",
                              result: "Counseled on supportive measures. Expect symptoms to improve over next 1-2 weeks.",
                              tier: "essential", reasoning: "FIRST-LINE: Viral URI is self-limited. Supportive care is the mainstay of treatment." },
                            { id: "otc_meds", name: "OTC symptom relief (decongestants, antihistamines, cough suppressants)",
                              result: "Can continue DayQuil/NyQuil. Pseudoephedrine may help congestion. Honey for cough.",
                              tier: "essential", reasoning: "Symptomatic relief only. Decongestants, antihistamines, and cough suppressants can help symptoms but don't shorten illness." },
                            { id: "saline", name: "Nasal saline irrigation",
                              result: "Continue saline spray. Neti pot or sinus rinse can also help.",
                              tier: "helpful", reasoning: "Saline irrigation is evidence-based for symptom relief in URI and sinusitis." },
                            { id: "antibiotics", name: "Antibiotics",
                              result: "NOT indicated - this is a viral infection.",
                              tier: "inappropriate", reasoning: "ANTIBIOTICS DO NOT HELP VIRAL URI. Inappropriate antibiotic use contributes to resistance. Patient does not meet criteria for bacterial sinusitis." },
                            { id: "steroids", name: "Systemic steroids",
                              result: "Not indicated for uncomplicated URI.",
                              tier: "less-helpful", reasoning: "No role for systemic steroids in viral URI." }
                        ],
                        consults: [],
                        disposition: [
                            { id: "discharge_precautions", name: "Discharge with return precautions",
                              result: "Discharge home. Return if: fever >102Â°F, symptoms worsen after initial improvement, shortness of breath, chest pain, symptoms >10-14 days without improvement.",
                              tier: "essential", reasoning: "Appropriate discharge with clear return precautions for red flags." }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Viral Upper Respiratory Infection (Common Cold)",
                        keyFindings: [
                            "Classic URI presentation: gradual onset, nasal congestion, postnasal drip, cough, low-grade fever",
                            "7-day duration with plateau/early improvement - typical viral course",
                            "Clear/yellow sputum (not purulent green)",
                            "Low-grade fever only (99.3Â°F)",
                            "Sick contacts (child, coworkers) - viral transmission",
                            "Clear lung exam - rules out pneumonia",
                            "No red flags: no high fever, no dyspnea, no hypoxia, no focal lung findings",
                            "Does NOT meet criteria for bacterial sinusitis (no high fever, no purulent drainage, no 'double worsening', <10 days)"
                        ],
                        teachingPoints: [
                            "VIRAL URI IS CLINICAL DIAGNOSIS: No labs or imaging needed for typical presentation. Save resources and avoid unnecessary radiation.",
                            "ANTIBIOTICS DON'T HELP VIRAL URI: Most URIs are viral. Antibiotics won't help and contribute to resistance. Resist patient pressure for antibiotics.",
                            "SPUTUM COLOR DOESN'T INDICATE BACTERIA: Yellow or even green sputum is common in viral infections and doesn't mean antibiotics are needed.",
                            "BACTERIAL SINUSITIS CRITERIA: Symptoms >10 days without improvement, OR 'double worsening' (improving then getting worse), OR severe symptoms (fever >102, purulent drainage for 3+ days). Most 'sinus infections' are viral.",
                            "KNOW THE RED FLAGS: High fever (>102), dyspnea, hypoxia, focal lung findings, severe sore throat with trismus, drooling, stridor - these need further workup.",
                            "TIME IS THE BEST TREATMENT: URI symptoms peak at day 3-4 and typically resolve by day 10-14. Set expectations.",
                            "PATIENT EDUCATION IS KEY: Explain why antibiotics aren't helpful. Discuss supportive care. Give clear return precautions."
                        ]
                    }
                }
            }
        },
        
        // ==================== CHRONIC FATIGUE / ANEMIA ====================
        {
            id: "chronic-fatigue-anemia",
            title: "Chronic Fatigue",
            category: "Hematology",
            icon: "ðŸ˜´",
            
            variants: {
                "adult-52-ida": {
                    name: "J. Smith",
                    age: 52,
                    gender: "female",
                    chiefComplaint: "I've been feeling really tired and short of breath for a few months",
                    vitalSigns: {
                        BP: "122/74",
                        HR: 94,
                        RR: 16,
                        Temp: "98.2Â°F",
                        SpO2: "98%"
                    },
                    
                    allDiagnoses: [
                        { name: "Iron Deficiency Anemia", correctCategory: "likely", rationale: "Classic presentation: fatigue, dyspnea on exertion, pica (ice chewing), vegetarian diet, heavy menses. Exam findings of pallor and glossitis support this." },
                        { name: "Anemia of Chronic Disease", correctCategory: "likely", rationale: "Consider given prior MI. However, no active inflammatory condition identified." },
                        
                        { name: "Occult GI Bleeding", correctCategory: "must-not-miss", rationale: "CRITICAL in anyone with iron deficiency anemia, especially over age 50. Must rule out colon cancer. GI workup required." },
                        { name: "CHF Exacerbation", correctCategory: "must-not-miss", rationale: "History of prior MI, stopped diuretic. Must evaluate for heart failure as cause of dyspnea." },
                        
                        { name: "Hypothyroidism", correctCategory: "less-likely", rationale: "Some symptoms overlap (fatigue, cold intolerance, weight gain, sluggish thinking). Should check TSH." },
                        { name: "COPD", correctCategory: "less-likely", rationale: "Former smoker but quit 5 years ago. No chronic cough, no wheezing. Dyspnea pattern doesn't fit." },
                        { name: "Deconditioning", correctCategory: "less-likely", rationale: "Sedentary lifestyle could contribute but doesn't explain pallor, pica, or lab abnormalities." }
                    ],
                    
                    oldcartsNarrative: `"For the past 3-4 months I've been feeling exhausted all the time. It doesn't matter how much I sleep, I wake up tired. And I get short of breath way easier than I used to - just walking up a flight of stairs or across the parking lot leaves me winded. Sometimes my heart feels like it's racing after I exert myself. I had a mild heart attack about 5 years ago and I'm worried it might be my heart again. I don't have the chest pain or swelling in my legs though. I've been vegetarian for years and don't eat much red meat. Here's the strange thing - I've been craving ice constantly. I just want to chew on ice all day. I know that's weird. My periods have always been heavy - usually last about a week with lots of pad changes. Oh, and I've been feeling cold all the time lately and gained about 5 pounds. I stopped taking my water pill about a month ago because it made me pee too much at night."`,
                    
                    historyQuestions: [
                        { id: "fatigue_pattern", text: "Describe the fatigue - is it constant or does it come and go?",
                          answer: "It's constant. I wake up tired, I'm tired all day, I go to bed tired. Doesn't matter how much sleep I get. It's been getting worse over months.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia", "Hypothyroidism"],
                          reasoning: "Constant fatigue not relieved by rest suggests systemic cause (anemia, thyroid) rather than sleep disorder or deconditioning." },
                        
                        { id: "dyspnea_pattern", text: "When do you get short of breath?",
                          answer: "With activity - stairs, walking across parking lots, carrying groceries. Things that never used to bother me. It goes away when I rest.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia", "CHF Exacerbation"],
                          reasoning: "Exertional dyspnea relieved by rest seen in both anemia (decreased O2 carrying capacity) and CHF (cardiac limitation)." },
                        
                        { id: "orthopnea_pnd", text: "Do you need extra pillows to sleep? Do you wake up gasping at night?",
                          answer: "No, I sleep flat with one pillow. No waking up short of breath at night.",
                          tier: "essential", linkedDx: ["CHF Exacerbation"],
                          reasoning: "No orthopnea or PND argues against CHF exacerbation despite stopping diuretic." },
                        
                        { id: "edema", text: "Any swelling in your legs or feet?",
                          answer: "No, my legs look normal.",
                          tier: "essential", linkedDx: ["CHF Exacerbation"],
                          reasoning: "No peripheral edema further argues against CHF." },
                        
                        { id: "pica", text: "You mentioned craving ice - tell me more about that.",
                          answer: "I can't stop chewing ice. I go through trays of ice cubes. I've been doing it for a couple months. I know it's strange but I just crave it.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia"],
                          reasoning: "PICA (craving non-nutritive substances, especially ice/pagophagia) is HIGHLY SPECIFIC for iron deficiency anemia. This is almost diagnostic." },
                        
                        { id: "diet", text: "Tell me about your diet.",
                          answer: "I've been vegetarian for about 10 years. I don't eat red meat at all. I try to eat beans and greens but I know I probably don't get enough iron.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia"],
                          reasoning: "Vegetarian diet with limited heme iron intake is a risk factor for iron deficiency." },
                        
                        { id: "menses", text: "Tell me about your menstrual periods.",
                          answer: "They've always been heavy. Usually last about 7 days. I go through a lot of pads, sometimes have to change every couple hours on heavy days. No clots though.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia"],
                          reasoning: "Heavy menstrual bleeding is the most common cause of iron deficiency in premenopausal women." },
                        
                        { id: "gi_bleeding", text: "Any blood in your stool? Black or tarry stools? Vomiting blood?",
                          answer: "No, my stools look normal. No blood that I've seen.",
                          tier: "essential", linkedDx: ["Occult GI Bleeding"],
                          reasoning: "No overt GI bleeding symptoms, BUT occult bleeding can still occur. Must do GI workup for iron deficiency in patients over 50." },
                        
                        { id: "cold_intolerance", text: "You mentioned feeling cold - any other symptoms like that?",
                          answer: "Yes, I'm always cold when others are comfortable. I've also noticed I feel kind of sluggish mentally, like my thinking is slower. And I gained about 5 pounds.",
                          tier: "helpful", linkedDx: ["Hypothyroidism"],
                          reasoning: "Cold intolerance, weight gain, cognitive slowing could suggest hypothyroidism. Should check TSH." },
                        
                        { id: "cardiac_history", text: "Tell me about your heart attack.",
                          answer: "It was 5 years ago, pretty mild they said. I didn't get a stent. I've been on metoprolol and lisinopril since then. No problems until now.",
                          tier: "helpful", linkedDx: ["CHF Exacerbation"],
                          reasoning: "Prior MI is risk factor for CHF. Important history but current presentation doesn't fit CHF pattern." },
                        
                        { id: "stopped_diuretic", text: "Why did you stop the water pill?",
                          answer: "It made me pee so much at night, I couldn't sleep. So I just stopped it about a month ago. Was that bad?",
                          tier: "helpful", linkedDx: ["CHF Exacerbation"],
                          reasoning: "Stopping furosemide could precipitate CHF, but patient denies orthopnea, PND, edema. Anemia more likely cause of symptoms." }
                    ],
                    
                    physicalExam: [
                        { id: "vitals_review", text: "Review vital signs", category: "Vitals",
                          finding: "BP 122/74, HR 94 (mildly elevated), RR 16, Temp 98.2Â°F, SpO2 98% on RA.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia"],
                          reasoning: "Mild tachycardia can be compensatory response to anemia. Normal oxygen saturation." },
                        
                        { id: "general", text: "General appearance", category: "General",
                          finding: "Fatigued-appearing but alert. Speaks in full sentences. Pale complexion. No acute distress.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia"],
                          reasoning: "Pallor is key finding for anemia. Fatigue visible but not severely ill-appearing." },
                        
                        { id: "conjunctival_pallor", text: "Examine conjunctivae", category: "HEENT",
                          finding: "Conjunctival pallor present bilaterally. Pale lower palpebral conjunctivae.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia"],
                          reasoning: "CONJUNCTIVAL PALLOR is sensitive bedside test for anemia, especially when Hgb <9." },
                        
                        { id: "tongue_exam", text: "Examine tongue and oral mucosa", category: "HEENT",
                          finding: "Glossitis present - tongue appears smooth, red, with loss of papillae. Mild angular cheilitis at corners of mouth.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia"],
                          reasoning: "GLOSSITIS (smooth, beefy red tongue) and angular cheilitis are classic iron deficiency findings." },
                        
                        { id: "cardiac_exam", text: "Cardiac examination", category: "Cardiovascular",
                          finding: "Regular rhythm, tachycardic. Soft systolic flow murmur at LLSB (grade 1-2/6). No S3 or S4 gallop. No heaves or thrills.",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia", "CHF Exacerbation"],
                          reasoning: "FLOW MURMUR is common with anemia - increased blood flow velocity across normal valves. No S3 argues against CHF." },
                        
                        { id: "jvp", text: "Assess JVP", category: "Cardiovascular",
                          finding: "JVP not elevated (normal). No hepatojugular reflux.",
                          tier: "essential", linkedDx: ["CHF Exacerbation"],
                          reasoning: "Normal JVP strongly argues against CHF despite stopping diuretic." },
                        
                        { id: "lung_exam", text: "Auscultate lungs", category: "Pulmonary",
                          finding: "Clear to auscultation bilaterally. No crackles, wheezes, or rhonchi.",
                          tier: "essential", linkedDx: ["CHF Exacerbation", "COPD"],
                          reasoning: "Clear lungs rule out pulmonary edema (CHF) and suggest no active COPD exacerbation." },
                        
                        { id: "abdominal_exam", text: "Examine abdomen including spleen", category: "Abdominal",
                          finding: "Soft, non-tender. No hepatomegaly. Spleen not palpable. No masses.",
                          tier: "helpful", linkedDx: ["Iron Deficiency Anemia"],
                          reasoning: "No splenomegaly (would suggest hemolytic anemia or other causes). No masses." },
                        
                        { id: "leg_exam", text: "Examine lower extremities", category: "Extremities",
                          finding: "No peripheral edema. No calf tenderness. Nails slightly concave (koilonychia beginning).",
                          tier: "essential", linkedDx: ["Iron Deficiency Anemia", "CHF Exacerbation"],
                          reasoning: "No edema rules out CHF. Koilonychia (spoon nails) is classic but late finding of iron deficiency." },
                        
                        { id: "thyroid_exam", text: "Examine thyroid", category: "HEENT",
                          finding: "Thyroid normal size, no nodules, no tenderness.",
                          tier: "helpful", linkedDx: ["Hypothyroidism"],
                          reasoning: "Normal thyroid exam but doesn't rule out hypothyroidism. Need TSH." },
                        
                        { id: "rectal_exam", text: "Rectal exam with stool guaiac", category: "GI",
                          finding: "Normal tone. No masses. Stool guaiac POSITIVE (occult blood detected).",
                          tier: "essential", linkedDx: ["Occult GI Bleeding"],
                          reasoning: "CRITICAL: Positive guaiac indicates occult GI bleeding. Requires colonoscopy, especially at age 52." }
                    ],
                    
                    workupOptions: {
                        labs: [
                            { id: "cbc", name: "CBC with indices",
                              result: "WBC 6.5, Hgb 8.2 g/dL (LOW), Hct 25%, MCV 72 fL (LOW - microcytic), RDW 18% (HIGH), Plt 420 (HIGH)",
                              tier: "essential", reasoning: "MICROCYTIC ANEMIA (low MCV) with elevated RDW and reactive thrombocytosis - classic pattern for iron deficiency anemia." },
                            { id: "iron_studies", name: "Iron studies (Fe, TIBC, ferritin)",
                              result: "Serum iron: 25 Î¼g/dL (LOW), TIBC: 450 Î¼g/dL (HIGH), Ferritin: 8 ng/mL (LOW), Transferrin saturation: 6% (LOW)",
                              tier: "essential", reasoning: "DIAGNOSTIC for iron deficiency: low iron, low ferritin, high TIBC, low transferrin saturation. This is the pattern." },
                            { id: "reticulocyte", name: "Reticulocyte count",
                              result: "Reticulocyte count: 0.8% (low-normal), Reticulocyte index: 0.4 (inadequate response)",
                              tier: "helpful", reasoning: "Low reticulocyte response indicates marrow isn't producing enough RBCs despite anemia - consistent with iron deficiency (no iron to make hemoglobin)." },
                            { id: "tsh", name: "TSH",
                              result: "TSH: 3.2 mIU/L (normal)",
                              tier: "helpful", reasoning: "Normal TSH rules out hypothyroidism as cause of symptoms." },
                            { id: "bmp", name: "BMP",
                              result: "Normal electrolytes, Cr 0.9.",
                              tier: "helpful", reasoning: "Normal renal function rules out anemia of chronic kidney disease." },
                            { id: "bnp", name: "BNP",
                              result: "BNP: 85 pg/mL (normal <100)",
                              tier: "helpful", reasoning: "Normal BNP argues strongly against CHF as cause of dyspnea." }
                        ],
                        imaging: [
                            { id: "cxr", name: "Chest X-ray",
                              result: "Normal heart size. Lungs clear. No pulmonary edema.",
                              tier: "helpful", reasoning: "Confirms no CHF. Heart not enlarged." },
                            { id: "echo", name: "Echocardiogram",
                              result: "EF 50% (mildly reduced but stable from prior). No wall motion abnormalities. No significant valvular disease.",
                              tier: "helpful", reasoning: "Stable from prior known mild LV dysfunction. Not cause of current symptoms." }
                        ],
                        procedures: [
                            { id: "colonoscopy", name: "Colonoscopy",
                              result: "REQUIRED - patient is over 50 with iron deficiency anemia and positive stool guaiac. Must rule out colon cancer.",
                              tier: "essential", reasoning: "MANDATORY: Iron deficiency anemia in anyone over 50 requires GI workup to rule out malignancy. Positive guaiac makes this even more urgent." },
                            { id: "egd", name: "Upper endoscopy (EGD)",
                              result: "Should be performed to evaluate upper GI source of blood loss.",
                              tier: "essential", reasoning: "Bidirectional endoscopy (both EGD and colonoscopy) often recommended for IDA in older adults." }
                        ],
                        treatments: [
                            { id: "iron_replacement", name: "Iron supplementation (ferrous sulfate 325mg daily)",
                              result: "Ferrous sulfate 325mg PO daily started. Take on empty stomach with vitamin C. Expect constipation, dark stools.",
                              tier: "essential", reasoning: "First-line treatment for iron deficiency. Takes 2-3 months to replenish stores. Reticulocyte count should rise in 1-2 weeks." },
                            { id: "dietary_counseling", name: "Dietary iron counseling",
                              result: "Counseled on iron-rich foods, importance of heme iron (if not strict vegetarian), vitamin C to enhance absorption.",
                              tier: "helpful", reasoning: "Dietary modification alone rarely corrects iron deficiency but helps maintain stores once repleted." },
                            { id: "transfusion", name: "Blood transfusion",
                              result: "Not indicated currently - patient is symptomatic but hemodynamically stable with Hgb 8.2.",
                              tier: "less-helpful", reasoning: "Transfusion reserved for severe anemia (typically Hgb <7) or hemodynamic instability. This patient can be treated with oral iron." }
                        ],
                        consults: [
                            { id: "gi_consult", name: "GI consult for colonoscopy/EGD",
                              result: "GI consulted. Colonoscopy and EGD scheduled.",
                              tier: "essential", reasoning: "MANDATORY: Must evaluate for GI source of blood loss. Colon cancer is a must-not-miss diagnosis." }
                        ],
                        disposition: [
                            { id: "outpatient", name: "Outpatient management with urgent GI referral",
                              result: "Discharged with iron supplementation. Urgent GI referral for endoscopy within 2-4 weeks.",
                              tier: "essential", reasoning: "Can be managed outpatient if stable. GI workup is urgent but not emergent." }
                        ]
                    },
                    
                    actualDiagnosis: {
                        name: "Iron Deficiency Anemia with Occult GI Bleeding - Requires Colonoscopy to Rule Out Malignancy",
                        keyFindings: [
                            "Classic IDA symptoms: fatigue, dyspnea on exertion, palpitations with activity",
                            "PICA (ice craving/pagophagia) - highly specific for iron deficiency",
                            "Risk factors: vegetarian diet, heavy menses",
                            "Physical exam: conjunctival pallor, glossitis, flow murmur, early koilonychia",
                            "Labs confirm IDA: Hgb 8.2, MCV 72 (microcytic), ferritin 8 (depleted stores), low iron, high TIBC",
                            "POSITIVE STOOL GUAIAC - occult GI bleeding source must be identified",
                            "No CHF findings despite prior MI: no orthopnea, no PND, no edema, normal JVP, normal BNP"
                        ],
                        teachingPoints: [
                            "PICA IS HIGHLY SPECIFIC FOR IRON DEFICIENCY: Ice craving (pagophagia) is almost diagnostic. Always ask about unusual cravings.",
                            "IRON DEFICIENCY IN ADULTS OVER 50 = GI WORKUP MANDATORY: You must rule out colon cancer. Even if patient has 'obvious' cause like heavy menses, still scope them.",
                            "FERRITIN IS THE MOST USEFUL SINGLE TEST: Low ferritin (<15-30) is specific for iron deficiency. But ferritin is an acute phase reactant - can be falsely normal with inflammation.",
                            "MCV HELPS CATEGORIZE ANEMIA: Low MCV (microcytic) = iron deficiency, thalassemia, or chronic disease. Normal MCV = early iron deficiency, chronic disease, renal disease. High MCV = B12/folate deficiency, liver disease.",
                            "FLOW MURMUR WITH ANEMIA: High cardiac output and decreased blood viscosity cause soft systolic murmurs across normal valves. Not pathologic.",
                            "DON'T FORGET THE RECTAL: Positive stool guaiac in patient with IDA clinches the need for GI workup.",
                            "IRON REPLACEMENT TAKES TIME: Expect reticulocyte response in 1-2 weeks, hemoglobin to rise 1-2 g/dL per month. Full repletion takes 3-6 months."
                        ]
                    }
                }
            }
        }
    ];
    
    // ============================================================
    // RENDER FUNCTIONS
    // ============================================================
    
    function render() {
        const app = document.getElementById('app');
        
        switch(state.screen) {
            case 'menu':
                app.innerHTML = renderMenu();
                break;
            case 'case-select':
                app.innerHTML = renderCaseSelect();
                break;
            case 'differential':
                app.innerHTML = renderDifferentialStage();
                break;
            case 'history':
                app.innerHTML = renderHistoryStage();
                break;
            case 'physical':
                app.innerHTML = renderPhysicalStage();
                break;
            case 'revised-differential':
                app.innerHTML = renderRevisedDifferentialStage();
                break;
            case 'workup':
                app.innerHTML = renderWorkupStage();
                break;
            case 'summary':
                app.innerHTML = renderSummary();
                break;
            default:
                app.innerHTML = renderMenu();
        }
    }
    
    function renderMenu() {
        return `
            <div class="text-center py-8 fade-in">
                <h1 class="text-4xl font-bold text-white mb-2">ðŸ©º Clinical Reasoning Trainer</h1>
                <p class="text-blue-200 mb-8">Master hypothesis-driven clinical thinking</p>
                
                <div class="card p-8 max-w-lg mx-auto">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Select Mode</h2>
                    
                    <div class="space-y-4">
                        <button onclick="selectMode('practice')" 
                                class="w-full p-6 rounded-xl border-2 border-blue-200 hover:border-blue-500 hover:bg-blue-50 transition-all text-left">
                            <div class="flex items-center gap-4">
                                <span class="text-4xl">ðŸ“š</span>
                                <div>
                                    <div class="font-bold text-lg text-gray-800">Practice Mode</div>
                                    <div class="text-gray-600 text-sm">Learn with detailed feedback at each step. No pressure, maximum learning.</div>
                                </div>
                            </div>
                        </button>
                        
                        <button onclick="selectMode('quiz')"
                                class="w-full p-6 rounded-xl border-2 border-purple-200 hover:border-purple-500 hover:bg-purple-50 transition-all text-left">
                            <div class="flex items-center gap-4">
                                <span class="text-4xl">ðŸŽ¯</span>
                                <div>
                                    <div class="font-bold text-lg text-gray-800">Quiz Mode</div>
                                    <div class="text-gray-600 text-sm">Test yourself with scoring. Feedback after each section plus final score.</div>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">How It Works</h3>
                        <ol class="text-sm text-gray-600 space-y-1">
                            <li>1ï¸âƒ£ Create initial differential diagnosis (categorize as "Most Likely" vs "Must Not Miss")</li>
                            <li>2ï¸âƒ£ Review OLDCARTS, then select targeted history questions</li>
                            <li>3ï¸âƒ£ Choose focused physical exam maneuvers</li>
                            <li>4ï¸âƒ£ Revise your differential based on findings</li>
                            <li>5ï¸âƒ£ Select workup and next steps</li>
                            <li>6ï¸âƒ£ Review final diagnosis and teaching points</li>
                        </ol>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderCaseSelect() {
        return `
            <div class="fade-in">
                <button onclick="goBack()" class="text-blue-200 hover:text-white mb-4 flex items-center gap-2">
                    â† Back to Menu
                </button>
                
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">
                        ${state.mode === 'quiz' ? 'ðŸŽ¯ Quiz Mode' : 'ðŸ“š Practice Mode'}
                    </h2>
                    <p class="text-gray-600 text-center mb-6">Select a case to begin</p>
                    
                    <div class="grid gap-4 md:grid-cols-2">
                        ${cases.map(c => `
                            <button onclick="selectCase('${c.id}')"
                                    class="p-4 rounded-xl border-2 ${state.caseType === c.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'} transition-all text-left">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">${c.icon}</span>
                                    <div>
                                        <div class="font-bold text-gray-800">${c.title}</div>
                                        <div class="text-sm text-gray-500">${Object.keys(c.variants).length} variant${Object.keys(c.variants).length > 1 ? 's' : ''}</div>
                                    </div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                    
                    ${state.caseType ? renderVariantSelection() : ''}
                </div>
            </div>
        `;
    }
    
    function renderVariantSelection() {
        const caseData = cases.find(c => c.id === state.caseType);
        if (!caseData) return '';
        
        return `
            <div class="mt-6 pt-6 border-t">
                <h3 class="font-bold text-gray-800 mb-4">Select Patient</h3>
                <div class="space-y-3">
                    ${Object.entries(caseData.variants).map(([key, variant]) => `
                        <button onclick="selectVariant('${key}')"
                                class="w-full p-4 rounded-lg border-2 ${state.variantKey === key ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'} transition-all text-left">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold text-gray-800">${variant.name}, ${variant.age}-year-old ${variant.gender === 'male' ? 'Male' : variant.gender === 'female' ? 'Female' : 'Adult'}</div>
                                    <div class="text-sm text-gray-600 italic">"${variant.chiefComplaint}"</div>
                                </div>
                                ${state.variantKey === key ? '<span class="text-blue-500 text-xl">âœ“</span>' : ''}
                            </div>
                        </button>
                    `).join('')}
                </div>
                
                <button onclick="startCase()"
                        class="w-full mt-6 py-3 rounded-lg font-bold text-white ${state.variantKey ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                        ${state.variantKey ? '' : 'disabled'}>
                    Begin Case â†’
                </button>
            </div>
        `;
    }
    
    function renderDifferentialStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        const vs = variant.vitalSigns;
        
        const totalSelected = state.selectedLikely.length + state.selectedMustNotMiss.length;
        const availableDx = variant.allDiagnoses.filter(d => 
            !state.selectedLikely.includes(d.name) && !state.selectedMustNotMiss.includes(d.name)
        );
        
        return `
            <div class="fade-in">
                <button onclick="goBack()" class="text-blue-200 hover:text-white mb-4 flex items-center gap-2">
                    â† Back to Case Selection
                </button>
                
                <div class="card p-6 mb-4">
                    <!-- Case Header -->
                    <div class="flex items-center gap-4 mb-4">
                        <span class="text-4xl">${caseData.icon}</span>
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">${variant.name}, ${variant.age}-year-old</h2>
                            <p class="text-gray-600">Chief Complaint: "${variant.chiefComplaint}"</p>
                        </div>
                    </div>
                    
                    <!-- Vital Signs -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-gray-700 mb-2">Vital Signs</h3>
                        <div class="grid grid-cols-5 gap-2 text-sm">
                            <div class="text-center"><span class="text-gray-500">BP</span><br><strong>${vs.BP}</strong></div>
                            <div class="text-center"><span class="text-gray-500">HR</span><br><strong>${vs.HR}</strong></div>
                            <div class="text-center"><span class="text-gray-500">RR</span><br><strong>${vs.RR}</strong></div>
                            <div class="text-center"><span class="text-gray-500">Temp</span><br><strong>${vs.Temp}</strong></div>
                            <div class="text-center"><span class="text-gray-500">SpO2</span><br><strong>${vs.SpO2}</strong></div>
                        </div>
                    </div>
                    
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 1 of 5</span>
                            <span>Initial Differential</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 20%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Build Your Differential Diagnosis</h3>
                    <p class="text-gray-600 text-sm mb-4">
                        Based on the chief complaint, vital signs, and patient demographics, categorize the diagnoses below. 
                        Click a diagnosis to assign it as "Most Likely" or "Must Not Miss."
                    </p>
                    
                    ${!state.differentialSubmitted ? `
                        <!-- Selection Counter -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                            <div class="text-center">
                                <span class="text-2xl font-bold text-blue-600">${totalSelected}</span>
                                <span class="text-gray-600"> diagnoses selected</span>
                            </div>
                            <p class="text-xs text-center text-gray-500 mt-1">Aim for 3-4 "Most Likely" and 2-3 "Must Not Miss"</p>
                        </div>
                        
                        <!-- Category Drop Zones -->
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <!-- Most Likely Zone -->
                            <div>
                                <h4 class="font-semibold text-green-700 mb-2 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                    Most Likely (${state.selectedLikely.length})
                                </h4>
                                <div class="category-zone likely min-h-[100px]">
                                    ${state.selectedLikely.length === 0 ? 
                                        '<p class="text-gray-400 text-sm text-center py-4">Click diagnoses below to add</p>' :
                                        state.selectedLikely.map(name => `
                                            <div class="dx-card selected-likely mb-2 flex justify-between items-center">
                                                <span>${name}</span>
                                                <button onclick="removeDx('${name}', 'likely')" class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                            
                            <!-- Must Not Miss Zone -->
                            <div>
                                <h4 class="font-semibold text-red-700 mb-2 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                    Must Not Miss (${state.selectedMustNotMiss.length})
                                </h4>
                                <div class="category-zone must-not-miss min-h-[100px]">
                                    ${state.selectedMustNotMiss.length === 0 ?
                                        '<p class="text-gray-400 text-sm text-center py-4">Click diagnoses below to add</p>' :
                                        state.selectedMustNotMiss.map(name => `
                                            <div class="dx-card selected-must-not-miss mb-2 flex justify-between items-center">
                                                <span>${name}</span>
                                                <button onclick="removeDx('${name}', 'must-not-miss')" class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Diagnoses -->
                        <h4 class="font-semibold text-gray-700 mb-2">Available Diagnoses (click to categorize)</h4>
                        <div class="grid gap-2 mb-6">
                            ${availableDx.map(dx => `
                                <div class="dx-card flex justify-between items-center">
                                    <span>${dx.name}</span>
                                    <div class="flex gap-2">
                                        <button onclick="addDx('${dx.name}', 'likely')" 
                                                class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                                            + Likely
                                        </button>
                                        <button onclick="addDx('${dx.name}', 'must-not-miss')"
                                                class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                            + Must Not Miss
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="submitDifferential()"
                                class="w-full py-3 rounded-lg font-bold text-white ${totalSelected >= 4 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${totalSelected >= 4 ? '' : 'disabled'}>
                            ${totalSelected < 4 ? `Select at least ${4 - totalSelected} more` : 'Submit Differential â†’'}
                        </button>
                    ` : renderDifferentialFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderDifferentialFeedback(variant) {
        // Calculate score
        let correctLikely = 0;
        let correctMustNotMiss = 0;
        let missedMustNotMiss = [];
        
        variant.allDiagnoses.forEach(dx => {
            if (dx.correctCategory === 'likely' && state.selectedLikely.includes(dx.name)) {
                correctLikely++;
            }
            if (dx.correctCategory === 'must-not-miss') {
                if (state.selectedMustNotMiss.includes(dx.name)) {
                    correctMustNotMiss++;
                } else if (!state.selectedLikely.includes(dx.name)) {
                    missedMustNotMiss.push(dx.name);
                }
            }
        });
        
        const totalMustNotMiss = variant.allDiagnoses.filter(d => d.correctCategory === 'must-not-miss').length;
        const allMustNotMissCaught = missedMustNotMiss.length === 0;
        
        return `
            <div class="slide-in">
                <!-- Score Display (Quiz Mode) -->
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${Math.round((correctLikely + correctMustNotMiss * 2) / (state.selectedLikely.length + state.selectedMustNotMiss.length * 2) * 100)}%</div>
                        <p class="text-gray-600 text-sm">Initial Differential Score</p>
                    </div>
                ` : ''}
                
                ${allMustNotMissCaught ? `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 text-green-700">
                            <span class="text-2xl">âœ…</span>
                            <span class="font-semibold">Excellent! You identified all "must not miss" diagnoses.</span>
                        </div>
                    </div>
                ` : `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 text-red-700 mb-2">
                            <span class="text-2xl">âš ï¸</span>
                            <span class="font-semibold">Missed some critical diagnoses!</span>
                        </div>
                        <p class="text-sm text-red-600">You missed: ${missedMustNotMiss.join(', ')}</p>
                    </div>
                `}
                
                <!-- Feedback for each selection -->
                <div class="space-y-4 mb-6">
                    <h4 class="font-semibold text-gray-700">Your Selections:</h4>
                    
                    <!-- Most Likely selections -->
                    ${state.selectedLikely.map(name => {
                        const dx = variant.allDiagnoses.find(d => d.name === name);
                        const isCorrect = dx?.correctCategory === 'likely';
                        const wasMustNotMiss = dx?.correctCategory === 'must-not-miss';
                        return `
                            <div class="p-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : wasMustNotMiss ? 'bg-yellow-50 border border-yellow-200' : 'bg-gray-50 border border-gray-200'}">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>${isCorrect ? 'âœ…' : wasMustNotMiss ? 'âš ï¸' : 'âž–'}</span>
                                    <span class="font-semibold">${name}</span>
                                    <span class="text-sm text-green-600">(You said: Most Likely)</span>
                                </div>
                                <p class="text-sm text-gray-600 ml-6">${dx?.rationale || ''}</p>
                                ${wasMustNotMiss ? '<p class="text-sm text-yellow-700 ml-6 mt-1"><strong>Note:</strong> This is actually a "Must Not Miss" diagnosis!</p>' : ''}
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- Must Not Miss selections -->
                    ${state.selectedMustNotMiss.map(name => {
                        const dx = variant.allDiagnoses.find(d => d.name === name);
                        const isCorrect = dx?.correctCategory === 'must-not-miss';
                        return `
                            <div class="p-3 rounded-lg ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'}">
                                <div class="flex items-center gap-2 mb-1">
                                    <span>${isCorrect ? 'âœ…' : 'âž–'}</span>
                                    <span class="font-semibold">${name}</span>
                                    <span class="text-sm text-red-600">(You said: Must Not Miss)</span>
                                </div>
                                <p class="text-sm text-gray-600 ml-6">${dx?.rationale || ''}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Thinking Prompt -->
                <div class="thinking-prompt mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ§ </span>
                        <h4 class="font-semibold text-purple-800">Before You Continue...</h4>
                    </div>
                    <p class="text-purple-700 text-sm">
                        Think about what history questions would help you distinguish between your top diagnoses. 
                        What specific information would make you more or less confident in each possibility?
                    </p>
                </div>
                
                <button onclick="advanceToHistory()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                    Continue to History Taking â†’
                </button>
            </div>
        `;
    }
    
    function renderHistoryStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        
        return `
            <div class="fade-in">
                <div class="card p-6 mb-4">
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 2 of 5</span>
                            <span>History Taking</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 40%"></div>
                        </div>
                    </div>
                    
                    <!-- OLDCARTS Narrative -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-800 mb-2">ðŸ“‹ Initial History (OLDCARTS)</h3>
                        <p class="text-sm text-gray-500 mb-3">After gathering the standard history using OLDCARTS or another approach, here's what you've learned:</p>
                        <div class="narrative-box">
                            ${variant.oldcartsNarrative}
                        </div>
                    </div>
                    
                    ${!state.historySubmitted ? `
                        <!-- Question Selection -->
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">ðŸŽ¯ Select Additional History Questions</h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Choose the questions that will most help you refine your differential. 
                                Focus on hypothesis-driven questions that rule in or rule out specific diagnoses.
                            </p>
                            
                            <!-- Selection Counter -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                                <div class="text-center">
                                    <span class="text-2xl font-bold text-blue-600">${state.selectedHistory.length}</span>
                                    <span class="text-gray-600"> questions selected</span>
                                </div>
                                <p class="text-xs text-center text-gray-500 mt-1">A focused history typically includes 6-8 targeted questions beyond OLDCARTS</p>
                            </div>
                            
                            <!-- Questions -->
                            <div class="space-y-2 mb-6">
                                ${variant.historyQuestions.map(q => `
                                    <button onclick="toggleHistory('${q.id}')"
                                            class="selection-btn ${state.selectedHistory.includes(q.id) ? 'selected' : ''}">
                                        <div class="flex items-center justify-between">
                                            <span>${q.text}</span>
                                            ${state.selectedHistory.includes(q.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                            
                            <button onclick="submitHistory()"
                                    class="w-full py-3 rounded-lg font-bold text-white ${state.selectedHistory.length >= 3 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                    ${state.selectedHistory.length >= 3 ? '' : 'disabled'}>
                                ${state.selectedHistory.length < 3 ? `Select at least ${3 - state.selectedHistory.length} more` : 'Submit History Questions â†’'}
                            </button>
                        </div>
                    ` : renderHistoryFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderHistoryFeedback(variant) {
        const selectedQuestions = variant.historyQuestions.filter(q => state.selectedHistory.includes(q.id));
        const essentialSelected = selectedQuestions.filter(q => q.tier === 'essential').length;
        const essentialTotal = variant.historyQuestions.filter(q => q.tier === 'essential').length;
        
        return `
            <div class="slide-in">
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${Math.round(essentialSelected / essentialTotal * 100)}%</div>
                        <p class="text-gray-600 text-sm">Essential Questions Asked</p>
                    </div>
                ` : ''}
                
                <h3 class="font-semibold text-gray-800 mb-4">Patient Responses & Feedback</h3>
                
                <div class="space-y-3 mb-6">
                    ${selectedQuestions.map(q => `
                        <div class="p-4 rounded-lg border ${q.tier === 'essential' ? 'border-green-300 bg-green-50' : q.tier === 'helpful' ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-gray-50'}">
                            <div class="flex items-start justify-between mb-2">
                                <span class="font-medium text-gray-800">${q.text}</span>
                                <span class="badge ${q.tier === 'essential' ? 'badge-essential' : q.tier === 'helpful' ? 'badge-helpful' : q.tier === 'neutral' ? 'badge-neutral' : 'badge-low-yield'}">
                                    ${q.tier === 'essential' ? 'â­ Essential' : q.tier === 'helpful' ? 'ðŸ‘ Helpful' : q.tier === 'neutral' ? 'âž– Neutral' : 'ðŸ“‰ Low-yield'}
                                </span>
                            </div>
                            <div class="bg-white rounded p-3 mb-2 italic text-gray-700">
                                "${q.answer}"
                            </div>
                            <div class="text-sm">
                                ${q.linkedDx.length > 0 ? `<span class="text-purple-600"><strong>Linked to:</strong> ${q.linkedDx.join(', ')}</span><br>` : ''}
                                <span class="text-gray-600">${q.reasoning}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Missed Essential Questions -->
                ${(() => {
                    const missedEssential = variant.historyQuestions.filter(q => q.tier === 'essential' && !state.selectedHistory.includes(q.id));
                    if (missedEssential.length === 0) return '';
                    return `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-yellow-800 mb-2">âš ï¸ Essential Questions You Didn't Ask:</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${missedEssential.map(q => `<li>â€¢ ${q.text} â€” <em>${q.reasoning}</em></li>`).join('')}
                            </ul>
                        </div>
                    `;
                })()}
                
                <div class="thinking-prompt mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ§ </span>
                        <h4 class="font-semibold text-purple-800">Reflect on Your Findings</h4>
                    </div>
                    <p class="text-purple-700 text-sm">
                        Based on what you've learned, which diagnoses are now MORE likely? Which are LESS likely? 
                        What physical exam findings would help you further narrow your differential?
                    </p>
                </div>
                
                <button onclick="advanceToPhysical()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                    Continue to Physical Exam â†’
                </button>
            </div>
        `;
    }
    
    function renderPhysicalStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        
        // Group exams by category
        const categories = [...new Set(variant.physicalExam.map(e => e.category))];
        
        return `
            <div class="fade-in">
                <div class="card p-6 mb-4">
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 3 of 5</span>
                            <span>Physical Examination</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 60%"></div>
                        </div>
                    </div>
                    
                    ${!state.physicalSubmitted ? `
                        <h3 class="font-semibold text-gray-800 mb-2">ðŸ©º Select Physical Exam Maneuvers</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            Choose the exam components that will help refine your differential. 
                            More thorough is generally better, but focus on the most relevant maneuvers for efficiency.
                        </p>
                        
                        <!-- Selection Counter -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                            <div class="text-center">
                                <span class="text-2xl font-bold text-blue-600">${state.selectedPhysical.length}</span>
                                <span class="text-gray-600"> maneuvers selected</span>
                            </div>
                            <p class="text-xs text-center text-gray-500 mt-1">A focused exam for this presentation typically includes 8-10 key maneuvers</p>
                        </div>
                        
                        <!-- Exam by Category -->
                        ${categories.map(cat => `
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-700 mb-2">${cat}</h4>
                                <div class="space-y-2">
                                    ${variant.physicalExam.filter(e => e.category === cat).map(exam => `
                                        <button onclick="togglePhysical('${exam.id}')"
                                                class="selection-btn ${state.selectedPhysical.includes(exam.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${exam.text}</span>
                                                ${state.selectedPhysical.includes(exam.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        
                        <button onclick="submitPhysical()"
                                class="w-full py-3 rounded-lg font-bold text-white ${state.selectedPhysical.length >= 5 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${state.selectedPhysical.length >= 5 ? '' : 'disabled'}>
                            ${state.selectedPhysical.length < 5 ? `Select at least ${5 - state.selectedPhysical.length} more` : 'Submit Physical Exam â†’'}
                        </button>
                    ` : renderPhysicalFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderPhysicalFeedback(variant) {
        const selectedExams = variant.physicalExam.filter(e => state.selectedPhysical.includes(e.id));
        const essentialSelected = selectedExams.filter(e => e.tier === 'essential').length;
        const essentialTotal = variant.physicalExam.filter(e => e.tier === 'essential').length;
        
        return `
            <div class="slide-in">
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${Math.round(essentialSelected / essentialTotal * 100)}%</div>
                        <p class="text-gray-600 text-sm">Essential Exams Performed</p>
                    </div>
                ` : ''}
                
                <h3 class="font-semibold text-gray-800 mb-4">Physical Exam Findings</h3>
                
                <div class="space-y-3 mb-6">
                    ${selectedExams.map(exam => `
                        <div class="p-4 rounded-lg border ${exam.tier === 'essential' ? 'border-green-300 bg-green-50' : exam.tier === 'helpful' ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-gray-50'}">
                            <div class="flex items-start justify-between mb-2">
                                <span class="font-medium text-gray-800">${exam.text}</span>
                                <span class="badge ${exam.tier === 'essential' ? 'badge-essential' : exam.tier === 'helpful' ? 'badge-helpful' : 'badge-neutral'}">
                                    ${exam.tier === 'essential' ? 'â­ Essential' : exam.tier === 'helpful' ? 'ðŸ‘ Helpful' : 'âž– Neutral'}
                                </span>
                            </div>
                            <div class="bg-white rounded p-3 mb-2 font-medium text-gray-800">
                                ${exam.finding}
                            </div>
                            <div class="text-sm text-gray-600">
                                ${exam.reasoning}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Exams Not Performed -->
                ${(() => {
                    const notPerformed = variant.physicalExam.filter(e => !state.selectedPhysical.includes(e.id));
                    if (notPerformed.length === 0) return '';
                    
                    // Separate by tier for organized display
                    const missedEssential = notPerformed.filter(e => e.tier === 'essential');
                    const missedHelpful = notPerformed.filter(e => e.tier === 'helpful');
                    const missedOther = notPerformed.filter(e => e.tier !== 'essential' && e.tier !== 'helpful');
                    
                    return `
                        <div class="mb-6">
                            <h3 class="font-semibold text-gray-800 mb-4">Exams You Didn't Perform</h3>
                            
                            ${missedEssential.length > 0 ? `
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold text-red-700 mb-2">âš ï¸ Essential Exams Missed:</h4>
                                    <div class="space-y-2">
                                        ${missedEssential.map(exam => `
                                            <div class="p-3 rounded-lg border border-red-200 bg-red-50">
                                                <div class="flex items-start justify-between mb-1">
                                                    <span class="font-medium text-gray-800">${exam.text}</span>
                                                    <span class="badge badge-essential">â­ Essential</span>
                                                </div>
                                                <div class="text-sm text-gray-600 mb-1">
                                                    <strong>Would have found:</strong> ${exam.finding}
                                                </div>
                                                <div class="text-sm text-red-700">
                                                    <strong>Why important:</strong> ${exam.reasoning}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${missedHelpful.length > 0 ? `
                                <div class="mb-4">
                                    <h4 class="text-sm font-semibold text-blue-700 mb-2">ðŸ’¡ Helpful Exams You Could Have Done:</h4>
                                    <div class="space-y-2">
                                        ${missedHelpful.map(exam => `
                                            <div class="p-3 rounded-lg border border-blue-200 bg-blue-50">
                                                <div class="flex items-start justify-between mb-1">
                                                    <span class="font-medium text-gray-800">${exam.text}</span>
                                                    <span class="badge badge-helpful">ðŸ‘ Helpful</span>
                                                </div>
                                                <div class="text-sm text-gray-600 mb-1">
                                                    <strong>Would have found:</strong> ${exam.finding}
                                                </div>
                                                <div class="text-sm text-blue-700">
                                                    <strong>Why helpful:</strong> ${exam.reasoning}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${missedOther.length > 0 ? `
                                <details class="mb-4">
                                    <summary class="text-sm font-semibold text-gray-600 mb-2 cursor-pointer hover:text-gray-800">
                                        âž• Other Exams Not Performed (${missedOther.length}) - Click to expand
                                    </summary>
                                    <div class="space-y-2 mt-2">
                                        ${missedOther.map(exam => `
                                            <div class="p-3 rounded-lg border border-gray-200 bg-gray-50">
                                                <div class="flex items-start justify-between mb-1">
                                                    <span class="font-medium text-gray-800">${exam.text}</span>
                                                    <span class="badge badge-neutral">âž– Neutral</span>
                                                </div>
                                                <div class="text-sm text-gray-600 mb-1">
                                                    <strong>Would have found:</strong> ${exam.finding}
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    ${exam.reasoning}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                })()}
                
                <div class="thinking-prompt mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ§ </span>
                        <h4 class="font-semibold text-purple-800">Time to Revise Your Differential</h4>
                    </div>
                    <p class="text-purple-700 text-sm">
                        Based on your history and physical findings, how has your differential changed? 
                        Which diagnoses have moved up? Which have been ruled out or become less likely?
                    </p>
                </div>
                
                <button onclick="advanceToRevisedDifferential()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                    Revise Your Differential â†’
                </button>
            </div>
        `;
    }
    
    function renderRevisedDifferentialStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        
        // Initialize revised lists from original if empty
        if (state.revisedLikely.length === 0 && state.revisedMustNotMiss.length === 0 && !state.revisedSubmitted) {
            state.revisedLikely = [...state.selectedLikely];
            state.revisedMustNotMiss = [...state.selectedMustNotMiss];
        }
        
        const totalSelected = state.revisedLikely.length + state.revisedMustNotMiss.length;
        const availableDx = variant.allDiagnoses.filter(d => 
            !state.revisedLikely.includes(d.name) && !state.revisedMustNotMiss.includes(d.name)
        );
        
        return `
            <div class="fade-in">
                <div class="card p-6">
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 4 of 5</span>
                            <span>Revised Differential</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 80%"></div>
                        </div>
                    </div>
                    
                    ${!state.revisedSubmitted ? `
                        <h3 class="font-semibold text-gray-800 mb-2">ðŸ“ Revise Your Differential Diagnosis</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            Based on your history and physical findings, update your differential. 
                            Add or remove diagnoses as appropriate. What has changed and why?
                        </p>
                        
                        <!-- Thinking Notes -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700">Optional: Note why your differential changed</label>
                            <textarea 
                                class="w-full p-3 border rounded-lg mt-1" 
                                rows="2" 
                                placeholder="e.g., 'Moved PUD up because of melena and NSAID use. Ruled out ACS given normal ECG...'"
                                onchange="state.differentialNotes = this.value"
                            >${state.differentialNotes}</textarea>
                        </div>
                        
                        <!-- Category Zones (same as before) -->
                        <div class="grid md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <h4 class="font-semibold text-green-700 mb-2 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                    Most Likely (${state.revisedLikely.length})
                                </h4>
                                <div class="category-zone likely min-h-[100px]">
                                    ${state.revisedLikely.length === 0 ? 
                                        '<p class="text-gray-400 text-sm text-center py-4">Click diagnoses below to add</p>' :
                                        state.revisedLikely.map(name => `
                                            <div class="dx-card selected-likely mb-2 flex justify-between items-center">
                                                <span>${name}</span>
                                                <button onclick="removeRevisedDx('${name}', 'likely')" class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-red-700 mb-2 flex items-center gap-2">
                                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                    Must Not Miss (${state.revisedMustNotMiss.length})
                                </h4>
                                <div class="category-zone must-not-miss min-h-[100px]">
                                    ${state.revisedMustNotMiss.length === 0 ?
                                        '<p class="text-gray-400 text-sm text-center py-4">Click diagnoses below to add</p>' :
                                        state.revisedMustNotMiss.map(name => `
                                            <div class="dx-card selected-must-not-miss mb-2 flex justify-between items-center">
                                                <span>${name}</span>
                                                <button onclick="removeRevisedDx('${name}', 'must-not-miss')" class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                            </div>
                                        `).join('')
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <h4 class="font-semibold text-gray-700 mb-2">Available Diagnoses</h4>
                        <div class="grid gap-2 mb-6">
                            ${availableDx.map(dx => `
                                <div class="dx-card flex justify-between items-center">
                                    <span>${dx.name}</span>
                                    <div class="flex gap-2">
                                        <button onclick="addRevisedDx('${dx.name}', 'likely')" 
                                                class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">
                                            + Likely
                                        </button>
                                        <button onclick="addRevisedDx('${dx.name}', 'must-not-miss')"
                                                class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">
                                            + Must Not Miss
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="submitRevisedDifferential()"
                                class="w-full py-3 rounded-lg font-bold text-white ${totalSelected >= 1 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${totalSelected >= 1 ? '' : 'disabled'}>
                            Submit Revised Differential â†’
                        </button>
                    ` : renderRevisedDifferentialFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderRevisedDifferentialFeedback(variant) {
        // Get the ideal differential from case data
        const idealLikely = variant.allDiagnoses.filter(d => d.correctCategory === 'likely').map(d => d.name);
        const idealMustNotMiss = variant.allDiagnoses.filter(d => d.correctCategory === 'must-not-miss').map(d => d.name);
        
        // Calculate what they got right/wrong
        const correctLikely = state.revisedLikely.filter(dx => idealLikely.includes(dx));
        const correctMustNotMiss = state.revisedMustNotMiss.filter(dx => idealMustNotMiss.includes(dx));
        const missedLikely = idealLikely.filter(dx => !state.revisedLikely.includes(dx) && !state.revisedMustNotMiss.includes(dx));
        const missedMustNotMiss = idealMustNotMiss.filter(dx => !state.revisedMustNotMiss.includes(dx) && !state.revisedLikely.includes(dx));
        
        // Check if they put must-not-miss in likely (acceptable but note it)
        const mustNotMissInLikely = state.revisedLikely.filter(dx => idealMustNotMiss.includes(dx));
        
        // Calculate score for quiz mode
        const totalIdeal = idealLikely.length + idealMustNotMiss.length;
        const totalCorrect = correctLikely.length + correctMustNotMiss.length + mustNotMissInLikely.length;
        const score = Math.round((totalCorrect / totalIdeal) * 100);
        
        return `
            <div class="slide-in">
                <!-- Student's Differential -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="font-semibold text-blue-800 mb-2">ðŸ“‹ Your Revised Differential</h4>
                    <div class="mt-2">
                        <strong class="text-green-700">Most Likely:</strong> ${state.revisedLikely.join(', ') || 'None'}
                    </div>
                    <div>
                        <strong class="text-red-700">Must Not Miss:</strong> ${state.revisedMustNotMiss.join(', ') || 'None'}
                    </div>
                </div>
                
                ${state.differentialNotes ? `
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-purple-800 mb-1">Your Reasoning:</h4>
                        <p class="text-purple-700 text-sm">${state.differentialNotes}</p>
                    </div>
                ` : ''}
                
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${score}%</div>
                        <p class="text-gray-600 text-sm">Revised Differential Score</p>
                    </div>
                ` : ''}
                
                <!-- Ideal Differential Comparison -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl p-5 mb-6">
                    <h4 class="font-bold text-green-800 mb-4 flex items-center gap-2">
                        <span class="text-xl">ðŸŽ¯</span>
                        Ideal Differential for This Case
                    </h4>
                    
                    <!-- Ideal Most Likely -->
                    <div class="mb-4">
                        <h5 class="font-semibold text-green-700 mb-2 flex items-center gap-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            Most Likely Diagnoses:
                        </h5>
                        <div class="space-y-2">
                            ${idealLikely.map(dx => {
                                const dxData = variant.allDiagnoses.find(d => d.name === dx);
                                const studentHadIt = state.revisedLikely.includes(dx);
                                const studentHadAsMustNotMiss = state.revisedMustNotMiss.includes(dx);
                                return `
                                    <div class="p-3 rounded-lg ${studentHadIt ? 'bg-green-100 border border-green-300' : studentHadAsMustNotMiss ? 'bg-yellow-100 border border-yellow-300' : 'bg-white border border-gray-200'}">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="font-medium">${dx}</span>
                                            ${studentHadIt ? '<span class="text-green-600 text-sm font-semibold">âœ“ You got this!</span>' : 
                                              studentHadAsMustNotMiss ? '<span class="text-yellow-600 text-sm">â†” You had as Must Not Miss</span>' :
                                              '<span class="text-red-600 text-sm">âœ— Missed</span>'}
                                        </div>
                                        <p class="text-sm text-gray-600">${dxData?.rationale || ''}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Ideal Must Not Miss -->
                    <div>
                        <h5 class="font-semibold text-red-700 mb-2 flex items-center gap-2">
                            <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                            Must Not Miss Diagnoses:
                        </h5>
                        <div class="space-y-2">
                            ${idealMustNotMiss.map(dx => {
                                const dxData = variant.allDiagnoses.find(d => d.name === dx);
                                const studentHadIt = state.revisedMustNotMiss.includes(dx);
                                const studentHadAsLikely = state.revisedLikely.includes(dx);
                                return `
                                    <div class="p-3 rounded-lg ${studentHadIt ? 'bg-green-100 border border-green-300' : studentHadAsLikely ? 'bg-yellow-100 border border-yellow-300' : 'bg-red-50 border border-red-200'}">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="font-medium">${dx}</span>
                                            ${studentHadIt ? '<span class="text-green-600 text-sm font-semibold">âœ“ You got this!</span>' : 
                                              studentHadAsLikely ? '<span class="text-yellow-600 text-sm">â†” You had as Most Likely (still on your radar!)</span>' :
                                              '<span class="text-red-600 text-sm font-semibold">âš ï¸ Missed - Critical!</span>'}
                                        </div>
                                        <p class="text-sm text-gray-600">${dxData?.rationale || ''}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Summary of Performance -->
                ${missedMustNotMiss.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 text-red-700 mb-2">
                            <span class="text-xl">âš ï¸</span>
                            <span class="font-semibold">Important: You missed ${missedMustNotMiss.length} "Must Not Miss" diagnosis${missedMustNotMiss.length > 1 ? 'es' : ''}!</span>
                        </div>
                        <p class="text-sm text-red-600">
                            In clinical practice, missing these could lead to serious patient harm. Always consider dangerous diagnoses even if less likely.
                        </p>
                    </div>
                ` : `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 text-green-700">
                            <span class="text-xl">âœ…</span>
                            <span class="font-semibold">Excellent! You identified all "Must Not Miss" diagnoses.</span>
                        </div>
                    </div>
                `}
                
                <div class="thinking-prompt mb-6">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xl">ðŸ§ </span>
                        <h4 class="font-semibold text-purple-800">Now Plan Your Workup</h4>
                    </div>
                    <p class="text-purple-700 text-sm">
                        What tests, imaging, or interventions would help confirm your leading diagnosis? 
                        What would help rule out your "must not miss" conditions? 
                        Prioritize: if you could only do 3 things right now, what would they be?
                    </p>
                </div>
                
                <button onclick="advanceToWorkup()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                    Continue to Workup & Next Steps â†’
                </button>
            </div>
        `;
    }
    
    function renderWorkupStage() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        const workup = variant.workupOptions;
        
        return `
            <div class="fade-in">
                <div class="card p-6">
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>Stage 5 of 5</span>
                            <span>Workup & Next Steps</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    ${!state.workupSubmitted ? `
                        <h3 class="font-semibold text-gray-800 mb-2">ðŸ”¬ Select Your Workup & Next Steps</h3>
                        <p class="text-sm text-gray-600 mb-2">
                            Choose the tests, imaging, treatments, and other steps you would order.
                        </p>
                        <p class="text-sm text-amber-600 font-medium mb-4">
                            ðŸ’¡ Prioritize: If you could only do 3 things immediately, what would they be?
                        </p>
                        
                        <!-- Selection Counter -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                            <div class="text-center">
                                <span class="text-2xl font-bold text-blue-600">${state.selectedWorkup.length}</span>
                                <span class="text-gray-600"> items selected</span>
                            </div>
                        </div>
                        
                        <!-- Workup Categories -->
                        <div class="space-y-4 mb-6">
                            <!-- Labs -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ§ª Labs</div>
                                <div class="p-3 space-y-2">
                                    ${workup.labs.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Imaging -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ“· Imaging</div>
                                <div class="p-3 space-y-2">
                                    ${workup.imaging.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Procedures -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ”§ Procedures</div>
                                <div class="p-3 space-y-2">
                                    ${workup.procedures.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Treatments -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ’Š Treatments</div>
                                <div class="p-3 space-y-2">
                                    ${workup.treatments.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Consults -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ‘¥ Consults</div>
                                <div class="p-3 space-y-2">
                                    ${workup.consults.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Disposition -->
                            <div class="workup-category">
                                <div class="workup-category-header">ðŸ¥ Disposition</div>
                                <div class="p-3 space-y-2">
                                    ${workup.disposition.map(item => `
                                        <button onclick="toggleWorkup('${item.id}')"
                                                class="selection-btn ${state.selectedWorkup.includes(item.id) ? 'selected' : ''}">
                                            <div class="flex items-center justify-between">
                                                <span>${item.name}</span>
                                                ${state.selectedWorkup.includes(item.id) ? '<span class="text-blue-500">âœ“</span>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="submitWorkup()"
                                class="w-full py-3 rounded-lg font-bold text-white ${state.selectedWorkup.length >= 3 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}"
                                ${state.selectedWorkup.length >= 3 ? '' : 'disabled'}>
                            ${state.selectedWorkup.length < 3 ? `Select at least ${3 - state.selectedWorkup.length} more` : 'Submit Workup & See Results â†’'}
                        </button>
                    ` : renderWorkupFeedback(variant)}
                </div>
            </div>
        `;
    }
    
    function renderWorkupFeedback(variant) {
        const workup = variant.workupOptions;
        const allItems = [...workup.labs, ...workup.imaging, ...workup.procedures, ...workup.treatments, ...workup.consults, ...workup.disposition];
        const selectedItems = allItems.filter(item => state.selectedWorkup.includes(item.id));
        
        const essentialSelected = selectedItems.filter(item => item.tier === 'essential').length;
        const essentialTotal = allItems.filter(item => item.tier === 'essential').length;
        
        return `
            <div class="slide-in">
                ${state.mode === 'quiz' ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-center">
                        <div class="text-3xl font-bold text-blue-600">${Math.round(essentialSelected / essentialTotal * 100)}%</div>
                        <p class="text-gray-600 text-sm">Essential Workup Items Selected</p>
                    </div>
                ` : ''}
                
                <h3 class="font-semibold text-gray-800 mb-4">ðŸ“‹ Results & Feedback</h3>
                
                <div class="space-y-3 mb-6">
                    ${selectedItems.map(item => `
                        <div class="p-4 rounded-lg border ${item.tier === 'essential' ? 'border-green-300 bg-green-50' : item.tier === 'helpful' ? 'border-blue-300 bg-blue-50' : item.tier === 'less-helpful' || item.tier === 'inappropriate' ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200 bg-gray-50'}">
                            <div class="flex items-start justify-between mb-2">
                                <span class="font-medium text-gray-800">${item.name}</span>
                                <span class="badge ${item.tier === 'essential' ? 'badge-essential' : item.tier === 'helpful' ? 'badge-helpful' : item.tier === 'less-helpful' || item.tier === 'inappropriate' ? 'badge-low-yield' : 'badge-neutral'}">
                                    ${item.tier === 'essential' ? 'â­ Essential' : item.tier === 'helpful' ? 'ðŸ‘ Helpful' : item.tier === 'less-helpful' ? 'ðŸ“‰ Less Helpful' : item.tier === 'inappropriate' ? 'âŒ Inappropriate' : 'âž– Neutral'}
                                </span>
                            </div>
                            <div class="bg-white rounded p-3 mb-2 font-medium text-gray-800">
                                ${item.result}
                            </div>
                            <div class="text-sm text-gray-600">
                                ${item.reasoning}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <button onclick="showSummary()"
                        class="w-full py-3 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700">
                    See Final Diagnosis & Summary â†’
                </button>
            </div>
        `;
    }
    
    function renderSummary() {
        const caseData = cases.find(c => c.id === state.caseType);
        const variant = caseData.variants[state.variantKey];
        const dx = variant.actualDiagnosis;
        
        return `
            <div class="fade-in">
                <div class="card p-6">
                    <div class="text-center mb-6">
                        <span class="text-6xl">ðŸŽ‰</span>
                        <h2 class="text-2xl font-bold text-gray-800 mt-4">Case Complete!</h2>
                    </div>
                    
                    <!-- Final Diagnosis -->
                    <div class="bg-green-50 border-2 border-green-300 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-bold text-green-800 mb-2">Final Diagnosis</h3>
                        <p class="text-xl font-semibold text-green-900">${dx.name}</p>
                    </div>
                    
                    <!-- Key Findings -->
                    <div class="mb-6">
                        <h3 class="font-bold text-gray-800 mb-3">ðŸ”‘ Key Findings</h3>
                        <ul class="space-y-2">
                            ${dx.keyFindings.map(f => `
                                <li class="flex items-start gap-2">
                                    <span class="text-green-500 mt-1">âœ“</span>
                                    <span>${f}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    <!-- Teaching Points -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
                        <h3 class="font-bold text-blue-800 mb-3">ðŸ“š Teaching Points</h3>
                        <ul class="space-y-3">
                            ${dx.teachingPoints.map(t => `
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-500 mt-1">ðŸ’¡</span>
                                    <span class="text-blue-900">${t}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    ${state.mode === 'quiz' ? renderFinalScore() : ''}
                    
                    <div class="flex gap-4">
                        <button onclick="resetAndGoToMenu()"
                                class="flex-1 py-3 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700">
                            â† Back to Menu
                        </button>
                        <button onclick="restartCase()"
                                class="flex-1 py-3 rounded-lg font-bold text-blue-600 border-2 border-blue-600 hover:bg-blue-50">
                            Try Another Case
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderFinalScore() {
        // Calculate weighted score
        // This is a simplified version - would need more sophisticated calculation
        return `
            <div class="bg-purple-50 border-2 border-purple-300 rounded-xl p-6 mb-6 text-center">
                <h3 class="font-bold text-purple-800 mb-2">ðŸŽ¯ Your Score</h3>
                <div class="text-5xl font-bold text-purple-600 mb-2">85%</div>
                <p class="text-purple-700 text-sm">Great clinical reasoning!</p>
            </div>
        `;
    }
    
    // ============================================================
    // ACTION FUNCTIONS
    // ============================================================
    
    function selectMode(mode) {
        state.mode = mode;
        state.screen = 'case-select';
        render();
    }
    
    function selectCase(caseId) {
        state.caseType = caseId;
        state.variantKey = null;
        render();
    }
    
    function selectVariant(variantKey) {
        state.variantKey = variantKey;
        render();
    }
    
    function startCase() {
        if (!state.variantKey) return;
        state.screen = 'differential';
        render();
    }
    
    function goBack() {
        if (state.screen === 'case-select') {
            state.screen = 'menu';
            state.mode = null;
            state.caseType = null;
        } else if (state.screen === 'differential') {
            state.screen = 'case-select';
        }
        render();
    }
    
    // Differential functions
    function addDx(name, category) {
        if (category === 'likely') {
            state.selectedLikely.push(name);
        } else {
            state.selectedMustNotMiss.push(name);
        }
        render();
    }
    
    function removeDx(name, category) {
        if (category === 'likely') {
            state.selectedLikely = state.selectedLikely.filter(n => n !== name);
        } else {
            state.selectedMustNotMiss = state.selectedMustNotMiss.filter(n => n !== name);
        }
        render();
    }
    
    function submitDifferential() {
        state.differentialSubmitted = true;
        render();
    }
    
    function advanceToHistory() {
        state.screen = 'history';
        render();
    }
    
    // History functions
    function toggleHistory(id) {
        if (state.selectedHistory.includes(id)) {
            state.selectedHistory = state.selectedHistory.filter(h => h !== id);
        } else {
            state.selectedHistory.push(id);
        }
        render();
    }
    
    function submitHistory() {
        state.historySubmitted = true;
        render();
    }
    
    function advanceToPhysical() {
        state.screen = 'physical';
        render();
    }
    
    // Physical exam functions
    function togglePhysical(id) {
        if (state.selectedPhysical.includes(id)) {
            state.selectedPhysical = state.selectedPhysical.filter(p => p !== id);
        } else {
            state.selectedPhysical.push(id);
        }
        render();
    }
    
    function submitPhysical() {
        state.physicalSubmitted = true;
        render();
    }
    
    function advanceToRevisedDifferential() {
        state.screen = 'revised-differential';
        render();
    }
    
    // Revised differential functions
    function addRevisedDx(name, category) {
        if (category === 'likely') {
            state.revisedLikely.push(name);
        } else {
            state.revisedMustNotMiss.push(name);
        }
        render();
    }
    
    function removeRevisedDx(name, category) {
        if (category === 'likely') {
            state.revisedLikely = state.revisedLikely.filter(n => n !== name);
        } else {
            state.revisedMustNotMiss = state.revisedMustNotMiss.filter(n => n !== name);
        }
        render();
    }
    
    function submitRevisedDifferential() {
        state.revisedSubmitted = true;
        render();
    }
    
    function advanceToWorkup() {
        state.screen = 'workup';
        render();
    }
    
    // Workup functions
    function toggleWorkup(id) {
        if (state.selectedWorkup.includes(id)) {
            state.selectedWorkup = state.selectedWorkup.filter(w => w !== id);
        } else {
            state.selectedWorkup.push(id);
        }
        render();
    }
    
    function submitWorkup() {
        state.workupSubmitted = true;
        render();
    }
    
    function showSummary() {
        state.screen = 'summary';
        render();
    }
    
    function resetAndGoToMenu() {
        // Reset all state
        Object.assign(state, {
            screen: 'menu',
            mode: null,
            caseType: null,
            variantKey: null,
            selectedLikely: [],
            selectedMustNotMiss: [],
            differentialSubmitted: false,
            selectedHistory: [],
            historySubmitted: false,
            selectedPhysical: [],
            physicalSubmitted: false,
            revisedLikely: [],
            revisedMustNotMiss: [],
            revisedSubmitted: false,
            differentialNotes: '',
            selectedWorkup: [],
            workupSubmitted: false
        });
        render();
    }
    
    function restartCase() {
        state.screen = 'case-select';
        state.variantKey = null;
        state.selectedLikely = [];
        state.selectedMustNotMiss = [];
        state.differentialSubmitted = false;
        state.selectedHistory = [];
        state.historySubmitted = false;
        state.selectedPhysical = [];
        state.physicalSubmitted = false;
        state.revisedLikely = [];
        state.revisedMustNotMiss = [];
        state.revisedSubmitted = false;
        state.differentialNotes = '';
        state.selectedWorkup = [];
        state.workupSubmitted = false;
        render();
    }
    
    // Initialize
    render();
    </script>
</body>
</html>
