<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Reasoning Tool - Epigastric Pain</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .selected-choice {
            background-color: #dbeafe;
            border: 2px solid #3b82f6;
        }
        .excellent-choice {
            background-color: #dcfce7;
            border: 2px solid #16a34a;
        }
        .good-choice {
            background-color: #dbeafe;
            border: 2px solid #3b82f6;
        }
        .fair-choice {
            background-color: #fef3c7;
            border: 2px solid #f59e0b;
        }
        .low-priority-choice {
            background-color: #fee2e2;
            border: 2px solid #dc2626;
        }
        .system-section {
            cursor: pointer;
            transition: all 0.2s;
        }
        .system-section:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        const ClinicalReasoningTool = () => {
          const [selectedCase, setSelectedCase] = useState(0);
          const [currentStage, setCurrentStage] = useState('initial');
          const [selectedDifferentials, setSelectedDifferentials] = useState([]);
          const [showDifferentialFeedback, setShowDifferentialFeedback] = useState(false);
          const [selectedHistory, setSelectedHistory] = useState([]);
          const [selectedPhysical, setSelectedPhysical] = useState([]);
          const [showFeedback, setShowFeedback] = useState(false);
          const [showComparison, setShowComparison] = useState(false);
          const [expandedSystems, setExpandedSystems] = useState([]);

          const differentialsBySystem = {
            'Cardiac': [
              'Myocardial infarction (MI)',
              'Angina/ACS',
              'Heart failure',
              'Pericarditis',
              'Arrhythmia'
            ],
            'Gastrointestinal': [
              'Gastritis',
              'GERD',
              'Peptic ulcer disease (PUD)',
              'Pancreatitis',
              'Cholecystitis/gallbladder disease',
              'Gastroenteritis',
              'Esophageal pathology',
              'Bowel obstruction',
              'Hepatitis'
            ],
            'Gynecologic/Reproductive': [
              'Pregnancy',
              'Ectopic pregnancy',
              'Ovarian cyst/rupture',
              'Ovarian torsion',
              'PID',
              'Endometriosis'
            ],
            'Endocrine': [
              'Hyperprolactinemia/prolactinoma',
              'PCOS',
              'Hypothalamic amenorrhea',
              'Thyroid disease',
              'Pituitary tumor',
              'Diabetes',
              'Adrenal insufficiency'
            ],
            'Pulmonary': [
              'Pneumonia',
              'Viral URI/common cold',
              'Acute bronchitis',
              'Bacterial sinusitis',
              'Asthma exacerbation',
              'COPD exacerbation',
              'Pulmonary embolism',
              'Allergic rhinitis'
            ],
            'Abdominal/Surgical': [
              'Appendicitis',
              'Bowel obstruction',
              'Perforated viscus',
              'Crohn\'s disease',
              'Diverticulitis'
            ],
            'Other': [
              'Medication-induced',
              'Musculoskeletal pain',
              'Anxiety/stress-related',
              'Anemia'
            ]
          };

          // Helper function for fuzzy matching diagnoses
          const diagnosisMatches = (selected, expected) => {
            const selectedLower = selected.toLowerCase();
            const expectedLower = expected.toLowerCase();
            
            // Exact match
            if (selectedLower === expectedLower) return true;
            
            // Selected contains expected or vice versa
            if (selectedLower.includes(expectedLower) || expectedLower.includes(selectedLower)) return true;
            
            // Check first word match (e.g., "Gastritis" matches "Gastritis (NSAID-induced)")
            const selectedFirst = selectedLower.split(/[\s(]/)[0];
            const expectedFirst = expectedLower.split(/[\s(]/)[0];
            if (selectedFirst === expectedFirst) return true;
            
            // Common abbreviation handling
            const abbreviations = {
              'mi': 'myocardial infarction',
              'pud': 'peptic ulcer disease',
              'gerd': 'gerd',
              'acs': 'angina',
              'sbo': 'small bowel obstruction'
            };
            
            for (const [abbrev, full] of Object.entries(abbreviations)) {
              if ((selectedLower.includes(abbrev) && expectedLower.includes(full)) ||
                  (selectedLower.includes(full) && expectedLower.includes(abbrev))) {
                return true;
              }
            }
            
            return false;
          };

          const cases = [
            {
              id: 1,
              title: "Epigastric Pain",
              doorNote: {
                name: "Robert Hayes",
                age: 62,
                sex: "Male",
                location: "Outpatient Primary Care Clinic",
                chiefComplaint: "I have pain in the upper middle part of my belly.",
                vitals: "BP 138/82, Temp 98.6Â°F, HR 88, RR 18, O2 Sat 98% RA, BMI 27.3"
              },
              // NO briefHPI - removed to avoid giving students clues

              expectedDifferential: [
                { 
                  diagnosis: "Gastritis", 
                  priority: "Most likely",
                  reasoning: "Epigastric pain in older adult taking NSAIDs is classic for gastritis. Must explore NSAID use pattern."
                },
                { 
                  diagnosis: "GERD", 
                  priority: "Common",
                  reasoning: "Burning epigastric pain. Common in older adults. Often overlaps with gastritis."
                },
                { 
                  diagnosis: "Peptic ulcer disease (PUD)", 
                  priority: "Common",
                  reasoning: "NSAID use is major PUD risk factor. Can present identically to gastritis. Must ask about bleeding symptoms."
                },
                { 
                  diagnosis: "Myocardial infarction (MI)", 
                  priority: "MUST-NOT-MISS",
                  reasoning: "62yo male - epigastric pain CAN BE atypical MI presentation. MUST rule out cardiac cause."
                },
                { 
                  diagnosis: "Pancreatitis", 
                  priority: "Must-not-miss",
                  reasoning: "Epigastric pain radiating to back. Ask about alcohol use. Less likely without severe pain/vomiting."
                },
                { 
                  diagnosis: "Cholecystitis/gallbladder disease", 
                  priority: "Consider",
                  reasoning: "Can cause epigastric pain. Would expect RUQ tenderness, worse with fatty foods."
                }
              ],

              differentialFeedback: {
                mustInclude: ["Gastritis", "Myocardial infarction (MI)", "Peptic ulcer disease (PUD)"],
                strongConsider: ["GERD", "Pancreatitis"],
                lessLikely: ["Cholecystitis/gallbladder disease"],
                shouldNotInclude: {
                  diagnoses: ["Pneumonia", "Pregnancy", "Appendicitis"],
                  reason: "Not related to epigastric pain presentation in older male"
                }
              },

              historyQuestions: {
                hpiFollowUp: [
                  // PAIN CHARACTER - Disaggregated
                  {
                    id: "h1",
                    question: "Can you describe what the pain feels like?",
                    quality: "excellent",
                    rationale: "Pain character is diagnostic. Burning = gastritis/GERD. Pressure/squeezing = cardiac. Crampy = obstruction. Sharp = perforation.",
                    impactsDx: ["Distinguishes GI vs cardiac causes"]
                  },
                  {
                    id: "h2",
                    question: "Is the pain burning?",
                    quality: "excellent",
                    rationale: "Burning pain is classic for gastritis and GERD. Specific question for most likely diagnosis.",
                    impactsDx: ["Gastritis", "GERD"]
                  },
                  {
                    id: "h3",
                    question: "Is the pain like pressure or squeezing?",
                    quality: "excellent",
                    rationale: "Pressure/squeezing quality suggests cardiac cause. CRITICAL to distinguish from GI pain in older adult.",
                    impactsDx: ["MI - pressure/squeezing is classic"]
                  },
                  {
                    id: "h4",
                    question: "When did the pain start?",
                    quality: "excellent",
                    rationale: "Timeline is critical. Acute onset (hours) = MI, perforation. Days = gastritis, PUD. Weeks/months = chronic condition.",
                    impactsDx: ["Acute vs chronic causes"]
                  },
                  {
                    id: "h5",
                    question: "Is the pain constant or does it come and go?",
                    quality: "good",
                    rationale: "Constant pain suggests inflammation (gastritis, pancreatitis). Intermittent suggests biliary colic, GERD.",
                    impactsDx: ["Pattern helps narrow differential"]
                  },

                  // PAIN RADIATION - Disaggregated (Critical for differentiating causes)
                  {
                    id: "h6",
                    question: "Does the pain stay in your upper belly, or does it move anywhere else?",
                    quality: "excellent",
                    rationale: "Radiation is KEY. MI: may radiate to jaw/arm/back. Pancreatitis: radiates to back. Biliary: right shoulder. Localized = gastritis/GERD.",
                    impactsDx: ["MI", "Pancreatitis", "Biliary disease"]
                  },
                  {
                    id: "h7",
                    question: "Does the pain radiate to your back?",
                    quality: "excellent",
                    rationale: "Back radiation is classic for pancreatitis. Also occurs in MI and aortic pathology. Critical question.",
                    impactsDx: ["Pancreatitis - classic", "MI", "Aortic dissection"]
                  },
                  {
                    id: "h8",
                    question: "Does the pain radiate to your chest?",
                    quality: "excellent",
                    rationale: "Epigastric pain radiating to chest = MI until proven otherwise in older adult. Changes urgency completely.",
                    impactsDx: ["MI - CRITICAL question"]
                  },
                  {
                    id: "h9",
                    question: "Does the pain radiate to your jaw?",
                    quality: "excellent",
                    rationale: "Jaw pain is classic MI radiation. Must ask specifically - patients may not volunteer.",
                    impactsDx: ["MI - classic radiation"]
                  },
                  {
                    id: "h10",
                    question: "Does the pain radiate to your left arm?",
                    quality: "excellent",
                    rationale: "Left arm pain is classic MI. Essential cardiac screening question in older adult with epigastric pain.",
                    impactsDx: ["MI - classic radiation"]
                  },
                  {
                    id: "h11",
                    question: "Does the pain radiate to your right arm?",
                    quality: "good",
                    rationale: "MI can radiate to right arm too. Less classic than left but still important to ask.",
                    impactsDx: ["MI - atypical radiation"]
                  },
                  {
                    id: "h12",
                    question: "Does the pain radiate to your right shoulder?",
                    quality: "excellent",
                    rationale: "Right shoulder radiation = biliary disease (referred pain from diaphragm). Classic for cholecystitis.",
                    impactsDx: ["Cholecystitis - classic"]
                  },

                  // AGGRAVATING/ALLEVIATING FACTORS
                  {
                    id: "h13",
                    question: "Is the pain worse after eating?",
                    quality: "excellent",
                    rationale: "Worse with meals = gastritis (most common), also GERD. Food triggers acid secretion. Key distinguishing question.",
                    impactsDx: ["Gastritis - worse after meals", "GERD"]
                  },
                  {
                    id: "h14",
                    question: "Does the pain happen after every meal, or just certain foods?",
                    quality: "excellent",
                    rationale: "Fatty food trigger = biliary disease. All food = gastritis. Helps distinguish between causes.",
                    impactsDx: ["Biliary - fatty foods", "Gastritis - any food"]
                  },
                  {
                    id: "h15",
                    question: "Does eating make the pain better?",
                    quality: "excellent",
                    rationale: "Pain IMPROVED by food = duodenal ulcer (food neutralizes acid). Classic distinguishing feature from gastritis.",
                    impactsDx: ["Duodenal ulcer - improves with food"]
                  },
                  {
                    id: "h16",
                    question: "Does the pain wake you up at night?",
                    quality: "excellent",
                    rationale: "Night pain is classic for duodenal ulcer - pain when stomach empty. Also GERD when lying flat.",
                    impactsDx: ["Duodenal ulcer", "GERD"]
                  },
                  {
                    id: "h17",
                    question: "Does anything make the pain better?",
                    quality: "fair",
                    rationale: "Good opening but be MORE SPECIFIC. Better: 'Does food help? Do antacids help?' Save time with targeted questions.",
                    impactsDx: ["Low yield unless followed by specifics"]
                  },
                  {
                    id: "h18",
                    question: "Do antacids help?",
                    quality: "good",
                    rationale: "Antacid relief suggests acid-related cause (gastritis, GERD, PUD). No relief suggests other cause.",
                    impactsDx: ["Acid-related conditions"]
                  },

                  // ASSOCIATED CARDIAC SYMPTOMS - CRITICAL for MI screening
                  {
                    id: "h19",
                    question: "Have you had any chest discomfort or pressure?",
                    quality: "excellent",
                    rationale: "CRITICAL - epigastric pain in 62yo male CAN BE MI. Must actively screen for cardiac symptoms.",
                    impactsDx: ["MI - MUST-NOT-MISS"]
                  },
                  {
                    id: "h20",
                    question: "Any chest tightness or squeezing sensation?",
                    quality: "excellent",
                    rationale: "Classic MI descriptors. Older adults may not recognize as 'chest pain.' Must ask specifically.",
                    impactsDx: ["MI - classic symptom"]
                  },
                  {
                    id: "h21",
                    question: "Any shortness of breath?",
                    quality: "excellent",
                    rationale: "Dyspnea + epigastric pain = MI until proven otherwise. Changes urgency dramatically.",
                    impactsDx: ["MI - associated symptom"]
                  },
                  {
                    id: "h22",
                    question: "Any sweating or feeling clammy?",
                    quality: "excellent",
                    rationale: "Diaphoresis is classic MI symptom. Epigastric pain + sweating = very high MI probability.",
                    impactsDx: ["MI - diaphoresis is classic"]
                  },
                  {
                    id: "h23",
                    question: "Any nausea?",
                    quality: "good",
                    rationale: "Nausea accompanies both GI causes and MI. Present in most conditions on differential.",
                    impactsDx: ["Multiple conditions"]
                  },
                  {
                    id: "h24",
                    question: "Any vomiting?",
                    quality: "good",
                    rationale: "Vomiting suggests pancreatitis, obstruction, or severe gastritis. Also occurs in MI.",
                    impactsDx: ["Pancreatitis", "Obstruction", "MI"]
                  },
                  {
                    id: "h25",
                    question: "Any feeling like you're going to pass out?",
                    quality: "excellent",
                    rationale: "Syncope/presyncope = hemodynamic instability. Could be MI, GI bleeding, arrhythmia. URGENT symptom.",
                    impactsDx: ["MI", "GI bleeding", "Serious illness"]
                  },

                  // GI BLEEDING SCREENING - Critical for PUD
                  {
                    id: "h26",
                    question: "Have you noticed any black, tarry stools?",
                    quality: "excellent",
                    rationale: "Melena = upper GI bleed. If positive with NSAID use, this is bleeding PUD. URGENT finding.",
                    impactsDx: ["Bleeding PUD - URGENT if positive"]
                  },
                  {
                    id: "h27",
                    question: "Have you seen bright red blood in your stool?",
                    quality: "excellent",
                    rationale: "Hematochezia usually = lower GI bleed, but brisk upper GI bleed can present this way. Must ask.",
                    impactsDx: ["GI bleeding assessment"]
                  },
                  {
                    id: "h28",
                    question: "Have you vomited any blood?",
                    quality: "excellent",
                    rationale: "Hematemesis = upper GI bleed. With NSAID use, suggests bleeding PUD. Changes management urgently.",
                    impactsDx: ["Bleeding PUD - URGENT"]
                  },
                  {
                    id: "h29",
                    question: "Have you vomited anything that looks like coffee grounds?",
                    quality: "excellent",
                    rationale: "Coffee-ground emesis = digested blood from upper GI bleed. May be missed if not asked specifically.",
                    impactsDx: ["Upper GI bleed"]
                  },

                  // NSAID USE - Critical for this case
                  {
                    id: "h30",
                    question: "Do you take any pain medications?",
                    quality: "good",
                    rationale: "Opens door to NSAID discussion. Good screening question, but follow with specifics.",
                    impactsDx: ["NSAID gastritis/PUD"]
                  },
                  {
                    id: "h31",
                    question: "How often do you take ibuprofen or similar medications?",
                    quality: "excellent",
                    rationale: "Frequency of NSAID use is THE most important factor for gastritis/PUD risk. Daily use >> occasional.",
                    impactsDx: ["NSAID gastritis/PUD - frequency determines risk"]
                  },
                  {
                    id: "h32",
                    question: "How many pills do you take at a time?",
                    quality: "excellent",
                    rationale: "Dose matters for GI toxicity. 800mg TID is much higher risk than 200mg PRN.",
                    impactsDx: ["NSAID gastritis/PUD - dose determines risk"]
                  },
                  {
                    id: "h33",
                    question: "Do you take pain medication on an empty stomach?",
                    quality: "excellent",
                    rationale: "NSAIDs on empty stomach dramatically increase gastritis risk. Critical modifiable risk factor.",
                    impactsDx: ["NSAID gastritis - empty stomach increases risk"]
                  },
                  {
                    id: "h34",
                    question: "How long have you been taking these medications?",
                    quality: "good",
                    rationale: "Duration of NSAID use affects cumulative risk. Years of use = higher risk than recent start.",
                    impactsDx: ["NSAID gastritis/PUD"]
                  },

                  // LOW-PRIORITY HPI QUESTIONS
                  {
                    id: "h35",
                    question: "On a scale of 1-10, how bad is your pain?",
                    quality: "low-priority",
                    rationale: "Pain scales have limited diagnostic utility. Better to ask about functional impact and specific characteristics.",
                    impactsDx: ["Minimal diagnostic value"]
                  },
                  {
                    id: "h36",
                    question: "Can you point to exactly where it hurts?",
                    quality: "fair",
                    rationale: "You know it's epigastric from chief complaint. More useful to ask about radiation than to re-localize.",
                    impactsDx: ["Already have this information"]
                  }
                ],
                
                ros: [
                  // RELEVANT GI ROS
                  {
                    id: "r1",
                    question: "Any difficulty swallowing?",
                    quality: "excellent",
                    rationale: "Dysphagia = esophageal pathology. Red flag for stricture, cancer. Important in older adult with GI symptoms.",
                    impactsDx: ["Esophageal stricture", "Cancer"]
                  },
                  {
                    id: "r2",
                    question: "Does food ever feel like it gets stuck?",
                    quality: "excellent",
                    rationale: "Specific dysphagia question. Helps distinguish mechanical obstruction from motility issues.",
                    impactsDx: ["Esophageal stricture", "Cancer"]
                  },
                  {
                    id: "r3",
                    question: "Have you lost any weight without trying?",
                    quality: "excellent",
                    rationale: "Unintentional weight loss = RED FLAG for malignancy (gastric, pancreatic, esophageal). Must ask in older adult.",
                    impactsDx: ["GI malignancy - red flag"]
                  },
                  {
                    id: "r4",
                    question: "Any change in your appetite?",
                    quality: "good",
                    rationale: "Decreased appetite with epigastric pain suggests more serious pathology. Worth asking.",
                    impactsDx: ["Severity assessment"]
                  },
                  {
                    id: "r5",
                    question: "Any heartburn or acid reflux?",
                    quality: "good",
                    rationale: "Directly asks about GERD symptoms. Relevant to differential.",
                    impactsDx: ["GERD"]
                  },
                  {
                    id: "r6",
                    question: "Any bloating or feeling full quickly?",
                    quality: "good",
                    rationale: "Early satiety suggests gastric pathology including malignancy. Bloating is common but nonspecific.",
                    impactsDx: ["Gastric pathology"]
                  },
                  {
                    id: "r7",
                    question: "Any diarrhea?",
                    quality: "fair",
                    rationale: "Not typically associated with epigastric pain (gastritis, PUD, MI). Lower priority.",
                    impactsDx: ["Minimal for this differential"]
                  },
                  {
                    id: "r8",
                    question: "Any constipation?",
                    quality: "fair",
                    rationale: "Not directly relevant to epigastric pain differential. Lower priority.",
                    impactsDx: ["Minimal"]
                  },

                  // CARDIAC ROS - RELEVANT for older male
                  {
                    id: "r9",
                    question: "Any palpitations or feeling like your heart is racing?",
                    quality: "good",
                    rationale: "Cardiac symptom relevant in older adult with possible MI. Worth asking briefly.",
                    impactsDx: ["Arrhythmia", "MI"]
                  },
                  {
                    id: "r10",
                    question: "Any leg swelling?",
                    quality: "fair",
                    rationale: "Suggests heart failure. Lower priority in this presentation but worth brief inquiry.",
                    impactsDx: ["Heart failure"]
                  },
                  {
                    id: "r11",
                    question: "Do you get short of breath when lying flat?",
                    quality: "fair",
                    rationale: "Orthopnea suggests heart failure. Also relevant for GERD (worse lying flat).",
                    impactsDx: ["Heart failure", "GERD"]
                  },

                  // PULMONARY ROS - NOT RELEVANT
                  {
                    id: "r12",
                    question: "Any cough?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain differential. In time-limited OSCE, skip unrelated systems.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r13",
                    question: "Any wheezing?",
                    quality: "low-priority",
                    rationale: "Not relevant to epigastric pain. Skip.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r14",
                    question: "Have you coughed up any blood?",
                    quality: "low-priority",
                    rationale: "Hemoptysis is not related to epigastric pain. Checklist ROS thinking.",
                    impactsDx: ["No impact"]
                  },

                  // GU ROS - NOT RELEVANT
                  {
                    id: "r15",
                    question: "Any burning when you urinate?",
                    quality: "low-priority",
                    rationale: "Dysuria not related to epigastric pain differential. Skip.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r16",
                    question: "Any blood in your urine?",
                    quality: "low-priority",
                    rationale: "Hematuria not related to epigastric pain. Checklist thinking.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r17",
                    question: "Any urinary frequency?",
                    quality: "low-priority",
                    rationale: "Not relevant to this differential. Skip.",
                    impactsDx: ["No impact"]
                  },

                  // NEUROLOGICAL ROS - NOT RELEVANT
                  {
                    id: "r18",
                    question: "Any headaches?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain differential. Skip.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r19",
                    question: "Any dizziness?",
                    quality: "fair",
                    rationale: "Could indicate orthostatic hypotension from GI bleeding. Worth brief inquiry.",
                    impactsDx: ["GI bleeding if severe"]
                  },
                  {
                    id: "r20",
                    question: "Any weakness?",
                    quality: "fair",
                    rationale: "Severe weakness could indicate anemia from chronic GI bleeding.",
                    impactsDx: ["Chronic bleeding/anemia"]
                  },
                  {
                    id: "r21",
                    question: "Any numbness or tingling?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain. Checklist ROS.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r22",
                    question: "Any vision changes?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain differential. Skip.",
                    impactsDx: ["No impact"]
                  },

                  // MSK ROS - NOT RELEVANT
                  {
                    id: "r23",
                    question: "Any joint pain or swelling?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain differential. Skip.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r24",
                    question: "Any muscle aches?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain. Checklist thinking.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r25",
                    question: "Any back pain?",
                    quality: "fair",
                    rationale: "Already asked about radiation to back for pancreatitis. General back pain ROS is lower yield.",
                    impactsDx: ["Already addressed"]
                  },

                  // CONSTITUTIONAL
                  {
                    id: "r26",
                    question: "Any fever or chills?",
                    quality: "fair",
                    rationale: "Fever suggests infection, pancreatitis, cholecystitis. Worth asking briefly.",
                    impactsDx: ["Pancreatitis", "Cholecystitis"]
                  },
                  {
                    id: "r27",
                    question: "Any night sweats?",
                    quality: "low-priority",
                    rationale: "Suggests chronic infection or malignancy. Less relevant to acute presentation.",
                    impactsDx: ["Minimal"]
                  },
                  {
                    id: "r28",
                    question: "Any fatigue?",
                    quality: "fair",
                    rationale: "Could indicate anemia from chronic bleeding. Lower priority in acute presentation.",
                    impactsDx: ["Chronic anemia"]
                  },

                  // SKIN ROS - LOW RELEVANCE
                  {
                    id: "r29",
                    question: "Any rashes?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain. Skip.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "r30",
                    question: "Any skin color changes?",
                    quality: "fair",
                    rationale: "Jaundice would suggest biliary/pancreatic disease. Better to examine than ask.",
                    impactsDx: ["Biliary obstruction - better to examine"]
                  },
                  {
                    id: "r31",
                    question: "Any easy bruising?",
                    quality: "low-priority",
                    rationale: "Could suggest coagulopathy but not relevant to acute epigastric pain.",
                    impactsDx: ["Minimal"]
                  }
                ],
                
                pmh: [
                  // CARDIAC HISTORY - CRITICAL for MI risk
                  {
                    id: "p1",
                    question: "Have you ever had a heart attack?",
                    quality: "excellent",
                    rationale: "Prior MI = VERY HIGH RISK for recurrent MI. This single question dramatically changes pre-test probability.",
                    impactsDx: ["MI - prior MI is strongest risk factor"]
                  },
                  {
                    id: "p2",
                    question: "Have you ever had angina or chest pain from your heart?",
                    quality: "excellent",
                    rationale: "History of angina = known CAD. Epigastric pain could be anginal equivalent in someone with CAD.",
                    impactsDx: ["MI/ACS - known CAD"]
                  },
                  {
                    id: "p3",
                    question: "Have you had any stents or bypass surgery?",
                    quality: "excellent",
                    rationale: "Coronary interventions confirm CAD. These patients at very high risk for recurrent events.",
                    impactsDx: ["MI - confirms CAD history"]
                  },
                  {
                    id: "p4",
                    question: "Have you ever had any heart problems?",
                    quality: "fair",
                    rationale: "Good opening but DON'T STOP HERE. Follow with specifics: 'Heart attack? Stents? Bypass?' Generic needs targeted follow-up.",
                    impactsDx: ["Low yield unless followed by specifics"]
                  },

                  // CARDIAC RISK FACTORS
                  {
                    id: "p5",
                    question: "Do you have diabetes?",
                    quality: "excellent",
                    rationale: "Major cardiac risk factor. Diabetics can have atypical/silent MI. Essential for risk stratification.",
                    impactsDx: ["MI risk - diabetics have atypical presentations"]
                  },
                  {
                    id: "p6",
                    question: "Do you have high blood pressure?",
                    quality: "excellent",
                    rationale: "BP 138/82 on vitals suggests possible HTN. Major cardiac risk factor. Must ask about history/treatment.",
                    impactsDx: ["MI risk - HTN is major risk factor"]
                  },
                  {
                    id: "p7",
                    question: "Do you have high cholesterol?",
                    quality: "excellent",
                    rationale: "Major cardiac risk factor. Combined with age, sex, and other factors = cardiac risk assessment.",
                    impactsDx: ["MI risk - hyperlipidemia compounds risk"]
                  },

                  // GI HISTORY
                  {
                    id: "p8",
                    question: "Have you ever had an ulcer?",
                    quality: "excellent",
                    rationale: "Prior PUD history = high recurrence risk, especially with NSAID use. Critical history.",
                    impactsDx: ["PUD recurrence"]
                  },
                  {
                    id: "p9",
                    question: "Have you ever been tested for H. pylori?",
                    quality: "excellent",
                    rationale: "H. pylori is major cause of PUD. If never tested, should consider testing. If treated, may have recurrence.",
                    impactsDx: ["PUD - H. pylori status"]
                  },
                  {
                    id: "p10",
                    question: "Have you ever had pancreatitis?",
                    quality: "good",
                    rationale: "Recurrent pancreatitis is common. Previous episode makes current pancreatitis more likely.",
                    impactsDx: ["Pancreatitis recurrence"]
                  },
                  {
                    id: "p11",
                    question: "Have you ever had gallbladder problems or gallstones?",
                    quality: "good",
                    rationale: "Biliary disease can cause epigastric pain. Also gallstones cause pancreatitis.",
                    impactsDx: ["Biliary disease", "Gallstone pancreatitis"]
                  },
                  {
                    id: "p12",
                    question: "Have you ever had stomach problems?",
                    quality: "fair",
                    rationale: "Good opening but vague. Better to ask specifically about ulcers, GERD, H. pylori.",
                    impactsDx: ["Low yield - be more specific"]
                  },

                  // SURGICAL HISTORY
                  {
                    id: "p13",
                    question: "Have you ever had abdominal surgery?",
                    quality: "good",
                    rationale: "Previous surgery could affect anatomy, cause adhesions. Good general screening question.",
                    impactsDx: ["Post-surgical complications"]
                  },

                  // GENERIC PMH
                  {
                    id: "p14",
                    question: "What medical problems do you have?",
                    quality: "fair",
                    rationale: "Good opening but DON'T STOP HERE. Follow with specifics about cardiac history, diabetes, GI history.",
                    impactsDx: ["Low yield unless followed by specifics"]
                  },
                  {
                    id: "p15",
                    question: "Have you ever been hospitalized?",
                    quality: "fair",
                    rationale: "May reveal relevant history but too broad. Better to ask specific conditions.",
                    impactsDx: ["May reveal relevant history"]
                  },

                  // UNRELATED PMH
                  {
                    id: "p16",
                    question: "Do you have asthma or lung disease?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain differential in this case. Skip.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "p17",
                    question: "Do you have thyroid problems?",
                    quality: "low-priority",
                    rationale: "Not related to epigastric pain differential. Skip in time-limited encounter.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "p18",
                    question: "Do you have kidney disease?",
                    quality: "fair",
                    rationale: "NSAIDs can worsen kidney function. Worth knowing but lower priority for diagnosis.",
                    impactsDx: ["NSAID complications"]
                  }
                ],
                
                socialHistory: [
                  // SMOKING - CRITICAL for cardiac and GI risk
                  {
                    id: "s1",
                    question: "Do you smoke cigarettes?",
                    quality: "excellent",
                    rationale: "Smoking is MAJOR risk factor for both CAD (2-4x risk) and PUD. Essential question for both top diagnoses.",
                    impactsDx: ["MI risk", "PUD risk"]
                  },
                  {
                    id: "s2",
                    question: "Have you ever smoked?",
                    quality: "excellent",
                    rationale: "Former smokers still have elevated cardiac risk. Smoking history matters even if quit.",
                    impactsDx: ["MI risk - former smoking still increases risk"]
                  },
                  {
                    id: "s3",
                    question: "How many packs per day do/did you smoke?",
                    quality: "excellent",
                    rationale: "Pack-years helps quantify cardiac risk. More packs = higher risk.",
                    impactsDx: ["MI risk - dose-dependent"]
                  },

                  // ALCOHOL - Important for pancreatitis/gastritis
                  {
                    id: "s4",
                    question: "How much alcohol do you drink per day?",
                    quality: "excellent",
                    rationale: "Heavy alcohol = #1 cause of pancreatitis. Also causes gastritis. Must quantify daily intake.",
                    impactsDx: ["Alcoholic pancreatitis", "Alcoholic gastritis"]
                  },
                  {
                    id: "s5",
                    question: "How often do you drink alcohol?",
                    quality: "excellent",
                    rationale: "Frequency matters. Daily heavy drinking vs occasional makes big difference for GI disease.",
                    impactsDx: ["Pancreatitis", "Gastritis"]
                  },

                  // MEDICATIONS
                  {
                    id: "s6",
                    question: "What other medications do you take?",
                    quality: "excellent",
                    rationale: "Critical question. Looking for: aspirin (adds to NSAID GI risk), cardiac meds (confirms history), antacids (suggests chronic GERD).",
                    impactsDx: ["Medication interactions", "Cardiac history clues"]
                  },
                  {
                    id: "s7",
                    question: "Do you take aspirin?",
                    quality: "excellent",
                    rationale: "Aspirin + NSAID = VERY HIGH GI bleed risk. Critical interaction. Must ask specifically.",
                    impactsDx: ["GI bleeding risk - aspirin + NSAID very high risk"]
                  },
                  {
                    id: "s8",
                    question: "Do you take any blood thinners?",
                    quality: "excellent",
                    rationale: "Anticoagulants + NSAIDs = increased bleeding risk. Also tells you about cardiac history (afib, prior clot).",
                    impactsDx: ["GI bleeding risk", "Cardiac history"]
                  },
                  {
                    id: "s9",
                    question: "Do you take any over-the-counter medicines or supplements?",
                    quality: "good",
                    rationale: "Patients may not consider OTC as 'medications.' May reveal additional NSAID use.",
                    impactsDx: ["Additional NSAID use"]
                  },

                  // FAMILY HISTORY
                  {
                    id: "s10",
                    question: "Does anyone in your family have heart disease?",
                    quality: "excellent",
                    rationale: "Family history of premature CAD (male <55, female <65) is major risk factor. Must ask.",
                    impactsDx: ["MI - family history increases risk"]
                  },
                  {
                    id: "s11",
                    question: "Has anyone in your family had a heart attack?",
                    quality: "excellent",
                    rationale: "Specific family history question. First-degree relative with MI = elevated risk.",
                    impactsDx: ["MI risk"]
                  },
                  {
                    id: "s12",
                    question: "Does anyone in your family have stomach cancer?",
                    quality: "good",
                    rationale: "Family history of gastric cancer is red flag, increases screening priority.",
                    impactsDx: ["Gastric cancer risk"]
                  },
                  {
                    id: "s13",
                    question: "Does anyone in your family have ulcers?",
                    quality: "fair",
                    rationale: "Family history of PUD suggests possible H. pylori in household. Lower yield than own history.",
                    impactsDx: ["PUD - weak risk factor"]
                  },

                  // OCCUPATIONAL/LIFESTYLE
                  {
                    id: "s14",
                    question: "What is your occupation?",
                    quality: "fair",
                    rationale: "Could be relevant for stress. Worth asking briefly but lower priority.",
                    impactsDx: ["Minimal direct impact"]
                  },
                  {
                    id: "s15",
                    question: "Are you under any unusual stress lately?",
                    quality: "fair",
                    rationale: "Stress can worsen GERD/gastritis but doesn't cause PUD. Lower priority.",
                    impactsDx: ["Minimal - stress doesn't cause ulcers"]
                  },

                  // LOW-PRIORITY SOCIAL HISTORY
                  {
                    id: "s16",
                    question: "What is your housing situation?",
                    quality: "low-priority",
                    rationale: "Not relevant to epigastric pain differential. Skip.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "s17",
                    question: "Who do you live with?",
                    quality: "low-priority",
                    rationale: "Not relevant to diagnosis. Skip in time-limited encounter.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "s18",
                    question: "What is your annual income?",
                    quality: "low-priority",
                    rationale: "Social determinants matter generally but don't impact immediate differential. Skip.",
                    impactsDx: ["No impact"]
                  },
                  {
                    id: "s19",
                    question: "What is your highest level of education?",
                    quality: "low-priority",
                    rationale: "Not relevant to epigastric pain differential. Checklist social history. Skip.",
                    impactsDx: ["No impact"]
                  }
                ]
              },

              physicalExam: [
                // GENERAL/VITAL ASSESSMENT
                {
                  id: "pe1",
                  maneuver: "Assess general appearance",
                  quality: "good",
                  rationale: "First step. Is patient comfortable or distressed? Diaphoretic (MI sign)? Quick but important.",
                  finding: "Alert, appears mildly uncomfortable but not in acute distress. No diaphoresis.",
                  impactsDx: "Not acutely ill appearing, less concerning for MI or surgical emergency"
                },
                {
                  id: "pe2",
                  maneuver: "Check blood pressure in both arms",
                  quality: "good",
                  rationale: "BP difference >20mmHg suggests aortic dissection. Quick screen for serious diagnosis.",
                  finding: "BP equal in both arms",
                  impactsDx: "Aortic dissection less likely"
                },

                // CARDIAC EXAM - CRITICAL for older adult with epigastric pain
                {
                  id: "pe3",
                  maneuver: "Auscultate heart sounds",
                  quality: "excellent",
                  rationale: "CRITICAL in 62yo with epigastric pain. Listen for new murmurs (ischemia), S3 (CHF), irregular rhythm.",
                  finding: "Regular rate and rhythm, normal S1/S2, no murmurs or extra heart sounds",
                  impactsDx: "No evidence of acute cardiac dysfunction"
                },
                {
                  id: "pe4",
                  maneuver: "Listen for S3 gallop",
                  quality: "good",
                  rationale: "S3 suggests heart failure or volume overload. Would indicate cardiac involvement.",
                  finding: "No S3 appreciated",
                  impactsDx: "No evidence of heart failure"
                },
                {
                  id: "pe5",
                  maneuver: "Listen for S4 gallop",
                  quality: "good",
                  rationale: "S4 suggests stiff ventricle (HTN, CAD). Common in older adults with cardiac disease.",
                  finding: "No S4 appreciated",
                  impactsDx: "No evidence of diastolic dysfunction"
                },
                {
                  id: "pe6",
                  maneuver: "Check for new murmurs",
                  quality: "good",
                  rationale: "New murmur in setting of chest/epigastric pain could indicate ischemic MR or VSD.",
                  finding: "No murmurs",
                  impactsDx: "No valvular complications"
                },
                {
                  id: "pe7",
                  maneuver: "Palpate chest wall for tenderness",
                  quality: "good",
                  rationale: "Reproducible chest wall tenderness suggests MSK cause. Helps distinguish from cardiac/GI.",
                  finding: "No chest wall tenderness",
                  impactsDx: "Not musculoskeletal"
                },

                // ABDOMINAL EXAM - ESSENTIAL
                {
                  id: "pe8",
                  maneuver: "Abdominal inspection",
                  quality: "good",
                  rationale: "Always start with inspection. Look for distension, scars, masses, pulsations (AAA).",
                  finding: "Abdomen flat, no distension, no visible masses or pulsations",
                  impactsDx: "No obstruction, no obvious AAA"
                },
                {
                  id: "pe9",
                  maneuver: "Auscultate abdomen for bowel sounds",
                  quality: "good",
                  rationale: "Standard exam. Absent = ileus/obstruction. Hyperactive = gastroenteritis. Normal expected here.",
                  finding: "Normal bowel sounds present",
                  impactsDx: "No obstruction"
                },
                {
                  id: "pe10",
                  maneuver: "Light palpation of all quadrants",
                  quality: "excellent",
                  rationale: "Start gentle. Identify areas of tenderness before deep palpation. Essential first step.",
                  finding: "Mild tenderness in epigastric region, no tenderness elsewhere",
                  impactsDx: "Localizes pathology to epigastrium, consistent with gastritis/PUD"
                },
                {
                  id: "pe11",
                  maneuver: "Deep palpation of epigastric region",
                  quality: "excellent",
                  rationale: "Epigastric tenderness supports gastritis/PUD. Assess severity of tenderness.",
                  finding: "Moderate epigastric tenderness, no masses",
                  impactsDx: "Supports gastritis/PUD"
                },
                {
                  id: "pe12",
                  maneuver: "Check for rebound tenderness",
                  quality: "excellent",
                  rationale: "Rebound = peritonitis = surgical emergency (perforation). MUST test in abdominal pain.",
                  finding: "No rebound tenderness",
                  impactsDx: "No peritonitis - perforation unlikely"
                },
                {
                  id: "pe13",
                  maneuver: "Check for guarding",
                  quality: "excellent",
                  rationale: "Involuntary guarding = peritonitis. Voluntary guarding = patient protecting area. Important distinction.",
                  finding: "No involuntary guarding",
                  impactsDx: "No peritonitis"
                },
                {
                  id: "pe14",
                  maneuver: "Murphy's sign",
                  quality: "excellent",
                  rationale: "Positive Murphy's = cholecystitis. Inspiratory arrest during RUQ palpation. Important to check.",
                  finding: "Murphy's sign negative",
                  impactsDx: "Cholecystitis less likely"
                },
                {
                  id: "pe15",
                  maneuver: "Palpate for abdominal aortic aneurysm",
                  quality: "good",
                  rationale: "Pulsatile abdominal mass = AAA. Can present with epigastric pain. Important in older adult.",
                  finding: "No pulsatile mass palpated",
                  impactsDx: "No evidence of AAA"
                },
                {
                  id: "pe16",
                  maneuver: "RUQ palpation",
                  quality: "good",
                  rationale: "Assess for hepatomegaly, gallbladder tenderness. Part of complete abdominal exam.",
                  finding: "No RUQ tenderness",
                  impactsDx: "Biliary disease less likely"
                },
                {
                  id: "pe17",
                  maneuver: "Palpate for hepatomegaly",
                  quality: "fair",
                  rationale: "Enlarged liver could suggest hepatic congestion (CHF) or liver disease.",
                  finding: "Liver not palpable below costal margin",
                  impactsDx: "No hepatomegaly"
                },
                {
                  id: "pe18",
                  maneuver: "Percuss abdomen",
                  quality: "fair",
                  rationale: "Tympany throughout = normal. Assess liver span, check for ascites.",
                  finding: "Normal tympany, normal liver span",
                  impactsDx: "No organomegaly or ascites"
                },

                // OTHER RELEVANT EXAMS
                {
                  id: "pe19",
                  maneuver: "Check sclerae for jaundice",
                  quality: "good",
                  rationale: "Scleral icterus = jaundice = hepatobiliary pathology. Quick, important observation.",
                  finding: "Sclerae white, no icterus",
                  impactsDx: "No biliary obstruction"
                },
                {
                  id: "pe20",
                  maneuver: "Check conjunctival pallor for anemia",
                  quality: "fair",
                  rationale: "Pallor suggests anemia, could be from chronic GI bleeding. Worth checking.",
                  finding: "No conjunctival pallor",
                  impactsDx: "No obvious anemia"
                },
                {
                  id: "pe21",
                  maneuver: "Check for peripheral edema",
                  quality: "fair",
                  rationale: "Leg edema suggests heart failure. Lower priority given no other HF symptoms.",
                  finding: "No peripheral edema",
                  impactsDx: "No evidence of heart failure"
                },
                {
                  id: "pe22",
                  maneuver: "Check JVD",
                  quality: "fair",
                  rationale: "Elevated JVP suggests right heart failure. Worth checking in cardiac evaluation.",
                  finding: "JVP not elevated",
                  impactsDx: "No right heart failure"
                },

                // LOW-PRIORITY EXAMS
                {
                  id: "pe23",
                  maneuver: "Complete lung examination",
                  quality: "low-priority",
                  rationale: "Lung exam not directly relevant to epigastric pain unless respiratory symptoms present. Skip.",
                  finding: "Clear to auscultation",
                  impactsDx: "No pulmonary cause"
                },
                {
                  id: "pe24",
                  maneuver: "CVA tenderness",
                  quality: "low-priority",
                  rationale: "Kidney pathology not suggested by presentation. Skip in focused exam.",
                  finding: "No CVA tenderness",
                  impactsDx: "No renal pathology"
                },
                {
                  id: "pe25",
                  maneuver: "Complete neurological exam",
                  quality: "low-priority",
                  rationale: "Neuro exam not relevant to epigastric pain differential. Wastes time.",
                  finding: "Neurologically intact",
                  impactsDx: "No impact"
                },
                {
                  id: "pe26",
                  maneuver: "LUQ palpation for spleen",
                  quality: "low-priority",
                  rationale: "Splenomegaly not related to epigastric pain presentation. Lower priority.",
                  finding: "Spleen not palpable",
                  impactsDx: "No impact"
                },
                {
                  id: "pe27",
                  maneuver: "Rectal exam for occult blood",
                  quality: "good",
                  rationale: "Occult blood would confirm GI bleeding. Important if suspecting bleeding PUD.",
                  finding: "Guaiac negative (if performed)",
                  impactsDx: "No evidence of GI bleeding"
                }
              ],

              diagnosticStudies: [
                {
                  study: "ECG (12-lead)",
                  priority: "FIRST TEST - MUST ORDER",
                  rationale: "CRITICAL in 62yo male with epigastric pain. Must rule out MI. Quick, cheap, potentially life-saving.",
                  expectedResult: "Normal sinus rhythm, no ST changes, no T-wave inversions",
                  interpretation: "No evidence of acute MI on ECG. Does NOT rule out MI completely - need troponin."
                },
                {
                  study: "Troponin",
                  priority: "Essential",
                  rationale: "Serum marker of myocardial injury. Must check in older adult with epigastric pain to rule out MI.",
                  expectedResult: "Negative",
                  interpretation: "Negative troponin makes MI very unlikely. Can reassure regarding cardiac cause."
                },
                {
                  study: "Complete Blood Count (CBC)",
                  priority: "Important",
                  rationale: "Check hemoglobin for GI bleeding, WBC for infection/inflammation.",
                  expectedResult: "Hgb 14.2, WBC 7.5, normal platelets",
                  interpretation: "No anemia (no chronic bleeding), no leukocytosis"
                },
                {
                  study: "Basic Metabolic Panel (BMP)",
                  priority: "Important",
                  rationale: "Assess kidney function (NSAID use), electrolytes, glucose.",
                  expectedResult: "Normal BUN/Cr, normal electrolytes, glucose 105",
                  interpretation: "Kidneys tolerating NSAIDs. Mildly elevated glucose - screen for diabetes."
                },
                {
                  study: "Lipase",
                  priority: "Consider",
                  rationale: "Rules out pancreatitis. Order if pain radiates to back or severe.",
                  expectedResult: "Normal",
                  interpretation: "Normal lipase rules out acute pancreatitis"
                },
                {
                  study: "Liver function tests",
                  priority: "Consider",
                  rationale: "Rules out hepatitis, biliary obstruction. Order if considering hepatobiliary cause.",
                  expectedResult: "Normal AST/ALT, normal bilirubin, normal alk phos",
                  interpretation: "No hepatobiliary pathology"
                },
                {
                  study: "H. pylori testing",
                  priority: "Recommended",
                  rationale: "Test-and-treat strategy for dyspepsia. H. pylori causes PUD. Should test if no prior testing.",
                  expectedResult: "Pending or positive",
                  interpretation: "If positive, treat with triple therapy. If negative, likely NSAID-induced gastritis."
                }
              ],

              actualDiagnosis: {
                diagnosis: "NSAID-induced gastritis with GERD",
                keyFindings: [
                  "62-year-old male with epigastric pain",
                  "Regular NSAID use for knee pain",
                  "Pain worse after meals (gastritis pattern)",
                  "Occasional nocturnal heartburn (GERD component)",
                  "No cardiac symptoms - negative ECG and troponin",
                  "Epigastric tenderness on exam without peritoneal signs",
                  "No evidence of GI bleeding"
                ],
                reasoning: "This case demonstrates hypothesis-driven approach to common complaint with serious 'must-not-miss' diagnosis. Epigastric pain in 62yo male MUST prompt consideration of MI - cardiac causes must be ruled out first. Once cardiac cause excluded (ECG, troponin), history of frequent NSAID use strongly suggests drug-induced gastritis. Pattern of pain worse with meals supports gastritis over duodenal ulcer (which improves with food). Nocturnal symptoms suggest GERD component. No alarm features (weight loss, dysphagia, bleeding) are present.",
                nextSteps: "Stop NSAIDs, trial of PPI, test for H. pylori, lifestyle modifications (elevate HOB, avoid late meals). If no improvement in 4-8 weeks, consider EGD."
              },

              teachingPoints: [
                "CRITICAL: Epigastric pain in older adults CAN BE myocardial infarction - always consider cardiac cause",
                "ECG and troponin should be first tests in older adult with epigastric pain",
                "NSAIDs are a MAJOR preventable cause of gastritis and PUD",
                "Ask specifics about NSAID use: frequency, dose, duration, empty stomach vs with food",
                "Pain worse with meals = gastritis. Pain improved by food = duodenal ulcer.",
                "Always screen for GI bleeding: melena, hematemesis, hematochezia",
                "Radiation patterns matter: back = pancreatitis, right shoulder = biliary, jaw/arm = cardiac",
                "Generic questions ('Any medical problems?') need targeted follow-up",
                "Aspirin + NSAID = very high GI bleeding risk",
                "In time-limited OSCEs, prioritize high-yield questions that distinguish between diagnoses",
                "Skip unrelated ROS questions (pulmonary, GU, neuro) to save time for relevant systems"
              ]
            }
          ];

          const currentCase = cases[selectedCase];

          const toggleDifferentialSelection = (diagnosis) => {
            if (selectedDifferentials.includes(diagnosis)) {
              setSelectedDifferentials(selectedDifferentials.filter(d => d !== diagnosis));
            } else {
              setSelectedDifferentials([...selectedDifferentials, diagnosis]);
            }
          };

          const toggleSystemExpansion = (system) => {
            if (expandedSystems.includes(system)) {
              setExpandedSystems(expandedSystems.filter(s => s !== system));
            } else {
              setExpandedSystems([...expandedSystems, system]);
            }
          };

          const getComparisonData = () => {
            const allQuestions = [
              ...currentCase.historyQuestions.hpiFollowUp,
              ...currentCase.historyQuestions.ros,
              ...currentCase.historyQuestions.pmh,
              ...currentCase.historyQuestions.socialHistory
            ];
            
            const optimalQuestions = allQuestions.filter(q => q.quality === 'excellent' || q.quality === 'good');
            const optimalIds = optimalQuestions.map(q => q.id);
            
            const selectedOptimal = selectedHistory.filter(id => optimalIds.includes(id));
            const missedOptimal = optimalIds.filter(id => !selectedHistory.includes(id));
            const lowPrioritySelected = selectedHistory.filter(id => {
              const q = allQuestions.find(q => q.id === id);
              return q && (q.quality === 'low-priority' || q.quality === 'fair');
            });
            
            return {
              totalSelected: selectedHistory.length,
              totalOptimal: optimalIds.length,
              selectedOptimal: selectedOptimal.length,
              missedOptimal: missedOptimal.length,
              lowPrioritySelected: lowPrioritySelected.length,
              missedOptimalQuestions: allQuestions.filter(q => missedOptimal.includes(q.id)),
              lowPriorityQuestions: allQuestions.filter(q => lowPrioritySelected.includes(q.id)),
              efficiency: Math.round((selectedOptimal.length / Math.max(selectedHistory.length, 1)) * 100)
            };
          };

          const getPhysicalComparisonData = () => {
            const allExams = currentCase.physicalExam;
            const optimalExams = allExams.filter(e => e.quality === 'excellent' || e.quality === 'good');
            const optimalIds = optimalExams.map(e => e.id);
            
            const selectedOptimal = selectedPhysical.filter(id => optimalIds.includes(id));
            const missedOptimal = optimalIds.filter(id => !selectedPhysical.includes(id));
            const lowPrioritySelected = selectedPhysical.filter(id => {
              const e = allExams.find(e => e.id === id);
              return e && (e.quality === 'low-priority' || e.quality === 'fair');
            });
            
            return {
              totalSelected: selectedPhysical.length,
              totalOptimal: optimalIds.length,
              selectedOptimal: selectedOptimal.length,
              missedOptimal: missedOptimal.length,
              lowPrioritySelected: lowPrioritySelected.length,
              missedOptimalExams: allExams.filter(e => missedOptimal.includes(e.id)),
              lowPriorityExams: allExams.filter(e => lowPrioritySelected.includes(e.id)),
              efficiency: Math.round((selectedOptimal.length / Math.max(selectedPhysical.length, 1)) * 100)
            };
          };

          const renderComparisonView = () => {
            const data = getComparisonData();
            
            return (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 className="text-2xl font-bold text-gray-900 mb-4">ð History Performance Analysis</h3>
                
                <div className="grid grid-cols-2 gap-4 mb-6">
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <div className="text-3xl font-bold text-blue-900">{data.totalSelected}</div>
                    <div className="text-sm text-blue-700">Questions You Selected</div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-lg">
                    <div className="text-3xl font-bold text-green-900">{data.totalOptimal}</div>
                    <div className="text-sm text-green-700">Optimal High-Yield Questions</div>
                  </div>
                  <div className="bg-emerald-50 p-4 rounded-lg">
                    <div className="text-3xl font-bold text-emerald-900">{data.selectedOptimal}</div>
                    <div className="text-sm text-emerald-700">High-Yield Questions You Selected</div>
                  </div>
                  <div className="bg-orange-50 p-4 rounded-lg">
                    <div className="text-3xl font-bold text-orange-900">{data.efficiency}%</div>
                    <div className="text-sm text-orange-700">Efficiency Score</div>
                    <div className="text-xs text-orange-600 mt-1">(High-yield selected / Total selected)</div>
                  </div>
                </div>

                {data.missedOptimal > 0 && (
                  <div className="bg-red-50 border-2 border-red-300 p-4 rounded-lg mb-4">
                    <h4 className="font-bold text-red-900 mb-2">â ï¸ You Missed {data.missedOptimal} High-Yield Questions:</h4>
                    <ul className="space-y-2">
                      {data.missedOptimalQuestions.slice(0, 5).map((q) => (
                        <li key={q.id} className="text-sm text-red-800">
                          <span className="font-semibold">â¢ {q.question}</span>
                          <p className="text-xs text-red-700 ml-4 mt-1">Why important: {q.rationale}</p>
                        </li>
                      ))}
                    </ul>
                    {data.missedOptimalQuestions.length > 5 && (
                      <p className="text-sm text-red-700 mt-2">...and {data.missedOptimalQuestions.length - 5} more</p>
                    )}
                  </div>
                )}

                {data.lowPrioritySelected > 0 && (
                  <div className="bg-yellow-50 border-2 border-yellow-300 p-4 rounded-lg">
                    <h4 className="font-bold text-yellow-900 mb-2">ð¡ You Selected {data.lowPrioritySelected} Lower-Priority Questions:</h4>
                    <p className="text-sm text-yellow-800 mb-2">These aren't "wrong" to ask, but in a time-limited OSCE, they're lower priority than the high-yield questions above.</p>
                    <ul className="space-y-2">
                      {data.lowPriorityQuestions.slice(0, 5).map((q) => (
                        <li key={q.id} className="text-sm text-yellow-800">
                          <span className="font-semibold">â¢ {q.question}</span>
                          <p className="text-xs text-yellow-700 ml-4 mt-1">{q.rationale}</p>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                <div className="mt-4 p-4 bg-indigo-50 rounded-lg">
                  <h4 className="font-semibold text-indigo-900 mb-2">ð¡ Interpretation:</h4>
                  {data.efficiency >= 80 && (
                    <p className="text-indigo-800">Excellent! You focused on high-yield questions and avoided lower-priority items. This approach will serve you well in time-limited OSCEs.</p>
                  )}
                  {data.efficiency >= 60 && data.efficiency < 80 && (
                    <p className="text-indigo-800">Good job! You selected many high-yield questions. Consider being even more targeted by focusing on questions that directly distinguish between diagnoses.</p>
                  )}
                  {data.efficiency < 60 && (
                    <p className="text-indigo-800">You selected many questions, but some were lower priority. In time-limited encounters, focus first on questions that are EXCELLENT or GOOD quality - these distinguish between diagnoses most efficiently.</p>
                  )}
                </div>
              </div>
            );
          };

          const renderPhysicalComparisonView = () => {
            const data = getPhysicalComparisonData();
            
            return (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 className="text-2xl font-bold text-gray-900 mb-4">ð Physical Exam Performance Analysis</h3>
                
                <div className="grid grid-cols-2 gap-4 mb-6">
                  <div className="bg-blue-50 p-4 rounded-lg">
                    <div className="text-3xl font-bold text-blue-900">{data.totalSelected}</div>
                    <div className="text-sm text-blue-700">Maneuvers You Selected</div>
                  </div>
                  <div className="bg-green-50 p-4 rounded-lg">
                    <div className="text-3xl font-bold text-green-900">{data.totalOptimal}</div>
                    <div className="text-sm text-green-700">Optimal High-Yield Maneuvers</div>
                  </div>
                  <div className="bg-emerald-50 p-4 rounded-lg">
                    <div className="text-3xl font-bold text-emerald-900">{data.selectedOptimal}</div>
                    <div className="text-sm text-emerald-700">High-Yield Maneuvers You Selected</div>
                  </div>
                  <div className="bg-orange-50 p-4 rounded-lg">
                    <div className="text-3xl font-bold text-orange-900">{data.efficiency}%</div>
                    <div className="text-sm text-orange-700">Efficiency Score</div>
                  </div>
                </div>

                {data.missedOptimal > 0 && (
                  <div className="bg-red-50 border-2 border-red-300 p-4 rounded-lg mb-4">
                    <h4 className="font-bold text-red-900 mb-2">â ï¸ You Missed {data.missedOptimal} High-Yield Exam Maneuvers:</h4>
                    <ul className="space-y-2">
                      {data.missedOptimalExams.slice(0, 5).map((e) => (
                        <li key={e.id} className="text-sm text-red-800">
                          <span className="font-semibold">â¢ {e.maneuver}</span>
                          <p className="text-xs text-red-700 ml-4 mt-1">Why important: {e.rationale}</p>
                        </li>
                      ))}
                    </ul>
                    {data.missedOptimalExams.length > 5 && (
                      <p className="text-sm text-red-700 mt-2">...and {data.missedOptimalExams.length - 5} more</p>
                    )}
                  </div>
                )}

                {data.lowPrioritySelected > 0 && (
                  <div className="bg-yellow-50 border-2 border-yellow-300 p-4 rounded-lg">
                    <h4 className="font-bold text-yellow-900 mb-2">ð¡ You Selected {data.lowPrioritySelected} Lower-Priority Maneuvers:</h4>
                    <ul className="space-y-2">
                      {data.lowPriorityExams.slice(0, 5).map((e) => (
                        <li key={e.id} className="text-sm text-yellow-800">
                          <span className="font-semibold">â¢ {e.maneuver}</span>
                          <p className="text-xs text-yellow-700 ml-4 mt-1">{e.rationale}</p>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            );
          };

          const renderInitialStage = () => (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-6 rounded-lg">
                <h3 className="text-lg font-semibold text-gray-900 mb-2">Door Note</h3>
                <div className="grid grid-cols-2 gap-4 text-gray-800">
                  <div><span className="font-semibold">Patient:</span> {currentCase.doorNote.name}</div>
                  <div><span className="font-semibold">Age:</span> {currentCase.doorNote.age} years</div>
                  <div><span className="font-semibold">Sex:</span> {currentCase.doorNote.sex}</div>
                  <div><span className="font-semibold">Location:</span> {currentCase.doorNote.location}</div>
                  <div className="col-span-2"><span className="font-semibold">Chief Complaint:</span> "{currentCase.doorNote.chiefComplaint}"</div>
                  <div className="col-span-2"><span className="font-semibold">Vitals:</span> {currentCase.doorNote.vitals}</div>
                </div>
              </div>

              <div className="bg-indigo-100 border-2 border-indigo-500 p-6 rounded-lg">
                <h3 className="text-lg font-semibold text-indigo-900 mb-2">Your First Task</h3>
                <p className="text-indigo-800 mb-4">
                  Based ONLY on the door note information above, generate your initial differential diagnosis. What are the most likely causes of this patient's presentation? What must-not-miss diagnoses should you consider?
                </p>
                <p className="text-indigo-700 text-sm">
                  In the next step, you'll select your top 3-5 diagnoses and get feedback on your clinical reasoning.
                </p>
              </div>

              <button
                onClick={() => setCurrentStage('differential')}
                className="w-full bg-indigo-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-indigo-700 transition-colors"
              >
                Generate My Differential Diagnosis â
              </button>
            </div>
          );

          const renderDifferentialStage = () => (
            <div className="space-y-6">
              <div className="bg-orange-50 border-l-4 border-orange-500 p-6 rounded-lg">
                <h3 className="text-lg font-semibold text-orange-900 mb-2">Generate Your Differential</h3>
                <p className="text-orange-800">
                  Select your top 3-5 most likely diagnoses based on the patient's presentation. Include at least one "must-not-miss" diagnosis. Click on body systems to expand and see possible diagnoses.
                </p>
              </div>

              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Select Diagnoses by System</h3>
                <div className="space-y-2">
                  {Object.keys(differentialsBySystem).map((system) => (
                    <div key={system} className="border-2 border-gray-200 rounded-lg overflow-hidden">
                      <div
                        className="system-section p-4 bg-gray-50 flex justify-between items-center"
                        onClick={() => toggleSystemExpansion(system)}
                      >
                        <h4 className="font-semibold text-gray-900">{system}</h4>
                        <span className="text-gray-600">
                          {expandedSystems.includes(system) ? 'â¼' : 'â¶'}
                        </span>
                      </div>
                      {expandedSystems.includes(system) && (
                        <div className="p-4 space-y-2 bg-white">
                          {differentialsBySystem[system].map((dx) => {
                            const isSelected = selectedDifferentials.includes(dx);
                            return (
                              <div
                                key={dx}
                                className={`p-3 border-2 rounded cursor-pointer transition-all ${
                                  isSelected ? 'selected-choice' : 'border-gray-200 hover:border-gray-400'
                                }`}
                                onClick={() => toggleDifferentialSelection(dx)}
                              >
                                <div className="flex items-center justify-between">
                                  <span className="text-gray-900">{dx}</span>
                                  <input
                                    type="checkbox"
                                    checked={isSelected}
                                    onChange={() => {}}
                                    className="w-5 h-5"
                                  />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {selectedDifferentials.length > 0 && (
                <div className="bg-blue-50 border-2 border-blue-500 p-4 rounded-lg">
                  <h4 className="font-semibold text-blue-900 mb-2">
                    Your Selected Differential ({selectedDifferentials.length} diagnoses):
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {selectedDifferentials.map((dx) => (
                      <span key={dx} className="bg-blue-200 text-blue-900 px-3 py-1 rounded-full text-sm">
                        {dx}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              <div className="flex gap-4">
                <button
                  onClick={() => setShowDifferentialFeedback(true)}
                  className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors"
                  disabled={showDifferentialFeedback || selectedDifferentials.length === 0}
                >
                  Get Feedback on My Differential
                </button>
                
                {showDifferentialFeedback && (
                  <button
                    onClick={() => setCurrentStage('history')}
                    className="flex-1 bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
                  >
                    Move to History Taking â
                  </button>
                )}
              </div>

              {showDifferentialFeedback && (
                <div className="bg-white rounded-lg shadow-lg p-6 space-y-4">
                  <h3 className="text-xl font-bold text-gray-900">Expected Differential & Feedback</h3>
                  
                  <div className="space-y-3">
                    {currentCase.expectedDifferential.map((dx, idx) => {
                      // Use fuzzy matching for diagnosis comparison
                      const wasSelected = selectedDifferentials.some(selected => 
                        diagnosisMatches(selected, dx.diagnosis)
                      );
                      return (
                        <div key={idx} className={`p-4 rounded-lg ${wasSelected ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50 border-2 border-gray-300'}`}>
                          <div className="flex justify-between items-start mb-2">
                            <h4 className="font-bold text-gray-900">{dx.diagnosis}</h4>
                            <div className="flex items-center gap-2">
                              {wasSelected && <span className="text-green-600 font-semibold">â You included this</span>}
                              <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                dx.priority === 'MUST-NOT-MISS' ? 'bg-red-100 text-red-800' :
                                dx.priority === 'Most likely' ? 'bg-green-100 text-green-800' :
                                'bg-indigo-100 text-indigo-800'
                              }`}>
                                {dx.priority}
                              </span>
                            </div>
                          </div>
                          <p className="text-gray-700 text-sm">{dx.reasoning}</p>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          );

          const toggleHistorySelection = (questionId) => {
            if (selectedHistory.includes(questionId)) {
              setSelectedHistory(selectedHistory.filter(id => id !== questionId));
            } else {
              setSelectedHistory([...selectedHistory, questionId]);
            }
          };

          const togglePhysicalSelection = (examId) => {
            if (selectedPhysical.includes(examId)) {
              setSelectedPhysical(selectedPhysical.filter(id => id !== examId));
            } else {
              setSelectedPhysical([...selectedPhysical, examId]);
            }
          };

          const renderHistoryStage = () => {
            const questionCategories = [
              { key: 'hpiFollowUp', label: 'HPI Follow-up Questions', description: 'Questions to clarify the chief complaint and associated symptoms' },
              { key: 'ros', label: 'Review of Systems', description: 'Systematic review - select only relevant questions for this case' },
              { key: 'pmh', label: 'Past Medical History', description: 'Previous diagnoses, surgeries, and hospitalizations' },
              { key: 'socialHistory', label: 'Social & Family History', description: 'Medications, substances, family history, social factors' }
            ];

            return (
              <div className="space-y-6">
                <div className="bg-teal-50 border-l-4 border-teal-500 p-6 rounded-lg">
                  <h3 className="text-lg font-semibold text-teal-900 mb-2">Hypothesis-Driven History Taking</h3>
                  <p className="text-teal-800">
                    Select the questions you would ask this patient. Remember: you have <span className="font-bold">limited time</span>. Choose questions that will help distinguish between your differential diagnoses.
                  </p>
                  <p className="text-teal-700 text-sm mt-2">
                    ð¡ Not all questions are equally valuable. After selecting, you'll see which questions are high-yield vs. low-priority for this case.
                  </p>
                </div>

                {questionCategories.map((category) => (
                  <div key={category.key} className="bg-white rounded-lg shadow-lg p-6">
                    <h3 className="text-xl font-bold text-gray-900 mb-2">{category.label}</h3>
                    <p className="text-gray-600 text-sm mb-4">{category.description}</p>
                    <div className="space-y-2">
                      {currentCase.historyQuestions[category.key].map((q) => {
                        const isSelected = selectedHistory.includes(q.id);
                        const showQuality = showFeedback;
                        return (
                          <div
                            key={q.id}
                            className={`p-3 border-2 rounded cursor-pointer transition-all ${
                              showQuality
                                ? q.quality === 'excellent' ? 'excellent-choice' :
                                  q.quality === 'good' ? 'good-choice' :
                                  q.quality === 'fair' ? 'fair-choice' :
                                  'low-priority-choice'
                                : isSelected ? 'selected-choice' : 'border-gray-200 hover:border-gray-400'
                            }`}
                            onClick={() => !showFeedback && toggleHistorySelection(q.id)}
                          >
                            <div className="flex items-center justify-between">
                              <span className="text-gray-900 flex-1">{q.question}</span>
                              <div className="flex items-center gap-2">
                                {showQuality && (
                                  <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                    q.quality === 'excellent' ? 'bg-green-200 text-green-800' :
                                    q.quality === 'good' ? 'bg-blue-200 text-blue-800' :
                                    q.quality === 'fair' ? 'bg-yellow-200 text-yellow-800' :
                                    'bg-red-200 text-red-800'
                                  }`}>
                                    {q.quality.toUpperCase()}
                                  </span>
                                )}
                                <input
                                  type="checkbox"
                                  checked={isSelected}
                                  onChange={() => {}}
                                  className="w-5 h-5"
                                  disabled={showFeedback}
                                />
                              </div>
                            </div>
                            {showQuality && (
                              <p className="text-sm text-gray-600 mt-2 italic">{q.rationale}</p>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}

                <div className="bg-blue-50 border-2 border-blue-500 p-4 rounded-lg">
                  <h4 className="font-semibold text-blue-900">
                    Questions Selected: {selectedHistory.length}
                  </h4>
                </div>

                <div className="flex gap-4">
                  <button
                    onClick={() => {
                      setShowFeedback(true);
                      setShowComparison(true);
                    }}
                    className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors"
                    disabled={showFeedback}
                  >
                    Get Feedback on My Choices
                  </button>
                  
                  {showFeedback && (
                    <button
                      onClick={() => setCurrentStage('physical')}
                      className="flex-1 bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
                    >
                      Move to Physical Exam â
                    </button>
                  )}
                </div>

                {showComparison && renderComparisonView()}

                {showFeedback && (
                  <div className="bg-white rounded-lg shadow-lg p-6">
                    <h3 className="text-xl font-bold text-gray-900 mb-4">Question Quality Legend</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="flex items-center gap-2">
                        <div className="w-4 h-4 rounded bg-green-500"></div>
                        <span><strong>EXCELLENT:</strong> Essential, high-yield question</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-4 h-4 rounded bg-blue-500"></div>
                        <span><strong>GOOD:</strong> Useful question, adds value</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-4 h-4 rounded bg-yellow-500"></div>
                        <span><strong>FAIR:</strong> Reasonable but lower priority</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-4 h-4 rounded bg-red-500"></div>
                        <span><strong>LOW-PRIORITY:</strong> Not relevant to this case</span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          };

          const renderPhysicalStage = () => {
            const [showPhysicalFeedback, setShowPhysicalFeedback] = useState(false);
            const [showPhysicalComparison, setShowPhysicalComparison] = useState(false);

            return (
              <div className="space-y-6">
                <div className="bg-purple-50 border-l-4 border-purple-500 p-6 rounded-lg">
                  <h3 className="text-lg font-semibold text-purple-900 mb-2">Targeted Physical Examination</h3>
                  <p className="text-purple-800">
                    Select the physical exam maneuvers you would perform. Remember: a hypothesis-driven exam focuses on maneuvers that will distinguish between your differential diagnoses.
                  </p>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h3 className="text-xl font-bold text-gray-900 mb-4">Physical Exam Maneuvers</h3>
                  <div className="space-y-2">
                    {currentCase.physicalExam.map((exam) => {
                      const isSelected = selectedPhysical.includes(exam.id);
                      const showQuality = showPhysicalFeedback;
                      return (
                        <div
                          key={exam.id}
                          className={`p-3 border-2 rounded cursor-pointer transition-all ${
                            showQuality
                              ? exam.quality === 'excellent' ? 'excellent-choice' :
                                exam.quality === 'good' ? 'good-choice' :
                                exam.quality === 'fair' ? 'fair-choice' :
                                'low-priority-choice'
                              : isSelected ? 'selected-choice' : 'border-gray-200 hover:border-gray-400'
                          }`}
                          onClick={() => !showPhysicalFeedback && togglePhysicalSelection(exam.id)}
                        >
                          <div className="flex items-center justify-between">
                            <span className="text-gray-900 flex-1 font-medium">{exam.maneuver}</span>
                            <div className="flex items-center gap-2">
                              {showQuality && (
                                <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                  exam.quality === 'excellent' ? 'bg-green-200 text-green-800' :
                                  exam.quality === 'good' ? 'bg-blue-200 text-blue-800' :
                                  exam.quality === 'fair' ? 'bg-yellow-200 text-yellow-800' :
                                  'bg-red-200 text-red-800'
                                }`}>
                                  {exam.quality.toUpperCase()}
                                </span>
                              )}
                              <input
                                type="checkbox"
                                checked={isSelected}
                                onChange={() => {}}
                                className="w-5 h-5"
                                disabled={showPhysicalFeedback}
                              />
                            </div>
                          </div>
                          {showQuality && (
                            <div className="mt-2 space-y-1">
                              <p className="text-sm text-gray-600 italic">{exam.rationale}</p>
                              <p className="text-sm text-gray-800"><strong>Finding:</strong> {exam.finding}</p>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div className="bg-purple-50 border-2 border-purple-500 p-4 rounded-lg">
                  <h4 className="font-semibold text-purple-900">
                    Exam Maneuvers Selected: {selectedPhysical.length}
                  </h4>
                </div>

                <div className="flex gap-4">
                  <button
                    onClick={() => {
                      setShowPhysicalFeedback(true);
                      setShowPhysicalComparison(true);
                    }}
                    className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors"
                    disabled={showPhysicalFeedback}
                  >
                    Get Feedback on My Exam
                  </button>
                  
                  {showPhysicalFeedback && (
                    <button
                      onClick={() => setCurrentStage('diagnosis')}
                      className="flex-1 bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
                    >
                      Move to Diagnosis â
                    </button>
                  )}
                </div>

                {showPhysicalComparison && renderPhysicalComparisonView()}
              </div>
            );
          };

          const renderDiagnosisStage = () => (
            <div className="space-y-6">
              <div className="bg-emerald-50 border-l-4 border-emerald-500 p-6 rounded-lg">
                <h3 className="text-lg font-semibold text-emerald-900 mb-2">Final Diagnosis & Case Resolution</h3>
                <p className="text-emerald-800">
                  Based on your history and physical exam findings, review the actual diagnosis and learn the key teaching points from this case.
                </p>
              </div>

              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-2xl font-bold text-emerald-900 mb-4">
                  Actual Diagnosis: {currentCase.actualDiagnosis.diagnosis}
                </h3>
                
                <div className="space-y-4">
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Key Findings Supporting Diagnosis:</h4>
                    <ul className="list-disc list-inside space-y-1 text-gray-700">
                      {currentCase.actualDiagnosis.keyFindings.map((finding, idx) => (
                        <li key={idx}>{finding}</li>
                      ))}
                    </ul>
                  </div>
                  
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Clinical Reasoning:</h4>
                    <p className="text-gray-700">{currentCase.actualDiagnosis.reasoning}</p>
                  </div>
                  
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-2">Next Steps:</h4>
                    <p className="text-gray-700">{currentCase.actualDiagnosis.nextSteps}</p>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg shadow-lg p-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Diagnostic Studies</h3>
                <div className="space-y-4">
                  {currentCase.diagnosticStudies.map((study, idx) => (
                    <div key={idx} className={`p-4 rounded-lg ${
                      study.priority.includes('MUST') || study.priority.includes('FIRST') ? 'bg-red-50 border-2 border-red-300' :
                      study.priority.includes('Essential') ? 'bg-orange-50 border-2 border-orange-300' :
                      'bg-gray-50 border-2 border-gray-200'
                    }`}>
                      <div className="flex justify-between items-start mb-2">
                        <h4 className="font-bold text-gray-900">{study.study}</h4>
                        <span className={`px-2 py-1 rounded text-xs font-semibold ${
                          study.priority.includes('MUST') || study.priority.includes('FIRST') ? 'bg-red-200 text-red-800' :
                          study.priority.includes('Essential') ? 'bg-orange-200 text-orange-800' :
                          'bg-gray-200 text-gray-800'
                        }`}>
                          {study.priority}
                        </span>
                      </div>
                      <p className="text-sm text-gray-600 mb-2">{study.rationale}</p>
                      <p className="text-sm"><strong>Expected Result:</strong> {study.expectedResult}</p>
                      <p className="text-sm"><strong>Interpretation:</strong> {study.interpretation}</p>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg shadow-lg p-6">
                <h3 className="text-xl font-bold text-indigo-900 mb-4">ð Key Teaching Points</h3>
                <ul className="space-y-2">
                  {currentCase.teachingPoints.map((point, idx) => (
                    <li key={idx} className="flex items-start gap-2 text-indigo-800">
                      <span className="text-indigo-500 font-bold">â¢</span>
                      {point}
                    </li>
                  ))}
                </ul>
              </div>

              <button
                onClick={() => {
                  setCurrentStage('initial');
                  setSelectedDifferentials([]);
                  setShowDifferentialFeedback(false);
                  setSelectedHistory([]);
                  setSelectedPhysical([]);
                  setShowFeedback(false);
                  setShowComparison(false);
                  setExpandedSystems([]);
                }}
                className="w-full bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-700 transition-colors"
              >
                Start Over
              </button>
            </div>
          );

          return (
            <div className="min-h-screen bg-gray-100">
              <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-6 px-4 shadow-lg">
                <div className="max-w-4xl mx-auto">
                  <h1 className="text-3xl font-bold">Clinical Reasoning Tool</h1>
                  <p className="text-indigo-200 mt-1">Learn hypothesis-driven history taking and targeted physical examination</p>
                </div>
              </div>

              <div className="max-w-4xl mx-auto py-6 px-4">
                <div className="bg-white rounded-lg shadow-lg p-4 mb-6">
                  <div className="flex justify-between items-center mb-2">
                    <h2 className="text-xl font-bold text-gray-900">
                      Case: {currentCase.title}
                    </h2>
                    <a href="index.html" className="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                      â Back to All Cases
                    </a>
                  </div>
                  <div className="flex gap-2 flex-wrap">
                    {['initial', 'differential', 'history', 'physical', 'diagnosis'].map((stage, idx) => (
                      <div
                        key={stage}
                        className={`px-3 py-1 rounded-full text-sm font-medium ${
                          currentStage === stage
                            ? 'bg-indigo-600 text-white'
                            : 'bg-gray-200 text-gray-600'
                        }`}
                      >
                        {idx + 1}. {stage.charAt(0).toUpperCase() + stage.slice(1)}
                      </div>
                    ))}
                  </div>
                </div>

                {currentStage === 'initial' && renderInitialStage()}
                {currentStage === 'differential' && renderDifferentialStage()}
                {currentStage === 'history' && renderHistoryStage()}
                {currentStage === 'physical' && renderPhysicalStage()}
                {currentStage === 'diagnosis' && renderDiagnosisStage()}
              </div>
            </div>
          );
        };

        ReactDOM.render(<ClinicalReasoningTool />, document.getElementById('root'));
    </script>
</body>
</html>
