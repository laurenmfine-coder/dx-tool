<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Reasoning Game</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        .selected-choice { background-color: #dbeafe; border: 2px solid #3b82f6; }
        .excellent-choice { background-color: #dcfce7; border: 2px solid #16a34a; }
        .good-choice { background-color: #dbeafe; border: 2px solid #3b82f6; }
        .fair-choice { background-color: #fef3c7; border: 2px solid #f59e0b; }
        .low-priority-choice { background-color: #fee2e2; border: 2px solid #dc2626; }
        .pulse-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.8); }
        }
        .score-pop { animation: score-pop 0.5s ease-out; }
        @keyframes score-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: #10b981; }
            100% { transform: scale(1); }
        }
        .badge-unlock { animation: badge-unlock 0.8s ease-out; }
        @keyframes badge-unlock {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .streak-fire { animation: streak-fire 0.3s ease-out; }
        @keyframes streak-fire {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .level-up { animation: level-up 1s ease-out; }
        @keyframes level-up {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1); box-shadow: 0 0 30px gold; }
            100% { transform: scale(1); box-shadow: none; }
        }
        .timer-warning { animation: timer-warning 0.5s infinite; }
        @keyframes timer-warning {
            0%, 100% { color: #dc2626; }
            50% { color: #fbbf24; }
        }
        .star { transition: all 0.3s; }
        .star-earned { color: #fbbf24; transform: scale(1.2); }
        .star-empty { color: #d1d5db; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ==================== GAME CONFIGURATION ====================
        const GAME_CONFIG = {
          // Scoring
          basePointsPerQuestion: 100,
          excellentMultiplier: 1.5,
          goodMultiplier: 1.0,
          fairMultiplier: 0.5,
          lowPriorityPenalty: -50,
          mustNotMissBonus: 200,
          missedMustNotMissPenalty: -150,
          
          // Streaks
          streakBonusPerLevel: 25,
          maxStreakMultiplier: 5,
          
          // Time
          timePerStage: 300, // 5 minutes per stage in seconds
          speedBonusThreshold: 0.5, // Complete in under 50% time for bonus
          speedBonusMultiplier: 1.5,
          
          // XP & Leveling
          xpPerPoint: 0.1,
          baseXpToLevel: 500,
          levelMultiplier: 1.5,
          
          // Stars
          threeStarThreshold: 85,
          twoStarThreshold: 70,
          oneStarThreshold: 50,
        };

        const LEVELS = [
          { level: 1, title: "Medical Student", minXp: 0, icon: "üìö" },
          { level: 2, title: "Clinical Clerk", minXp: 500, icon: "ü©∫" },
          { level: 3, title: "Sub-Intern", minXp: 1200, icon: "üìã" },
          { level: 4, title: "Intern", minXp: 2500, icon: "üíâ" },
          { level: 5, title: "Resident", minXp: 4500, icon: "üî¨" },
          { level: 6, title: "Senior Resident", minXp: 7500, icon: "üìä" },
          { level: 7, title: "Chief Resident", minXp: 12000, icon: "‚≠ê" },
          { level: 8, title: "Attending", minXp: 18000, icon: "üë®‚Äç‚öïÔ∏è" },
          { level: 9, title: "Master Diagnostician", minXp: 30000, icon: "üèÜ" },
          { level: 10, title: "Legendary Clinician", minXp: 50000, icon: "üëë" },
        ];

        const BADGES = [
          { id: "first_case", name: "First Steps", description: "Complete your first case", icon: "üéØ", condition: (stats) => stats.casesCompleted >= 1 },
          { id: "five_cases", name: "Getting Started", description: "Complete 5 cases", icon: "üìà", condition: (stats) => stats.casesCompleted >= 5 },
          { id: "ten_cases", name: "Dedicated Learner", description: "Complete 10 cases", icon: "üåü", condition: (stats) => stats.casesCompleted >= 10 },
          { id: "perfect_differential", name: "Differential Master", description: "Include all expected diagnoses", icon: "üéØ", condition: (stats) => stats.perfectDifferentials >= 1 },
          { id: "speed_demon", name: "Speed Demon", description: "Complete a stage in under 2 minutes", icon: "‚ö°", condition: (stats) => stats.speedBonusesEarned >= 1 },
          { id: "efficiency_expert", name: "Efficiency Expert", description: "Score 90%+ efficiency on history", icon: "üíé", condition: (stats) => stats.highEfficiencyScores >= 1 },
          { id: "streak_master", name: "Streak Master", description: "Get a 10+ correct streak", icon: "üî•", condition: (stats) => stats.maxStreak >= 10 },
          { id: "three_stars", name: "Star Performer", description: "Get 3 stars on a case", icon: "‚≠ê", condition: (stats) => stats.threeStarCases >= 1 },
          { id: "cardiac_champion", name: "Cardiac Champion", description: "Never miss MI in differential", icon: "‚ù§Ô∏è", condition: (stats) => stats.neverMissedMI >= 3 },
          { id: "gi_guru", name: "GI Guru", description: "Complete 5 GI-related cases", icon: "ü´É", condition: (stats) => stats.giCasesCompleted >= 5 },
          { id: "must_not_miss_master", name: "Must-Not-Miss Master", description: "Never miss a must-not-miss diagnosis", icon: "üõ°Ô∏è", condition: (stats) => stats.perfectMustNotMiss >= 5 },
          { id: "no_low_priority", name: "Focused Clinician", description: "Complete case with zero low-priority selections", icon: "üéØ", condition: (stats) => stats.noLowPriorityCases >= 1 },
          { id: "thousand_points", name: "Point Collector", description: "Earn 1,000 total points", icon: "üí∞", condition: (stats) => stats.totalPoints >= 1000 },
          { id: "five_thousand_points", name: "High Scorer", description: "Earn 5,000 total points", icon: "üíé", condition: (stats) => stats.totalPoints >= 5000 },
          { id: "level_five", name: "Resident Status", description: "Reach Resident level", icon: "üî¨", condition: (stats) => stats.level >= 5 },
          { id: "level_eight", name: "Attending Achieved", description: "Reach Attending level", icon: "üë®‚Äç‚öïÔ∏è", condition: (stats) => stats.level >= 8 },
          { id: "all_cases_unlocked", name: "Case Collector", description: "Unlock all available cases", icon: "üóÇÔ∏è", condition: (stats) => stats.casesUnlocked >= stats.totalCases },
          { id: "comeback_kid", name: "Comeback Kid", description: "Improve your score on a case by 20%+", icon: "üìà", condition: (stats) => stats.majorImprovements >= 1 },
        ];

        // ==================== CASE DATA ====================
        const CASES = [
          {
            id: "epigastric-pain",
            title: "Epigastric Pain",
            difficulty: 1,
            category: "GI/Cardiac",
            unlocked: true,
            icon: "ü´É",
            doorNote: {
              name: "R.H.",
              age: 62,
              sex: "Male",
              location: "Outpatient Primary Care Clinic",
              chiefComplaint: "I have pain in the upper middle part of my belly.",
              vitals: "BP 138/82, Temp 98.6¬∞F, HR 88, RR 18, O2 Sat 98% RA, BMI 27.3"
            },
            expectedDifferential: [
              { diagnosis: "Gastritis", priority: "Most likely", reasoning: "Epigastric pain in older adult taking NSAIDs is classic for gastritis.", mustNotMiss: false },
              { diagnosis: "GERD", priority: "Common", reasoning: "Burning epigastric pain, common in older adults.", mustNotMiss: false },
              { diagnosis: "Peptic ulcer disease (PUD)", priority: "Common", reasoning: "NSAID use is major PUD risk factor.", mustNotMiss: false },
              { diagnosis: "Myocardial infarction (MI)", priority: "MUST-NOT-MISS", reasoning: "62yo male - epigastric pain CAN BE atypical MI.", mustNotMiss: true },
              { diagnosis: "Pancreatitis", priority: "Must-not-miss", reasoning: "Epigastric pain radiating to back.", mustNotMiss: true },
              { diagnosis: "Cholecystitis/gallbladder disease", priority: "Consider", reasoning: "Can cause epigastric pain.", mustNotMiss: false }
            ],
            historyQuestions: {
              hpiFollowUp: [
                { id: "h1", question: "Can you describe what the pain feels like?", quality: "excellent", rationale: "Pain character is diagnostic." },
                { id: "h2", question: "Is the pain burning?", quality: "excellent", rationale: "Burning pain is classic for gastritis and GERD." },
                { id: "h3", question: "Is the pain like pressure or squeezing?", quality: "excellent", rationale: "Pressure/squeezing suggests cardiac cause." },
                { id: "h4", question: "When did the pain start?", quality: "excellent", rationale: "Timeline is critical for diagnosis." },
                { id: "h5", question: "Is the pain constant or does it come and go?", quality: "good", rationale: "Pattern helps narrow differential." },
                { id: "h6", question: "Does the pain radiate to your back?", quality: "excellent", rationale: "Back radiation is classic for pancreatitis." },
                { id: "h7", question: "Does the pain radiate to your chest?", quality: "excellent", rationale: "Chest radiation suggests MI." },
                { id: "h8", question: "Does the pain radiate to your jaw?", quality: "excellent", rationale: "Jaw pain is classic MI radiation." },
                { id: "h9", question: "Does the pain radiate to your left arm?", quality: "excellent", rationale: "Left arm pain is classic MI." },
                { id: "h10", question: "Is the pain worse after eating?", quality: "excellent", rationale: "Worse with meals = gastritis." },
                { id: "h11", question: "Does eating make the pain better?", quality: "excellent", rationale: "Pain IMPROVED by food = duodenal ulcer." },
                { id: "h12", question: "Have you had any chest discomfort or pressure?", quality: "excellent", rationale: "CRITICAL - must screen for cardiac symptoms." },
                { id: "h13", question: "Any shortness of breath?", quality: "excellent", rationale: "Dyspnea + epigastric pain = MI concern." },
                { id: "h14", question: "Any sweating or feeling clammy?", quality: "excellent", rationale: "Diaphoresis is classic MI symptom." },
                { id: "h15", question: "Have you noticed any black, tarry stools?", quality: "excellent", rationale: "Melena = upper GI bleed." },
                { id: "h16", question: "Have you vomited any blood?", quality: "excellent", rationale: "Hematemesis = upper GI bleed." },
                { id: "h17", question: "How often do you take ibuprofen?", quality: "excellent", rationale: "NSAID frequency determines risk." },
                { id: "h18", question: "On a scale of 1-10, how bad is your pain?", quality: "low-priority", rationale: "Pain scales have limited diagnostic utility." },
                { id: "h19", question: "What color is your urine?", quality: "low-priority", rationale: "Not relevant to epigastric pain." },
                { id: "h20", question: "Any ringing in your ears?", quality: "low-priority", rationale: "Not related to this differential." }
              ],
              ros: [
                { id: "r1", question: "Any difficulty swallowing?", quality: "excellent", rationale: "Dysphagia = esophageal pathology red flag." },
                { id: "r2", question: "Have you lost weight without trying?", quality: "excellent", rationale: "Unintentional weight loss = RED FLAG for malignancy." },
                { id: "r3", question: "Any heartburn?", quality: "good", rationale: "Directly asks about GERD symptoms." },
                { id: "r4", question: "Any fever or chills?", quality: "fair", rationale: "Suggests infection or inflammation." },
                { id: "r5", question: "Any cough?", quality: "low-priority", rationale: "Not related to epigastric pain." },
                { id: "r6", question: "Any wheezing?", quality: "low-priority", rationale: "Not relevant." },
                { id: "r7", question: "Any burning when you urinate?", quality: "low-priority", rationale: "Not related." },
                { id: "r8", question: "Any joint pain?", quality: "low-priority", rationale: "Not related." }
              ],
              pmh: [
                { id: "p1", question: "Have you ever had a heart attack?", quality: "excellent", rationale: "Prior MI = VERY HIGH RISK for recurrent MI." },
                { id: "p2", question: "Have you ever had angina?", quality: "excellent", rationale: "History of angina = known CAD." },
                { id: "p3", question: "Do you have diabetes?", quality: "excellent", rationale: "Major cardiac risk factor." },
                { id: "p4", question: "Do you have high blood pressure?", quality: "excellent", rationale: "Major cardiac risk factor." },
                { id: "p5", question: "Have you ever had an ulcer?", quality: "excellent", rationale: "Prior PUD = high recurrence risk." },
                { id: "p6", question: "Have you ever had pancreatitis?", quality: "good", rationale: "Recurrent pancreatitis is common." },
                { id: "p7", question: "Do you have asthma?", quality: "low-priority", rationale: "Not related to epigastric pain." },
                { id: "p8", question: "Any thyroid problems?", quality: "low-priority", rationale: "Not related." }
              ],
              socialHistory: [
                { id: "s1", question: "Do you smoke cigarettes?", quality: "excellent", rationale: "Major risk factor for CAD and PUD." },
                { id: "s2", question: "How much alcohol do you drink?", quality: "excellent", rationale: "Heavy alcohol = pancreatitis, gastritis." },
                { id: "s3", question: "Do you take aspirin?", quality: "excellent", rationale: "Aspirin + NSAID = very high GI bleed risk." },
                { id: "s4", question: "Family history of heart disease?", quality: "excellent", rationale: "Family CAD is major risk factor." },
                { id: "s5", question: "What is your occupation?", quality: "fair", rationale: "Lower priority for this case." },
                { id: "s6", question: "Who do you live with?", quality: "low-priority", rationale: "Not relevant to diagnosis." }
              ]
            },
            physicalExam: [
              { id: "pe1", maneuver: "Assess general appearance", quality: "good", finding: "Mildly uncomfortable, no diaphoresis", rationale: "First step - is patient in distress?" },
              { id: "pe2", maneuver: "Auscultate heart sounds", quality: "excellent", finding: "Regular rate and rhythm, no murmurs", rationale: "CRITICAL in older adult with epigastric pain." },
              { id: "pe3", maneuver: "Light palpation of abdomen", quality: "excellent", finding: "Mild epigastric tenderness", rationale: "Essential first step of abdominal exam." },
              { id: "pe4", maneuver: "Deep palpation of epigastrium", quality: "excellent", finding: "Moderate tenderness, no masses", rationale: "Assess severity of tenderness." },
              { id: "pe5", maneuver: "Check for rebound tenderness", quality: "excellent", finding: "No rebound", rationale: "Rebound = peritonitis = surgical emergency." },
              { id: "pe6", maneuver: "Murphy's sign", quality: "excellent", finding: "Negative", rationale: "Tests for cholecystitis." },
              { id: "pe7", maneuver: "Auscultate bowel sounds", quality: "good", finding: "Normal bowel sounds", rationale: "Standard abdominal exam." },
              { id: "pe8", maneuver: "Complete neurological exam", quality: "low-priority", finding: "Normal", rationale: "Not relevant to this case." },
              { id: "pe9", maneuver: "Check deep tendon reflexes", quality: "low-priority", finding: "Normal", rationale: "Not relevant." },
              { id: "pe10", maneuver: "Examine ear canals", quality: "low-priority", finding: "Normal", rationale: "Not relevant to epigastric pain." }
            ],
            diagnosticStudies: [
              { study: "ECG (12-lead)", priority: "FIRST TEST", rationale: "Must rule out MI in older adult.", expectedResult: "Normal sinus rhythm" },
              { study: "Troponin", priority: "Essential", rationale: "Serum marker of myocardial injury.", expectedResult: "Negative" },
              { study: "CBC", priority: "Important", rationale: "Check for anemia from GI bleeding.", expectedResult: "Normal" },
              { study: "Lipase", priority: "Consider", rationale: "Rules out pancreatitis.", expectedResult: "Normal" }
            ],
            actualDiagnosis: {
              diagnosis: "NSAID-induced gastritis with GERD",
              keyFindings: ["Regular NSAID use", "Pain worse after meals", "No cardiac symptoms", "Epigastric tenderness"],
              teachingPoints: [
                "Epigastric pain in older adults CAN BE myocardial infarction",
                "ECG and troponin should be first tests in older adults",
                "NSAIDs are a MAJOR preventable cause of gastritis and PUD",
                "Ask specifics about NSAID use: frequency, dose, empty stomach"
              ]
            }
          },
          {
            id: "nausea-vomiting",
            title: "Nausea & Vomiting",
            difficulty: 2,
            category: "OB/GYN/GI",
            unlocked: false,
            icon: "ü§¢",
            doorNote: {
              name: "S.R.",
              age: 34,
              sex: "Female",
              location: "Urgent Care Clinic",
              chiefComplaint: "I've been throwing up for two days and can't keep anything down.",
              vitals: "BP 100/64, Temp 99.1¬∞F, HR 108, RR 18, O2 Sat 99% RA"
            },
            expectedDifferential: [
              { diagnosis: "Pregnancy", priority: "Most likely", reasoning: "Reproductive-age female with nausea/vomiting - ALWAYS consider.", mustNotMiss: true },
              { diagnosis: "Viral gastroenteritis", priority: "Common", reasoning: "Common cause of acute nausea/vomiting.", mustNotMiss: false },
              { diagnosis: "Gastritis", priority: "Common", reasoning: "Inflammation of stomach lining.", mustNotMiss: false },
              { diagnosis: "Small bowel obstruction", priority: "MUST-NOT-MISS", reasoning: "Bilious vomiting, prior surgery = SBO.", mustNotMiss: true },
              { diagnosis: "Diabetic ketoacidosis", priority: "MUST-NOT-MISS", reasoning: "Vomiting + polyuria + polydipsia.", mustNotMiss: true },
              { diagnosis: "Increased intracranial pressure", priority: "MUST-NOT-MISS", reasoning: "Projectile vomiting + headache.", mustNotMiss: true },
              { diagnosis: "Pancreatitis", priority: "Consider", reasoning: "Epigastric pain radiating to back.", mustNotMiss: false }
            ],
            historyQuestions: {
              hpiFollowUp: [
                { id: "h1", question: "When was your last menstrual period?", quality: "excellent", rationale: "MUST ASK in reproductive-age female." },
                { id: "h2", question: "Could you be pregnant?", quality: "excellent", rationale: "Direct question about pregnancy." },
                { id: "h3", question: "Are you sexually active?", quality: "excellent", rationale: "Establishes pregnancy risk." },
                { id: "h4", question: "What does the vomit look like?", quality: "excellent", rationale: "Bilious = SBO, blood = GI bleed." },
                { id: "h5", question: "Is the vomit green or yellow?", quality: "excellent", rationale: "Bilious vomiting = obstruction." },
                { id: "h6", question: "Is the vomiting projectile?", quality: "excellent", rationale: "Projectile = increased ICP." },
                { id: "h7", question: "When was your last bowel movement?", quality: "excellent", rationale: "Obstipation = SBO." },
                { id: "h8", question: "Are you passing gas?", quality: "excellent", rationale: "No flatus = complete obstruction." },
                { id: "h9", question: "Any headaches?", quality: "excellent", rationale: "Headache + vomiting = ICP." },
                { id: "h10", question: "Urinating more than usual?", quality: "excellent", rationale: "Polyuria = DKA." },
                { id: "h11", question: "Very thirsty?", quality: "excellent", rationale: "Polydipsia = DKA." },
                { id: "h12", question: "Any abdominal pain?", quality: "good", rationale: "Location helps narrow differential." },
                { id: "h13", question: "Any diarrhea?", quality: "good", rationale: "Diarrhea suggests gastroenteritis." },
                { id: "h14", question: "Anyone else sick?", quality: "good", rationale: "Sick contacts = infectious cause." },
                { id: "h15", question: "What's your favorite color?", quality: "low-priority", rationale: "Not medically relevant." },
                { id: "h16", question: "Do you like your job?", quality: "low-priority", rationale: "Not relevant to acute symptoms." }
              ],
              ros: [
                { id: "r1", question: "Any vision changes?", quality: "excellent", rationale: "Vision changes = increased ICP." },
                { id: "r2", question: "Any confusion?", quality: "excellent", rationale: "Altered mental status is concerning." },
                { id: "r3", question: "Any fever?", quality: "good", rationale: "Fever suggests infection." },
                { id: "r4", question: "Any neck stiffness?", quality: "good", rationale: "Meningismus concerning for CNS infection." },
                { id: "r5", question: "Any cough?", quality: "low-priority", rationale: "Not related to vomiting." },
                { id: "r6", question: "Any joint pain?", quality: "low-priority", rationale: "Not related." }
              ],
              pmh: [
                { id: "p1", question: "Do you have diabetes?", quality: "excellent", rationale: "DKA is must-not-miss in diabetics." },
                { id: "p2", question: "Ever had abdominal surgery?", quality: "excellent", rationale: "Adhesions = #1 cause of SBO." },
                { id: "p3", question: "Ever pregnant before?", quality: "good", rationale: "G/P status relevant." },
                { id: "p4", question: "Severe nausea in previous pregnancies?", quality: "good", rationale: "Hyperemesis recurs 15-20%." },
                { id: "p5", question: "Any thyroid problems?", quality: "fair", rationale: "Thyroid can cause nausea." },
                { id: "p6", question: "Any skin conditions?", quality: "low-priority", rationale: "Not related." }
              ],
              socialHistory: [
                { id: "s1", question: "Using birth control?", quality: "excellent", rationale: "Risk assessment for pregnancy." },
                { id: "s2", question: "Taken a pregnancy test?", quality: "excellent", rationale: "May already know." },
                { id: "s3", question: "Use marijuana?", quality: "good", rationale: "Cannabinoid hyperemesis syndrome." },
                { id: "s4", question: "Alcohol use?", quality: "good", rationale: "Alcoholic gastritis, pancreatitis." },
                { id: "s5", question: "What's your highest education level?", quality: "low-priority", rationale: "Not relevant to acute symptoms." }
              ]
            },
            physicalExam: [
              { id: "pe1", maneuver: "Assess hydration status", quality: "excellent", finding: "Dry mucous membranes", rationale: "Critical for dehydration assessment." },
              { id: "pe2", maneuver: "Check skin turgor", quality: "excellent", finding: "Mild tenting", rationale: "Tenting = dehydration." },
              { id: "pe3", maneuver: "Fundoscopic exam for papilledema", quality: "excellent", finding: "No papilledema", rationale: "Papilledema = increased ICP." },
              { id: "pe4", maneuver: "Abdominal inspection", quality: "excellent", finding: "Flat, no distension", rationale: "Distension suggests obstruction." },
              { id: "pe5", maneuver: "Auscultate bowel sounds", quality: "excellent", finding: "Normal", rationale: "High-pitched = obstruction." },
              { id: "pe6", maneuver: "Palpate for rebound tenderness", quality: "excellent", finding: "No rebound", rationale: "Peritonitis screening." },
              { id: "pe7", maneuver: "Check for guarding", quality: "excellent", finding: "No guarding", rationale: "Involuntary guarding = peritonitis." },
              { id: "pe8", maneuver: "Smell breath for fruity odor", quality: "good", finding: "No fruity odor", rationale: "Ketones = DKA." },
              { id: "pe9", maneuver: "Complete skin exam", quality: "low-priority", finding: "Normal", rationale: "Not relevant." },
              { id: "pe10", maneuver: "Check for bunions", quality: "low-priority", finding: "None", rationale: "Not relevant." }
            ],
            diagnosticStudies: [
              { study: "Urine pregnancy test", priority: "FIRST TEST", rationale: "MANDATORY in reproductive-age female.", expectedResult: "POSITIVE" },
              { study: "Serum hCG", priority: "Essential", rationale: "Quantify for dating pregnancy.", expectedResult: "28,000 mIU/mL" },
              { study: "BMP", priority: "Essential", rationale: "Electrolytes, glucose, kidney function.", expectedResult: "K+ 3.2, BUN 22" },
              { study: "Pelvic ultrasound", priority: "Important", rationale: "Confirm intrauterine pregnancy.", expectedResult: "IUP confirmed" }
            ],
            actualDiagnosis: {
              diagnosis: "Early pregnancy with hyperemesis gravidarum",
              keyFindings: ["Positive pregnancy test", "Persistent vomiting", "Dehydration signs", "Tachycardia"],
              teachingPoints: [
                "ALWAYS consider pregnancy in reproductive-age females",
                "First test = pregnancy test",
                "Hyperemesis: nausea/vomiting + dehydration + ketonuria",
                "Must-not-miss: SBO, DKA, increased ICP"
              ]
            }
          }
        ];

        const differentialsBySystem = {
          'Cardiac': ['Myocardial infarction (MI)', 'Angina/ACS', 'Heart failure', 'Pericarditis'],
          'Gastrointestinal': ['Gastritis', 'GERD', 'Peptic ulcer disease (PUD)', 'Pancreatitis', 'Cholecystitis/gallbladder disease', 'Gastroenteritis', 'Small bowel obstruction', 'Hepatitis'],
          'Gynecologic': ['Pregnancy', 'Ectopic pregnancy', 'Hyperemesis gravidarum', 'Ovarian torsion'],
          'Endocrine': ['Diabetic ketoacidosis', 'Thyroid disease', 'Adrenal insufficiency'],
          'Neurological': ['Increased intracranial pressure', 'Migraine', 'Vestibular disorders'],
          'Other': ['Medication-induced', 'Anxiety/stress-related', 'Food poisoning']
        };

        // ==================== HELPER FUNCTIONS ====================
        const diagnosisMatches = (selected, expected) => {
          const s = selected.toLowerCase();
          const e = expected.toLowerCase();
          if (s === e) return true;
          if (s.includes(e) || e.includes(s)) return true;
          const sFirst = s.split(/[\s(/]/)[0];
          const eFirst = e.split(/[\s(/]/)[0];
          if (sFirst === eFirst) return true;
          return false;
        };

        const getLevelInfo = (xp) => {
          let currentLevel = LEVELS[0];
          for (const level of LEVELS) {
            if (xp >= level.minXp) currentLevel = level;
          }
          const nextLevel = LEVELS.find(l => l.minXp > xp) || currentLevel;
          const xpForNext = nextLevel.minXp - currentLevel.minXp;
          const xpProgress = xp - currentLevel.minXp;
          return { ...currentLevel, nextLevel, xpForNext, xpProgress, progressPercent: Math.min(100, (xpProgress / xpForNext) * 100) };
        };

        const formatTime = (seconds) => {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        // ==================== MAIN COMPONENT ====================
        const ClinicalReasoningGame = () => {
          // Game State
          const [gameMode, setGameMode] = useState('menu'); // menu, practice, game, profile, caseSelect
          const [currentCaseIndex, setCurrentCaseIndex] = useState(0);
          const [currentStage, setCurrentStage] = useState('initial');
          const [timer, setTimer] = useState(GAME_CONFIG.timePerStage);
          const [isTimerRunning, setIsTimerRunning] = useState(false);
          const [showFeedback, setShowFeedback] = useState(false);
          
          // Selections
          const [selectedDifferentials, setSelectedDifferentials] = useState([]);
          const [selectedHistory, setSelectedHistory] = useState([]);
          const [selectedPhysical, setSelectedPhysical] = useState([]);
          const [expandedSystems, setExpandedSystems] = useState([]);
          
          // Scoring
          const [currentScore, setCurrentScore] = useState(0);
          const [stageScores, setStageScores] = useState({});
          const [streak, setStreak] = useState(0);
          const [maxStreak, setMaxStreak] = useState(0);
          const [scorePopup, setScorePopup] = useState(null);
          
          // Player Profile (persisted)
          const [playerStats, setPlayerStats] = useState(() => {
            const saved = localStorage.getItem('clinicalReasoningStats');
            return saved ? JSON.parse(saved) : {
              totalXp: 0,
              totalPoints: 0,
              casesCompleted: 0,
              casesUnlocked: 1,
              totalCases: CASES.length,
              badges: [],
              caseScores: {},
              perfectDifferentials: 0,
              speedBonusesEarned: 0,
              highEfficiencyScores: 0,
              maxStreak: 0,
              threeStarCases: 0,
              neverMissedMI: 0,
              giCasesCompleted: 0,
              perfectMustNotMiss: 0,
              noLowPriorityCases: 0,
              majorImprovements: 0,
              level: 1
            };
          });
          
          const [unlockedCases, setUnlockedCases] = useState(() => {
            const saved = localStorage.getItem('unlockedCases');
            return saved ? JSON.parse(saved) : ['epigastric-pain'];
          });
          
          const [newBadges, setNewBadges] = useState([]);
          const [showLevelUp, setShowLevelUp] = useState(false);

          // Save stats to localStorage
          useEffect(() => {
            localStorage.setItem('clinicalReasoningStats', JSON.stringify(playerStats));
          }, [playerStats]);

          useEffect(() => {
            localStorage.setItem('unlockedCases', JSON.stringify(unlockedCases));
          }, [unlockedCases]);

          // Timer effect
          useEffect(() => {
            let interval;
            if (isTimerRunning && timer > 0 && gameMode === 'game') {
              interval = setInterval(() => {
                setTimer(t => t - 1);
              }, 1000);
            }
            return () => clearInterval(interval);
          }, [isTimerRunning, timer, gameMode]);

          const currentCase = CASES[currentCaseIndex];

          // Check for new badges
          const checkBadges = (updatedStats) => {
            const newlyEarned = [];
            BADGES.forEach(badge => {
              if (!updatedStats.badges.includes(badge.id) && badge.condition(updatedStats)) {
                newlyEarned.push(badge);
              }
            });
            return newlyEarned;
          };

          // Calculate score for a selection
          const calculateSelectionScore = (item, isCorrect) => {
            let points = 0;
            if (item.quality === 'excellent') {
              points = GAME_CONFIG.basePointsPerQuestion * GAME_CONFIG.excellentMultiplier;
            } else if (item.quality === 'good') {
              points = GAME_CONFIG.basePointsPerQuestion * GAME_CONFIG.goodMultiplier;
            } else if (item.quality === 'fair') {
              points = GAME_CONFIG.basePointsPerQuestion * GAME_CONFIG.fairMultiplier;
            } else {
              points = GAME_CONFIG.lowPriorityPenalty;
            }
            
            // Apply streak bonus
            if (points > 0) {
              const streakBonus = Math.min(streak, GAME_CONFIG.maxStreakMultiplier) * GAME_CONFIG.streakBonusPerLevel;
              points += streakBonus;
            }
            
            return Math.round(points);
          };

          // Handle selection with scoring
          const handleHistorySelection = (questionId) => {
            if (showFeedback) return;
            
            const allQuestions = [
              ...currentCase.historyQuestions.hpiFollowUp,
              ...currentCase.historyQuestions.ros,
              ...currentCase.historyQuestions.pmh,
              ...currentCase.historyQuestions.socialHistory
            ];
            const question = allQuestions.find(q => q.id === questionId);
            
            if (selectedHistory.includes(questionId)) {
              setSelectedHistory(selectedHistory.filter(id => id !== questionId));
              if (gameMode === 'game') {
                const points = calculateSelectionScore(question, true);
                setCurrentScore(s => Math.max(0, s - points));
                setStreak(0);
              }
            } else {
              setSelectedHistory([...selectedHistory, questionId]);
              if (gameMode === 'game') {
                const points = calculateSelectionScore(question, true);
                setCurrentScore(s => s + points);
                if (points > 0) {
                  setStreak(s => s + 1);
                  setMaxStreak(m => Math.max(m, streak + 1));
                  setScorePopup({ points, x: Math.random() * 100, y: Math.random() * 50 });
                  setTimeout(() => setScorePopup(null), 500);
                } else {
                  setStreak(0);
                }
              }
            }
          };

          const handlePhysicalSelection = (examId) => {
            if (showFeedback) return;
            
            const exam = currentCase.physicalExam.find(e => e.id === examId);
            
            if (selectedPhysical.includes(examId)) {
              setSelectedPhysical(selectedPhysical.filter(id => id !== examId));
              if (gameMode === 'game') {
                const points = calculateSelectionScore(exam, true);
                setCurrentScore(s => Math.max(0, s - points));
              }
            } else {
              setSelectedPhysical([...selectedPhysical, examId]);
              if (gameMode === 'game') {
                const points = calculateSelectionScore(exam, true);
                setCurrentScore(s => s + points);
                if (points > 0) {
                  setStreak(s => s + 1);
                  setScorePopup({ points, x: Math.random() * 100, y: Math.random() * 50 });
                  setTimeout(() => setScorePopup(null), 500);
                } else {
                  setStreak(0);
                }
              }
            }
          };

          // Calculate final case score
          const calculateFinalScore = () => {
            let totalScore = currentScore;
            
            // Speed bonus
            const timeUsed = GAME_CONFIG.timePerStage * 3 - timer;
            const timeAllowed = GAME_CONFIG.timePerStage * 3;
            if (timeUsed < timeAllowed * GAME_CONFIG.speedBonusThreshold) {
              totalScore = Math.round(totalScore * GAME_CONFIG.speedBonusMultiplier);
            }
            
            // Must-not-miss bonus/penalty
            const mustNotMiss = currentCase.expectedDifferential.filter(d => d.mustNotMiss);
            let missedMustNotMiss = 0;
            mustNotMiss.forEach(dx => {
              const included = selectedDifferentials.some(s => diagnosisMatches(s, dx.diagnosis));
              if (included) {
                totalScore += GAME_CONFIG.mustNotMissBonus;
              } else {
                totalScore += GAME_CONFIG.missedMustNotMissPenalty;
                missedMustNotMiss++;
              }
            });
            
            // Calculate efficiency
            const allQuestions = [
              ...currentCase.historyQuestions.hpiFollowUp,
              ...currentCase.historyQuestions.ros,
              ...currentCase.historyQuestions.pmh,
              ...currentCase.historyQuestions.socialHistory
            ];
            const selectedQ = allQuestions.filter(q => selectedHistory.includes(q.id));
            const highYield = selectedQ.filter(q => q.quality === 'excellent' || q.quality === 'good');
            const lowPriority = selectedQ.filter(q => q.quality === 'low-priority');
            const efficiency = selectedQ.length > 0 ? (highYield.length / selectedQ.length) * 100 : 0;
            
            // Stars
            let stars = 0;
            const scorePercent = Math.min(100, (totalScore / 2000) * 100);
            if (scorePercent >= GAME_CONFIG.threeStarThreshold) stars = 3;
            else if (scorePercent >= GAME_CONFIG.twoStarThreshold) stars = 2;
            else if (scorePercent >= GAME_CONFIG.oneStarThreshold) stars = 1;
            
            // XP earned
            const xpEarned = Math.round(totalScore * GAME_CONFIG.xpPerPoint);
            
            return {
              totalScore,
              efficiency,
              stars,
              xpEarned,
              missedMustNotMiss,
              lowPriorityCount: lowPriority.length,
              timeUsed,
              speedBonus: timeUsed < timeAllowed * GAME_CONFIG.speedBonusThreshold
            };
          };

          // Complete case and update stats
          const completeCase = () => {
            const results = calculateFinalScore();
            const oldLevel = getLevelInfo(playerStats.totalXp).level;
            
            // Check if this is an improvement
            const previousBest = playerStats.caseScores[currentCase.id] || 0;
            const isImprovement = results.totalScore > previousBest * 1.2;
            
            const updatedStats = {
              ...playerStats,
              totalXp: playerStats.totalXp + results.xpEarned,
              totalPoints: playerStats.totalPoints + results.totalScore,
              casesCompleted: playerStats.casesCompleted + 1,
              caseScores: {
                ...playerStats.caseScores,
                [currentCase.id]: Math.max(previousBest, results.totalScore)
              },
              maxStreak: Math.max(playerStats.maxStreak, maxStreak),
              threeStarCases: playerStats.threeStarCases + (results.stars === 3 ? 1 : 0),
              speedBonusesEarned: playerStats.speedBonusesEarned + (results.speedBonus ? 1 : 0),
              highEfficiencyScores: playerStats.highEfficiencyScores + (results.efficiency >= 90 ? 1 : 0),
              perfectMustNotMiss: playerStats.perfectMustNotMiss + (results.missedMustNotMiss === 0 ? 1 : 0),
              noLowPriorityCases: playerStats.noLowPriorityCases + (results.lowPriorityCount === 0 ? 1 : 0),
              majorImprovements: playerStats.majorImprovements + (isImprovement ? 1 : 0),
              giCasesCompleted: playerStats.giCasesCompleted + (currentCase.category.includes('GI') ? 1 : 0)
            };
            
            updatedStats.level = getLevelInfo(updatedStats.totalXp).level;
            
            // Check for new badges
            const earnedBadges = checkBadges(updatedStats);
            if (earnedBadges.length > 0) {
              updatedStats.badges = [...updatedStats.badges, ...earnedBadges.map(b => b.id)];
              setNewBadges(earnedBadges);
            }
            
            // Check for level up
            if (updatedStats.level > oldLevel) {
              setShowLevelUp(true);
            }
            
            // Unlock next case
            const nextCaseIndex = currentCaseIndex + 1;
            if (nextCaseIndex < CASES.length && results.stars >= 1) {
              const nextCaseId = CASES[nextCaseIndex].id;
              if (!unlockedCases.includes(nextCaseId)) {
                setUnlockedCases([...unlockedCases, nextCaseId]);
                updatedStats.casesUnlocked = unlockedCases.length + 1;
              }
            }
            
            setPlayerStats(updatedStats);
            setStageScores(results);
          };

          // Reset for new case
          const resetCase = () => {
            setCurrentStage('initial');
            setSelectedDifferentials([]);
            setSelectedHistory([]);
            setSelectedPhysical([]);
            setExpandedSystems([]);
            setShowFeedback(false);
            setCurrentScore(0);
            setStreak(0);
            setMaxStreak(0);
            setTimer(GAME_CONFIG.timePerStage);
            setIsTimerRunning(false);
            setStageScores({});
            setNewBadges([]);
            setShowLevelUp(false);
          };

          const startCase = (caseIndex, mode) => {
            setCurrentCaseIndex(caseIndex);
            setGameMode(mode);
            resetCase();
            if (mode === 'game') {
              setIsTimerRunning(true);
            }
          };

          // ==================== RENDER FUNCTIONS ====================
          
          const renderMenu = () => (
            <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-800 flex items-center justify-center p-4">
              <div className="max-w-4xl w-full">
                <div className="text-center mb-12">
                  <h1 className="text-5xl font-bold text-white mb-4">ü©∫ Clinical Reasoning Game</h1>
                  <p className="text-xl text-indigo-200">Master hypothesis-driven clinical thinking</p>
                </div>
                
                <div className="grid md:grid-cols-2 gap-6 mb-8">
                  <button
                    onClick={() => setGameMode('caseSelect')}
                    className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-8 rounded-2xl shadow-2xl hover:scale-105 transition-transform"
                  >
                    <div className="text-4xl mb-4">üéÆ</div>
                    <h2 className="text-2xl font-bold mb-2">Game Mode</h2>
                    <p className="text-green-100">Timed challenges with scoring, XP, and achievements</p>
                  </button>
                  
                  <button
                    onClick={() => { setGameMode('caseSelect'); }}
                    className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-8 rounded-2xl shadow-2xl hover:scale-105 transition-transform"
                  >
                    <div className="text-4xl mb-4">üìö</div>
                    <h2 className="text-2xl font-bold mb-2">Practice Mode</h2>
                    <p className="text-blue-100">Learn at your own pace without time pressure</p>
                  </button>
                </div>
                
                <div className="flex justify-center gap-4">
                  <button
                    onClick={() => setGameMode('profile')}
                    className="bg-white/10 backdrop-blur text-white px-6 py-3 rounded-xl hover:bg-white/20 transition"
                  >
                    üë§ My Profile
                  </button>
                  <button
                    onClick={() => setGameMode('achievements')}
                    className="bg-white/10 backdrop-blur text-white px-6 py-3 rounded-xl hover:bg-white/20 transition"
                  >
                    üèÜ Achievements
                  </button>
                </div>
                
                {/* Quick Stats */}
                <div className="mt-8 bg-white/10 backdrop-blur rounded-xl p-6">
                  <div className="grid grid-cols-4 gap-4 text-center">
                    <div>
                      <div className="text-3xl font-bold text-white">{playerStats.casesCompleted}</div>
                      <div className="text-indigo-200 text-sm">Cases Done</div>
                    </div>
                    <div>
                      <div className="text-3xl font-bold text-yellow-400">{playerStats.totalPoints.toLocaleString()}</div>
                      <div className="text-indigo-200 text-sm">Total Points</div>
                    </div>
                    <div>
                      <div className="text-3xl font-bold text-green-400">{getLevelInfo(playerStats.totalXp).title}</div>
                      <div className="text-indigo-200 text-sm">Current Rank</div>
                    </div>
                    <div>
                      <div className="text-3xl font-bold text-purple-300">{playerStats.badges.length}</div>
                      <div className="text-indigo-200 text-sm">Badges</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );

          const renderCaseSelect = () => (
            <div className="min-h-screen bg-gradient-to-br from-gray-900 to-indigo-900 p-6">
              <div className="max-w-4xl mx-auto">
                <button
                  onClick={() => setGameMode('menu')}
                  className="text-indigo-300 hover:text-white mb-6 flex items-center gap-2"
                >
                  ‚Üê Back to Menu
                </button>
                
                <h2 className="text-3xl font-bold text-white mb-8">Select a Case</h2>
                
                <div className="grid md:grid-cols-2 gap-6">
                  {CASES.map((caseData, index) => {
                    const isUnlocked = unlockedCases.includes(caseData.id);
                    const bestScore = playerStats.caseScores[caseData.id] || 0;
                    const stars = bestScore > 0 ? (bestScore >= 1700 ? 3 : bestScore >= 1400 ? 2 : 1) : 0;
                    
                    return (
                      <div
                        key={caseData.id}
                        className={`rounded-2xl overflow-hidden ${isUnlocked ? 'bg-white shadow-xl' : 'bg-gray-700 opacity-60'}`}
                      >
                        <div className={`p-4 ${isUnlocked ? 'bg-gradient-to-r from-indigo-500 to-purple-500' : 'bg-gray-600'}`}>
                          <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                              <span className="text-3xl">{caseData.icon}</span>
                              <div>
                                <h3 className="text-xl font-bold text-white">{caseData.title}</h3>
                                <p className="text-indigo-100 text-sm">{caseData.category}</p>
                              </div>
                            </div>
                            {!isUnlocked && <span className="text-3xl">üîí</span>}
                          </div>
                        </div>
                        
                        <div className="p-6">
                          {isUnlocked ? (
                            <>
                              <div className="flex justify-between items-center mb-4">
                                <div className="flex gap-1">
                                  {[1, 2, 3].map(s => (
                                    <span key={s} className={`text-2xl star ${s <= stars ? 'star-earned' : 'star-empty'}`}>‚òÖ</span>
                                  ))}
                                </div>
                                {bestScore > 0 && (
                                  <span className="text-gray-600 font-semibold">Best: {bestScore.toLocaleString()}</span>
                                )}
                              </div>
                              
                              <div className="flex gap-3">
                                <button
                                  onClick={() => startCase(index, 'game')}
                                  className="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:opacity-90"
                                >
                                  üéÆ Play
                                </button>
                                <button
                                  onClick={() => startCase(index, 'practice')}
                                  className="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:opacity-90"
                                >
                                  üìö Practice
                                </button>
                              </div>
                            </>
                          ) : (
                            <p className="text-gray-400 text-center">Complete the previous case to unlock</p>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );

          const renderProfile = () => {
            const levelInfo = getLevelInfo(playerStats.totalXp);
            
            return (
              <div className="min-h-screen bg-gradient-to-br from-gray-900 to-indigo-900 p-6">
                <div className="max-w-4xl mx-auto">
                  <button
                    onClick={() => setGameMode('menu')}
                    className="text-indigo-300 hover:text-white mb-6 flex items-center gap-2"
                  >
                    ‚Üê Back to Menu
                  </button>
                  
                  {/* Level Card */}
                  <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 mb-8 shadow-2xl">
                    <div className="flex items-center gap-6">
                      <div className="text-6xl">{levelInfo.icon}</div>
                      <div className="flex-1">
                        <h2 className="text-3xl font-bold text-white">{levelInfo.title}</h2>
                        <p className="text-indigo-200">Level {levelInfo.level}</p>
                        <div className="mt-4">
                          <div className="flex justify-between text-sm text-indigo-200 mb-1">
                            <span>{playerStats.totalXp.toLocaleString()} XP</span>
                            <span>{levelInfo.nextLevel.minXp.toLocaleString()} XP</span>
                          </div>
                          <div className="bg-indigo-900 rounded-full h-4 overflow-hidden">
                            <div 
                              className="bg-gradient-to-r from-yellow-400 to-orange-500 h-full transition-all duration-500"
                              style={{ width: `${levelInfo.progressPercent}%` }}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Stats Grid */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div className="bg-white/10 backdrop-blur rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-white">{playerStats.casesCompleted}</div>
                      <div className="text-indigo-200 text-sm">Cases Completed</div>
                    </div>
                    <div className="bg-white/10 backdrop-blur rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-yellow-400">{playerStats.totalPoints.toLocaleString()}</div>
                      <div className="text-indigo-200 text-sm">Total Points</div>
                    </div>
                    <div className="bg-white/10 backdrop-blur rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-orange-400">{playerStats.maxStreak}</div>
                      <div className="text-indigo-200 text-sm">Best Streak</div>
                    </div>
                    <div className="bg-white/10 backdrop-blur rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-green-400">{playerStats.threeStarCases}</div>
                      <div className="text-indigo-200 text-sm">3-Star Cases</div>
                    </div>
                  </div>
                  
                  {/* Badges */}
                  <div className="bg-white/10 backdrop-blur rounded-xl p-6">
                    <h3 className="text-xl font-bold text-white mb-4">Badges Earned ({playerStats.badges.length}/{BADGES.length})</h3>
                    <div className="grid grid-cols-4 md:grid-cols-6 gap-4">
                      {BADGES.map(badge => {
                        const earned = playerStats.badges.includes(badge.id);
                        return (
                          <div
                            key={badge.id}
                            className={`text-center p-3 rounded-lg ${earned ? 'bg-white/20' : 'bg-black/20 opacity-40'}`}
                            title={badge.description}
                          >
                            <div className="text-3xl mb-1">{badge.icon}</div>
                            <div className="text-xs text-white truncate">{badge.name}</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          const renderAchievements = () => (
            <div className="min-h-screen bg-gradient-to-br from-gray-900 to-indigo-900 p-6">
              <div className="max-w-4xl mx-auto">
                <button
                  onClick={() => setGameMode('menu')}
                  className="text-indigo-300 hover:text-white mb-6 flex items-center gap-2"
                >
                  ‚Üê Back to Menu
                </button>
                
                <h2 className="text-3xl font-bold text-white mb-8">üèÜ Achievements</h2>
                
                <div className="space-y-4">
                  {BADGES.map(badge => {
                    const earned = playerStats.badges.includes(badge.id);
                    return (
                      <div
                        key={badge.id}
                        className={`flex items-center gap-4 p-4 rounded-xl ${earned ? 'bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-500/50' : 'bg-white/5'}`}
                      >
                        <div className={`text-4xl ${earned ? '' : 'grayscale opacity-40'}`}>{badge.icon}</div>
                        <div className="flex-1">
                          <h3 className={`font-bold ${earned ? 'text-yellow-400' : 'text-gray-400'}`}>{badge.name}</h3>
                          <p className="text-gray-400 text-sm">{badge.description}</p>
                        </div>
                        {earned && <span className="text-green-400 text-2xl">‚úì</span>}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );

          const renderGameHUD = () => (
            <div className="bg-gray-900 text-white py-3 px-4 shadow-lg sticky top-0 z-50">
              <div className="max-w-4xl mx-auto flex justify-between items-center">
                <div className="flex items-center gap-6">
                  <button
                    onClick={() => { setGameMode('menu'); resetCase(); }}
                    className="text-gray-400 hover:text-white"
                  >
                    ‚úï Quit
                  </button>
                  <div className="text-lg font-bold">{currentCase.title}</div>
                </div>
                
                {gameMode === 'game' && (
                  <div className="flex items-center gap-6">
                    {/* Streak */}
                    {streak > 0 && (
                      <div className="flex items-center gap-2 streak-fire">
                        <span className="text-orange-400">üî•</span>
                        <span className="font-bold text-orange-400">{streak}x</span>
                      </div>
                    )}
                    
                    {/* Score */}
                    <div className="text-xl font-bold">
                      <span className="text-yellow-400">{currentScore.toLocaleString()}</span>
                      <span className="text-gray-400 text-sm ml-1">pts</span>
                    </div>
                    
                    {/* Timer */}
                    <div className={`text-xl font-mono font-bold ${timer < 60 ? 'timer-warning' : 'text-white'}`}>
                      ‚è±Ô∏è {formatTime(timer)}
                    </div>
                  </div>
                )}
                
                {gameMode === 'practice' && (
                  <div className="text-indigo-400">üìö Practice Mode</div>
                )}
              </div>
              
              {/* Score popup */}
              {scorePopup && (
                <div
                  className="absolute text-green-400 font-bold text-xl score-pop pointer-events-none"
                  style={{ left: `${scorePopup.x}%`, top: `${scorePopup.y + 50}px` }}
                >
                  +{scorePopup.points}
                </div>
              )}
            </div>
          );

          const renderInitialStage = () => (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-6 rounded-lg">
                <h3 className="text-lg font-semibold text-gray-900 mb-2">Door Note</h3>
                <div className="grid grid-cols-2 gap-4 text-gray-800">
                  <div><span className="font-semibold">Patient:</span> {currentCase.doorNote.name}</div>
                  <div><span className="font-semibold">Age:</span> {currentCase.doorNote.age} years</div>
                  <div><span className="font-semibold">Sex:</span> {currentCase.doorNote.sex}</div>
                  <div><span className="font-semibold">Location:</span> {currentCase.doorNote.location}</div>
                  <div className="col-span-2"><span className="font-semibold">Chief Complaint:</span> "{currentCase.doorNote.chiefComplaint}"</div>
                  <div className="col-span-2"><span className="font-semibold">Vitals:</span> {currentCase.doorNote.vitals}</div>
                </div>
              </div>

              <div className="bg-indigo-100 border-2 border-indigo-500 p-6 rounded-lg">
                <h3 className="text-lg font-semibold text-indigo-900 mb-2">Your First Task</h3>
                <p className="text-indigo-800 mb-4">
                  Based ONLY on the door note, generate your initial differential diagnosis. Include "must-not-miss" diagnoses!
                </p>
              </div>

              <button
                onClick={() => setCurrentStage('differential')}
                className="w-full bg-indigo-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-indigo-700 transition-colors pulse-glow"
              >
                Generate My Differential ‚Üí
              </button>
            </div>
          );

          const renderDifferentialStage = () => (
            <div className="space-y-6">
              <div className="bg-orange-50 border-l-4 border-orange-500 p-6 rounded-lg">
                <h3 className="text-lg font-semibold text-orange-900">Select Your Differential (3-5 diagnoses)</h3>
                <p className="text-orange-700 text-sm">Include at least one must-not-miss diagnosis!</p>
              </div>

              <div className="bg-white rounded-lg shadow-lg p-6">
                <div className="space-y-2">
                  {Object.keys(differentialsBySystem).map((system) => (
                    <div key={system} className="border-2 border-gray-200 rounded-lg overflow-hidden">
                      <div
                        className="p-4 bg-gray-50 flex justify-between items-center cursor-pointer hover:bg-gray-100"
                        onClick={() => {
                          if (expandedSystems.includes(system)) {
                            setExpandedSystems(expandedSystems.filter(s => s !== system));
                          } else {
                            setExpandedSystems([...expandedSystems, system]);
                          }
                        }}
                      >
                        <h4 className="font-semibold text-gray-900">{system}</h4>
                        <span className="text-gray-600">{expandedSystems.includes(system) ? '‚ñº' : '‚ñ∂'}</span>
                      </div>
                      {expandedSystems.includes(system) && (
                        <div className="p-4 space-y-2 bg-white">
                          {differentialsBySystem[system].map((dx) => {
                            const isSelected = selectedDifferentials.includes(dx);
                            return (
                              <div
                                key={dx}
                                className={`p-3 border-2 rounded cursor-pointer transition-all ${isSelected ? 'selected-choice' : 'border-gray-200 hover:border-gray-400'}`}
                                onClick={() => {
                                  if (isSelected) {
                                    setSelectedDifferentials(selectedDifferentials.filter(d => d !== dx));
                                  } else {
                                    setSelectedDifferentials([...selectedDifferentials, dx]);
                                  }
                                }}
                              >
                                <div className="flex items-center justify-between">
                                  <span className="text-gray-900">{dx}</span>
                                  <input type="checkbox" checked={isSelected} onChange={() => {}} className="w-5 h-5" />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {selectedDifferentials.length > 0 && (
                <div className="bg-blue-50 border-2 border-blue-500 p-4 rounded-lg">
                  <h4 className="font-semibold text-blue-900 mb-2">Your Differential ({selectedDifferentials.length}):</h4>
                  <div className="flex flex-wrap gap-2">
                    {selectedDifferentials.map((dx) => (
                      <span key={dx} className="bg-blue-200 text-blue-900 px-3 py-1 rounded-full text-sm">{dx}</span>
                    ))}
                  </div>
                </div>
              )}

              <button
                onClick={() => setCurrentStage('history')}
                disabled={selectedDifferentials.length < 2}
                className="w-full bg-indigo-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                Continue to History Taking ‚Üí
              </button>
            </div>
          );

          const renderHistoryStage = () => {
            const questionCategories = [
              { key: 'hpiFollowUp', label: 'HPI Follow-up', questions: currentCase.historyQuestions.hpiFollowUp },
              { key: 'ros', label: 'Review of Systems', questions: currentCase.historyQuestions.ros },
              { key: 'pmh', label: 'Past Medical History', questions: currentCase.historyQuestions.pmh },
              { key: 'socialHistory', label: 'Social & Family History', questions: currentCase.historyQuestions.socialHistory }
            ];

            return (
              <div className="space-y-6">
                <div className="bg-teal-50 border-l-4 border-teal-500 p-6 rounded-lg">
                  <h3 className="text-lg font-semibold text-teal-900">History Taking</h3>
                  <p className="text-teal-700 text-sm">Select questions to ask. In Game Mode, high-yield questions earn more points!</p>
                </div>

                {questionCategories.map((category) => (
                  <div key={category.key} className="bg-white rounded-lg shadow-lg p-6">
                    <h3 className="text-xl font-bold text-gray-900 mb-4">{category.label}</h3>
                    <div className="space-y-2">
                      {category.questions.map((q) => {
                        const isSelected = selectedHistory.includes(q.id);
                        return (
                          <div
                            key={q.id}
                            className={`p-3 border-2 rounded cursor-pointer transition-all ${
                              showFeedback
                                ? q.quality === 'excellent' ? 'excellent-choice' :
                                  q.quality === 'good' ? 'good-choice' :
                                  q.quality === 'fair' ? 'fair-choice' : 'low-priority-choice'
                                : isSelected ? 'selected-choice' : 'border-gray-200 hover:border-gray-400'
                            }`}
                            onClick={() => handleHistorySelection(q.id)}
                          >
                            <div className="flex items-center justify-between">
                              <span className="text-gray-900 flex-1">{q.question}</span>
                              <div className="flex items-center gap-2">
                                {showFeedback && (
                                  <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                    q.quality === 'excellent' ? 'bg-green-200 text-green-800' :
                                    q.quality === 'good' ? 'bg-blue-200 text-blue-800' :
                                    q.quality === 'fair' ? 'bg-yellow-200 text-yellow-800' :
                                    'bg-red-200 text-red-800'
                                  }`}>
                                    {q.quality.toUpperCase()}
                                  </span>
                                )}
                                <input type="checkbox" checked={isSelected} onChange={() => {}} className="w-5 h-5" disabled={showFeedback} />
                              </div>
                            </div>
                            {showFeedback && <p className="text-sm text-gray-600 mt-2 italic">{q.rationale}</p>}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}

                <div className="flex gap-4">
                  {!showFeedback ? (
                    <button
                      onClick={() => setShowFeedback(true)}
                      className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700"
                    >
                      Show Feedback
                    </button>
                  ) : (
                    <button
                      onClick={() => { setShowFeedback(false); setCurrentStage('physical'); }}
                      className="flex-1 bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700"
                    >
                      Continue to Physical Exam ‚Üí
                    </button>
                  )}
                </div>
              </div>
            );
          };

          const renderPhysicalStage = () => {
            const [showPhysicalFeedback, setShowPhysicalFeedback] = useState(false);

            return (
              <div className="space-y-6">
                <div className="bg-purple-50 border-l-4 border-purple-500 p-6 rounded-lg">
                  <h3 className="text-lg font-semibold text-purple-900">Physical Examination</h3>
                  <p className="text-purple-700 text-sm">Select exam maneuvers to perform.</p>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-6">
                  <div className="space-y-2">
                    {currentCase.physicalExam.map((exam) => {
                      const isSelected = selectedPhysical.includes(exam.id);
                      return (
                        <div
                          key={exam.id}
                          className={`p-3 border-2 rounded cursor-pointer transition-all ${
                            showPhysicalFeedback
                              ? exam.quality === 'excellent' ? 'excellent-choice' :
                                exam.quality === 'good' ? 'good-choice' :
                                exam.quality === 'fair' ? 'fair-choice' : 'low-priority-choice'
                              : isSelected ? 'selected-choice' : 'border-gray-200 hover:border-gray-400'
                          }`}
                          onClick={() => handlePhysicalSelection(exam.id)}
                        >
                          <div className="flex items-center justify-between">
                            <span className="text-gray-900 font-medium flex-1">{exam.maneuver}</span>
                            <div className="flex items-center gap-2">
                              {showPhysicalFeedback && (
                                <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                  exam.quality === 'excellent' ? 'bg-green-200 text-green-800' :
                                  exam.quality === 'good' ? 'bg-blue-200 text-blue-800' :
                                  exam.quality === 'fair' ? 'bg-yellow-200 text-yellow-800' :
                                  'bg-red-200 text-red-800'
                                }`}>
                                  {exam.quality.toUpperCase()}
                                </span>
                              )}
                              <input type="checkbox" checked={isSelected} onChange={() => {}} className="w-5 h-5" disabled={showPhysicalFeedback} />
                            </div>
                          </div>
                          {showPhysicalFeedback && (
                            <div className="mt-2">
                              <p className="text-sm text-gray-600 italic">{exam.rationale}</p>
                              <p className="text-sm mt-1"><strong>Finding:</strong> {exam.finding}</p>
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>

                <div className="flex gap-4">
                  {!showPhysicalFeedback ? (
                    <button
                      onClick={() => setShowPhysicalFeedback(true)}
                      className="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700"
                    >
                      Show Feedback
                    </button>
                  ) : (
                    <button
                      onClick={() => { setIsTimerRunning(false); completeCase(); setCurrentStage('results'); }}
                      className="flex-1 bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700"
                    >
                      Complete Case ‚Üí
                    </button>
                  )}
                </div>
              </div>
            );
          };

          const renderResults = () => (
            <div className="space-y-6">
              {/* Score Card */}
              <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 text-white text-center">
                <h2 className="text-3xl font-bold mb-4">Case Complete!</h2>
                
                {/* Stars */}
                <div className="flex justify-center gap-2 mb-4">
                  {[1, 2, 3].map(s => (
                    <span key={s} className={`text-5xl star ${s <= stageScores.stars ? 'star-earned' : 'star-empty'}`}>‚òÖ</span>
                  ))}
                </div>
                
                <div className="text-5xl font-bold mb-2">{stageScores.totalScore?.toLocaleString()}</div>
                <div className="text-indigo-200 mb-6">Total Points</div>
                
                <div className="grid grid-cols-3 gap-4 text-center">
                  <div className="bg-white/20 rounded-lg p-3">
                    <div className="text-2xl font-bold">{stageScores.efficiency?.toFixed(0)}%</div>
                    <div className="text-sm text-indigo-200">Efficiency</div>
                  </div>
                  <div className="bg-white/20 rounded-lg p-3">
                    <div className="text-2xl font-bold">+{stageScores.xpEarned}</div>
                    <div className="text-sm text-indigo-200">XP Earned</div>
                  </div>
                  <div className="bg-white/20 rounded-lg p-3">
                    <div className="text-2xl font-bold">{maxStreak}</div>
                    <div className="text-sm text-indigo-200">Best Streak</div>
                  </div>
                </div>
                
                {stageScores.speedBonus && (
                  <div className="mt-4 bg-yellow-500/30 rounded-lg p-2">
                    ‚ö° Speed Bonus Applied!
                  </div>
                )}
              </div>
              
              {/* New Badges */}
              {newBadges.length > 0 && (
                <div className="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl p-6 text-white">
                  <h3 className="text-xl font-bold mb-4 text-center">üèÜ New Badges Earned!</h3>
                  <div className="flex justify-center gap-4">
                    {newBadges.map(badge => (
                      <div key={badge.id} className="text-center badge-unlock">
                        <div className="text-4xl mb-2">{badge.icon}</div>
                        <div className="font-semibold">{badge.name}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* Level Up */}
              {showLevelUp && (
                <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl p-6 text-white text-center level-up">
                  <h3 className="text-2xl font-bold mb-2">üéâ Level Up!</h3>
                  <p className="text-xl">{getLevelInfo(playerStats.totalXp).icon} {getLevelInfo(playerStats.totalXp).title}</p>
                </div>
              )}
              
              {/* Diagnosis Review */}
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Actual Diagnosis</h3>
                <div className="bg-emerald-50 border-2 border-emerald-500 rounded-lg p-4 mb-4">
                  <h4 className="text-lg font-bold text-emerald-900">{currentCase.actualDiagnosis.diagnosis}</h4>
                </div>
                <div className="space-y-2">
                  <h4 className="font-semibold">Key Teaching Points:</h4>
                  <ul className="list-disc list-inside text-gray-700 space-y-1">
                    {currentCase.actualDiagnosis.teachingPoints.map((point, i) => (
                      <li key={i}>{point}</li>
                    ))}
                  </ul>
                </div>
              </div>
              
              {/* Action Buttons */}
              <div className="flex gap-4">
                <button
                  onClick={() => { resetCase(); setCurrentStage('initial'); }}
                  className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                >
                  üîÑ Retry Case
                </button>
                <button
                  onClick={() => setGameMode('caseSelect')}
                  className="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700"
                >
                  üìã Case Select
                </button>
                <button
                  onClick={() => setGameMode('menu')}
                  className="flex-1 bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700"
                >
                  üè† Menu
                </button>
              </div>
            </div>
          );

          // ==================== MAIN RENDER ====================
          if (gameMode === 'menu') return renderMenu();
          if (gameMode === 'caseSelect') return renderCaseSelect();
          if (gameMode === 'profile') return renderProfile();
          if (gameMode === 'achievements') return renderAchievements();

          return (
            <div className="min-h-screen bg-gray-100">
              {renderGameHUD()}
              
              <div className="max-w-4xl mx-auto py-6 px-4">
                {/* Stage Progress */}
                <div className="bg-white rounded-lg shadow p-4 mb-6">
                  <div className="flex gap-2 flex-wrap">
                    {['initial', 'differential', 'history', 'physical', 'results'].map((stage, idx) => (
                      <div
                        key={stage}
                        className={`px-3 py-1 rounded-full text-sm font-medium ${
                          currentStage === stage ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-600'
                        }`}
                      >
                        {idx + 1}. {stage.charAt(0).toUpperCase() + stage.slice(1)}
                      </div>
                    ))}
                  </div>
                </div>

                {currentStage === 'initial' && renderInitialStage()}
                {currentStage === 'differential' && renderDifferentialStage()}
                {currentStage === 'history' && renderHistoryStage()}
                {currentStage === 'physical' && renderPhysicalStage()}
                {currentStage === 'results' && renderResults()}
              </div>
            </div>
          );
        };

        ReactDOM.render(<ClinicalReasoningGame />, document.getElementById('root'));
    </script>
</body>
</html>
